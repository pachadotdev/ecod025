<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Mauricio Vargas Sepulveda">

<title>Problem Set 1</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="index_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap-813c323200a87c37e262811031999de4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-full toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#problem" id="toc-problem" class="nav-link active" data-scroll-target="#problem">Problem</a></li>
  <li><a href="#goal" id="toc-goal" class="nav-link" data-scroll-target="#goal">Goal</a></li>
  <li><a href="#github-repository" id="toc-github-repository" class="nav-link" data-scroll-target="#github-repository">GitHub repository</a></li>
  <li><a href="#technical-note" id="toc-technical-note" class="nav-link" data-scroll-target="#technical-note">Technical note</a></li>
  <li><a href="#models" id="toc-models" class="nav-link" data-scroll-target="#models">Models</a>
  <ul class="collapse">
  <li><a href="#vector-autoregressions-var" id="toc-vector-autoregressions-var" class="nav-link" data-scroll-target="#vector-autoregressions-var">Vector Autoregressions (VAR)</a></li>
  <li><a href="#factor-augmented-var-fa-var" id="toc-factor-augmented-var-fa-var" class="nav-link" data-scroll-target="#factor-augmented-var-fa-var">Factor-Augmented VAR (FA-VAR)</a></li>
  <li><a href="#dynamic-factor-model-dfm" id="toc-dynamic-factor-model-dfm" class="nav-link" data-scroll-target="#dynamic-factor-model-dfm">Dynamic Factor Model (DFM)</a></li>
  <li><a href="#state-space-representation" id="toc-state-space-representation" class="nav-link" data-scroll-target="#state-space-representation">State-space representation</a>
  <ul class="collapse">
  <li><a href="#vector-autoregressions-var-1" id="toc-vector-autoregressions-var-1" class="nav-link" data-scroll-target="#vector-autoregressions-var-1">Vector Autoregressions (VAR)</a></li>
  <li><a href="#factor-augmented-var-fa-var-1" id="toc-factor-augmented-var-fa-var-1" class="nav-link" data-scroll-target="#factor-augmented-var-fa-var-1">Factor-Augmented VAR (FA-VAR)</a></li>
  <li><a href="#dynamic-factor-model-dfm-1" id="toc-dynamic-factor-model-dfm-1" class="nav-link" data-scroll-target="#dynamic-factor-model-dfm-1">Dynamic Factor Model (DFM)</a></li>
  </ul></li>
  <li><a href="#forecast-comparison-metrics" id="toc-forecast-comparison-metrics" class="nav-link" data-scroll-target="#forecast-comparison-metrics">Forecast Comparison Metrics</a>
  <ul class="collapse">
  <li><a href="#root-mean-squared-forecast-error-rmsfe" id="toc-root-mean-squared-forecast-error-rmsfe" class="nav-link" data-scroll-target="#root-mean-squared-forecast-error-rmsfe">Root Mean Squared Forecast Error (RMSFE)</a></li>
  <li><a href="#mean-absolute-error-mae" id="toc-mean-absolute-error-mae" class="nav-link" data-scroll-target="#mean-absolute-error-mae">Mean Absolute Error (MAE)</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a></li>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation">Data preparation</a></li>
  <li><a href="#estimate-a-var-model" id="toc-estimate-a-var-model" class="nav-link" data-scroll-target="#estimate-a-var-model">Estimate a VAR model</a></li>
  <li><a href="#estimate-a-fa-var-model" id="toc-estimate-a-fa-var-model" class="nav-link" data-scroll-target="#estimate-a-fa-var-model">Estimate a FA-VAR model</a></li>
  <li><a href="#estimate-a-dfm-model" id="toc-estimate-a-dfm-model" class="nav-link" data-scroll-target="#estimate-a-dfm-model">Estimate a DFM model</a></li>
  <li><a href="#model-comparison" id="toc-model-comparison" class="nav-link" data-scroll-target="#model-comparison">Model Comparison</a></li>
  <li><a href="#c-codes" id="toc-c-codes" class="nav-link" data-scroll-target="#c-codes">C++ codes</a>
  <ul class="collapse">
  <li><a href="#model-metrics" id="toc-model-metrics" class="nav-link" data-scroll-target="#model-metrics">Model metrics</a></li>
  <li><a href="#var" id="toc-var" class="nav-link" data-scroll-target="#var">VAR</a></li>
  <li><a href="#fa-var" id="toc-fa-var" class="nav-link" data-scroll-target="#fa-var">FA-VAR</a></li>
  <li><a href="#dfm" id="toc-dfm" class="nav-link" data-scroll-target="#dfm">DFM</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content column-page-right" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Problem Set 1</h1>
</div>



<div class="quarto-title-meta column-page-right">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Mauricio Vargas Sepulveda </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="problem" class="level1">
<h1>Problem</h1>
<p>Recent headlines emphasize the challenges faced by central banks: inflation remains persistent in the U.S., global supply chain uncertainties continue, and growth forecasts remain fragile amid geopolitical risks.</p>
</section>
<section id="goal" class="level1">
<h1>Goal</h1>
<p>Provide policy recommendations for the Federal Reserve (Fed) new forecasting system.</p>
</section>
<section id="github-repository" class="level1">
<h1>GitHub repository</h1>
<p>All the codes and data for this problem set are available in the GitHub repository: <a href="https://github.com/pachadotdev/ecod025">https://github.com/pachadotdev/ecod025</a></p>
</section>
<section id="technical-note" class="level1">
<h1>Technical note</h1>
<p>For this problem set, the models were written in C++ using the Armadillo library for linear algebra <span class="citation" data-cites="sanderson16 sanderson24">(<a href="#ref-sanderson16" role="doc-biblioref">Sanderson and Curtin 2016</a>; <a href="#ref-sanderson24" role="doc-biblioref">Sanderson 2024</a>)</span>.</p>
<p>To run the model functions, you need to change this boolean to “TRUE”, otherwise when rendering the file it will load pre-computed results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>run_models <span class="ot">&lt;-</span> T</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The functions were made available in the R package <code>ecod025ps1</code> which can be installed from this same repository:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"ecod025ps1"</span>) <span class="sc">&amp;&amp;</span> run_models) {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    repository <span class="ot">&lt;-</span> <span class="st">"https://cran.rstudio.com"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"pak"</span>)) {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">install.packages</span>(<span class="st">"pak"</span>, <span class="at">repos =</span> repository)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    pak<span class="sc">::</span><span class="fu">pkg_install</span>(<span class="st">"pachadotdev/ecod025/ecod025ps1"</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"dynlm"</span>)) <span class="fu">install.packages</span>(<span class="st">"dynlm"</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (run_models) {</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(ecod025ps1)</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(dynlm)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>R package for accessing the data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"alfred"</span>)) {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(<span class="st">"alfred"</span>)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(alfred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Additional packages for data manipulation and plotting:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"dplyr"</span>)) {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(<span class="st">"dplyr"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"lubridate"</span>)) {</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(<span class="st">"lubridate"</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"rlang"</span>)) {</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(<span class="st">"rlang"</span>)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"purrr"</span>)) {</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(<span class="st">"purrr"</span>)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"ggplot2"</span>)) {</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"tintin"</span>)) {</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(<span class="st">"tintin"</span>)</span>
<span id="cb4-18"><a href="#cb4-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-19"><a href="#cb4-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-20"><a href="#cb4-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb4-21"><a href="#cb4-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb4-22"><a href="#cb4-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rlang)</span>
<span id="cb4-23"><a href="#cb4-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb4-24"><a href="#cb4-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb4-25"><a href="#cb4-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tintin)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="models" class="level1">
<h1>Models</h1>
<section id="vector-autoregressions-var" class="level2">
<h2 class="anchored" data-anchor-id="vector-autoregressions-var">Vector Autoregressions (VAR)</h2>
<p><span class="math inline">\(\text{VAR}(p)\)</span> for inflation (<span class="math inline">\(\pi_t\)</span>) and growth (<span class="math inline">\(g_t\)</span>):</p>
<p><span class="math display">\[
y_t = A_1 y_{t-1} + \ldots + Ap y_{t-p} + u_t = A(L) y_t + u_t,\: y_t = [\pi_t, g_t]^T.
\]</span></p>
</section>
<section id="factor-augmented-var-fa-var" class="level2">
<h2 class="anchored" data-anchor-id="factor-augmented-var-fa-var">Factor-Augmented VAR (FA-VAR)</h2>
<p><span class="math display">\[
\begin{aligned}
X_t &amp;= \Lambda F_t + e_t, \cr
F_t &amp;= \Phi_1 F_{t-1} + \ldots + \Phi_p F_{t-p} + v_t, \cr
y_t &amp;= B(L)y_{t-1} + C(L)F_{t} + u_t
\end{aligned}
\]</span></p>
</section>
<section id="dynamic-factor-model-dfm" class="level2">
<h2 class="anchored" data-anchor-id="dynamic-factor-model-dfm">Dynamic Factor Model (DFM)</h2>
<p><span class="math display">\[
\begin{aligned}
X_t &amp;= \Lambda F_t + u_t,\: u_t \sim N(0, R), \cr
F_t &amp;= AF_{t-1} + \eta_t,\: \eta_t \sim N(0, Q).
\end{aligned}
\]</span></p>
<p>For DFM, we consider VAR models that are identified and that can be written using lag polynomials such that besides <span class="math inline">\(F_t\)</span> lagged definition we have</p>
<p><span class="math display">\[
\begin{aligned}
A(L) F_t &amp;= v_t \cr
B(L) u_t &amp;= e_t,
\end{aligned}
\]</span></p>
<p>where <span class="math inline">\(A(L)\)</span> and <span class="math inline">\(B(L)\)</span> are lag polynomials with <span class="math inline">\(p\)</span> and <span class="math inline">\(q\)</span> lags, respectively <span class="citation" data-cites="hansen22">(<a href="#ref-hansen22" role="doc-biblioref">Hansen 2022</a>)</span>.</p>
<p>To avoid identification issues, we will restrict the lag polynomial <span class="math inline">\(B(L)\)</span> to be diagonal.</p>
<p>Defining the inverse lag operators</p>
<p><span class="math display">\[
\begin{aligned}
D(L) &amp;= A(L)^{-1} \cr
C(L) &amp;= B(L)^{-1}
\end{aligned},
\]</span></p>
<p>then we have</p>
<p><span class="math display">\[
\begin{aligned}
X_t &amp;= \Lambda F_t + u_t \cr
\implies C(L) X_t &amp;= C(L) \Lambda F_t + C(L) u_t
\implies C(L) X_t &amp;= C(L) \Lambda D(L) v_t + e_t \cr
\implies C(L) X_t &amp;= \Lambda(L) v_t + e_t.
\end{aligned}
\]</span></p>
<p>Furthermore, we will restrict <span class="math inline">\(\Lambda(L) = C(L) \Lambda D(L)\)</span> to be a polynomial of <span class="math inline">\(l\)</span> lags.</p>
<p>The static form of the dynamic model is</p>
<p><span class="math display">\[
C(L) X_t = HV_t + e_t
\]</span></p>
<p>for a matrix <span class="math inline">\(H\)</span> with dimensions <span class="math inline">\(N \times rl\)</span> columns provided that <span class="math inline">\(X_t\)</span> and u_t$ are <span class="math inline">\(N \times 1\)</span>, <span class="math inline">\(\Lambda\)</span> is <span class="math inline">\(N \times r\)</span> (<span class="math inline">\(r &lt; N\)</span>), and <span class="math inline">\(F_t\)</span> is <span class="math inline">\(r \times 1\)</span>.</p>
<p>To avoid scaling issues, we will transform the elements of <span class="math inline">\(X_t\)</span> to have mean 0 and common variance.</p>
</section>
<section id="state-space-representation" class="level2">
<h2 class="anchored" data-anchor-id="state-space-representation">State-space representation</h2>
<section id="vector-autoregressions-var-1" class="level3">
<h3 class="anchored" data-anchor-id="vector-autoregressions-var-1">Vector Autoregressions (VAR)</h3>
<p>Model specification (reduced form):</p>
<ul>
<li><span class="math inline">\(y_t = A(L) \cdot y_t + u_t\)</span></li>
</ul>
<p>State-space form (companion representation):</p>
<ul>
<li>Observation: <span class="math inline">\(y_t = [I_K, 0, \ldots, 0] \cdot \chi_t + u_t\)</span></li>
<li>Transition: <span class="math inline">\(\chi_t = F \cdot \chi_{t-1} + \eta_t\)</span></li>
</ul>
<p>where: - <span class="math inline">\(\chi_t = [y_t', y_{t-1}', \ldots, y_{t-p+1}']'\)</span> is the state vector (<span class="math inline">\(Kp \times 1\)</span>) and <span class="math inline">\(F\)</span> is the companion matrix (<span class="math inline">\(Kp \times Kp\)</span>) - <span class="math inline">\(y_t\)</span> is <span class="math inline">\(K \times 1\)</span> (observed variables) - <span class="math inline">\(A_i\)</span> are <span class="math inline">\(K \times K\)</span> (coefficient matrices for <span class="math inline">\(i = 1, \ldots, p\)</span>) - <span class="math inline">\(u_t \sim N(0, \Sigma)\)</span> (error term) - <span class="math inline">\(\Sigma\)</span> is <span class="math inline">\(K \times K\)</span> (covariance matrix)</p>
<p>Estimation: Equation-by-equation OLS</p>
</section>
<section id="factor-augmented-var-fa-var-1" class="level3">
<h3 class="anchored" data-anchor-id="factor-augmented-var-fa-var-1">Factor-Augmented VAR (FA-VAR)</h3>
<p>Model specification:</p>
<ul>
<li><span class="math inline">\(X_t = \Lambda F_t + e_t\)</span></li>
<li><span class="math inline">\(F_t = \Phi_1 F_{t-1} + \ldots + \Phi_p F_{t-p} + v_t\)</span></li>
<li><span class="math inline">\(y_t = B(L) y_{t-1} + C(L) F_{t-1} + u_t\)</span></li>
</ul>
<p>where <span class="math inline">\(X_t = [y_t, y_{t-1}, \ldots, y_{t-n}]\)</span> is the information set constructed from current and lagged values of the target variable.</p>
<p>We use lagged factors <span class="math inline">\(F_{t-1}\)</span> (not contemporaneous <span class="math inline">\(F_t\)</span>) in the augmented VAR to avoid data leakage, since <span class="math inline">\(F_t\)</span> is extracted from <span class="math inline">\(X_t\)</span> which contains <span class="math inline">\(y_t\)</span>.</p>
<p>State-space form (companion representation):</p>
<ul>
<li>Observation: <span class="math inline">\(X_t = [\Lambda, 0, \ldots, 0] \cdot \chi_t + e_t\)</span></li>
<li>Transition: <span class="math inline">\(\chi_t = A \cdot \chi_{t-1} + \eta_t\)</span></li>
</ul>
<p>where: - <span class="math inline">\(\chi_t = [F_t', F_{t-1}', \ldots, F_{t-p+1}']'\)</span> is the state vector and <span class="math inline">\(A\)</span> is the companion matrix for the factor VAR - <span class="math inline">\(X_t\)</span> is <span class="math inline">\(N \times 1\)</span> (information set: current and lagged <span class="math inline">\(y\)</span>) - <span class="math inline">\(F_t\)</span> is <span class="math inline">\(r \times 1\)</span> (latent factors extracted from <span class="math inline">\(X_t\)</span>, with <span class="math inline">\(r &lt; N\)</span>) - <span class="math inline">\(y_t\)</span> is <span class="math inline">\(K \times 1\)</span> (target variable of interest, <span class="math inline">\(K=1\)</span> for univariate) - <span class="math inline">\(\Lambda\)</span> is <span class="math inline">\(N \times r\)</span> (factor loadings) - <span class="math inline">\(B(L) = B_1 L + \ldots + B_{p_y} L^{p_y}\)</span> (lag polynomial for <span class="math inline">\(y\)</span> dynamics) - <span class="math inline">\(\Phi(L) = \Phi_1 L + \ldots + \Phi_{p_f} L^{p_f}\)</span> (lag polynomial for factor dynamics) - <span class="math inline">\(C(L) = C_1 L + \ldots + C_{p_f} L^{p_f}\)</span> (lag polynomial for factor impact on <span class="math inline">\(y\)</span>)</p>
<p>Estimation: PCA for factor extraction, OLS for VARs</p>
</section>
<section id="dynamic-factor-model-dfm-1" class="level3">
<h3 class="anchored" data-anchor-id="dynamic-factor-model-dfm-1">Dynamic Factor Model (DFM)</h3>
<p>Model specification (state-space form):</p>
<ul>
<li>Observation equation: <span class="math inline">\(X_t = \Lambda \cdot F_t + u_t\)</span>, <span class="math inline">\(u_t \sim N(0, R)\)</span></li>
<li>State equation: <span class="math inline">\(F_t = A \cdot F_{t-1} + \eta_t\)</span>, <span class="math inline">\(\eta_t \sim N(0, Q)\)</span></li>
</ul>
<p>For VAR(p) factor dynamics, use companion form:</p>
<ul>
<li>Observation: <span class="math inline">\(X_t = [\Lambda, 0, \ldots, 0] \cdot \chi_t + u_t\)</span></li>
<li>Transition: <span class="math inline">\(\chi_t = A \cdot \chi_{t-1} + \eta_t\)</span></li>
</ul>
<p>where: - <span class="math inline">\(\chi_t = [F_t', F_{t-1}', \ldots, F_{t-p+1}']'\)</span> is the state vector (<span class="math inline">\(rp \times 1\)</span>) and <span class="math inline">\(A\)</span> is the companion matrix (<span class="math inline">\(rp \times rp\)</span>) - <span class="math inline">\(X_t\)</span> is <span class="math inline">\(N \times 1\)</span> (observed variables, standardized to mean 0, common variance) - <span class="math inline">\(F_t\)</span> is <span class="math inline">\(r \times 1\)</span> (latent factors, <span class="math inline">\(r &lt; N\)</span>) - <span class="math inline">\(\Lambda\)</span> is <span class="math inline">\(N \times r\)</span> (factor loadings) - <span class="math inline">\(A\)</span> is <span class="math inline">\(r \times r\)</span> (transition matrix for VAR(1)) or <span class="math inline">\(rp \times rp\)</span> (companion form for VAR(p)) - <span class="math inline">\(R\)</span> is <span class="math inline">\(N \times N\)</span> (idiosyncratic covariance, diagonal) - <span class="math inline">\(Q\)</span> is <span class="math inline">\(r \times r\)</span> (factor innovation covariance) or <span class="math inline">\(rp \times rp\)</span> (companion form)</p>
<p>Estimation: EM algorithm with Kalman filter for state estimation</p>
</section>
</section>
<section id="forecast-comparison-metrics" class="level2">
<h2 class="anchored" data-anchor-id="forecast-comparison-metrics">Forecast Comparison Metrics</h2>
<section id="root-mean-squared-forecast-error-rmsfe" class="level3">
<h3 class="anchored" data-anchor-id="root-mean-squared-forecast-error-rmsfe">Root Mean Squared Forecast Error (RMSFE)</h3>
<p><span class="math display">\[
\text{RMSFE} = \sqrt{\frac{1}{T} \sum_{t=1}^{T} (y_{t+h} - \hat{y}_{t+h \mid t})^2}.
\]</span></p>
</section>
<section id="mean-absolute-error-mae" class="level3">
<h3 class="anchored" data-anchor-id="mean-absolute-error-mae">Mean Absolute Error (MAE)</h3>
<p><span class="math display">\[
\text{MAE} = \frac{1}{T} \sum_{t=1}^{T} |y_{t+h} - \hat{y}_{t+h \mid t}|.
\]</span></p>
</section>
</section>
</section>
<section id="data" class="level1">
<h1>Data</h1>
<p>Get the different series used to measure inflation according to <a href="https://files.stlouisfed.org/files/htdocs/pageone-economics/uploads/Lessons/DataPracticeFRED_Measures_of_Inflation.pdf">FED</a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">try</span>(<span class="fu">dir.create</span>(<span class="st">"data"</span>), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>download_data <span class="ot">&lt;-</span> <span class="cf">function</span>(series_id) {</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    fout <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"data/"</span>, series_id, <span class="st">".rds"</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(fout)) {</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        data <span class="ot">&lt;-</span> <span class="fu">get_alfred_series</span>(series_id)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        data <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(data)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">saveRDS</span>(data, fout, <span class="at">compress =</span> <span class="st">"xz"</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(fout)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(data)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Consumer Price Index for All Urban Consumers: All Items</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>cpiaucsl <span class="ot">&lt;-</span> <span class="fu">download_data</span>(<span class="st">"CPIAUCSL"</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Consumer Price Index for All Urban Consumers: All Items Less Food &amp; Energy</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>cpilfesl <span class="ot">&lt;-</span> <span class="fu">download_data</span>(<span class="st">"CPILFESL"</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Consumer Price Index for All Urban Consumers: Energy</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>cpiengsl <span class="ot">&lt;-</span> <span class="fu">download_data</span>(<span class="st">"CPIENGSL"</span>)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Consumer Price Index for All Urban Consumers: Food</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>cpifood <span class="ot">&lt;-</span> <span class="fu">download_data</span>(<span class="st">"CPIUFDSL"</span>)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="co"># GDP Deflator</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>gdpdef <span class="ot">&lt;-</span> <span class="fu">download_data</span>(<span class="st">"GDPDEF"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Get the quarterly real GDP data to compute growth rates:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>gdpc1 <span class="ot">&lt;-</span> <span class="fu">download_data</span>(<span class="st">"GDPC1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also require the ‘University of Michigan: Inflation Expectation (Median expected price change next 12 months)’ as a covariate for DFM:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="co"># University of Michigan: Inflation Expectation (Median expected price change next 12 months)</span></span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>michigan <span class="ot">&lt;-</span> <span class="fu">download_data</span>(<span class="st">"MICH"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-preparation" class="level1">
<h1>Data preparation</h1>
<p>We need to filter and differentiate to get inflation rates as</p>
<p><span class="math display">\[
\text{Inflation Rate}_t = 100 \times \frac{C_t - C_{t-1}}{C_{t-1}}
\]</span></p>
<p>We will use October data to compute the inflation rate to match the reported quarterly GDP data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>inflation_mm <span class="ot">&lt;-</span> <span class="cf">function</span>(data, col) {</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    data <span class="sc">%&gt;%</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">arrange</span>(<span class="fu">desc</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># keep the most updated figure</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(realtime_period <span class="sc">==</span> <span class="fu">max</span>(realtime_period)) <span class="sc">%&gt;%</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(date), <span class="at">month =</span> <span class="fu">month</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(month <span class="sc">==</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(</span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">inflation =</span> <span class="dv">100</span> <span class="sc">*</span> (<span class="sc">!!</span><span class="fu">sym</span>(col) <span class="sc">-</span> <span class="fu">lead</span>(<span class="sc">!!</span><span class="fu">sym</span>(col))) <span class="sc">/</span> <span class="fu">lead</span>(<span class="sc">!!</span><span class="fu">sym</span>(col))</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>cpiaucsl_mm <span class="ot">&lt;-</span> <span class="fu">inflation_mm</span>(cpiaucsl, <span class="st">"CPIAUCSL"</span>)</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>cpilfesl_mm <span class="ot">&lt;-</span> <span class="fu">inflation_mm</span>(cpilfesl, <span class="st">"CPILFESL"</span>)</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>cpiengsl_mm <span class="ot">&lt;-</span> <span class="fu">inflation_mm</span>(cpiengsl, <span class="st">"CPIENGSL"</span>)</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>cpifood_mm <span class="ot">&lt;-</span> <span class="fu">inflation_mm</span>(cpifood, <span class="st">"CPIUFDSL"</span>)</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>gdpdef_mm <span class="ot">&lt;-</span> <span class="fu">inflation_mm</span>(gdpdef, <span class="st">"GDPDEF"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The GDP data has a different frequency (quarterly) so we need to adjust the code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>gdpc1_yy <span class="ot">&lt;-</span> gdpc1 <span class="sc">%&gt;%</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(realtime_period <span class="sc">==</span> <span class="fu">max</span>(realtime_period)) <span class="sc">%&gt;%</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(year <span class="sc">&lt;</span> <span class="dv">2025</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(<span class="at">gdp =</span> <span class="fu">sum</span>(GDPC1), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">date =</span> <span class="fu">ymd</span>(<span class="fu">paste0</span>(year, <span class="st">"-10-01"</span>)),</span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">gdpgrowth =</span> <span class="dv">100</span> <span class="sc">*</span> (gdp <span class="sc">-</span> <span class="fu">lag</span>(gdp)) <span class="sc">/</span> <span class="fu">lag</span>(gdp)</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>UM data has a different format (it is already in percentage base 100 and lagged 1 year):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>michigan_mm <span class="ot">&lt;-</span> michigan <span class="sc">%&gt;%</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(realtime_period <span class="sc">==</span> <span class="fu">max</span>(realtime_period)) <span class="sc">%&gt;%</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(date), <span class="at">month =</span> <span class="fu">month</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(month <span class="sc">==</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">date =</span> date <span class="sc">+</span> <span class="fu">years</span>(<span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">inflation =</span> MICH)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Merge all into one data frame for plotting:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>inflation <span class="ot">&lt;-</span> <span class="fu">map2_df</span>(</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>        cpiaucsl_mm,</span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>        cpilfesl_mm,</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>        cpiengsl_mm,</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>        cpifood_mm,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>        gdpdef_mm,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>        michigan_mm</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"CPIAUCSL"</span>, <span class="st">"CPILFESL"</span>, <span class="st">"CPIENGSL"</span>, <span class="st">"CPIUFDSL"</span>, <span class="st">"GDPDEF"</span>, <span class="st">"MICH"</span>),</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x, y) {</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>        x <span class="sc">%&gt;%</span></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>            <span class="fu">select</span>(date, <span class="at">value =</span> inflation) <span class="sc">%&gt;%</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(<span class="at">series =</span> y)</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Plot of the different inflation measures:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(inflation, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value, <span class="at">color =</span> series)) <span class="sc">+</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Inflation Measures"</span>,</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Year"</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Inflation rate (%)"</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Series"</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_tintin_d</span>() <span class="sc">+</span></span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>series, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>) <span class="sc">+</span></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/plots2-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(gdpc1_yy, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> gdpgrowth)) <span class="sc">+</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Real GDP Change"</span>,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Year"</span>,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Growth rate (%)"</span>,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Series"</span></span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>) <span class="sc">+</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/plots2-2.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>The plots show some level of similarity between all series except for CPIENGSL (energy prices) which is more volatile. The series without food and energy (CPILFESL) is more stable and is similar to the GDP deflator (GDPDEF) while the other series have more volatility. The Michigan survey (MICH) shows a proper forward-looking measure of inflation expectations.</p>
<p>Because energy depends on external factors (e.g., geopolitical events that affect oil prices) and food prices are affected by seasonal patterns, we will use the CPILFESL and GDP deflator as our main inflation measure.</p>
<p>GDP is also affected by external factors (e.g., the <span class="math inline">\(X - M\)</span> component of GDP) but we do not have another measure of GDP growth.</p>
</section>
<section id="estimate-a-var-model" class="level1">
<h1>Estimate a VAR model</h1>
<p>The goal is to choose the lag length based on information criteria.</p>
<p>The first step is to determine the lag length using information criteria.</p>
<p>For CPILFESL and adapting from <a href="https://www.econometrics-with-r.org/14.6-llsuic.html">Econometrics with R</a>, which uses BIC, we will use the AIC criterion.</p>
<p><span class="math display">\[
\text{AIC}(p) = \log \left( \frac{\text{SSR}(p)}{T} \right) + (p+1)\frac{2}{T}.
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compute AIC for AR model objects of class 'dynlm'</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>AIC <span class="ot">&lt;-</span> <span class="cf">function</span>(model) {</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>    ssr <span class="ot">&lt;-</span> <span class="fu">sum</span>(model<span class="sc">$</span>residuals<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    t <span class="ot">&lt;-</span> <span class="fu">length</span>(model<span class="sc">$</span>residuals)</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    npar <span class="ot">&lt;-</span> <span class="fu">length</span>(model<span class="sc">$</span>coef)</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">round</span>(<span class="fu">c</span>(<span class="st">"AIC"</span> <span class="ot">=</span> <span class="fu">log</span>(ssr <span class="sc">/</span> t) <span class="sc">+</span> npar <span class="sc">*</span> <span class="dv">2</span> <span class="sc">/</span> t), <span class="dv">4</span>)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a><span class="co"># intercept only AR model</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(<span class="fu">dynlm</span>(<span class="fu">ts</span>(cpilfesl_mm<span class="sc">$</span>inflation) <span class="sc">~</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   AIC 
1.8429 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(<span class="fu">dynlm</span>(<span class="fu">ts</span>(gdpc1_yy<span class="sc">$</span>gdpgrowth) <span class="sc">~</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   AIC 
1.6976 </code></pre>
</div>
</div>
<p>Looping over different model orders:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># loop AIC over models of different orders</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>order <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>inflation_AICs <span class="ot">&lt;-</span> <span class="fu">vapply</span>(</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>    order,</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) {</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">AIC</span>(<span class="fu">dynlm</span>(</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a>            <span class="fu">ts</span>(cpilfesl_mm<span class="sc">$</span>inflation) <span class="sc">~</span> <span class="fu">L</span>(<span class="fu">ts</span>(cpilfesl_mm<span class="sc">$</span>inflation), <span class="dv">1</span><span class="sc">:</span>x)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a>        ))</span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb18-11"><a href="#cb18-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">FUN.VALUE =</span> <span class="fu">numeric</span>(<span class="dv">1</span>)</span>
<span id="cb18-12"><a href="#cb18-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-13"><a href="#cb18-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-14"><a href="#cb18-14" aria-hidden="true" tabindex="-1"></a>gdpdef_AICs <span class="ot">&lt;-</span> <span class="fu">vapply</span>(</span>
<span id="cb18-15"><a href="#cb18-15" aria-hidden="true" tabindex="-1"></a>    order,</span>
<span id="cb18-16"><a href="#cb18-16" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) {</span>
<span id="cb18-17"><a href="#cb18-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">AIC</span>(<span class="fu">dynlm</span>(<span class="fu">ts</span>(gdpdef_mm<span class="sc">$</span>inflation) <span class="sc">~</span> <span class="fu">L</span>(<span class="fu">ts</span>(gdpdef_mm<span class="sc">$</span>inflation), <span class="dv">1</span><span class="sc">:</span>x)))</span>
<span id="cb18-18"><a href="#cb18-18" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb18-19"><a href="#cb18-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">FUN.VALUE =</span> <span class="fu">numeric</span>(<span class="dv">1</span>)</span>
<span id="cb18-20"><a href="#cb18-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-21"><a href="#cb18-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-22"><a href="#cb18-22" aria-hidden="true" tabindex="-1"></a>gdpgrowth_AICs <span class="ot">&lt;-</span> <span class="fu">vapply</span>(</span>
<span id="cb18-23"><a href="#cb18-23" aria-hidden="true" tabindex="-1"></a>    order,</span>
<span id="cb18-24"><a href="#cb18-24" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) {</span>
<span id="cb18-25"><a href="#cb18-25" aria-hidden="true" tabindex="-1"></a>        <span class="fu">AIC</span>(<span class="fu">dynlm</span>(<span class="fu">ts</span>(gdpc1_yy<span class="sc">$</span>gdpgrowth) <span class="sc">~</span> <span class="fu">L</span>(<span class="fu">ts</span>(gdpc1_yy<span class="sc">$</span>gdpgrowth), <span class="dv">1</span><span class="sc">:</span>x)))</span>
<span id="cb18-26"><a href="#cb18-26" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb18-27"><a href="#cb18-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">FUN.VALUE =</span> <span class="fu">numeric</span>(<span class="dv">1</span>)</span>
<span id="cb18-28"><a href="#cb18-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb18-29"><a href="#cb18-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-30"><a href="#cb18-30" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(inflation_AICs, <span class="st">"data/aics_cpilfesl.rds"</span>)</span>
<span id="cb18-31"><a href="#cb18-31" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(gdpdef_AICs, <span class="st">"data/aics_gdpdef.rds"</span>)</span>
<span id="cb18-32"><a href="#cb18-32" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(gdpgrowth_AICs, <span class="st">"data/aics_gdpgrowth.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>run_models) {</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    inflation_AICs <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/aics_cpilfesl.rds"</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    gdpdef_AICs <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/aics_gdpdef.rds"</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>    gdpgrowth_AICs <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/aics_gdpgrowth.rds"</span>)</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a><span class="fu">which.min</span>(inflation_AICs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a><span class="fu">which.min</span>(gdpdef_AICs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6</code></pre>
</div>
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a><span class="fu">which.min</span>(gdpgrowth_AICs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4</code></pre>
</div>
</div>
<p>Based on the AIC criterion, we select a lag length of:</p>
<ul>
<li>4 for CPILFESL</li>
<li>6 for GDPDEF</li>
<li>4 for GDP growth</li>
</ul>
<p>Now we can estimate the VAR model using <code>var_model()</code> from the <code>ecod025ps1</code> package:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a><span class="co"># remove the last value as it is NA after the the lagged difference</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="dv">12</span>L</span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>l1 <span class="ot">&lt;-</span> <span class="dv">4</span>L</span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>l2 <span class="ot">&lt;-</span> <span class="dv">6</span>L</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a>l3 <span class="ot">&lt;-</span> <span class="dv">4</span>L</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The interesting excercise is to evaluate the forecasts from the VAR model by subsetting the data “T” years before the end date and compare the predictions with the actual values. One problem in this time horizon is that we have the COVID-19 pandemic (2020) external shock.</p>
<p>In other words, we will consider both in and out of sample model metrics. Because of the GDP data, we need to trim the series before 2025.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>common_years <span class="ot">&lt;-</span> cpilfesl_mm <span class="sc">%&gt;%</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(<span class="fu">select</span>(gdpdef_mm, date), <span class="at">by =</span> <span class="st">"date"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(<span class="fu">select</span>(gdpc1_yy, date), <span class="at">by =</span> <span class="st">"date"</span>)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a><span class="co"># subset data</span></span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>cpilfesl_mm_subset <span class="ot">&lt;-</span> cpilfesl_mm <span class="sc">%&gt;%</span></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(common_years, <span class="at">by =</span> <span class="st">"date"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(date <span class="sc">&lt;=</span> (<span class="fu">max</span>(date) <span class="sc">-</span> <span class="fu">years</span>(h)))</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>gdpdef_mm_subset <span class="ot">&lt;-</span> gdpdef_mm <span class="sc">%&gt;%</span></span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(common_years, <span class="at">by =</span> <span class="st">"date"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(date <span class="sc">&lt;=</span> (<span class="fu">max</span>(date) <span class="sc">-</span> <span class="fu">years</span>(h)))</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>gdpc1_yy_subset <span class="ot">&lt;-</span> gdpc1_yy <span class="sc">%&gt;%</span></span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(common_years, <span class="at">by =</span> <span class="st">"date"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(date <span class="sc">&lt;=</span> (<span class="fu">max</span>(date) <span class="sc">-</span> <span class="fu">years</span>(h)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a>fit_cpilfesl_subset <span class="ot">&lt;-</span> <span class="fu">var_model</span>(</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>(<span class="fu">as.matrix</span>(cpilfesl_mm_subset<span class="sc">$</span>inflation)),</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span> l1,</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">include_const =</span> <span class="cn">TRUE</span>,</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">forecast_h =</span> h</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>fit_gdpdef_subset <span class="ot">&lt;-</span> <span class="fu">var_model</span>(</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>(<span class="fu">as.matrix</span>(gdpdef_mm_subset<span class="sc">$</span>inflation)),</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span> l2,</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">include_const =</span> <span class="cn">TRUE</span>,</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">forecast_h =</span> h</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>fit_gdpgrowth_subset <span class="ot">&lt;-</span> <span class="fu">var_model</span>(</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>(<span class="fu">as.matrix</span>(gdpc1_yy_subset<span class="sc">$</span>gdpgrowth)),</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span> l3,</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">include_const =</span> <span class="cn">TRUE</span>,</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">forecast_h =</span> h</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fit_cpilfesl_subset, <span class="st">"data/fit_cpilfesl_subset.rds"</span>)</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fit_gdpdef_subset, <span class="st">"data/fit_gdpdef_subset.rds"</span>)</span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fit_gdpgrowth_subset, <span class="st">"data/fit_gdpgrowth_subset.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>run_models) {</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    fit_cpilfesl_subset <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/fit_cpilfesl_subset.rds"</span>)</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    fit_gdpdef_subset <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/fit_gdpdef_subset.rds"</span>)</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>    fit_gdpgrowth_subset <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/fit_gdpgrowth_subset.rds"</span>)</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>fit_predictions2 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">max</span>(cpilfesl_mm_subset<span class="sc">$</span>date) <span class="sc">+</span></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">years</span>(<span class="fu">seq_len</span>(fit_cpilfesl_subset<span class="sc">$</span>forecast_h)),</span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">prediction =</span> <span class="fu">as.numeric</span>(fit_cpilfesl_subset<span class="sc">$</span>forecasts),</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">series =</span> <span class="st">"CPILFESL"</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tibble</span>(</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">date =</span> <span class="fu">max</span>(gdpdef_mm_subset<span class="sc">$</span>date) <span class="sc">+</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>                <span class="fu">years</span>(<span class="fu">seq_len</span>(fit_gdpdef_subset<span class="sc">$</span>forecast_h)),</span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">prediction =</span> <span class="fu">as.numeric</span>(fit_gdpdef_subset<span class="sc">$</span>forecasts),</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>            <span class="at">series =</span> <span class="st">"GDPDEF"</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tibble</span>(</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>            <span class="at">date =</span> <span class="fu">max</span>(gdpc1_yy_subset<span class="sc">$</span>date) <span class="sc">+</span></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>                <span class="fu">years</span>(<span class="fu">seq_len</span>(fit_gdpgrowth_subset<span class="sc">$</span>forecast_h)),</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>            <span class="at">prediction =</span> <span class="fu">as.numeric</span>(fit_gdpgrowth_subset<span class="sc">$</span>forecasts),</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>            <span class="at">series =</span> <span class="st">"GDPGROWTH"</span></span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>fit_predictions2 <span class="ot">&lt;-</span> fit_predictions2 <span class="sc">%&gt;%</span></span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>        inflation <span class="sc">%&gt;%</span></span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(series <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"CPILFESL"</span>, <span class="st">"GDPDEF"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(<span class="fu">year</span>(date) <span class="sc">&gt;</span> <span class="fu">max</span>(<span class="fu">year</span>(date) <span class="sc">-</span> h)) <span class="sc">%&gt;%</span></span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>            <span class="fu">rename</span>(<span class="at">observed =</span> value) <span class="sc">%&gt;%</span></span>
<span id="cb28-36"><a href="#cb28-36" aria-hidden="true" tabindex="-1"></a>            <span class="fu">bind_rows</span>(</span>
<span id="cb28-37"><a href="#cb28-37" aria-hidden="true" tabindex="-1"></a>                gdpc1_yy <span class="sc">%&gt;%</span></span>
<span id="cb28-38"><a href="#cb28-38" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">filter</span>(<span class="fu">year</span>(date) <span class="sc">&gt;</span> <span class="fu">max</span>(<span class="fu">year</span>(date) <span class="sc">-</span> h)) <span class="sc">%&gt;%</span></span>
<span id="cb28-39"><a href="#cb28-39" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">select</span>(date, <span class="at">observed =</span> gdpgrowth) <span class="sc">%&gt;%</span></span>
<span id="cb28-40"><a href="#cb28-40" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">mutate</span>(<span class="at">series =</span> <span class="st">"GDPGROWTH"</span>)</span>
<span id="cb28-41"><a href="#cb28-41" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb28-42"><a href="#cb28-42" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"series"</span>)</span>
<span id="cb28-43"><a href="#cb28-43" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-44"><a href="#cb28-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-45"><a href="#cb28-45" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fit_predictions2) <span class="sc">+</span></span>
<span id="cb28-46"><a href="#cb28-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> observed, <span class="at">color =</span> series), <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb28-47"><a href="#cb28-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> observed, <span class="at">color =</span> series), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb28-48"><a href="#cb28-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-49"><a href="#cb28-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(</span>
<span id="cb28-50"><a href="#cb28-50" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> prediction, <span class="at">color =</span> series),</span>
<span id="cb28-51"><a href="#cb28-51" aria-hidden="true" tabindex="-1"></a>        <span class="at">linewidth =</span> <span class="dv">1</span>,</span>
<span id="cb28-52"><a href="#cb28-52" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"gray70"</span></span>
<span id="cb28-53"><a href="#cb28-53" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb28-54"><a href="#cb28-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(</span>
<span id="cb28-55"><a href="#cb28-55" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> fit_predictions2,</span>
<span id="cb28-56"><a href="#cb28-56" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> prediction, <span class="at">color =</span> series),</span>
<span id="cb28-57"><a href="#cb28-57" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="dv">2</span>,</span>
<span id="cb28-58"><a href="#cb28-58" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"gray70"</span></span>
<span id="cb28-59"><a href="#cb28-59" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb28-60"><a href="#cb28-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-61"><a href="#cb28-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_segment</span>(</span>
<span id="cb28-62"><a href="#cb28-62" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> fit_predictions2,</span>
<span id="cb28-63"><a href="#cb28-63" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">xend =</span> date, <span class="at">y =</span> observed, <span class="at">yend =</span> prediction),</span>
<span id="cb28-64"><a href="#cb28-64" aria-hidden="true" tabindex="-1"></a>        <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb28-65"><a href="#cb28-65" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"gray50"</span></span>
<span id="cb28-66"><a href="#cb28-66" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb28-67"><a href="#cb28-67" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-68"><a href="#cb28-68" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb28-69"><a href="#cb28-69" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Observed Past Magnitudes vs VAR Predictions"</span>,</span>
<span id="cb28-70"><a href="#cb28-70" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"Predictions in gray"</span>,</span>
<span id="cb28-71"><a href="#cb28-71" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb28-72"><a href="#cb28-72" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Change Rate (%)"</span>,</span>
<span id="cb28-73"><a href="#cb28-73" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Series"</span></span>
<span id="cb28-74"><a href="#cb28-74" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb28-75"><a href="#cb28-75" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_tintin_d</span>() <span class="sc">+</span></span>
<span id="cb28-76"><a href="#cb28-76" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>series, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb28-77"><a href="#cb28-77" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb28-78"><a href="#cb28-78" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>) <span class="sc">+</span></span>
<span id="cb28-79"><a href="#cb28-79" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/var5c-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>For the out-of-sample RMSFE and MAE metrics we need an R-side RMSFE and MAE functions as their C++ counterparts are not exported):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a>RMSFE <span class="ot">&lt;-</span> <span class="cf">function</span>(actual, predicted) {</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">mean</span>((actual <span class="sc">-</span> predicted)<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>MAE <span class="ot">&lt;-</span> <span class="cf">function</span>(actual, predicted) {</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="fu">abs</span>(actual <span class="sc">-</span> predicted), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>fit_predictions2 <span class="sc">%&gt;%</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(series <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"CPILFESL"</span>, <span class="st">"GDPDEF"</span>, <span class="st">"GDPGROWTH"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(series) <span class="sc">%&gt;%</span></span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">RMSFE_out_of_sample =</span> <span class="fu">RMSFE</span>(observed, prediction),</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">MAE_out_of_sample =</span> <span class="fu">MAE</span>(observed, prediction)</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">RMSFE_in_sample =</span> <span class="fu">c</span>(</span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>            fit_gdpgrowth_subset<span class="sc">$</span>rmsfe,</span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>            fit_gdpdef_subset<span class="sc">$</span>rmsfe,</span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>            fit_gdpgrowth_subset<span class="sc">$</span>rmsfe</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">MAE_in_sample =</span> <span class="fu">c</span>(</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>            fit_gdpgrowth_subset<span class="sc">$</span>mae,</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a>            fit_gdpdef_subset<span class="sc">$</span>mae,</span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a>            fit_gdpgrowth_subset<span class="sc">$</span>mae</span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(</span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>        series,</span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>        RMSFE_in_sample,</span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>        RMSFE_out_of_sample,</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>        MAE_in_sample,</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>        MAE_out_of_sample</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 5
  series    RMSFE_in_sample RMSFE_out_of_sample MAE_in_sample MAE_out_of_sample
  &lt;chr&gt;               &lt;dbl&gt;               &lt;dbl&gt;         &lt;dbl&gt;             &lt;dbl&gt;
1 CPILFESL            1.97                 1.19         1.57              0.803
2 GDPDEF              0.975                1.57         0.660             1.27 
3 GDPGROWTH           1.97                 1.94         1.57              1.34 </code></pre>
</div>
</div>
</section>
<section id="estimate-a-fa-var-model" class="level1">
<h1>Estimate a FA-VAR model</h1>
<p>The FA-VAR model follows a pure time series approach: it creates an information set <span class="math inline">\(X_t\)</span> from the target variable and its lags, extracts latent factors via PCA, and augments a VAR with these factors.</p>
<p>Model specification: - <span class="math inline">\(X_t = [y_t, y_{t-1}, \ldots, y_{t-L}]\)</span> (information set created from y and its lags) - Extract <span class="math inline">\(r\)</span> factors from <span class="math inline">\(X_t\)</span> using PCA - Estimate: <span class="math inline">\(y_t = B(L) y_{t-1} + C(L) F_t + u_t\)</span> (augmented VAR with factor lags)</p>
<p>This approach captures nonlinear patterns in the autocorrelation structure through factor extraction.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="co"># FA-VAR parameters (simplified to avoid overfitting)</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>n_lags <span class="ot">&lt;-</span> <span class="dv">3</span>L <span class="co"># Number of lags to create information set X (creates 4 variables)</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>n_factors <span class="ot">&lt;-</span> <span class="dv">2</span>L <span class="co"># Number of factors to extract from X</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>p_f <span class="ot">&lt;-</span> <span class="dv">2</span>L <span class="co"># Factor lags</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(<span class="fu">as.matrix</span>(cpilfesl_mm_subset<span class="sc">$</span>inflation))</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate FA-VAR models</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>fit_cpilfesl_favar <span class="ot">&lt;-</span> <span class="fu">favar_model</span>(</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> y,</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_lags =</span> n_lags,</span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_factors =</span> n_factors,</span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_y =</span> l1,</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_f =</span> p_f,</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">include_const =</span> <span class="cn">TRUE</span>,</span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">forecast_h =</span> h</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-error">
<pre><code>Error: 
warning: </code></pre>
</div>
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Tuned parameters for GDPDEF</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>n_lags <span class="ot">&lt;-</span> <span class="dv">3</span>L</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>n_factors <span class="ot">&lt;-</span> <span class="dv">2</span>L</span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>p_f <span class="ot">&lt;-</span> <span class="dv">1</span>L</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(<span class="fu">as.matrix</span>(gdpdef_mm_subset<span class="sc">$</span>inflation))</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>fit_gdpdef_favar <span class="ot">&lt;-</span> <span class="fu">favar_model</span>(</span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> y,</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_lags =</span> n_lags,</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_factors =</span> n_factors,</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_y =</span> l2,</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_f =</span> p_f,</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">include_const =</span> <span class="cn">TRUE</span>,</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">forecast_h =</span> h</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Tuned parameters for GDP growth</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>n_lags <span class="ot">&lt;-</span> <span class="dv">3</span>L</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>n_factors <span class="ot">&lt;-</span> <span class="dv">2</span>L</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>p_f <span class="ot">&lt;-</span> <span class="dv">1</span>L</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(<span class="fu">as.matrix</span>(gdpc1_yy_subset<span class="sc">$</span>gdpgrowth))</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>fit_gdpc1_favar <span class="ot">&lt;-</span> <span class="fu">favar_model</span>(</span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> y,</span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_lags =</span> n_lags,</span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_factors =</span> n_factors,</span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_y =</span> l3,</span>
<span id="cb33-30"><a href="#cb33-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">p_f =</span> p_f,</span>
<span id="cb33-31"><a href="#cb33-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">include_const =</span> <span class="cn">TRUE</span>,</span>
<span id="cb33-32"><a href="#cb33-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">forecast_h =</span> h</span>
<span id="cb33-33"><a href="#cb33-33" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb33-34"><a href="#cb33-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-35"><a href="#cb33-35" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fit_cpilfesl_favar, <span class="st">"data/fit_cpilfesl_favar.rds"</span>)</span>
<span id="cb33-36"><a href="#cb33-36" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fit_gdpdef_favar, <span class="st">"data/fit_gdpdef_favar.rds"</span>)</span>
<span id="cb33-37"><a href="#cb33-37" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fit_gdpc1_favar, <span class="st">"data/fit_gdpc1_favar.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>run_models) {</span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>    fit_cpilfesl_favar <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/fit_cpilfesl_favar.rds"</span>)</span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>    fit_gdpdef_favar <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/fit_gdpdef_favar.rds"</span>)</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    fit_gdpc1_favar <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/fit_gdpc1_yy_favar.rds"</span>)</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>fit_predictions3 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">max</span>(cpilfesl_mm_subset<span class="sc">$</span>date) <span class="sc">+</span></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">years</span>(<span class="fu">seq_len</span>(fit_cpilfesl_favar<span class="sc">$</span>forecast_horizon)),</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">prediction =</span> <span class="fu">as.numeric</span>(fit_cpilfesl_favar<span class="sc">$</span>forecasts),</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">series =</span> <span class="st">"CPILFESL"</span></span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tibble</span>(</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">date =</span> <span class="fu">max</span>(gdpdef_mm_subset<span class="sc">$</span>date) <span class="sc">+</span></span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>                <span class="fu">years</span>(<span class="fu">seq_len</span>(fit_gdpdef_favar<span class="sc">$</span>forecast_horizon)),</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">prediction =</span> <span class="fu">as.numeric</span>(fit_gdpdef_favar<span class="sc">$</span>forecasts),</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>            <span class="at">series =</span> <span class="st">"GDPDEF"</span></span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tibble</span>(</span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>            <span class="at">date =</span> <span class="fu">max</span>(gdpc1_yy_subset<span class="sc">$</span>date) <span class="sc">+</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>                <span class="fu">years</span>(<span class="fu">seq_len</span>(fit_gdpc1_favar<span class="sc">$</span>forecast_horizon)),</span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>            <span class="at">prediction =</span> <span class="fu">as.numeric</span>(fit_gdpc1_favar<span class="sc">$</span>forecasts),</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>            <span class="at">series =</span> <span class="st">"GDPGROWTH"</span></span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a>fit_predictions3 <span class="ot">&lt;-</span> fit_predictions3 <span class="sc">%&gt;%</span></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a>        inflation <span class="sc">%&gt;%</span></span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(series <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"CPILFESL"</span>, <span class="st">"GDPDEF"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(<span class="fu">year</span>(date) <span class="sc">&gt;</span> <span class="fu">max</span>(<span class="fu">year</span>(date) <span class="sc">-</span> h)) <span class="sc">%&gt;%</span></span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>            <span class="fu">select</span>(date, <span class="at">observed =</span> value, series) <span class="sc">%&gt;%</span></span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>            <span class="fu">bind_rows</span>(</span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>                gdpc1_yy <span class="sc">%&gt;%</span></span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">filter</span>(<span class="fu">year</span>(date) <span class="sc">&gt;</span> <span class="fu">max</span>(<span class="fu">year</span>(date) <span class="sc">-</span> h)) <span class="sc">%&gt;%</span></span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">select</span>(date, <span class="at">observed =</span> gdpgrowth) <span class="sc">%&gt;%</span></span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">mutate</span>(<span class="at">series =</span> <span class="st">"GDPGROWTH"</span>)</span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"series"</span>)</span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a>fit_predictions3 <span class="sc">%&gt;%</span></span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(series <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"CPILFESL"</span>, <span class="st">"GDPDEF"</span>, <span class="st">"GDPGROWTH"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(series) <span class="sc">%&gt;%</span></span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a>        <span class="at">RMSFE_out_of_sample =</span> <span class="fu">RMSFE</span>(observed, prediction),</span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a>        <span class="at">MAE_out_of_sample =</span> <span class="fu">MAE</span>(observed, prediction)</span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a>        <span class="at">RMSFE_in_sample =</span> <span class="fu">c</span>(</span>
<span id="cb34-55"><a href="#cb34-55" aria-hidden="true" tabindex="-1"></a>            fit_cpilfesl_favar<span class="sc">$</span>rmsfe,</span>
<span id="cb34-56"><a href="#cb34-56" aria-hidden="true" tabindex="-1"></a>            fit_gdpdef_favar<span class="sc">$</span>rmsfe,</span>
<span id="cb34-57"><a href="#cb34-57" aria-hidden="true" tabindex="-1"></a>            fit_gdpc1_favar<span class="sc">$</span>rmsfe</span>
<span id="cb34-58"><a href="#cb34-58" aria-hidden="true" tabindex="-1"></a>        ),</span>
<span id="cb34-59"><a href="#cb34-59" aria-hidden="true" tabindex="-1"></a>        <span class="at">MAE_in_sample =</span> <span class="fu">c</span>(</span>
<span id="cb34-60"><a href="#cb34-60" aria-hidden="true" tabindex="-1"></a>            fit_cpilfesl_favar<span class="sc">$</span>mae,</span>
<span id="cb34-61"><a href="#cb34-61" aria-hidden="true" tabindex="-1"></a>            fit_gdpdef_favar<span class="sc">$</span>mae,</span>
<span id="cb34-62"><a href="#cb34-62" aria-hidden="true" tabindex="-1"></a>            fit_gdpc1_favar<span class="sc">$</span>mae</span>
<span id="cb34-63"><a href="#cb34-63" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb34-64"><a href="#cb34-64" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb34-65"><a href="#cb34-65" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(</span>
<span id="cb34-66"><a href="#cb34-66" aria-hidden="true" tabindex="-1"></a>        series,</span>
<span id="cb34-67"><a href="#cb34-67" aria-hidden="true" tabindex="-1"></a>        RMSFE_in_sample,</span>
<span id="cb34-68"><a href="#cb34-68" aria-hidden="true" tabindex="-1"></a>        RMSFE_out_of_sample,</span>
<span id="cb34-69"><a href="#cb34-69" aria-hidden="true" tabindex="-1"></a>        MAE_in_sample,</span>
<span id="cb34-70"><a href="#cb34-70" aria-hidden="true" tabindex="-1"></a>        MAE_out_of_sample</span>
<span id="cb34-71"><a href="#cb34-71" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 5
  series    RMSFE_in_sample RMSFE_out_of_sample MAE_in_sample MAE_out_of_sample
  &lt;chr&gt;               &lt;dbl&gt;               &lt;dbl&gt;         &lt;dbl&gt;             &lt;dbl&gt;
1 CPILFESL            1.47                 1.16         0.883             0.804
2 GDPDEF              0.997                1.75         0.686             1.33 
3 GDPGROWTH           2.00                 2.23         1.60              1.86 </code></pre>
</div>
</div>
<p>Plot the FA-VAR forecasts on the censored data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fit_predictions3) <span class="sc">+</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> observed, <span class="at">color =</span> series), <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> observed, <span class="at">color =</span> series), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb36-4"><a href="#cb36-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-5"><a href="#cb36-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(</span>
<span id="cb36-6"><a href="#cb36-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> prediction, <span class="at">color =</span> series),</span>
<span id="cb36-7"><a href="#cb36-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">linewidth =</span> <span class="dv">1</span>,</span>
<span id="cb36-8"><a href="#cb36-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"gray70"</span></span>
<span id="cb36-9"><a href="#cb36-9" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb36-10"><a href="#cb36-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(</span>
<span id="cb36-11"><a href="#cb36-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> prediction, <span class="at">color =</span> series),</span>
<span id="cb36-12"><a href="#cb36-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="dv">2</span>,</span>
<span id="cb36-13"><a href="#cb36-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"gray70"</span></span>
<span id="cb36-14"><a href="#cb36-14" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb36-15"><a href="#cb36-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-16"><a href="#cb36-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_segment</span>(</span>
<span id="cb36-17"><a href="#cb36-17" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">xend =</span> date, <span class="at">y =</span> observed, <span class="at">yend =</span> prediction),</span>
<span id="cb36-18"><a href="#cb36-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb36-19"><a href="#cb36-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"gray50"</span></span>
<span id="cb36-20"><a href="#cb36-20" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb36-21"><a href="#cb36-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb36-22"><a href="#cb36-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb36-23"><a href="#cb36-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Observed Past Magnitudes vs FA-VAR Predictions"</span>,</span>
<span id="cb36-24"><a href="#cb36-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"Predictions in gray"</span>,</span>
<span id="cb36-25"><a href="#cb36-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb36-26"><a href="#cb36-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Change Rate (%)"</span>,</span>
<span id="cb36-27"><a href="#cb36-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Series"</span></span>
<span id="cb36-28"><a href="#cb36-28" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb36-29"><a href="#cb36-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_tintin_d</span>() <span class="sc">+</span></span>
<span id="cb36-30"><a href="#cb36-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>series, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb36-31"><a href="#cb36-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb36-32"><a href="#cb36-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/favar3-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="estimate-a-dfm-model" class="level1">
<h1>Estimate a DFM model</h1>
<p>The DFM uses a state-space representation with PCA initialization and Kalman filter for parameter estimation.</p>
<p>DFM is designed for multivariate data where we want to extract common factors across different economic variables. Unlike FA-VAR (which uses autoregressive lags), DFM works best with actual multivariate series that share common dynamics.</p>
<p>We’ll use two inflation measures <span class="math inline">\([CPILFESL/GDPDEF, CPIFOOD]\)</span> to extract common factors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>dfm_data_cpilfesl <span class="ot">&lt;-</span> cpilfesl_mm_subset <span class="sc">%&gt;%</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(date, <span class="at">cpilfesl =</span> inflation) <span class="sc">%&gt;%</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>        cpifood_mm <span class="sc">%&gt;%</span> <span class="fu">select</span>(date, <span class="at">cpifood =</span> inflation),</span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"date"</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>x_cpilfesl_dfm <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(dfm_data_cpilfesl[, <span class="fu">c</span>(<span class="st">"cpilfesl"</span>, <span class="st">"cpifood"</span>)])</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate DFM (1 common inflation factor from 2 variables)</span></span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>fit_cpilfesl_dfm <span class="ot">&lt;-</span> <span class="fu">dfm_model</span>(</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> x_cpilfesl_dfm,</span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_factors =</span> <span class="dv">1</span>L,</span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span> <span class="dv">1</span>L,</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_iter =</span> <span class="dv">50</span>L,</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">tol =</span> <span class="fl">1e-6</span>,</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">forecast_h =</span> h</span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>dfm_data_gdpdef <span class="ot">&lt;-</span> gdpdef_mm_subset <span class="sc">%&gt;%</span></span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(date, <span class="at">gdpdef =</span> inflation) <span class="sc">%&gt;%</span></span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>        cpifood_mm <span class="sc">%&gt;%</span> <span class="fu">select</span>(date, <span class="at">cpifood =</span> inflation),</span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"date"</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>x_gdpdef_dfm <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(dfm_data_gdpdef[, <span class="fu">c</span>(<span class="st">"gdpdef"</span>, <span class="st">"cpifood"</span>)])</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>fit_gdpdef_dfm <span class="ot">&lt;-</span> <span class="fu">dfm_model</span>(</span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> x_gdpdef_dfm,</span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_factors =</span> <span class="dv">1</span>L,</span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span> <span class="dv">1</span>L,</span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_iter =</span> <span class="dv">50</span>L,</span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">tol =</span> <span class="fl">1e-6</span>,</span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">forecast_h =</span> h</span>
<span id="cb37-38"><a href="#cb37-38" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-39"><a href="#cb37-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-40"><a href="#cb37-40" aria-hidden="true" tabindex="-1"></a>dfm_data_gdpc1 <span class="ot">&lt;-</span> gdpc1_yy_subset <span class="sc">%&gt;%</span></span>
<span id="cb37-41"><a href="#cb37-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(date, <span class="at">gdpgrowth =</span> gdpgrowth) <span class="sc">%&gt;%</span></span>
<span id="cb37-42"><a href="#cb37-42" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(</span>
<span id="cb37-43"><a href="#cb37-43" aria-hidden="true" tabindex="-1"></a>        cpifood_mm <span class="sc">%&gt;%</span> <span class="fu">select</span>(date, <span class="at">cpifood =</span> inflation),</span>
<span id="cb37-44"><a href="#cb37-44" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"date"</span></span>
<span id="cb37-45"><a href="#cb37-45" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb37-46"><a href="#cb37-46" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb37-47"><a href="#cb37-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-48"><a href="#cb37-48" aria-hidden="true" tabindex="-1"></a>x_gdpc1_dfm <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(dfm_data_gdpc1[, <span class="fu">c</span>(<span class="st">"gdpgrowth"</span>, <span class="st">"cpifood"</span>)])</span>
<span id="cb37-49"><a href="#cb37-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-50"><a href="#cb37-50" aria-hidden="true" tabindex="-1"></a>fit_gdpc1_dfm <span class="ot">&lt;-</span> <span class="fu">dfm_model</span>(</span>
<span id="cb37-51"><a href="#cb37-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> x_gdpc1_dfm,</span>
<span id="cb37-52"><a href="#cb37-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_factors =</span> <span class="dv">1</span>L,</span>
<span id="cb37-53"><a href="#cb37-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span> <span class="dv">2</span>L,</span>
<span id="cb37-54"><a href="#cb37-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">max_iter =</span> <span class="dv">50</span>L,</span>
<span id="cb37-55"><a href="#cb37-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">tol =</span> <span class="fl">1e-6</span>,</span>
<span id="cb37-56"><a href="#cb37-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">forecast_h =</span> h</span>
<span id="cb37-57"><a href="#cb37-57" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb37-58"><a href="#cb37-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb37-59"><a href="#cb37-59" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fit_cpilfesl_dfm, <span class="st">"data/fit_cpilfesl_dfm.rds"</span>)</span>
<span id="cb37-60"><a href="#cb37-60" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fit_gdpdef_dfm, <span class="st">"data/fit_gdpdef_dfm.rds"</span>)</span>
<span id="cb37-61"><a href="#cb37-61" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fit_gdpc1_dfm, <span class="st">"data/fit_gdpc1_dfm.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>run_models) {</span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>  fit_cpilfesl_dfm <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/fit_cpilfesl_dfm.rds"</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>  fit_gdpdef_dfm <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/fit_gdpdef_dfm.rds"</span>)</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  fit_gdpc1_dfm <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/fit_gdpc1_dfm.rds"</span>)</span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract forecasts for the FIRST variable only (our target)</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a><span class="co"># DFM forecasts all variables, but we only want the first one</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>fit_predictions4 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">max</span>(dfm_data_cpilfesl<span class="sc">$</span>date) <span class="sc">+</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">years</span>(<span class="fu">seq_len</span>(fit_cpilfesl_dfm<span class="sc">$</span>forecast_horizon)),</span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">prediction =</span> <span class="fu">as.numeric</span>(fit_cpilfesl_dfm<span class="sc">$</span>forecasts[, <span class="dv">1</span>]), <span class="co"># First column is CPILFESL</span></span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">series =</span> <span class="st">"CPILFESL"</span></span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tibble</span>(</span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">date =</span> <span class="fu">max</span>(dfm_data_gdpdef<span class="sc">$</span>date) <span class="sc">+</span></span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>                <span class="fu">years</span>(<span class="fu">seq_len</span>(fit_gdpdef_dfm<span class="sc">$</span>forecast_horizon)),</span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">prediction =</span> <span class="fu">as.numeric</span>(fit_gdpdef_dfm<span class="sc">$</span>forecasts[, <span class="dv">1</span>]), <span class="co"># First column is GDPDEF</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>            <span class="at">series =</span> <span class="st">"GDPDEF"</span></span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tibble</span>(</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>            <span class="at">date =</span> <span class="fu">max</span>(dfm_data_gdpc1<span class="sc">$</span>date) <span class="sc">+</span></span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>                <span class="fu">years</span>(<span class="fu">seq_len</span>(fit_gdpc1_dfm<span class="sc">$</span>forecast_horizon)),</span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>            <span class="at">prediction =</span> <span class="fu">as.numeric</span>(fit_gdpc1_dfm<span class="sc">$</span>forecasts[, <span class="dv">1</span>]), <span class="co"># First column is GDP growth</span></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>            <span class="at">series =</span> <span class="st">"GDPGROWTH"</span></span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>fit_predictions4 <span class="ot">&lt;-</span> fit_predictions4 <span class="sc">%&gt;%</span></span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(</span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>        inflation <span class="sc">%&gt;%</span></span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(series <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"CPILFESL"</span>, <span class="st">"GDPDEF"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>            <span class="fu">filter</span>(<span class="fu">year</span>(date) <span class="sc">&gt;</span> <span class="fu">max</span>(<span class="fu">year</span>(date) <span class="sc">-</span> h)) <span class="sc">%&gt;%</span></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>            <span class="fu">select</span>(date, <span class="at">observed =</span> value, series) <span class="sc">%&gt;%</span></span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>            <span class="fu">bind_rows</span>(</span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>                gdpc1_yy <span class="sc">%&gt;%</span></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">filter</span>(<span class="fu">year</span>(date) <span class="sc">&gt;</span> <span class="fu">max</span>(<span class="fu">year</span>(date) <span class="sc">-</span> h)) <span class="sc">%&gt;%</span></span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">select</span>(date, <span class="at">observed =</span> gdpgrowth) <span class="sc">%&gt;%</span></span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>                    <span class="fu">mutate</span>(<span class="at">series =</span> <span class="st">"GDPGROWTH"</span>)</span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>            ),</span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"series"</span>)</span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a>fit_predictions4 <span class="sc">%&gt;%</span></span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(series <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"CPILFESL"</span>, <span class="st">"GDPDEF"</span>, <span class="st">"GDPGROWTH"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(series) <span class="sc">%&gt;%</span></span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>        <span class="at">RMSFE_out_of_sample =</span> <span class="fu">RMSFE</span>(observed, prediction),</span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a>        <span class="at">MAE_out_of_sample =</span> <span class="fu">MAE</span>(observed, prediction)</span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>        <span class="at">RMSFE_in_sample =</span> <span class="fu">c</span>(fit_cpilfesl_dfm<span class="sc">$</span>rmsfe, fit_gdpdef_dfm<span class="sc">$</span>rmsfe, fit_gdpc1_dfm<span class="sc">$</span>rmsfe),</span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a>        <span class="at">MAE_in_sample =</span> <span class="fu">c</span>(fit_cpilfesl_dfm<span class="sc">$</span>mae, fit_gdpdef_dfm<span class="sc">$</span>mae, fit_gdpc1_dfm<span class="sc">$</span>mae)</span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(</span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a>        series,</span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a>        RMSFE_in_sample,</span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a>        RMSFE_out_of_sample,</span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a>        MAE_in_sample,</span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a>        MAE_out_of_sample</span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 5
  series    RMSFE_in_sample RMSFE_out_of_sample MAE_in_sample MAE_out_of_sample
  &lt;chr&gt;               &lt;dbl&gt;               &lt;dbl&gt;         &lt;dbl&gt;             &lt;dbl&gt;
1 CPILFESL             2.01                1.67          1.44              1.54
2 GDPDEF               1.46                1.96          1.09              1.83
3 GDPGROWTH            2.17                1.84          1.70              1.16</code></pre>
</div>
</div>
<p>Now we can plot the forecast on the censored data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fit_predictions4) <span class="sc">+</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> observed, <span class="at">color =</span> series),</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">linewidth =</span> <span class="fl">1.5</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> observed, <span class="at">color =</span> series),</span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(</span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> prediction, <span class="at">color =</span> series),</span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">linewidth =</span> <span class="dv">1</span>,</span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"gray70"</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> prediction, <span class="at">color =</span> series),</span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="dv">2</span>,</span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"gray70"</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_segment</span>(</span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">data =</span> fit_predictions4,</span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">xend =</span> date, <span class="at">y =</span> observed, <span class="at">yend =</span> prediction),</span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"gray50"</span></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Inflation Measures and Past DFM Predictions"</span>,</span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"Predictions in gray"</span>,</span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Inflation Rate (%)"</span>,</span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Series"</span></span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_tintin_d</span>() <span class="sc">+</span></span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>series, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>) <span class="sc">+</span></span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/dfm3-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="model-comparison" class="level1">
<h1>Model Comparison</h1>
</section>
<section id="c-codes" class="level1">
<h1>C++ codes</h1>
<section id="model-metrics" class="level2">
<h2 class="anchored" data-anchor-id="model-metrics">Model metrics</h2>
<div class="sourceCode" id="cb41"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Root Mean Squared Forecast Error (RMSFE) */</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> rmsfe<span class="op">(</span><span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> actual<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> forecast<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> errors <span class="op">=</span> actual <span class="op">-</span> forecast<span class="op">;</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> squared_errors <span class="op">=</span> square<span class="op">(</span>errors<span class="op">);</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> mse <span class="op">=</span> accu<span class="op">(</span>squared_errors<span class="op">)</span> <span class="op">/</span> squared_errors<span class="op">.</span>n_elem<span class="op">;</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> sqrt<span class="op">(</span>mse<span class="op">);</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a><span class="co">/* Mean Absolute Error (MAE) */</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> mae<span class="op">(</span><span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> actual<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> forecast<span class="op">)</span> <span class="op">{</span>  </span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> errors <span class="op">=</span> abs<span class="op">(</span>actual <span class="op">-</span> forecast<span class="op">);</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> accu<span class="op">(</span>errors<span class="op">)</span> <span class="op">/</span> errors<span class="op">.</span>n_elem<span class="op">;</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a><span class="co">/* Akaike Information Criterion (AIC) */</span></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> aic_metric<span class="op">(</span><span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> residuals<span class="op">,</span> <span class="dt">int</span> n_params<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> residuals<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Sum of squared residuals</span></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> ssr <span class="op">=</span> accu<span class="op">(</span>square<span class="op">(</span>residuals<span class="op">));</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a>  <span class="co">// AIC = log(SSR/T) + (p+1) * 2/T</span></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">// For multivariate models, use total SSR across all equations</span></span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> aic <span class="op">=</span> log<span class="op">(</span>ssr <span class="op">/</span> T<span class="op">)</span> <span class="op">+</span> n_params <span class="op">*</span> <span class="fl">2.0</span> <span class="op">/</span> T<span class="op">;</span></span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> aic<span class="op">;</span></span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="var" class="level2">
<h2 class="anchored" data-anchor-id="var">VAR</h2>
<div class="sourceCode" id="cb42"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Vector Autoregressions (VAR) */</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Create lagged matrix for VAR model</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> <span class="va">create_lags_</span><span class="op">(</span><span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> Y<span class="op">,</span> <span class="dt">int</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> Y<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> K <span class="op">=</span> Y<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Effective sample size after lagging</span></span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T_eff <span class="op">=</span> T <span class="op">-</span> p<span class="op">;</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create lagged matrix: [Y_{t-1}, Y_{t-2}, ..., Y_{t-p}]</span></span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X_lag<span class="op">(</span>T_eff<span class="op">,</span> K <span class="op">*</span> p<span class="op">);</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> lag <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> lag <span class="op">&lt;=</span> p<span class="op">;</span> <span class="op">++</span>lag<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> t <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> t <span class="op">&lt;</span> T_eff<span class="op">;</span> <span class="op">++</span>t<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>      X_lag<span class="op">.</span>submat<span class="op">(</span>t<span class="op">,</span> <span class="op">(</span>lag<span class="op">-</span><span class="dv">1</span><span class="op">)*</span>K<span class="op">,</span> t<span class="op">,</span> lag<span class="op">*</span>K<span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">=</span> Y<span class="op">.</span>row<span class="op">(</span>t <span class="op">+</span> p <span class="op">-</span> lag<span class="op">);</span></span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> X_lag<span class="op">;</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a><span class="co">// Estimate VAR model using equation-by-equation OLS</span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> <span class="va">var_estimate_</span><span class="op">(</span><span class="at">const</span> doubles_matrix<span class="op">&lt;&gt;&amp;</span> y<span class="op">,</span> <span class="dt">int</span> p<span class="op">,</span> <span class="dt">bool</span> include_const <span class="op">=</span> <span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Y <span class="op">=</span> as_Mat<span class="op">(</span>y<span class="op">);</span></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> Y<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>T <span class="op">&lt;=</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span><span class="st">"Sample size must be greater than lag order p"</span><span class="op">);</span></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create lagged regressors</span></span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Y_lag <span class="op">=</span> <span class="va">create_lags_</span><span class="op">(</span>Y<span class="op">,</span> p<span class="op">);</span></span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Dependent variable (after losing p observations)</span></span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Y_dep <span class="op">=</span> Y<span class="op">.</span>rows<span class="op">(</span>p<span class="op">,</span> T<span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add constant if requested</span></span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X<span class="op">;</span></span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>include_const<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> ones<span class="op">(</span>Y_lag<span class="op">.</span>n_rows<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> fill<span class="op">::</span>ones<span class="op">);</span></span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> join_horiz<span class="op">(</span>ones<span class="op">,</span> Y_lag<span class="op">);</span></span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> Y_lag<span class="op">;</span></span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Estimate VAR coefficients: A = (X'X)^(-1)(X'Y)</span></span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> XtX <span class="op">=</span> X<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> X<span class="op">;</span></span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> XtX_inv <span class="op">=</span> inv<span class="op">(</span>XtX<span class="op">);</span></span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> A <span class="op">=</span> XtX_inv <span class="op">*</span> X<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> Y_dep<span class="op">;</span></span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> A<span class="op">;</span></span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true" tabindex="-1"></a><span class="co">// Compute VAR residuals and fitted values</span></span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>pair<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;</span> <span class="va">var_fitted_resid_</span><span class="op">(</span><span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> Y<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> A<span class="op">,</span> </span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true" tabindex="-1"></a>                                                      <span class="dt">int</span> p<span class="op">,</span> <span class="dt">bool</span> include_const <span class="op">=</span> <span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-58"><a href="#cb42-58" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> Y<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb42-59"><a href="#cb42-59" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-60"><a href="#cb42-60" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create lagged regressors</span></span>
<span id="cb42-61"><a href="#cb42-61" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Y_lag <span class="op">=</span> <span class="va">create_lags_</span><span class="op">(</span>Y<span class="op">,</span> p<span class="op">);</span></span>
<span id="cb42-62"><a href="#cb42-62" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-63"><a href="#cb42-63" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Dependent variable (after losing p observations)</span></span>
<span id="cb42-64"><a href="#cb42-64" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Y_dep <span class="op">=</span> Y<span class="op">.</span>rows<span class="op">(</span>p<span class="op">,</span> T<span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb42-65"><a href="#cb42-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-66"><a href="#cb42-66" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add constant if requested</span></span>
<span id="cb42-67"><a href="#cb42-67" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X<span class="op">;</span></span>
<span id="cb42-68"><a href="#cb42-68" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>include_const<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-69"><a href="#cb42-69" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> ones<span class="op">(</span>Y_lag<span class="op">.</span>n_rows<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> fill<span class="op">::</span>ones<span class="op">);</span></span>
<span id="cb42-70"><a href="#cb42-70" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> join_horiz<span class="op">(</span>ones<span class="op">,</span> Y_lag<span class="op">);</span></span>
<span id="cb42-71"><a href="#cb42-71" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb42-72"><a href="#cb42-72" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> Y_lag<span class="op">;</span></span>
<span id="cb42-73"><a href="#cb42-73" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-74"><a href="#cb42-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-75"><a href="#cb42-75" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute fitted values and residuals</span></span>
<span id="cb42-76"><a href="#cb42-76" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Y_fitted <span class="op">=</span> X <span class="op">*</span> A<span class="op">;</span></span>
<span id="cb42-77"><a href="#cb42-77" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> residuals <span class="op">=</span> Y_dep <span class="op">-</span> Y_fitted<span class="op">;</span></span>
<span id="cb42-78"><a href="#cb42-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-79"><a href="#cb42-79" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">std::</span>make_pair<span class="op">(</span>Y_fitted<span class="op">,</span> residuals<span class="op">);</span></span>
<span id="cb42-80"><a href="#cb42-80" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb42-81"><a href="#cb42-81" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-82"><a href="#cb42-82" aria-hidden="true" tabindex="-1"></a><span class="co">// Create VAR companion matrix for analysis and forecasting</span></span>
<span id="cb42-83"><a href="#cb42-83" aria-hidden="true" tabindex="-1"></a>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> <span class="va">var_companion_</span><span class="op">(</span><span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> A<span class="op">,</span> <span class="dt">int</span> p<span class="op">,</span> <span class="dt">int</span> K<span class="op">,</span> <span class="dt">bool</span> include_const <span class="op">=</span> <span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-84"><a href="#cb42-84" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Extract coefficient matrices (exclude constant if present)</span></span>
<span id="cb42-85"><a href="#cb42-85" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> A_coeff<span class="op">;</span></span>
<span id="cb42-86"><a href="#cb42-86" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>include_const<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-87"><a href="#cb42-87" aria-hidden="true" tabindex="-1"></a>    A_coeff <span class="op">=</span> A<span class="op">.</span>rows<span class="op">(</span><span class="dv">1</span><span class="op">,</span> A<span class="op">.</span>n_rows<span class="op">-</span><span class="dv">1</span><span class="op">);</span>  <span class="co">// Skip first row (constants)</span></span>
<span id="cb42-88"><a href="#cb42-88" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb42-89"><a href="#cb42-89" aria-hidden="true" tabindex="-1"></a>    A_coeff <span class="op">=</span> A<span class="op">;</span></span>
<span id="cb42-90"><a href="#cb42-90" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-91"><a href="#cb42-91" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-92"><a href="#cb42-92" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create companion matrix</span></span>
<span id="cb42-93"><a href="#cb42-93" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F<span class="op">(</span>K<span class="op">*</span>p<span class="op">,</span> K<span class="op">*</span>p<span class="op">,</span> fill<span class="op">::</span>zeros<span class="op">);</span></span>
<span id="cb42-94"><a href="#cb42-94" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-95"><a href="#cb42-95" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Fill first K rows with coefficient matrices A1, A2, ..., Ap</span></span>
<span id="cb42-96"><a href="#cb42-96" aria-hidden="true" tabindex="-1"></a>  F<span class="op">.</span>submat<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> K<span class="op">-</span><span class="dv">1</span><span class="op">,</span> K<span class="op">*</span>p<span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">=</span> A_coeff<span class="op">.</span>t<span class="op">();</span></span>
<span id="cb42-97"><a href="#cb42-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-98"><a href="#cb42-98" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Fill identity blocks for lagged terms</span></span>
<span id="cb42-99"><a href="#cb42-99" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>p <span class="op">&gt;</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-100"><a href="#cb42-100" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> I_K <span class="op">=</span> eye<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;(</span>K<span class="op">,</span> K<span class="op">);</span></span>
<span id="cb42-101"><a href="#cb42-101" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;</span> p<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-102"><a href="#cb42-102" aria-hidden="true" tabindex="-1"></a>      F<span class="op">.</span>submat<span class="op">(</span>i<span class="op">*</span>K<span class="op">,</span> <span class="op">(</span>i<span class="op">-</span><span class="dv">1</span><span class="op">)*</span>K<span class="op">,</span> <span class="op">(</span>i<span class="op">+</span><span class="dv">1</span><span class="op">)*</span>K<span class="op">-</span><span class="dv">1</span><span class="op">,</span> i<span class="op">*</span>K<span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">=</span> I_K<span class="op">;</span></span>
<span id="cb42-103"><a href="#cb42-103" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-104"><a href="#cb42-104" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-105"><a href="#cb42-105" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-106"><a href="#cb42-106" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> F<span class="op">;</span></span>
<span id="cb42-107"><a href="#cb42-107" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb42-108"><a href="#cb42-108" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-109"><a href="#cb42-109" aria-hidden="true" tabindex="-1"></a><span class="co">// VAR forecasting function</span></span>
<span id="cb42-110"><a href="#cb42-110" aria-hidden="true" tabindex="-1"></a>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> <span class="va">var_forecast_</span><span class="op">(</span><span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> Y<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> A<span class="op">,</span> </span>
<span id="cb42-111"><a href="#cb42-111" aria-hidden="true" tabindex="-1"></a>                         <span class="dt">int</span> p<span class="op">,</span> <span class="dt">int</span> h<span class="op">,</span> <span class="dt">bool</span> include_const <span class="op">=</span> <span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-112"><a href="#cb42-112" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> Y<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb42-113"><a href="#cb42-113" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> K <span class="op">=</span> Y<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb42-114"><a href="#cb42-114" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-115"><a href="#cb42-115" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Get last p observations for initialization</span></span>
<span id="cb42-116"><a href="#cb42-116" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Y_init <span class="op">=</span> Y<span class="op">.</span>rows<span class="op">(</span>T<span class="op">-</span>p<span class="op">,</span> T<span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb42-117"><a href="#cb42-117" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-118"><a href="#cb42-118" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Initialize forecast container</span></span>
<span id="cb42-119"><a href="#cb42-119" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> forecasts<span class="op">(</span>h<span class="op">,</span> K<span class="op">);</span></span>
<span id="cb42-120"><a href="#cb42-120" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-121"><a href="#cb42-121" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Current state vector (flatten last p observations)</span></span>
<span id="cb42-122"><a href="#cb42-122" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> y_current <span class="op">=</span> vectorise<span class="op">(</span>Y_init<span class="op">.</span>t<span class="op">()).</span>t<span class="op">();</span>  <span class="co">// Reshape to row vector</span></span>
<span id="cb42-123"><a href="#cb42-123" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-124"><a href="#cb42-124" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Extract coefficients</span></span>
<span id="cb42-125"><a href="#cb42-125" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> const_term<span class="op">;</span></span>
<span id="cb42-126"><a href="#cb42-126" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> A_coeff<span class="op">;</span></span>
<span id="cb42-127"><a href="#cb42-127" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-128"><a href="#cb42-128" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>include_const<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-129"><a href="#cb42-129" aria-hidden="true" tabindex="-1"></a>    const_term <span class="op">=</span> A<span class="op">.</span>row<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb42-130"><a href="#cb42-130" aria-hidden="true" tabindex="-1"></a>    A_coeff <span class="op">=</span> A<span class="op">.</span>rows<span class="op">(</span><span class="dv">1</span><span class="op">,</span> A<span class="op">.</span>n_rows<span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb42-131"><a href="#cb42-131" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb42-132"><a href="#cb42-132" aria-hidden="true" tabindex="-1"></a>    const_term <span class="op">=</span> zeros<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;(</span><span class="dv">1</span><span class="op">,</span> K<span class="op">);</span></span>
<span id="cb42-133"><a href="#cb42-133" aria-hidden="true" tabindex="-1"></a>    A_coeff <span class="op">=</span> A<span class="op">;</span></span>
<span id="cb42-134"><a href="#cb42-134" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-135"><a href="#cb42-135" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-136"><a href="#cb42-136" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create lagged design matrix for current state</span></span>
<span id="cb42-137"><a href="#cb42-137" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X_lag <span class="op">=</span> y_current<span class="op">;</span></span>
<span id="cb42-138"><a href="#cb42-138" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-139"><a href="#cb42-139" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Forecast h periods ahead</span></span>
<span id="cb42-140"><a href="#cb42-140" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> h<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-141"><a href="#cb42-141" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Forecast: y_{T+i+1} = c + A1*y_{T+i} + ... + Ap*y_{T+i-p+1}</span></span>
<span id="cb42-142"><a href="#cb42-142" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> y_forecast <span class="op">=</span> const_term <span class="op">+</span> X_lag <span class="op">*</span> A_coeff<span class="op">;</span></span>
<span id="cb42-143"><a href="#cb42-143" aria-hidden="true" tabindex="-1"></a>    forecasts<span class="op">.</span>row<span class="op">(</span>i<span class="op">)</span> <span class="op">=</span> y_forecast<span class="op">;</span></span>
<span id="cb42-144"><a href="#cb42-144" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-145"><a href="#cb42-145" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update lagged matrix for next forecast</span></span>
<span id="cb42-146"><a href="#cb42-146" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>i <span class="op">&lt;</span> h<span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-147"><a href="#cb42-147" aria-hidden="true" tabindex="-1"></a>      Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> new_X_lag <span class="op">=</span> join_horiz<span class="op">(</span>y_forecast<span class="op">,</span> X_lag<span class="op">.</span>cols<span class="op">(</span><span class="dv">0</span><span class="op">,</span> K<span class="op">*(</span>p<span class="op">-</span><span class="dv">1</span><span class="op">)-</span><span class="dv">1</span><span class="op">));</span></span>
<span id="cb42-148"><a href="#cb42-148" aria-hidden="true" tabindex="-1"></a>      X_lag <span class="op">=</span> new_X_lag<span class="op">;</span></span>
<span id="cb42-149"><a href="#cb42-149" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-150"><a href="#cb42-150" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-151"><a href="#cb42-151" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-152"><a href="#cb42-152" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> forecasts<span class="op">;</span></span>
<span id="cb42-153"><a href="#cb42-153" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb42-154"><a href="#cb42-154" aria-hidden="true" tabindex="-1"></a><span class="co">/* roxygen</span></span>
<span id="cb42-155"><a href="#cb42-155" aria-hidden="true" tabindex="-1"></a><span class="co">@title Main VAR estimation function that returns everything</span></span>
<span id="cb42-156"><a href="#cb42-156" aria-hidden="true" tabindex="-1"></a><span class="co">@description Estimates a VAR model using OLS.</span></span>
<span id="cb42-157"><a href="#cb42-157" aria-hidden="true" tabindex="-1"></a><span class="co">@param y Time series vector (T x 1)</span></span>
<span id="cb42-158"><a href="#cb42-158" aria-hidden="true" tabindex="-1"></a><span class="co">@param p Lag order</span></span>
<span id="cb42-159"><a href="#cb42-159" aria-hidden="true" tabindex="-1"></a><span class="co">@param include_const Include constant term in VAR</span></span>
<span id="cb42-160"><a href="#cb42-160" aria-hidden="true" tabindex="-1"></a><span class="co">@param forecast_h Forecast horizon (0 for no forecast)</span></span>
<span id="cb42-161"><a href="#cb42-161" aria-hidden="true" tabindex="-1"></a><span class="co">@export</span></span>
<span id="cb42-162"><a href="#cb42-162" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb42-163"><a href="#cb42-163" aria-hidden="true" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp4r</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span> list var_model<span class="op">(</span><span class="at">const</span> doubles_matrix<span class="op">&lt;&gt;&amp;</span> y<span class="op">,</span> <span class="dt">int</span> p<span class="op">,</span> </span>
<span id="cb42-164"><a href="#cb42-164" aria-hidden="true" tabindex="-1"></a>                                   <span class="dt">bool</span> include_const <span class="op">=</span> <span class="kw">true</span><span class="op">,</span> <span class="dt">int</span> forecast_h <span class="op">=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-165"><a href="#cb42-165" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Y <span class="op">=</span> as_Mat<span class="op">(</span>y<span class="op">);</span></span>
<span id="cb42-166"><a href="#cb42-166" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> Y<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb42-167"><a href="#cb42-167" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> K <span class="op">=</span> Y<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb42-168"><a href="#cb42-168" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-169"><a href="#cb42-169" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>T <span class="op">&lt;=</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-170"><a href="#cb42-170" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span><span class="st">"Sample size must be greater than lag order p"</span><span class="op">);</span></span>
<span id="cb42-171"><a href="#cb42-171" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-172"><a href="#cb42-172" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-173"><a href="#cb42-173" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Estimate VAR coefficients</span></span>
<span id="cb42-174"><a href="#cb42-174" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> A <span class="op">=</span> <span class="va">var_estimate_</span><span class="op">(</span>y<span class="op">,</span> p<span class="op">,</span> include_const<span class="op">);</span></span>
<span id="cb42-175"><a href="#cb42-175" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-176"><a href="#cb42-176" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute fitted values and residuals</span></span>
<span id="cb42-177"><a href="#cb42-177" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> fitted_resid <span class="op">=</span> <span class="va">var_fitted_resid_</span><span class="op">(</span>Y<span class="op">,</span> A<span class="op">,</span> p<span class="op">,</span> include_const<span class="op">);</span></span>
<span id="cb42-178"><a href="#cb42-178" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Y_fitted <span class="op">=</span> fitted_resid<span class="op">.</span>first<span class="op">;</span></span>
<span id="cb42-179"><a href="#cb42-179" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> residuals <span class="op">=</span> fitted_resid<span class="op">.</span>second<span class="op">;</span></span>
<span id="cb42-180"><a href="#cb42-180" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-181"><a href="#cb42-181" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute residual covariance matrix</span></span>
<span id="cb42-182"><a href="#cb42-182" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Sigma <span class="op">=</span> <span class="op">(</span>residuals<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> residuals<span class="op">)</span> <span class="op">/</span> <span class="op">(</span>residuals<span class="op">.</span>n_rows <span class="op">-</span> A<span class="op">.</span>n_rows<span class="op">);</span></span>
<span id="cb42-183"><a href="#cb42-183" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-184"><a href="#cb42-184" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create companion matrix</span></span>
<span id="cb42-185"><a href="#cb42-185" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F <span class="op">=</span> <span class="va">var_companion_</span><span class="op">(</span>A<span class="op">,</span> p<span class="op">,</span> K<span class="op">,</span> include_const<span class="op">);</span></span>
<span id="cb42-186"><a href="#cb42-186" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-187"><a href="#cb42-187" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute AIC</span></span>
<span id="cb42-188"><a href="#cb42-188" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n_params <span class="op">=</span> A<span class="op">.</span>n_rows <span class="op">*</span> K<span class="op">;</span>  <span class="co">// Total number of parameters</span></span>
<span id="cb42-189"><a href="#cb42-189" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> aic <span class="op">=</span> aic_metric<span class="op">(</span>residuals<span class="op">,</span> n_params<span class="op">);</span></span>
<span id="cb42-190"><a href="#cb42-190" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-191"><a href="#cb42-191" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Prepare results list</span></span>
<span id="cb42-192"><a href="#cb42-192" aria-hidden="true" tabindex="-1"></a>  writable<span class="op">::</span>list result<span class="op">;</span></span>
<span id="cb42-193"><a href="#cb42-193" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-194"><a href="#cb42-194" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"coefficients"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>A<span class="op">)});</span></span>
<span id="cb42-195"><a href="#cb42-195" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"fitted_values"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>Y_fitted<span class="op">)});</span></span>
<span id="cb42-196"><a href="#cb42-196" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"residuals"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>residuals<span class="op">)});</span></span>
<span id="cb42-197"><a href="#cb42-197" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"sigma"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>Sigma<span class="op">)});</span></span>
<span id="cb42-198"><a href="#cb42-198" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"companion_matrix"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>F<span class="op">)});</span></span>
<span id="cb42-199"><a href="#cb42-199" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-200"><a href="#cb42-200" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"lag_order"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>p<span class="op">)});</span></span>
<span id="cb42-201"><a href="#cb42-201" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"n_variables"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>K<span class="op">)});</span></span>
<span id="cb42-202"><a href="#cb42-202" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"n_obs"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>T <span class="op">-</span> p<span class="op">)});</span>  <span class="co">// Effective sample size</span></span>
<span id="cb42-203"><a href="#cb42-203" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"include_const"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>include_const<span class="op">)});</span></span>
<span id="cb42-204"><a href="#cb42-204" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"rmsfe"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>rmsfe<span class="op">(</span>Y<span class="op">.</span>rows<span class="op">(</span>p<span class="op">,</span> T<span class="op">-</span><span class="dv">1</span><span class="op">),</span> Y_fitted<span class="op">))});</span></span>
<span id="cb42-205"><a href="#cb42-205" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-206"><a href="#cb42-206" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"mae"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>mae<span class="op">(</span>Y<span class="op">.</span>rows<span class="op">(</span>p<span class="op">,</span> T<span class="op">-</span><span class="dv">1</span><span class="op">),</span> Y_fitted<span class="op">))});</span></span>
<span id="cb42-207"><a href="#cb42-207" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"aic"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>aic<span class="op">)});</span></span>
<span id="cb42-208"><a href="#cb42-208" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-209"><a href="#cb42-209" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add forecasts if requested</span></span>
<span id="cb42-210"><a href="#cb42-210" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>forecast_h <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-211"><a href="#cb42-211" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> forecasts <span class="op">=</span> <span class="va">var_forecast_</span><span class="op">(</span>Y<span class="op">,</span> A<span class="op">,</span> p<span class="op">,</span> forecast_h<span class="op">,</span> include_const<span class="op">);</span></span>
<span id="cb42-212"><a href="#cb42-212" aria-hidden="true" tabindex="-1"></a>    result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"forecasts"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>forecasts<span class="op">)});</span></span>
<span id="cb42-213"><a href="#cb42-213" aria-hidden="true" tabindex="-1"></a>    result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"forecast_horizon"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>forecast_h<span class="op">)});</span></span>
<span id="cb42-214"><a href="#cb42-214" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span>  </span>
<span id="cb42-215"><a href="#cb42-215" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-216"><a href="#cb42-216" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb42-217"><a href="#cb42-217" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="fa-var" class="level2">
<h2 class="anchored" data-anchor-id="fa-var">FA-VAR</h2>
<div class="sourceCode" id="cb43"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">// Factor-Augmented VAR (FA-VAR)</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Extract factors using PCA from time series data</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>pair<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;</span> <span class="va">favar_extract_factors_</span><span class="op">(</span><span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> X<span class="op">,</span> <span class="dt">int</span> n_factors<span class="op">)</span> <span class="op">{</span>  </span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Center the data</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X_centered <span class="op">=</span> X<span class="op">.</span>each_row<span class="op">()</span> <span class="op">-</span> mean<span class="op">(</span>X<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Perform SVD on X' (N x T matrix)</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> U<span class="op">,</span> V<span class="op">;</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  vec s<span class="op">;</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  svd_econ<span class="op">(</span>U<span class="op">,</span> s<span class="op">,</span> V<span class="op">,</span> X_centered<span class="op">.</span>t<span class="op">());</span></span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Factor loadings (first n_factors principal components)</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Lambda <span class="op">=</span> U<span class="op">.</span>cols<span class="op">(</span><span class="dv">0</span><span class="op">,</span> n_factors<span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Common factors (T x n_factors)</span></span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F <span class="op">=</span> X_centered <span class="op">*</span> Lambda<span class="op">;</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">std::</span>make_pair<span class="op">(</span>F<span class="op">,</span> Lambda<span class="op">);</span></span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a><span class="co">// Estimate factor VAR: F_t = Phi_1*F_{t-1} + ... + Phi_p*F_{t-p} + v_t</span></span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> <span class="va">favar_factor_var_</span><span class="op">(</span><span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> F<span class="op">,</span> <span class="dt">int</span> p<span class="op">,</span> <span class="dt">bool</span> include_const <span class="op">=</span> <span class="kw">false</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> F<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>p <span class="op">==</span> <span class="dv">0</span> <span class="op">||</span> T <span class="op">&lt;=</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span><span class="st">"Invalid lag order for factor VAR"</span><span class="op">);</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Use existing VAR estimation function</span></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Phi <span class="op">=</span> <span class="va">var_estimate_</span><span class="op">(</span>as_doubles_matrix<span class="op">(</span>F<span class="op">),</span> p<span class="op">,</span> include_const<span class="op">);</span></span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> Phi<span class="op">;</span></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a><span class="co">// Estimate augmented VAR: y_t = B(L)*y_{t-1} + C(L)*F_{t-1} + u_t</span></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a><span class="co">// Uses only LAGGED factors to avoid data leakage</span></span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>pair<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;</span> <span class="va">favar_augmented_var_</span><span class="op">(</span></span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> y<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> F<span class="op">,</span> <span class="dt">int</span> p_y<span class="op">,</span> <span class="dt">int</span> p_f<span class="op">,</span> <span class="dt">bool</span> include_const <span class="op">=</span> <span class="kw">false</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> y<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> K <span class="op">=</span> y<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> max_p <span class="op">=</span> <span class="bu">std::</span>max<span class="op">(</span>p_y<span class="op">,</span> p_f<span class="op">);</span></span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>T <span class="op">&lt;=</span> max_p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span><span class="st">"Sample size must be greater than lag order"</span><span class="op">);</span></span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create lagged y variables</span></span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> y_lag<span class="op">;</span></span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> y_dep <span class="op">=</span> y<span class="op">.</span>rows<span class="op">(</span>max_p<span class="op">,</span> T <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>p_y <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a>    y_lag <span class="op">=</span> <span class="va">create_lags_</span><span class="op">(</span>y<span class="op">,</span> p_y<span class="op">);</span></span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Align if needed</span></span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>p_y <span class="op">&lt;</span> max_p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-58"><a href="#cb43-58" aria-hidden="true" tabindex="-1"></a>      y_lag <span class="op">=</span> y_lag<span class="op">.</span>rows<span class="op">(</span>max_p <span class="op">-</span> p_y<span class="op">,</span> y_lag<span class="op">.</span>n_rows <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb43-59"><a href="#cb43-59" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-60"><a href="#cb43-60" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-61"><a href="#cb43-61" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-62"><a href="#cb43-62" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create factor regressors: [F_{t-1}, ..., F_{t-p_f}] (only lagged factors)</span></span>
<span id="cb43-63"><a href="#cb43-63" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_regressors<span class="op">;</span></span>
<span id="cb43-64"><a href="#cb43-64" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-65"><a href="#cb43-65" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>p_f <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-66"><a href="#cb43-66" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_lag <span class="op">=</span> <span class="va">create_lags_</span><span class="op">(</span>F<span class="op">,</span> p_f<span class="op">);</span></span>
<span id="cb43-67"><a href="#cb43-67" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Align if needed</span></span>
<span id="cb43-68"><a href="#cb43-68" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>p_f <span class="op">&lt;</span> max_p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-69"><a href="#cb43-69" aria-hidden="true" tabindex="-1"></a>      F_lag <span class="op">=</span> F_lag<span class="op">.</span>rows<span class="op">(</span>max_p <span class="op">-</span> p_f<span class="op">,</span> F_lag<span class="op">.</span>n_rows <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb43-70"><a href="#cb43-70" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-71"><a href="#cb43-71" aria-hidden="true" tabindex="-1"></a>    F_regressors <span class="op">=</span> F_lag<span class="op">;</span></span>
<span id="cb43-72"><a href="#cb43-72" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb43-73"><a href="#cb43-73" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span><span class="st">"p_f must be at least 1 for FAVAR"</span><span class="op">);</span></span>
<span id="cb43-74"><a href="#cb43-74" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-75"><a href="#cb43-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-76"><a href="#cb43-76" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Combine regressors: [y_{t-1}, ..., y_{t-p_y}, F_{t-1}, ..., F_{t-p_f}]</span></span>
<span id="cb43-77"><a href="#cb43-77" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X<span class="op">;</span></span>
<span id="cb43-78"><a href="#cb43-78" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>p_y <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-79"><a href="#cb43-79" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> join_horiz<span class="op">(</span>y_lag<span class="op">,</span> F_regressors<span class="op">);</span></span>
<span id="cb43-80"><a href="#cb43-80" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb43-81"><a href="#cb43-81" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> F_regressors<span class="op">;</span></span>
<span id="cb43-82"><a href="#cb43-82" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-83"><a href="#cb43-83" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-84"><a href="#cb43-84" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add constant if requested</span></span>
<span id="cb43-85"><a href="#cb43-85" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>include_const<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-86"><a href="#cb43-86" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> ones<span class="op">(</span>X<span class="op">.</span>n_rows<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> fill<span class="op">::</span>ones<span class="op">);</span></span>
<span id="cb43-87"><a href="#cb43-87" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> join_horiz<span class="op">(</span>ones<span class="op">,</span> X<span class="op">);</span></span>
<span id="cb43-88"><a href="#cb43-88" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-89"><a href="#cb43-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-90"><a href="#cb43-90" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Estimate coefficients: [B, C] = (X'X)^(-1)(X'y)</span></span>
<span id="cb43-91"><a href="#cb43-91" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> beta <span class="op">=</span> solve<span class="op">(</span>X<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> X<span class="op">,</span> X<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> y_dep<span class="op">);</span></span>
<span id="cb43-92"><a href="#cb43-92" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-93"><a href="#cb43-93" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Extract factor coefficients C</span></span>
<span id="cb43-94"><a href="#cb43-94" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> start_idx <span class="op">=</span> include_const <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb43-95"><a href="#cb43-95" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> factor_start <span class="op">=</span> start_idx <span class="op">+</span> <span class="op">(</span>p_y <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">?</span> K <span class="op">*</span> p_y <span class="op">:</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb43-96"><a href="#cb43-96" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> C <span class="op">=</span> beta<span class="op">.</span>rows<span class="op">(</span>factor_start<span class="op">,</span> beta<span class="op">.</span>n_rows <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb43-97"><a href="#cb43-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-98"><a href="#cb43-98" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">std::</span>make_pair<span class="op">(</span>beta<span class="op">,</span> C<span class="op">);</span></span>
<span id="cb43-99"><a href="#cb43-99" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb43-100"><a href="#cb43-100" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-101"><a href="#cb43-101" aria-hidden="true" tabindex="-1"></a><span class="co">// Compute FAVAR fitted values and residuals</span></span>
<span id="cb43-102"><a href="#cb43-102" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>pair<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;</span> <span class="va">favar_fitted_resid_</span><span class="op">(</span></span>
<span id="cb43-103"><a href="#cb43-103" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> y<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> F<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> beta<span class="op">,</span></span>
<span id="cb43-104"><a href="#cb43-104" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> p_y<span class="op">,</span> <span class="dt">int</span> p_f<span class="op">,</span> <span class="dt">bool</span> include_const <span class="op">=</span> <span class="kw">false</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-105"><a href="#cb43-105" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-106"><a href="#cb43-106" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> y<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb43-107"><a href="#cb43-107" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> max_p <span class="op">=</span> <span class="bu">std::</span>max<span class="op">(</span>p_y<span class="op">,</span> p_f<span class="op">);</span></span>
<span id="cb43-108"><a href="#cb43-108" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-109"><a href="#cb43-109" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Reconstruct regressor matrix</span></span>
<span id="cb43-110"><a href="#cb43-110" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> y_dep <span class="op">=</span> y<span class="op">.</span>rows<span class="op">(</span>max_p<span class="op">,</span> T <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb43-111"><a href="#cb43-111" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X<span class="op">;</span></span>
<span id="cb43-112"><a href="#cb43-112" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-113"><a href="#cb43-113" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>p_y <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-114"><a href="#cb43-114" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> y_lag <span class="op">=</span> <span class="va">create_lags_</span><span class="op">(</span>y<span class="op">,</span> p_y<span class="op">);</span></span>
<span id="cb43-115"><a href="#cb43-115" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>p_y <span class="op">&lt;</span> max_p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-116"><a href="#cb43-116" aria-hidden="true" tabindex="-1"></a>      y_lag <span class="op">=</span> y_lag<span class="op">.</span>rows<span class="op">(</span>max_p <span class="op">-</span> p_y<span class="op">,</span> y_lag<span class="op">.</span>n_rows <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb43-117"><a href="#cb43-117" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-118"><a href="#cb43-118" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-119"><a href="#cb43-119" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_regressors<span class="op">;</span></span>
<span id="cb43-120"><a href="#cb43-120" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-121"><a href="#cb43-121" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>p_f <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-122"><a href="#cb43-122" aria-hidden="true" tabindex="-1"></a>      Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_lag <span class="op">=</span> <span class="va">create_lags_</span><span class="op">(</span>F<span class="op">,</span> p_f<span class="op">);</span></span>
<span id="cb43-123"><a href="#cb43-123" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>p_f <span class="op">&lt;</span> max_p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-124"><a href="#cb43-124" aria-hidden="true" tabindex="-1"></a>        F_lag <span class="op">=</span> F_lag<span class="op">.</span>rows<span class="op">(</span>max_p <span class="op">-</span> p_f<span class="op">,</span> F_lag<span class="op">.</span>n_rows <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb43-125"><a href="#cb43-125" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb43-126"><a href="#cb43-126" aria-hidden="true" tabindex="-1"></a>      F_regressors <span class="op">=</span> F_lag<span class="op">;</span></span>
<span id="cb43-127"><a href="#cb43-127" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-128"><a href="#cb43-128" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-129"><a href="#cb43-129" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> join_horiz<span class="op">(</span>y_lag<span class="op">,</span> F_regressors<span class="op">);</span></span>
<span id="cb43-130"><a href="#cb43-130" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb43-131"><a href="#cb43-131" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_regressors<span class="op">;</span></span>
<span id="cb43-132"><a href="#cb43-132" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-133"><a href="#cb43-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>p_f <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-134"><a href="#cb43-134" aria-hidden="true" tabindex="-1"></a>      Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_lag <span class="op">=</span> <span class="va">create_lags_</span><span class="op">(</span>F<span class="op">,</span> p_f<span class="op">);</span></span>
<span id="cb43-135"><a href="#cb43-135" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>p_f <span class="op">&lt;</span> max_p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-136"><a href="#cb43-136" aria-hidden="true" tabindex="-1"></a>        F_lag <span class="op">=</span> F_lag<span class="op">.</span>rows<span class="op">(</span>max_p <span class="op">-</span> p_f<span class="op">,</span> F_lag<span class="op">.</span>n_rows <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb43-137"><a href="#cb43-137" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb43-138"><a href="#cb43-138" aria-hidden="true" tabindex="-1"></a>      F_regressors <span class="op">=</span> F_lag<span class="op">;</span></span>
<span id="cb43-139"><a href="#cb43-139" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-140"><a href="#cb43-140" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-141"><a href="#cb43-141" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> F_regressors<span class="op">;</span></span>
<span id="cb43-142"><a href="#cb43-142" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-143"><a href="#cb43-143" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-144"><a href="#cb43-144" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>include_const<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-145"><a href="#cb43-145" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> ones<span class="op">(</span>X<span class="op">.</span>n_rows<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> fill<span class="op">::</span>ones<span class="op">);</span></span>
<span id="cb43-146"><a href="#cb43-146" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> join_horiz<span class="op">(</span>ones<span class="op">,</span> X<span class="op">);</span></span>
<span id="cb43-147"><a href="#cb43-147" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-148"><a href="#cb43-148" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-149"><a href="#cb43-149" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute fitted values and residuals</span></span>
<span id="cb43-150"><a href="#cb43-150" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> y_fitted <span class="op">=</span> X <span class="op">*</span> beta<span class="op">;</span></span>
<span id="cb43-151"><a href="#cb43-151" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> residuals <span class="op">=</span> y_dep <span class="op">-</span> y_fitted<span class="op">;</span></span>
<span id="cb43-152"><a href="#cb43-152" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-153"><a href="#cb43-153" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">std::</span>make_pair<span class="op">(</span>y_fitted<span class="op">,</span> residuals<span class="op">);</span></span>
<span id="cb43-154"><a href="#cb43-154" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb43-155"><a href="#cb43-155" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-156"><a href="#cb43-156" aria-hidden="true" tabindex="-1"></a><span class="co">// FAVAR forecasting with lagged factors only</span></span>
<span id="cb43-157"><a href="#cb43-157" aria-hidden="true" tabindex="-1"></a>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> <span class="va">favar_forecast_</span><span class="op">(</span><span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> y<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> F<span class="op">,</span></span>
<span id="cb43-158"><a href="#cb43-158" aria-hidden="true" tabindex="-1"></a>                           <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> beta_y<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> Phi_f<span class="op">,</span></span>
<span id="cb43-159"><a href="#cb43-159" aria-hidden="true" tabindex="-1"></a>                           <span class="dt">int</span> p_y<span class="op">,</span> <span class="dt">int</span> p_f<span class="op">,</span> <span class="dt">int</span> h<span class="op">,</span> <span class="dt">bool</span> include_const <span class="op">=</span> <span class="kw">false</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-160"><a href="#cb43-160" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-161"><a href="#cb43-161" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> y<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb43-162"><a href="#cb43-162" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> K <span class="op">=</span> y<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb43-163"><a href="#cb43-163" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n_factors <span class="op">=</span> F<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb43-164"><a href="#cb43-164" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-165"><a href="#cb43-165" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Initialize forecasts</span></span>
<span id="cb43-166"><a href="#cb43-166" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> y_forecast<span class="op">(</span>h<span class="op">,</span> K<span class="op">);</span></span>
<span id="cb43-167"><a href="#cb43-167" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_forecast<span class="op">(</span>h<span class="op">,</span> n_factors<span class="op">);</span></span>
<span id="cb43-168"><a href="#cb43-168" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-169"><a href="#cb43-169" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Step 1: Forecast factors using factor VAR</span></span>
<span id="cb43-170"><a href="#cb43-170" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_init <span class="op">=</span> F<span class="op">.</span>rows<span class="op">(</span>T <span class="op">-</span> p_f<span class="op">,</span> T <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb43-171"><a href="#cb43-171" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_current <span class="op">=</span> vectorise<span class="op">(</span>F_init<span class="op">.</span>t<span class="op">()).</span>t<span class="op">();</span></span>
<span id="cb43-172"><a href="#cb43-172" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-173"><a href="#cb43-173" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> h<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-174"><a href="#cb43-174" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X_f<span class="op">;</span></span>
<span id="cb43-175"><a href="#cb43-175" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>include_const<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-176"><a href="#cb43-176" aria-hidden="true" tabindex="-1"></a>      Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> ones<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> fill<span class="op">::</span>ones<span class="op">);</span></span>
<span id="cb43-177"><a href="#cb43-177" aria-hidden="true" tabindex="-1"></a>      X_f <span class="op">=</span> join_horiz<span class="op">(</span>ones<span class="op">,</span> F_current<span class="op">);</span></span>
<span id="cb43-178"><a href="#cb43-178" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb43-179"><a href="#cb43-179" aria-hidden="true" tabindex="-1"></a>      X_f <span class="op">=</span> F_current<span class="op">;</span></span>
<span id="cb43-180"><a href="#cb43-180" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-181"><a href="#cb43-181" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-182"><a href="#cb43-182" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_pred <span class="op">=</span> X_f <span class="op">*</span> Phi_f<span class="op">;</span></span>
<span id="cb43-183"><a href="#cb43-183" aria-hidden="true" tabindex="-1"></a>    F_forecast<span class="op">.</span>row<span class="op">(</span>i<span class="op">)</span> <span class="op">=</span> F_pred<span class="op">;</span></span>
<span id="cb43-184"><a href="#cb43-184" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-185"><a href="#cb43-185" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update state for next iteration</span></span>
<span id="cb43-186"><a href="#cb43-186" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>i <span class="op">&lt;</span> h <span class="op">-</span> <span class="dv">1</span> <span class="op">&amp;&amp;</span> p_f <span class="op">&gt;</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-187"><a href="#cb43-187" aria-hidden="true" tabindex="-1"></a>      F_current <span class="op">=</span> join_horiz<span class="op">(</span>F_pred<span class="op">,</span> F_current<span class="op">.</span>cols<span class="op">(</span><span class="dv">0</span><span class="op">,</span> n_factors <span class="op">*</span> <span class="op">(</span>p_f <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">-</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb43-188"><a href="#cb43-188" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>p_f <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-189"><a href="#cb43-189" aria-hidden="true" tabindex="-1"></a>      F_current <span class="op">=</span> F_pred<span class="op">;</span></span>
<span id="cb43-190"><a href="#cb43-190" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-191"><a href="#cb43-191" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-192"><a href="#cb43-192" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-193"><a href="#cb43-193" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Step 2: Forecast y using forecasted factors (lagged factors only)</span></span>
<span id="cb43-194"><a href="#cb43-194" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> y_init <span class="op">=</span> y<span class="op">.</span>rows<span class="op">(</span>T <span class="op">-</span> <span class="bu">std::</span>max<span class="op">(</span>p_y<span class="op">,</span> <span class="dv">1</span><span class="op">),</span> T <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb43-195"><a href="#cb43-195" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> y_current <span class="op">=</span> <span class="op">(</span>p_y <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">?</span> vectorise<span class="op">(</span>y_init<span class="op">.</span>t<span class="op">()).</span>t<span class="op">()</span> <span class="op">:</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;();</span></span>
<span id="cb43-196"><a href="#cb43-196" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-197"><a href="#cb43-197" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Extend F with forecasts for easier indexing</span></span>
<span id="cb43-198"><a href="#cb43-198" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_extended <span class="op">=</span> join_vert<span class="op">(</span>F<span class="op">,</span> F_forecast<span class="op">);</span></span>
<span id="cb43-199"><a href="#cb43-199" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-200"><a href="#cb43-200" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> h<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-201"><a href="#cb43-201" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X_y<span class="op">;</span></span>
<span id="cb43-202"><a href="#cb43-202" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-203"><a href="#cb43-203" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add y lags if p_y &gt; 0</span></span>
<span id="cb43-204"><a href="#cb43-204" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>p_y <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-205"><a href="#cb43-205" aria-hidden="true" tabindex="-1"></a>      X_y <span class="op">=</span> y_current<span class="op">;</span></span>
<span id="cb43-206"><a href="#cb43-206" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-207"><a href="#cb43-207" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-208"><a href="#cb43-208" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add lagged factors: F_{T+i-1}, ..., F_{T+i-p_f} (no contemporaneous factor)</span></span>
<span id="cb43-209"><a href="#cb43-209" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_current_forecast<span class="op">;</span></span>
<span id="cb43-210"><a href="#cb43-210" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>p_f <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-211"><a href="#cb43-211" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> lag <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> lag <span class="op">&lt;=</span> p_f<span class="op">;</span> <span class="op">++</span>lag<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-212"><a href="#cb43-212" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>T <span class="op">+</span> i <span class="op">-</span> lag <span class="op">&gt;=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-213"><a href="#cb43-213" aria-hidden="true" tabindex="-1"></a>          Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> <span class="dt">F_lag_t</span> <span class="op">=</span> F_extended<span class="op">.</span>row<span class="op">(</span>T <span class="op">+</span> i <span class="op">-</span> lag<span class="op">);</span></span>
<span id="cb43-214"><a href="#cb43-214" aria-hidden="true" tabindex="-1"></a>          <span class="cf">if</span> <span class="op">(</span>lag <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-215"><a href="#cb43-215" aria-hidden="true" tabindex="-1"></a>            F_current_forecast <span class="op">=</span> <span class="dt">F_lag_t</span><span class="op">;</span></span>
<span id="cb43-216"><a href="#cb43-216" aria-hidden="true" tabindex="-1"></a>          <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb43-217"><a href="#cb43-217" aria-hidden="true" tabindex="-1"></a>            F_current_forecast <span class="op">=</span> join_horiz<span class="op">(</span>F_current_forecast<span class="op">,</span> <span class="dt">F_lag_t</span><span class="op">);</span></span>
<span id="cb43-218"><a href="#cb43-218" aria-hidden="true" tabindex="-1"></a>          <span class="op">}</span></span>
<span id="cb43-219"><a href="#cb43-219" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb43-220"><a href="#cb43-220" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb43-221"><a href="#cb43-221" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-222"><a href="#cb43-222" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-223"><a href="#cb43-223" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Combine y lags and factors</span></span>
<span id="cb43-224"><a href="#cb43-224" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>p_y <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-225"><a href="#cb43-225" aria-hidden="true" tabindex="-1"></a>      X_y <span class="op">=</span> join_horiz<span class="op">(</span>X_y<span class="op">,</span> F_current_forecast<span class="op">);</span></span>
<span id="cb43-226"><a href="#cb43-226" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb43-227"><a href="#cb43-227" aria-hidden="true" tabindex="-1"></a>      X_y <span class="op">=</span> F_current_forecast<span class="op">;</span></span>
<span id="cb43-228"><a href="#cb43-228" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-229"><a href="#cb43-229" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-230"><a href="#cb43-230" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add constant if needed</span></span>
<span id="cb43-231"><a href="#cb43-231" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>include_const<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-232"><a href="#cb43-232" aria-hidden="true" tabindex="-1"></a>      Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> ones<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> fill<span class="op">::</span>ones<span class="op">);</span></span>
<span id="cb43-233"><a href="#cb43-233" aria-hidden="true" tabindex="-1"></a>      X_y <span class="op">=</span> join_horiz<span class="op">(</span>ones<span class="op">,</span> X_y<span class="op">);</span></span>
<span id="cb43-234"><a href="#cb43-234" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-235"><a href="#cb43-235" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-236"><a href="#cb43-236" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> y_pred <span class="op">=</span> X_y <span class="op">*</span> beta_y<span class="op">;</span></span>
<span id="cb43-237"><a href="#cb43-237" aria-hidden="true" tabindex="-1"></a>    y_forecast<span class="op">.</span>row<span class="op">(</span>i<span class="op">)</span> <span class="op">=</span> y_pred<span class="op">;</span></span>
<span id="cb43-238"><a href="#cb43-238" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-239"><a href="#cb43-239" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update y_current for next iteration</span></span>
<span id="cb43-240"><a href="#cb43-240" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>p_y <span class="op">&gt;</span> <span class="dv">1</span> <span class="op">&amp;&amp;</span> i <span class="op">&lt;</span> h <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-241"><a href="#cb43-241" aria-hidden="true" tabindex="-1"></a>      y_current <span class="op">=</span> join_horiz<span class="op">(</span>y_pred<span class="op">,</span> y_current<span class="op">.</span>cols<span class="op">(</span><span class="dv">0</span><span class="op">,</span> K <span class="op">*</span> <span class="op">(</span>p_y <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">-</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb43-242"><a href="#cb43-242" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>p_y <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-243"><a href="#cb43-243" aria-hidden="true" tabindex="-1"></a>      y_current <span class="op">=</span> y_pred<span class="op">;</span></span>
<span id="cb43-244"><a href="#cb43-244" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-245"><a href="#cb43-245" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-246"><a href="#cb43-246" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-247"><a href="#cb43-247" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> y_forecast<span class="op">;</span></span>
<span id="cb43-248"><a href="#cb43-248" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb43-249"><a href="#cb43-249" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-250"><a href="#cb43-250" aria-hidden="true" tabindex="-1"></a><span class="co">/* roxygen</span></span>
<span id="cb43-251"><a href="#cb43-251" aria-hidden="true" tabindex="-1"></a><span class="co">@title Factor-Augmented VAR (FA-VAR) Model</span></span>
<span id="cb43-252"><a href="#cb43-252" aria-hidden="true" tabindex="-1"></a><span class="co">@description Estimates a FA-VAR model using PCA for factor extraction.</span></span>
<span id="cb43-253"><a href="#cb43-253" aria-hidden="true" tabindex="-1"></a><span class="co">@param y Time series vector (T x 1)</span></span>
<span id="cb43-254"><a href="#cb43-254" aria-hidden="true" tabindex="-1"></a><span class="co">@param n_lags Number of lags of y to include in X for factor extraction</span></span>
<span id="cb43-255"><a href="#cb43-255" aria-hidden="true" tabindex="-1"></a><span class="co">@param n_factors Number of latent factors to extract (r &lt; n_lags + 1)</span></span>
<span id="cb43-256"><a href="#cb43-256" aria-hidden="true" tabindex="-1"></a><span class="co">@param p_y VAR lag order for y dynamics</span></span>
<span id="cb43-257"><a href="#cb43-257" aria-hidden="true" tabindex="-1"></a><span class="co">@param p_f VAR lag order for factor dynamics</span></span>
<span id="cb43-258"><a href="#cb43-258" aria-hidden="true" tabindex="-1"></a><span class="co">@param include_const Include constant term in VARs</span></span>
<span id="cb43-259"><a href="#cb43-259" aria-hidden="true" tabindex="-1"></a><span class="co">@param forecast_h Forecast horizon (0 for no forecast)</span></span>
<span id="cb43-260"><a href="#cb43-260" aria-hidden="true" tabindex="-1"></a><span class="co">@export</span></span>
<span id="cb43-261"><a href="#cb43-261" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb43-262"><a href="#cb43-262" aria-hidden="true" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp4r</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span> list favar_model<span class="op">(</span><span class="at">const</span> doubles_matrix<span class="op">&lt;&gt;&amp;</span> y<span class="op">,</span> <span class="dt">int</span> n_lags<span class="op">,</span></span>
<span id="cb43-263"><a href="#cb43-263" aria-hidden="true" tabindex="-1"></a>                                     <span class="dt">int</span> n_factors<span class="op">,</span> <span class="dt">int</span> p_y <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">int</span> p_f <span class="op">=</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb43-264"><a href="#cb43-264" aria-hidden="true" tabindex="-1"></a>                                     <span class="dt">bool</span> include_const <span class="op">=</span> <span class="kw">false</span><span class="op">,</span> <span class="dt">int</span> forecast_h <span class="op">=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-265"><a href="#cb43-265" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-266"><a href="#cb43-266" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Y <span class="op">=</span> as_Mat<span class="op">(</span>y<span class="op">);</span></span>
<span id="cb43-267"><a href="#cb43-267" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> Y<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb43-268"><a href="#cb43-268" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> K <span class="op">=</span> Y<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb43-269"><a href="#cb43-269" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-270"><a href="#cb43-270" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>K <span class="op">!=</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-271"><a href="#cb43-271" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span><span class="st">"FA-VAR requires univariate y (single column)"</span><span class="op">);</span></span>
<span id="cb43-272"><a href="#cb43-272" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-273"><a href="#cb43-273" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-274"><a href="#cb43-274" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>T <span class="op">&lt;=</span> n_lags <span class="op">+</span> <span class="bu">std::</span>max<span class="op">(</span>p_y<span class="op">,</span> p_f<span class="op">))</span> <span class="op">{</span></span>
<span id="cb43-275"><a href="#cb43-275" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span><span class="st">"Insufficient observations for lags"</span><span class="op">);</span></span>
<span id="cb43-276"><a href="#cb43-276" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-277"><a href="#cb43-277" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-278"><a href="#cb43-278" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Step 1: Create X matrix [y_t, y_{t-1}, ..., y_{t-n_lags}]</span></span>
<span id="cb43-279"><a href="#cb43-279" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X_lags <span class="op">=</span> <span class="va">create_lags_</span><span class="op">(</span>Y<span class="op">,</span> n_lags<span class="op">);</span></span>
<span id="cb43-280"><a href="#cb43-280" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Y_contemp <span class="op">=</span> Y<span class="op">.</span>rows<span class="op">(</span>n_lags<span class="op">,</span> T <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb43-281"><a href="#cb43-281" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X <span class="op">=</span> join_horiz<span class="op">(</span>Y_contemp<span class="op">,</span> X_lags<span class="op">);</span></span>
<span id="cb43-282"><a href="#cb43-282" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-283"><a href="#cb43-283" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> N <span class="op">=</span> X<span class="op">.</span>n_cols<span class="op">;</span>  <span class="co">// n_lags + 1</span></span>
<span id="cb43-284"><a href="#cb43-284" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-285"><a href="#cb43-285" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>n_factors <span class="op">&gt;=</span> N<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-286"><a href="#cb43-286" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span><span class="st">"Number of factors must be less than number of variables in X"</span><span class="op">);</span></span>
<span id="cb43-287"><a href="#cb43-287" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-288"><a href="#cb43-288" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-289"><a href="#cb43-289" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Step 2: Extract factors from X using PCA</span></span>
<span id="cb43-290"><a href="#cb43-290" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> factor_result <span class="op">=</span> <span class="va">favar_extract_factors_</span><span class="op">(</span>X<span class="op">,</span> n_factors<span class="op">);</span></span>
<span id="cb43-291"><a href="#cb43-291" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F <span class="op">=</span> factor_result<span class="op">.</span>first<span class="op">;</span></span>
<span id="cb43-292"><a href="#cb43-292" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Lambda <span class="op">=</span> factor_result<span class="op">.</span>second<span class="op">;</span></span>
<span id="cb43-293"><a href="#cb43-293" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-294"><a href="#cb43-294" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Step 3: Estimate factor VAR</span></span>
<span id="cb43-295"><a href="#cb43-295" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Phi <span class="op">=</span> <span class="va">favar_factor_var_</span><span class="op">(</span>F<span class="op">,</span> p_f<span class="op">,</span> include_const<span class="op">);</span></span>
<span id="cb43-296"><a href="#cb43-296" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-297"><a href="#cb43-297" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Step 4: Estimate augmented VAR (y on its lags + lagged factors only)</span></span>
<span id="cb43-298"><a href="#cb43-298" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Need to align y with F (both start at observation n_lags)</span></span>
<span id="cb43-299"><a href="#cb43-299" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Y_aligned <span class="op">=</span> Y<span class="op">.</span>rows<span class="op">(</span>n_lags<span class="op">,</span> T <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb43-300"><a href="#cb43-300" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-301"><a href="#cb43-301" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> var_result <span class="op">=</span> <span class="va">favar_augmented_var_</span><span class="op">(</span>Y_aligned<span class="op">,</span> F<span class="op">,</span> p_y<span class="op">,</span> p_f<span class="op">,</span> include_const<span class="op">);</span></span>
<span id="cb43-302"><a href="#cb43-302" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> beta <span class="op">=</span> var_result<span class="op">.</span>first<span class="op">;</span></span>
<span id="cb43-303"><a href="#cb43-303" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> C <span class="op">=</span> var_result<span class="op">.</span>second<span class="op">;</span></span>
<span id="cb43-304"><a href="#cb43-304" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-305"><a href="#cb43-305" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Step 5: Compute fitted values and residuals</span></span>
<span id="cb43-306"><a href="#cb43-306" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> fitted_resid <span class="op">=</span> <span class="va">favar_fitted_resid_</span><span class="op">(</span>Y_aligned<span class="op">,</span> F<span class="op">,</span> beta<span class="op">,</span> p_y<span class="op">,</span> p_f<span class="op">,</span> include_const<span class="op">);</span></span>
<span id="cb43-307"><a href="#cb43-307" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> y_fitted <span class="op">=</span> fitted_resid<span class="op">.</span>first<span class="op">;</span></span>
<span id="cb43-308"><a href="#cb43-308" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> residuals <span class="op">=</span> fitted_resid<span class="op">.</span>second<span class="op">;</span></span>
<span id="cb43-309"><a href="#cb43-309" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-310"><a href="#cb43-310" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute residual covariance</span></span>
<span id="cb43-311"><a href="#cb43-311" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Sigma <span class="op">=</span> <span class="op">(</span>residuals<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> residuals<span class="op">)</span> <span class="op">/</span> <span class="op">(</span>residuals<span class="op">.</span>n_rows <span class="op">-</span> beta<span class="op">.</span>n_rows<span class="op">);</span></span>
<span id="cb43-312"><a href="#cb43-312" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-313"><a href="#cb43-313" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute factor residuals</span></span>
<span id="cb43-314"><a href="#cb43-314" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> factor_fitted_resid <span class="op">=</span> <span class="va">var_fitted_resid_</span><span class="op">(</span>F<span class="op">,</span> Phi<span class="op">,</span> p_f<span class="op">,</span> include_const<span class="op">);</span></span>
<span id="cb43-315"><a href="#cb43-315" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_residuals <span class="op">=</span> factor_fitted_resid<span class="op">.</span>second<span class="op">;</span></span>
<span id="cb43-316"><a href="#cb43-316" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Omega <span class="op">=</span> <span class="op">(</span>F_residuals<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> F_residuals<span class="op">)</span> <span class="op">/</span> <span class="op">(</span>F_residuals<span class="op">.</span>n_rows <span class="op">-</span> Phi<span class="op">.</span>n_rows<span class="op">);</span></span>
<span id="cb43-317"><a href="#cb43-317" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-318"><a href="#cb43-318" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute AIC</span></span>
<span id="cb43-319"><a href="#cb43-319" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n_params <span class="op">=</span> beta<span class="op">.</span>n_rows <span class="op">*</span> K<span class="op">;</span></span>
<span id="cb43-320"><a href="#cb43-320" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> aic <span class="op">=</span> aic_metric<span class="op">(</span>residuals<span class="op">,</span> n_params<span class="op">);</span></span>
<span id="cb43-321"><a href="#cb43-321" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-322"><a href="#cb43-322" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Prepare results list</span></span>
<span id="cb43-323"><a href="#cb43-323" aria-hidden="true" tabindex="-1"></a>  writable<span class="op">::</span>list result<span class="op">;</span></span>
<span id="cb43-324"><a href="#cb43-324" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-325"><a href="#cb43-325" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"coefficients"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>beta<span class="op">)});</span></span>
<span id="cb43-326"><a href="#cb43-326" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"factor_coefficients"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>Phi<span class="op">)});</span></span>
<span id="cb43-327"><a href="#cb43-327" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"factor_loadings"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>Lambda<span class="op">)});</span></span>
<span id="cb43-328"><a href="#cb43-328" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"factors"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>F<span class="op">)});</span></span>
<span id="cb43-329"><a href="#cb43-329" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"fitted_values"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>y_fitted<span class="op">)});</span></span>
<span id="cb43-330"><a href="#cb43-330" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-331"><a href="#cb43-331" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"residuals"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>residuals<span class="op">)});</span></span>
<span id="cb43-332"><a href="#cb43-332" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"factor_residuals"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>F_residuals<span class="op">)});</span></span>
<span id="cb43-333"><a href="#cb43-333" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"sigma"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>Sigma<span class="op">)});</span></span>
<span id="cb43-334"><a href="#cb43-334" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"omega"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>Omega<span class="op">)});</span></span>
<span id="cb43-335"><a href="#cb43-335" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"n_factors"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>n_factors<span class="op">)});</span></span>
<span id="cb43-336"><a href="#cb43-336" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-337"><a href="#cb43-337" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"n_lags"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>n_lags<span class="op">)});</span></span>
<span id="cb43-338"><a href="#cb43-338" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"lag_order_y"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>p_y<span class="op">)});</span></span>
<span id="cb43-339"><a href="#cb43-339" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"lag_order_f"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>p_f<span class="op">)});</span></span>
<span id="cb43-340"><a href="#cb43-340" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"n_obs"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>y_fitted<span class="op">.</span>n_rows<span class="op">)});</span></span>
<span id="cb43-341"><a href="#cb43-341" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"include_const"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>include_const<span class="op">)});</span></span>
<span id="cb43-342"><a href="#cb43-342" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-343"><a href="#cb43-343" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute RMSFE and MAE using helper functions</span></span>
<span id="cb43-344"><a href="#cb43-344" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Need to align Y_aligned with fitted values (both start after max_p lags)</span></span>
<span id="cb43-345"><a href="#cb43-345" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> max_p <span class="op">=</span> <span class="bu">std::</span>max<span class="op">(</span>p_y<span class="op">,</span> p_f<span class="op">);</span></span>
<span id="cb43-346"><a href="#cb43-346" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Y_actual <span class="op">=</span> Y_aligned<span class="op">.</span>rows<span class="op">(</span>max_p<span class="op">,</span> Y_aligned<span class="op">.</span>n_rows <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb43-347"><a href="#cb43-347" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-348"><a href="#cb43-348" aria-hidden="true" tabindex="-1"></a>  <span class="co">// result.push_back({"observed_values"_nm = as_doubles_matrix(Y_actual)});</span></span>
<span id="cb43-349"><a href="#cb43-349" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"rmsfe"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>rmsfe<span class="op">(</span>Y_actual<span class="op">,</span> y_fitted<span class="op">))});</span></span>
<span id="cb43-350"><a href="#cb43-350" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"mae"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>mae<span class="op">(</span>Y_actual<span class="op">,</span> y_fitted<span class="op">))});</span></span>
<span id="cb43-351"><a href="#cb43-351" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"aic"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>aic<span class="op">)});</span></span>
<span id="cb43-352"><a href="#cb43-352" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-353"><a href="#cb43-353" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add forecasts if requested</span></span>
<span id="cb43-354"><a href="#cb43-354" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>forecast_h <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-355"><a href="#cb43-355" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> forecasts <span class="op">=</span> <span class="va">favar_forecast_</span><span class="op">(</span>Y_aligned<span class="op">,</span> F<span class="op">,</span> beta<span class="op">,</span> Phi<span class="op">,</span> p_y<span class="op">,</span> p_f<span class="op">,</span> forecast_h<span class="op">,</span> include_const<span class="op">);</span></span>
<span id="cb43-356"><a href="#cb43-356" aria-hidden="true" tabindex="-1"></a>    result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"forecasts"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>forecasts<span class="op">)});</span></span>
<span id="cb43-357"><a href="#cb43-357" aria-hidden="true" tabindex="-1"></a>    result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"forecast_horizon"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>forecast_h<span class="op">)});</span></span>
<span id="cb43-358"><a href="#cb43-358" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-359"><a href="#cb43-359" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-360"><a href="#cb43-360" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb43-361"><a href="#cb43-361" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="dfm" class="level2">
<h2 class="anchored" data-anchor-id="dfm">DFM</h2>
<div class="sourceCode" id="cb44"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a><span class="co">/* Dynamic Factor Model (DFM) */</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-3"><a href="#cb44-3" aria-hidden="true" tabindex="-1"></a><span class="co">// Standardize data: mean 0 and common variance (to avoid scaling issues)</span></span>
<span id="cb44-4"><a href="#cb44-4" aria-hidden="true" tabindex="-1"></a><span class="co">// Returns: standardized data, column means, and common std dev</span></span>
<span id="cb44-5"><a href="#cb44-5" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>tuple<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> rowvec<span class="op">,</span> <span class="dt">double</span><span class="op">&gt;</span> <span class="va">dfm_standardize_</span><span class="op">(</span><span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> X<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-6"><a href="#cb44-6" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> X<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb44-7"><a href="#cb44-7" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> N <span class="op">=</span> X<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb44-8"><a href="#cb44-8" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-9"><a href="#cb44-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Center each variable and save means</span></span>
<span id="cb44-10"><a href="#cb44-10" aria-hidden="true" tabindex="-1"></a>  rowvec means <span class="op">=</span> mean<span class="op">(</span>X<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb44-11"><a href="#cb44-11" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X_centered <span class="op">=</span> X<span class="op">.</span>each_row<span class="op">()</span> <span class="op">-</span> means<span class="op">;</span></span>
<span id="cb44-12"><a href="#cb44-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-13"><a href="#cb44-13" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute common variance (pooled across all variables)</span></span>
<span id="cb44-14"><a href="#cb44-14" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> total_var <span class="op">=</span> accu<span class="op">(</span>square<span class="op">(</span>X_centered<span class="op">))</span> <span class="op">/</span> <span class="op">(</span>T <span class="op">*</span> N<span class="op">);</span></span>
<span id="cb44-15"><a href="#cb44-15" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> common_sd <span class="op">=</span> sqrt<span class="op">(</span>total_var<span class="op">);</span></span>
<span id="cb44-16"><a href="#cb44-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-17"><a href="#cb44-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Standardize to common variance</span></span>
<span id="cb44-18"><a href="#cb44-18" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X_std <span class="op">=</span> X_centered <span class="op">/</span> common_sd<span class="op">;</span></span>
<span id="cb44-19"><a href="#cb44-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-20"><a href="#cb44-20" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">std::</span>make_tuple<span class="op">(</span>X_std<span class="op">,</span> means<span class="op">,</span> common_sd<span class="op">);</span></span>
<span id="cb44-21"><a href="#cb44-21" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-22"><a href="#cb44-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-23"><a href="#cb44-23" aria-hidden="true" tabindex="-1"></a><span class="co">// Unstandardize data back to original scale</span></span>
<span id="cb44-24"><a href="#cb44-24" aria-hidden="true" tabindex="-1"></a>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> <span class="va">dfm_unstandardize_</span><span class="op">(</span><span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> X_std<span class="op">,</span> <span class="at">const</span> rowvec<span class="op">&amp;</span> means<span class="op">,</span> <span class="dt">double</span> common_sd<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-25"><a href="#cb44-25" aria-hidden="true" tabindex="-1"></a>  <span class="co">// X_unstd = X_std * common_sd + means (broadcast means across rows)</span></span>
<span id="cb44-26"><a href="#cb44-26" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X_unstd <span class="op">=</span> X_std <span class="op">*</span> common_sd<span class="op">;</span></span>
<span id="cb44-27"><a href="#cb44-27" aria-hidden="true" tabindex="-1"></a>  X_unstd<span class="op">.</span>each_row<span class="op">()</span> <span class="op">+=</span> means<span class="op">;</span></span>
<span id="cb44-28"><a href="#cb44-28" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> X_unstd<span class="op">;</span></span>
<span id="cb44-29"><a href="#cb44-29" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-30"><a href="#cb44-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-31"><a href="#cb44-31" aria-hidden="true" tabindex="-1"></a><span class="co">// PCA-based factor extraction for initialization</span></span>
<span id="cb44-32"><a href="#cb44-32" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>pair<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;</span> <span class="va">dfm_extract_factors_</span><span class="op">(</span><span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> X<span class="op">,</span> <span class="dt">int</span> n_factors<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-33"><a href="#cb44-33" aria-hidden="true" tabindex="-1"></a>  <span class="co">// X should already be standardized</span></span>
<span id="cb44-34"><a href="#cb44-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-35"><a href="#cb44-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Perform SVD on X' (N x T matrix)</span></span>
<span id="cb44-36"><a href="#cb44-36" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> U<span class="op">,</span> V<span class="op">;</span></span>
<span id="cb44-37"><a href="#cb44-37" aria-hidden="true" tabindex="-1"></a>  vec s<span class="op">;</span></span>
<span id="cb44-38"><a href="#cb44-38" aria-hidden="true" tabindex="-1"></a>  svd_econ<span class="op">(</span>U<span class="op">,</span> s<span class="op">,</span> V<span class="op">,</span> X<span class="op">.</span>t<span class="op">());</span></span>
<span id="cb44-39"><a href="#cb44-39" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-40"><a href="#cb44-40" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Factor loadings (first n_factors principal components)</span></span>
<span id="cb44-41"><a href="#cb44-41" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Lambda <span class="op">=</span> U<span class="op">.</span>cols<span class="op">(</span><span class="dv">0</span><span class="op">,</span> n_factors<span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb44-42"><a href="#cb44-42" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-43"><a href="#cb44-43" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Common factors (T x n_factors)</span></span>
<span id="cb44-44"><a href="#cb44-44" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F <span class="op">=</span> X <span class="op">*</span> Lambda<span class="op">;</span></span>
<span id="cb44-45"><a href="#cb44-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-46"><a href="#cb44-46" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">std::</span>make_pair<span class="op">(</span>F<span class="op">,</span> Lambda<span class="op">);</span></span>
<span id="cb44-47"><a href="#cb44-47" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-48"><a href="#cb44-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-49"><a href="#cb44-49" aria-hidden="true" tabindex="-1"></a><span class="co">// Initialize DFM parameters using PCA</span></span>
<span id="cb44-50"><a href="#cb44-50" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>tuple<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;</span> <span class="va">dfm_init_</span><span class="op">(</span></span>
<span id="cb44-51"><a href="#cb44-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> X<span class="op">,</span> <span class="dt">int</span> n_factors<span class="op">,</span> <span class="dt">int</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-52"><a href="#cb44-52" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> X<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb44-53"><a href="#cb44-53" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-54"><a href="#cb44-54" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Step 1: Extract factors using PCA</span></span>
<span id="cb44-55"><a href="#cb44-55" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> factor_result <span class="op">=</span> <span class="va">dfm_extract_factors_</span><span class="op">(</span>X<span class="op">,</span> n_factors<span class="op">);</span></span>
<span id="cb44-56"><a href="#cb44-56" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F <span class="op">=</span> factor_result<span class="op">.</span>first<span class="op">;</span></span>
<span id="cb44-57"><a href="#cb44-57" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Lambda <span class="op">=</span> factor_result<span class="op">.</span>second<span class="op">;</span></span>
<span id="cb44-58"><a href="#cb44-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-59"><a href="#cb44-59" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Step 2: Estimate factor dynamics F_t = A * F_{t-1} + eta_t</span></span>
<span id="cb44-60"><a href="#cb44-60" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Convert VAR(p) to VAR(1) in companion form</span></span>
<span id="cb44-61"><a href="#cb44-61" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> A<span class="op">;</span></span>
<span id="cb44-62"><a href="#cb44-62" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Q<span class="op">;</span></span>
<span id="cb44-63"><a href="#cb44-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-64"><a href="#cb44-64" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>p <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-65"><a href="#cb44-65" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Estimate VAR(p) for factors</span></span>
<span id="cb44-66"><a href="#cb44-66" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> A_var <span class="op">=</span> <span class="va">var_estimate_</span><span class="op">(</span>as_doubles_matrix<span class="op">(</span>F<span class="op">),</span> p<span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb44-67"><a href="#cb44-67" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-68"><a href="#cb44-68" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Create companion form matrix</span></span>
<span id="cb44-69"><a href="#cb44-69" aria-hidden="true" tabindex="-1"></a>    A <span class="op">=</span> <span class="va">var_companion_</span><span class="op">(</span>A_var<span class="op">,</span> p<span class="op">,</span> n_factors<span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb44-70"><a href="#cb44-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-71"><a href="#cb44-71" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Compute residual covariance</span></span>
<span id="cb44-72"><a href="#cb44-72" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> fitted_resid <span class="op">=</span> <span class="va">var_fitted_resid_</span><span class="op">(</span>F<span class="op">,</span> A_var<span class="op">,</span> p<span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb44-73"><a href="#cb44-73" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> eta <span class="op">=</span> fitted_resid<span class="op">.</span>second<span class="op">;</span></span>
<span id="cb44-74"><a href="#cb44-74" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-75"><a href="#cb44-75" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Q is for the companion form (only top-left block is non-zero)</span></span>
<span id="cb44-76"><a href="#cb44-76" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> state_dim <span class="op">=</span> n_factors <span class="op">*</span> p<span class="op">;</span></span>
<span id="cb44-77"><a href="#cb44-77" aria-hidden="true" tabindex="-1"></a>    Q <span class="op">=</span> zeros<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;(</span>state_dim<span class="op">,</span> state_dim<span class="op">);</span></span>
<span id="cb44-78"><a href="#cb44-78" aria-hidden="true" tabindex="-1"></a>    Q<span class="op">.</span>submat<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> n_factors<span class="op">-</span><span class="dv">1</span><span class="op">,</span> n_factors<span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">=</span> <span class="op">(</span>eta<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> eta<span class="op">)</span> <span class="op">/</span> eta<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb44-79"><a href="#cb44-79" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb44-80"><a href="#cb44-80" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Static factor model: F_t = constant (no dynamics)</span></span>
<span id="cb44-81"><a href="#cb44-81" aria-hidden="true" tabindex="-1"></a>    A <span class="op">=</span> eye<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;(</span>n_factors<span class="op">,</span> n_factors<span class="op">);</span></span>
<span id="cb44-82"><a href="#cb44-82" aria-hidden="true" tabindex="-1"></a>    Q <span class="op">=</span> eye<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;(</span>n_factors<span class="op">,</span> n_factors<span class="op">)</span> <span class="op">*</span> <span class="fl">0.01</span><span class="op">;</span></span>
<span id="cb44-83"><a href="#cb44-83" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb44-84"><a href="#cb44-84" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-85"><a href="#cb44-85" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Initialize R as diagonal (idiosyncratic errors)</span></span>
<span id="cb44-86"><a href="#cb44-86" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X_fitted <span class="op">=</span> F<span class="op">.</span>cols<span class="op">(</span><span class="dv">0</span><span class="op">,</span> n_factors<span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">*</span> Lambda<span class="op">.</span>t<span class="op">();</span></span>
<span id="cb44-87"><a href="#cb44-87" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> residuals <span class="op">=</span> X <span class="op">-</span> X_fitted<span class="op">;</span></span>
<span id="cb44-88"><a href="#cb44-88" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> R <span class="op">=</span> diagmat<span class="op">(</span>sum<span class="op">(</span>square<span class="op">(</span>residuals<span class="op">),</span> <span class="dv">0</span><span class="op">)</span> <span class="op">/</span> T<span class="op">);</span></span>
<span id="cb44-89"><a href="#cb44-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-90"><a href="#cb44-90" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">std::</span>make_tuple<span class="op">(</span>Lambda<span class="op">,</span> A<span class="op">,</span> Q<span class="op">,</span> R<span class="op">);</span></span>
<span id="cb44-91"><a href="#cb44-91" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-92"><a href="#cb44-92" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-93"><a href="#cb44-93" aria-hidden="true" tabindex="-1"></a><span class="co">// Kalman Filter for DFM state-space model</span></span>
<span id="cb44-94"><a href="#cb44-94" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>tuple<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> <span class="dt">double</span><span class="op">&gt;</span> <span class="va">dfm_kalman_</span><span class="op">(</span></span>
<span id="cb44-95"><a href="#cb44-95" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> X<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> Lambda<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> A<span class="op">,</span></span>
<span id="cb44-96"><a href="#cb44-96" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> Q<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> R<span class="op">,</span> <span class="dt">int</span> n_factors<span class="op">,</span> <span class="dt">int</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-97"><a href="#cb44-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-98"><a href="#cb44-98" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> X<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb44-99"><a href="#cb44-99" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> N <span class="op">=</span> X<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb44-100"><a href="#cb44-100" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> state_dim <span class="op">=</span> <span class="op">(</span>p <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">?</span> n_factors <span class="op">*</span> p <span class="op">:</span> n_factors<span class="op">;</span></span>
<span id="cb44-101"><a href="#cb44-101" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-102"><a href="#cb44-102" aria-hidden="true" tabindex="-1"></a>  <span class="co">// State variables</span></span>
<span id="cb44-103"><a href="#cb44-103" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_pred<span class="op">(</span>T<span class="op">,</span> state_dim<span class="op">);</span>  <span class="co">// Predicted states</span></span>
<span id="cb44-104"><a href="#cb44-104" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_upd<span class="op">(</span>T<span class="op">,</span> state_dim<span class="op">);</span>   <span class="co">// Updated states</span></span>
<span id="cb44-105"><a href="#cb44-105" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> P_pred<span class="op">(</span>state_dim<span class="op">,</span> state_dim<span class="op">);</span>  <span class="co">// Predicted covariance</span></span>
<span id="cb44-106"><a href="#cb44-106" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> P_upd<span class="op">(</span>state_dim<span class="op">,</span> state_dim<span class="op">);</span>   <span class="co">// Updated covariance</span></span>
<span id="cb44-107"><a href="#cb44-107" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-108"><a href="#cb44-108" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Log likelihood</span></span>
<span id="cb44-109"><a href="#cb44-109" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> loglik <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb44-110"><a href="#cb44-110" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-111"><a href="#cb44-111" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Observation matrix H: maps state to observables</span></span>
<span id="cb44-112"><a href="#cb44-112" aria-hidden="true" tabindex="-1"></a>  <span class="co">// X_t = H * F_t + u_t</span></span>
<span id="cb44-113"><a href="#cb44-113" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> H <span class="op">=</span> zeros<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;(</span>N<span class="op">,</span> state_dim<span class="op">);</span></span>
<span id="cb44-114"><a href="#cb44-114" aria-hidden="true" tabindex="-1"></a>  H<span class="op">.</span>submat<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> N<span class="op">-</span><span class="dv">1</span><span class="op">,</span> n_factors<span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">=</span> Lambda<span class="op">;</span>  <span class="co">// Only first n_factors matter</span></span>
<span id="cb44-115"><a href="#cb44-115" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-116"><a href="#cb44-116" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Transition matrix (A is already in companion form if p &gt; 1)</span></span>
<span id="cb44-117"><a href="#cb44-117" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_trans <span class="op">=</span> A<span class="op">;</span></span>
<span id="cb44-118"><a href="#cb44-118" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-119"><a href="#cb44-119" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Process noise covariance (Q is already in companion form)</span></span>
<span id="cb44-120"><a href="#cb44-120" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Q_full <span class="op">=</span> Q<span class="op">;</span></span>
<span id="cb44-121"><a href="#cb44-121" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-122"><a href="#cb44-122" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Initial conditions: diffuse prior</span></span>
<span id="cb44-123"><a href="#cb44-123" aria-hidden="true" tabindex="-1"></a>  vec mu0 <span class="op">=</span> zeros<span class="op">&lt;</span>vec<span class="op">&gt;(</span>state_dim<span class="op">);</span></span>
<span id="cb44-124"><a href="#cb44-124" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> P0 <span class="op">=</span> eye<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;(</span>state_dim<span class="op">,</span> state_dim<span class="op">)</span> <span class="op">*</span> <span class="fl">10.0</span><span class="op">;</span>  <span class="co">// Diffuse</span></span>
<span id="cb44-125"><a href="#cb44-125" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-126"><a href="#cb44-126" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Kalman filter loop</span></span>
<span id="cb44-127"><a href="#cb44-127" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> t <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> t <span class="op">&lt;</span> T<span class="op">;</span> <span class="op">++</span>t<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-128"><a href="#cb44-128" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Prediction step</span></span>
<span id="cb44-129"><a href="#cb44-129" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>t <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-130"><a href="#cb44-130" aria-hidden="true" tabindex="-1"></a>      F_pred<span class="op">.</span>row<span class="op">(</span>t<span class="op">)</span> <span class="op">=</span> mu0<span class="op">.</span>t<span class="op">();</span></span>
<span id="cb44-131"><a href="#cb44-131" aria-hidden="true" tabindex="-1"></a>      P_pred <span class="op">=</span> P0<span class="op">;</span></span>
<span id="cb44-132"><a href="#cb44-132" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb44-133"><a href="#cb44-133" aria-hidden="true" tabindex="-1"></a>      F_pred<span class="op">.</span>row<span class="op">(</span>t<span class="op">)</span> <span class="op">=</span> <span class="op">(</span>F_trans <span class="op">*</span> F_upd<span class="op">.</span>row<span class="op">(</span>t<span class="op">-</span><span class="dv">1</span><span class="op">).</span>t<span class="op">()).</span>t<span class="op">();</span></span>
<span id="cb44-134"><a href="#cb44-134" aria-hidden="true" tabindex="-1"></a>      P_pred <span class="op">=</span> F_trans <span class="op">*</span> P_upd <span class="op">*</span> F_trans<span class="op">.</span>t<span class="op">()</span> <span class="op">+</span> Q_full<span class="op">;</span></span>
<span id="cb44-135"><a href="#cb44-135" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb44-136"><a href="#cb44-136" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-137"><a href="#cb44-137" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update step</span></span>
<span id="cb44-138"><a href="#cb44-138" aria-hidden="true" tabindex="-1"></a>    vec <span class="dt">y_t</span> <span class="op">=</span> X<span class="op">.</span>row<span class="op">(</span>t<span class="op">).</span>t<span class="op">();</span></span>
<span id="cb44-139"><a href="#cb44-139" aria-hidden="true" tabindex="-1"></a>    vec y_pred <span class="op">=</span> H <span class="op">*</span> F_pred<span class="op">.</span>row<span class="op">(</span>t<span class="op">).</span>t<span class="op">();</span></span>
<span id="cb44-140"><a href="#cb44-140" aria-hidden="true" tabindex="-1"></a>    vec innov <span class="op">=</span> <span class="dt">y_t</span> <span class="op">-</span> y_pred<span class="op">;</span></span>
<span id="cb44-141"><a href="#cb44-141" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-142"><a href="#cb44-142" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> S <span class="op">=</span> H <span class="op">*</span> P_pred <span class="op">*</span> H<span class="op">.</span>t<span class="op">()</span> <span class="op">+</span> R<span class="op">;</span></span>
<span id="cb44-143"><a href="#cb44-143" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> K <span class="op">=</span> P_pred <span class="op">*</span> H<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> inv<span class="op">(</span>S<span class="op">);</span></span>
<span id="cb44-144"><a href="#cb44-144" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-145"><a href="#cb44-145" aria-hidden="true" tabindex="-1"></a>    F_upd<span class="op">.</span>row<span class="op">(</span>t<span class="op">)</span> <span class="op">=</span> F_pred<span class="op">.</span>row<span class="op">(</span>t<span class="op">)</span> <span class="op">+</span> <span class="op">(</span>K <span class="op">*</span> innov<span class="op">).</span>t<span class="op">();</span></span>
<span id="cb44-146"><a href="#cb44-146" aria-hidden="true" tabindex="-1"></a>    P_upd <span class="op">=</span> <span class="op">(</span>eye<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;(</span>state_dim<span class="op">,</span> state_dim<span class="op">)</span> <span class="op">-</span> K <span class="op">*</span> H<span class="op">)</span> <span class="op">*</span> P_pred<span class="op">;</span></span>
<span id="cb44-147"><a href="#cb44-147" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-148"><a href="#cb44-148" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Log likelihood contribution</span></span>
<span id="cb44-149"><a href="#cb44-149" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> log_det_S <span class="op">=</span> log<span class="op">(</span>det<span class="op">(</span>S<span class="op">));</span></span>
<span id="cb44-150"><a href="#cb44-150" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> mahal <span class="op">=</span> dot<span class="op">(</span>innov<span class="op">,</span> solve<span class="op">(</span>S<span class="op">,</span> innov<span class="op">));</span></span>
<span id="cb44-151"><a href="#cb44-151" aria-hidden="true" tabindex="-1"></a>    loglik <span class="op">+=</span> <span class="op">-</span><span class="fl">0.5</span> <span class="op">*</span> <span class="op">(</span>N <span class="op">*</span> log<span class="op">(</span><span class="dv">2</span> <span class="op">*</span> datum<span class="op">::</span>pi<span class="op">)</span> <span class="op">+</span> log_det_S <span class="op">+</span> mahal<span class="op">);</span></span>
<span id="cb44-152"><a href="#cb44-152" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb44-153"><a href="#cb44-153" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-154"><a href="#cb44-154" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Extract just the factors (first n_factors columns of state)</span></span>
<span id="cb44-155"><a href="#cb44-155" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_smooth <span class="op">=</span> F_upd<span class="op">.</span>cols<span class="op">(</span><span class="dv">0</span><span class="op">,</span> n_factors<span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb44-156"><a href="#cb44-156" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-157"><a href="#cb44-157" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">std::</span>make_tuple<span class="op">(</span>F_smooth<span class="op">,</span> F_upd<span class="op">,</span> loglik<span class="op">);</span></span>
<span id="cb44-158"><a href="#cb44-158" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-159"><a href="#cb44-159" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-160"><a href="#cb44-160" aria-hidden="true" tabindex="-1"></a><span class="co">// EM Algorithm for DFM parameter estimation</span></span>
<span id="cb44-161"><a href="#cb44-161" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>tuple<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;</span> <span class="va">dfm_em_</span><span class="op">(</span></span>
<span id="cb44-162"><a href="#cb44-162" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> X<span class="op">,</span> <span class="dt">int</span> n_factors<span class="op">,</span> <span class="dt">int</span> p<span class="op">,</span> <span class="dt">int</span> max_iter <span class="op">=</span> <span class="dv">50</span><span class="op">,</span> <span class="dt">double</span> tol <span class="op">=</span> <span class="fl">1e-4</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-163"><a href="#cb44-163" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> X<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb44-164"><a href="#cb44-164" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-165"><a href="#cb44-165" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Initialize parameters</span></span>
<span id="cb44-166"><a href="#cb44-166" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> init_params <span class="op">=</span> <span class="va">dfm_init_</span><span class="op">(</span>X<span class="op">,</span> n_factors<span class="op">,</span> p<span class="op">);</span></span>
<span id="cb44-167"><a href="#cb44-167" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Lambda <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">0</span><span class="op">&gt;(</span>init_params<span class="op">);</span></span>
<span id="cb44-168"><a href="#cb44-168" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> A <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">1</span><span class="op">&gt;(</span>init_params<span class="op">);</span></span>
<span id="cb44-169"><a href="#cb44-169" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Q <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">2</span><span class="op">&gt;(</span>init_params<span class="op">);</span></span>
<span id="cb44-170"><a href="#cb44-170" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> R <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">3</span><span class="op">&gt;(</span>init_params<span class="op">);</span></span>
<span id="cb44-171"><a href="#cb44-171" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-172"><a href="#cb44-172" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> prev_loglik <span class="op">=</span> <span class="op">-</span>datum<span class="op">::</span>inf<span class="op">;</span></span>
<span id="cb44-173"><a href="#cb44-173" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-174"><a href="#cb44-174" aria-hidden="true" tabindex="-1"></a>  <span class="co">// EM iterations</span></span>
<span id="cb44-175"><a href="#cb44-175" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> iter <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> iter <span class="op">&lt;</span> max_iter<span class="op">;</span> <span class="op">++</span>iter<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-176"><a href="#cb44-176" aria-hidden="true" tabindex="-1"></a>    <span class="co">// E-step: Kalman filter to get expected factors</span></span>
<span id="cb44-177"><a href="#cb44-177" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> kalman_result <span class="op">=</span> <span class="va">dfm_kalman_</span><span class="op">(</span>X<span class="op">,</span> Lambda<span class="op">,</span> A<span class="op">,</span> Q<span class="op">,</span> R<span class="op">,</span> n_factors<span class="op">,</span> p<span class="op">);</span></span>
<span id="cb44-178"><a href="#cb44-178" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_smooth <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">0</span><span class="op">&gt;(</span>kalman_result<span class="op">);</span></span>
<span id="cb44-179"><a href="#cb44-179" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> loglik <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">2</span><span class="op">&gt;(</span>kalman_result<span class="op">);</span></span>
<span id="cb44-180"><a href="#cb44-180" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-181"><a href="#cb44-181" aria-hidden="true" tabindex="-1"></a>    <span class="co">// M-step: Update parameters given expected factors</span></span>
<span id="cb44-182"><a href="#cb44-182" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-183"><a href="#cb44-183" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update Lambda: X_t = Lambda * F_t + u_t</span></span>
<span id="cb44-184"><a href="#cb44-184" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Lambda_new = (sum_t X_t F_t') * (sum_t F_t F_t')^{-1}</span></span>
<span id="cb44-185"><a href="#cb44-185" aria-hidden="true" tabindex="-1"></a>    Lambda <span class="op">=</span> <span class="op">(</span>X<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> F_smooth<span class="op">)</span> <span class="op">*</span> inv<span class="op">(</span>F_smooth<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> F_smooth<span class="op">);</span></span>
<span id="cb44-186"><a href="#cb44-186" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-187"><a href="#cb44-187" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update R (diagonal idiosyncratic covariance)</span></span>
<span id="cb44-188"><a href="#cb44-188" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> residuals <span class="op">=</span> X <span class="op">-</span> F_smooth <span class="op">*</span> Lambda<span class="op">.</span>t<span class="op">();</span></span>
<span id="cb44-189"><a href="#cb44-189" aria-hidden="true" tabindex="-1"></a>    R <span class="op">=</span> diagmat<span class="op">(</span>sum<span class="op">(</span>square<span class="op">(</span>residuals<span class="op">),</span> <span class="dv">0</span><span class="op">)</span> <span class="op">/</span> T<span class="op">);</span></span>
<span id="cb44-190"><a href="#cb44-190" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-191"><a href="#cb44-191" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update A and Q (factor dynamics)</span></span>
<span id="cb44-192"><a href="#cb44-192" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>p <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-193"><a href="#cb44-193" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Re-estimate VAR(p) for updated factors</span></span>
<span id="cb44-194"><a href="#cb44-194" aria-hidden="true" tabindex="-1"></a>      Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> A_var <span class="op">=</span> <span class="va">var_estimate_</span><span class="op">(</span>as_doubles_matrix<span class="op">(</span>F_smooth<span class="op">),</span> p<span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb44-195"><a href="#cb44-195" aria-hidden="true" tabindex="-1"></a>      A <span class="op">=</span> <span class="va">var_companion_</span><span class="op">(</span>A_var<span class="op">,</span> p<span class="op">,</span> n_factors<span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb44-196"><a href="#cb44-196" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb44-197"><a href="#cb44-197" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Update Q</span></span>
<span id="cb44-198"><a href="#cb44-198" aria-hidden="true" tabindex="-1"></a>      <span class="kw">auto</span> factor_resid <span class="op">=</span> <span class="va">var_fitted_resid_</span><span class="op">(</span>F_smooth<span class="op">,</span> A_var<span class="op">,</span> p<span class="op">,</span> <span class="kw">false</span><span class="op">);</span></span>
<span id="cb44-199"><a href="#cb44-199" aria-hidden="true" tabindex="-1"></a>      Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> eta <span class="op">=</span> factor_resid<span class="op">.</span>second<span class="op">;</span></span>
<span id="cb44-200"><a href="#cb44-200" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb44-201"><a href="#cb44-201" aria-hidden="true" tabindex="-1"></a>      <span class="dt">int</span> state_dim <span class="op">=</span> n_factors <span class="op">*</span> p<span class="op">;</span></span>
<span id="cb44-202"><a href="#cb44-202" aria-hidden="true" tabindex="-1"></a>      Q <span class="op">=</span> zeros<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;(</span>state_dim<span class="op">,</span> state_dim<span class="op">);</span></span>
<span id="cb44-203"><a href="#cb44-203" aria-hidden="true" tabindex="-1"></a>      Q<span class="op">.</span>submat<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> n_factors<span class="op">-</span><span class="dv">1</span><span class="op">,</span> n_factors<span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">=</span> <span class="op">(</span>eta<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> eta<span class="op">)</span> <span class="op">/</span> eta<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb44-204"><a href="#cb44-204" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb44-205"><a href="#cb44-205" aria-hidden="true" tabindex="-1"></a>    <span class="co">// For static model (p=0), A and Q remain fixed</span></span>
<span id="cb44-206"><a href="#cb44-206" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-207"><a href="#cb44-207" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Check convergence</span></span>
<span id="cb44-208"><a href="#cb44-208" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>iter <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> abs<span class="op">(</span>loglik <span class="op">-</span> prev_loglik<span class="op">)</span> <span class="op">&lt;</span> tol<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-209"><a href="#cb44-209" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb44-210"><a href="#cb44-210" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb44-211"><a href="#cb44-211" aria-hidden="true" tabindex="-1"></a>    prev_loglik <span class="op">=</span> loglik<span class="op">;</span></span>
<span id="cb44-212"><a href="#cb44-212" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb44-213"><a href="#cb44-213" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-214"><a href="#cb44-214" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">std::</span>make_tuple<span class="op">(</span>Lambda<span class="op">,</span> A<span class="op">,</span> Q<span class="op">,</span> R<span class="op">);</span></span>
<span id="cb44-215"><a href="#cb44-215" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-216"><a href="#cb44-216" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-217"><a href="#cb44-217" aria-hidden="true" tabindex="-1"></a><span class="co">// DFM forecasting using state-space representation</span></span>
<span id="cb44-218"><a href="#cb44-218" aria-hidden="true" tabindex="-1"></a>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> <span class="va">dfm_forecast_</span><span class="op">(</span><span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> F_state<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> Lambda<span class="op">,</span></span>
<span id="cb44-219"><a href="#cb44-219" aria-hidden="true" tabindex="-1"></a>                         <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> A<span class="op">,</span> <span class="dt">int</span> n_factors<span class="op">,</span> <span class="dt">int</span> p<span class="op">,</span> <span class="dt">int</span> h<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-220"><a href="#cb44-220" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> N <span class="op">=</span> Lambda<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb44-221"><a href="#cb44-221" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-222"><a href="#cb44-222" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Initialize forecasts</span></span>
<span id="cb44-223"><a href="#cb44-223" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_forecast<span class="op">(</span>h<span class="op">,</span> n_factors<span class="op">);</span></span>
<span id="cb44-224"><a href="#cb44-224" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X_forecast<span class="op">(</span>h<span class="op">,</span> N<span class="op">);</span></span>
<span id="cb44-225"><a href="#cb44-225" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-226"><a href="#cb44-226" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Current state (last row of F_state which is in companion form)</span></span>
<span id="cb44-227"><a href="#cb44-227" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_current <span class="op">=</span> F_state<span class="op">.</span>row<span class="op">(</span>F_state<span class="op">.</span>n_rows <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb44-228"><a href="#cb44-228" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-229"><a href="#cb44-229" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Forecast loop</span></span>
<span id="cb44-230"><a href="#cb44-230" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> h<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-231"><a href="#cb44-231" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Predict next state: F_{t+h} = A^h * F_t</span></span>
<span id="cb44-232"><a href="#cb44-232" aria-hidden="true" tabindex="-1"></a>    F_current <span class="op">=</span> <span class="op">(</span>A <span class="op">*</span> F_current<span class="op">.</span>t<span class="op">()).</span>t<span class="op">();</span></span>
<span id="cb44-233"><a href="#cb44-233" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-234"><a href="#cb44-234" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Extract actual factors (first n_factors elements of state)</span></span>
<span id="cb44-235"><a href="#cb44-235" aria-hidden="true" tabindex="-1"></a>    F_forecast<span class="op">.</span>row<span class="op">(</span>i<span class="op">)</span> <span class="op">=</span> F_current<span class="op">.</span>cols<span class="op">(</span><span class="dv">0</span><span class="op">,</span> n_factors <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb44-236"><a href="#cb44-236" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-237"><a href="#cb44-237" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Forecast observables: X_{t+h} = Lambda * F_{t+h}</span></span>
<span id="cb44-238"><a href="#cb44-238" aria-hidden="true" tabindex="-1"></a>    X_forecast<span class="op">.</span>row<span class="op">(</span>i<span class="op">)</span> <span class="op">=</span> <span class="op">(</span>Lambda <span class="op">*</span> F_forecast<span class="op">.</span>row<span class="op">(</span>i<span class="op">).</span>t<span class="op">()).</span>t<span class="op">();</span></span>
<span id="cb44-239"><a href="#cb44-239" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb44-240"><a href="#cb44-240" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-241"><a href="#cb44-241" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> X_forecast<span class="op">;</span></span>
<span id="cb44-242"><a href="#cb44-242" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb44-243"><a href="#cb44-243" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-244"><a href="#cb44-244" aria-hidden="true" tabindex="-1"></a><span class="co">/* roxygen</span></span>
<span id="cb44-245"><a href="#cb44-245" aria-hidden="true" tabindex="-1"></a><span class="co">@title Dynamic Factor Model (DFM)</span></span>
<span id="cb44-246"><a href="#cb44-246" aria-hidden="true" tabindex="-1"></a><span class="co">@description Estimates a Dynamic Factor Model using PCA initialization and EM algorithm with Kalman filter.</span></span>
<span id="cb44-247"><a href="#cb44-247" aria-hidden="true" tabindex="-1"></a><span class="co">@param x Matrix of observed variables (T x N)</span></span>
<span id="cb44-248"><a href="#cb44-248" aria-hidden="true" tabindex="-1"></a><span class="co">@param n_factors Number of latent factors (r &lt; N)</span></span>
<span id="cb44-249"><a href="#cb44-249" aria-hidden="true" tabindex="-1"></a><span class="co">@param p VAR lag order for factor dynamics (0 for static model, recommend p=1 for small samples)</span></span>
<span id="cb44-250"><a href="#cb44-250" aria-hidden="true" tabindex="-1"></a><span class="co">@param max_iter Maximum EM iterations</span></span>
<span id="cb44-251"><a href="#cb44-251" aria-hidden="true" tabindex="-1"></a><span class="co">@param tol Convergence tolerance for log-likelihood</span></span>
<span id="cb44-252"><a href="#cb44-252" aria-hidden="true" tabindex="-1"></a><span class="co">@param forecast_h Forecast horizon (0 for no forecast)</span></span>
<span id="cb44-253"><a href="#cb44-253" aria-hidden="true" tabindex="-1"></a><span class="co">@export</span></span>
<span id="cb44-254"><a href="#cb44-254" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb44-255"><a href="#cb44-255" aria-hidden="true" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp4r</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span> list dfm_model<span class="op">(</span><span class="at">const</span> doubles_matrix<span class="op">&lt;&gt;&amp;</span> x<span class="op">,</span> <span class="dt">int</span> n_factors<span class="op">,</span> <span class="dt">int</span> p <span class="op">=</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb44-256"><a href="#cb44-256" aria-hidden="true" tabindex="-1"></a>                                   <span class="dt">int</span> max_iter <span class="op">=</span> <span class="dv">50</span><span class="op">,</span> <span class="dt">double</span> tol <span class="op">=</span> <span class="fl">1e-4</span><span class="op">,</span> <span class="dt">int</span> forecast_h <span class="op">=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-257"><a href="#cb44-257" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X_raw <span class="op">=</span> as_Mat<span class="op">(</span>x<span class="op">);</span></span>
<span id="cb44-258"><a href="#cb44-258" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> X_raw<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb44-259"><a href="#cb44-259" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> N <span class="op">=</span> X_raw<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb44-260"><a href="#cb44-260" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-261"><a href="#cb44-261" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>T <span class="op">&lt;=</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-262"><a href="#cb44-262" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span><span class="st">"Sample size must be greater than lag order p"</span><span class="op">);</span></span>
<span id="cb44-263"><a href="#cb44-263" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb44-264"><a href="#cb44-264" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-265"><a href="#cb44-265" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>n_factors <span class="op">&gt;=</span> N<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-266"><a href="#cb44-266" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span><span class="st">"Number of factors must be less than number of variables"</span><span class="op">);</span></span>
<span id="cb44-267"><a href="#cb44-267" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb44-268"><a href="#cb44-268" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-269"><a href="#cb44-269" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Standardize data to mean 0 and common variance</span></span>
<span id="cb44-270"><a href="#cb44-270" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> standardize_result <span class="op">=</span> <span class="va">dfm_standardize_</span><span class="op">(</span>X_raw<span class="op">);</span></span>
<span id="cb44-271"><a href="#cb44-271" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">0</span><span class="op">&gt;(</span>standardize_result<span class="op">);</span></span>
<span id="cb44-272"><a href="#cb44-272" aria-hidden="true" tabindex="-1"></a>  rowvec means <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">1</span><span class="op">&gt;(</span>standardize_result<span class="op">);</span></span>
<span id="cb44-273"><a href="#cb44-273" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> common_sd <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">2</span><span class="op">&gt;(</span>standardize_result<span class="op">);</span></span>
<span id="cb44-274"><a href="#cb44-274" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-275"><a href="#cb44-275" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Estimate DFM parameters using EM algorithm</span></span>
<span id="cb44-276"><a href="#cb44-276" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> em_result <span class="op">=</span> <span class="va">dfm_em_</span><span class="op">(</span>X<span class="op">,</span> n_factors<span class="op">,</span> p<span class="op">,</span> max_iter<span class="op">,</span> tol<span class="op">);</span></span>
<span id="cb44-277"><a href="#cb44-277" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Lambda <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">0</span><span class="op">&gt;(</span>em_result<span class="op">);</span></span>
<span id="cb44-278"><a href="#cb44-278" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> A <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">1</span><span class="op">&gt;(</span>em_result<span class="op">);</span></span>
<span id="cb44-279"><a href="#cb44-279" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Q <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">2</span><span class="op">&gt;(</span>em_result<span class="op">);</span></span>
<span id="cb44-280"><a href="#cb44-280" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> R <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">3</span><span class="op">&gt;(</span>em_result<span class="op">);</span></span>
<span id="cb44-281"><a href="#cb44-281" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-282"><a href="#cb44-282" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Final Kalman filter to get smoothed factors</span></span>
<span id="cb44-283"><a href="#cb44-283" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> kalman_result <span class="op">=</span> <span class="va">dfm_kalman_</span><span class="op">(</span>X<span class="op">,</span> Lambda<span class="op">,</span> A<span class="op">,</span> Q<span class="op">,</span> R<span class="op">,</span> n_factors<span class="op">,</span> p<span class="op">);</span></span>
<span id="cb44-284"><a href="#cb44-284" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">0</span><span class="op">&gt;(</span>kalman_result<span class="op">);</span></span>
<span id="cb44-285"><a href="#cb44-285" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_state <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">1</span><span class="op">&gt;(</span>kalman_result<span class="op">);</span></span>
<span id="cb44-286"><a href="#cb44-286" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> loglik <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">2</span><span class="op">&gt;(</span>kalman_result<span class="op">);</span></span>
<span id="cb44-287"><a href="#cb44-287" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-288"><a href="#cb44-288" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute fitted values on standardized scale</span></span>
<span id="cb44-289"><a href="#cb44-289" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X_fitted_std <span class="op">=</span> F <span class="op">*</span> Lambda<span class="op">.</span>t<span class="op">();</span></span>
<span id="cb44-290"><a href="#cb44-290" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> residuals_std <span class="op">=</span> X <span class="op">-</span> X_fitted_std<span class="op">;</span></span>
<span id="cb44-291"><a href="#cb44-291" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-292"><a href="#cb44-292" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Unstandardize fitted values to original scale</span></span>
<span id="cb44-293"><a href="#cb44-293" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X_fitted <span class="op">=</span> <span class="va">dfm_unstandardize_</span><span class="op">(</span>X_fitted_std<span class="op">,</span> means<span class="op">,</span> common_sd<span class="op">);</span></span>
<span id="cb44-294"><a href="#cb44-294" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> residuals <span class="op">=</span> X_raw <span class="op">-</span> X_fitted<span class="op">;</span></span>
<span id="cb44-295"><a href="#cb44-295" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-296"><a href="#cb44-296" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Information criteria</span></span>
<span id="cb44-297"><a href="#cb44-297" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n_params <span class="op">=</span> N <span class="op">*</span> n_factors <span class="op">+</span>  <span class="co">// Lambda</span></span>
<span id="cb44-298"><a href="#cb44-298" aria-hidden="true" tabindex="-1"></a>                 n_factors <span class="op">*</span> n_factors <span class="op">*</span> p <span class="op">+</span>  <span class="co">// A (in companion form)</span></span>
<span id="cb44-299"><a href="#cb44-299" aria-hidden="true" tabindex="-1"></a>                 n_factors <span class="op">*</span> n_factors <span class="op">+</span>  <span class="co">// Q</span></span>
<span id="cb44-300"><a href="#cb44-300" aria-hidden="true" tabindex="-1"></a>                 N<span class="op">;</span>  <span class="co">// R (diagonal)</span></span>
<span id="cb44-301"><a href="#cb44-301" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> aic <span class="op">=</span> aic_metric<span class="op">(</span>residuals<span class="op">,</span> n_params<span class="op">);</span></span>
<span id="cb44-302"><a href="#cb44-302" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-303"><a href="#cb44-303" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Prepare results list</span></span>
<span id="cb44-304"><a href="#cb44-304" aria-hidden="true" tabindex="-1"></a>  writable<span class="op">::</span>list result<span class="op">;</span></span>
<span id="cb44-305"><a href="#cb44-305" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-306"><a href="#cb44-306" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"factors"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>F<span class="op">)});</span></span>
<span id="cb44-307"><a href="#cb44-307" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"loadings"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>Lambda<span class="op">)});</span></span>
<span id="cb44-308"><a href="#cb44-308" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"transition"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>A<span class="op">)});</span></span>
<span id="cb44-309"><a href="#cb44-309" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"factor_cov"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>Q<span class="op">)});</span></span>
<span id="cb44-310"><a href="#cb44-310" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"idiosync_cov"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>R<span class="op">)});</span></span>
<span id="cb44-311"><a href="#cb44-311" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-312"><a href="#cb44-312" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"fitted_values"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>X_fitted<span class="op">)});</span></span>
<span id="cb44-313"><a href="#cb44-313" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"residuals"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>residuals<span class="op">)});</span></span>
<span id="cb44-314"><a href="#cb44-314" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"loglik"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>loglik<span class="op">)});</span></span>
<span id="cb44-315"><a href="#cb44-315" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"n_factors"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>n_factors<span class="op">)});</span></span>
<span id="cb44-316"><a href="#cb44-316" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"lag_order"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>p<span class="op">)});</span></span>
<span id="cb44-317"><a href="#cb44-317" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb44-318"><a href="#cb44-318" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"n_variables"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>N<span class="op">)});</span></span>
<span id="cb44-319"><a href="#cb44-319" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"n_obs"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>T<span class="op">)});</span></span>
<span id="cb44-320"><a href="#cb44-320" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-321"><a href="#cb44-321" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute RMSFE and MAE for first variable (ORIGINAL scale)</span></span>
<span id="cb44-322"><a href="#cb44-322" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"rmsfe"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>rmsfe<span class="op">(</span>X_raw<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">),</span> X_fitted<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">)))});</span></span>
<span id="cb44-323"><a href="#cb44-323" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"mae"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>mae<span class="op">(</span>X_raw<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">),</span> X_fitted<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">)))});</span></span>
<span id="cb44-324"><a href="#cb44-324" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"aic"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>aic<span class="op">)});</span></span>
<span id="cb44-325"><a href="#cb44-325" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-326"><a href="#cb44-326" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add forecasts if requested</span></span>
<span id="cb44-327"><a href="#cb44-327" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>forecast_h <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-328"><a href="#cb44-328" aria-hidden="true" tabindex="-1"></a>    <span class="co">// For forecasting, construct initial companion state from last p observations of F</span></span>
<span id="cb44-329"><a href="#cb44-329" aria-hidden="true" tabindex="-1"></a>    <span class="co">// F is T x n_factors, we need to create companion state [F_T, F_{T-1}, ..., F_{T-p+1}]</span></span>
<span id="cb44-330"><a href="#cb44-330" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_init_state<span class="op">;</span></span>
<span id="cb44-331"><a href="#cb44-331" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>p <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-332"><a href="#cb44-332" aria-hidden="true" tabindex="-1"></a>      <span class="dt">int</span> state_dim <span class="op">=</span> n_factors <span class="op">*</span> p<span class="op">;</span></span>
<span id="cb44-333"><a href="#cb44-333" aria-hidden="true" tabindex="-1"></a>      F_init_state <span class="op">=</span> zeros<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;(</span><span class="dv">1</span><span class="op">,</span> state_dim<span class="op">);</span></span>
<span id="cb44-334"><a href="#cb44-334" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> p<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-335"><a href="#cb44-335" aria-hidden="true" tabindex="-1"></a>        <span class="dt">int</span> t_idx <span class="op">=</span> T <span class="op">-</span> <span class="dv">1</span> <span class="op">-</span> i<span class="op">;</span>  <span class="co">// T-1, T-2, ..., T-p</span></span>
<span id="cb44-336"><a href="#cb44-336" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>t_idx <span class="op">&gt;=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb44-337"><a href="#cb44-337" aria-hidden="true" tabindex="-1"></a>          F_init_state<span class="op">.</span>cols<span class="op">(</span>i <span class="op">*</span> n_factors<span class="op">,</span> <span class="op">(</span>i <span class="op">+</span> <span class="dv">1</span><span class="op">)</span> <span class="op">*</span> n_factors <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">=</span> F<span class="op">.</span>row<span class="op">(</span>t_idx<span class="op">);</span></span>
<span id="cb44-338"><a href="#cb44-338" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb44-339"><a href="#cb44-339" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb44-340"><a href="#cb44-340" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb44-341"><a href="#cb44-341" aria-hidden="true" tabindex="-1"></a>      F_init_state <span class="op">=</span> F<span class="op">.</span>row<span class="op">(</span>T <span class="op">-</span> <span class="dv">1</span><span class="op">);</span>  <span class="co">// Just the last factor for static model</span></span>
<span id="cb44-342"><a href="#cb44-342" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb44-343"><a href="#cb44-343" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-344"><a href="#cb44-344" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> forecasts_std <span class="op">=</span> <span class="va">dfm_forecast_</span><span class="op">(</span>F_init_state<span class="op">,</span> Lambda<span class="op">,</span> A<span class="op">,</span> n_factors<span class="op">,</span> p<span class="op">,</span> forecast_h<span class="op">);</span></span>
<span id="cb44-345"><a href="#cb44-345" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-346"><a href="#cb44-346" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Unstandardize forecasts to original scale</span></span>
<span id="cb44-347"><a href="#cb44-347" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> forecasts <span class="op">=</span> <span class="va">dfm_unstandardize_</span><span class="op">(</span>forecasts_std<span class="op">,</span> means<span class="op">,</span> common_sd<span class="op">);</span></span>
<span id="cb44-348"><a href="#cb44-348" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb44-349"><a href="#cb44-349" aria-hidden="true" tabindex="-1"></a>    result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"forecasts"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>forecasts<span class="op">)});</span></span>
<span id="cb44-350"><a href="#cb44-350" aria-hidden="true" tabindex="-1"></a>    result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"forecast_horizon"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>forecast_h<span class="op">)});</span></span>
<span id="cb44-351"><a href="#cb44-351" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb44-352"><a href="#cb44-352" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb44-353"><a href="#cb44-353" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb44-354"><a href="#cb44-354" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>

</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-hansen22" class="csl-entry" role="listitem">
Hansen, Bruce E. 2022. <em>Econometrics</em>. Princeton, New Jersey: Princeton University Press.
</div>
<div id="ref-sanderson24" class="csl-entry" role="listitem">
Sanderson, Conrad. 2024. <span>“Armadillo: <span>C</span>++ Library for Linear Algebra &amp; Scientific Computing.”</span> <a href="https://arma.sourceforge.net/speed.html">https://arma.sourceforge.net/speed.html</a>.
</div>
<div id="ref-sanderson16" class="csl-entry" role="listitem">
Sanderson, Conrad, and Ryan Curtin. 2016. <span>“Armadillo: A Template-Based <span>C</span>++ Library for Linear Algebra.”</span> <em>Journal of Open Source Software</em> 1 (2): 26. <a href="https://doi.org/10.21105/joss.00026">https://doi.org/10.21105/joss.00026</a>.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>