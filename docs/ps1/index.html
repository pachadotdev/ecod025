<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Mauricio Vargas Sepulveda">

<title>Problem Set 1</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="index_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap-813c323200a87c37e262811031999de4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-full toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#problem" id="toc-problem" class="nav-link active" data-scroll-target="#problem">Problem</a></li>
  <li><a href="#goal" id="toc-goal" class="nav-link" data-scroll-target="#goal">Goal</a></li>
  <li><a href="#github-repository" id="toc-github-repository" class="nav-link" data-scroll-target="#github-repository">GitHub repository</a></li>
  <li><a href="#technical-note" id="toc-technical-note" class="nav-link" data-scroll-target="#technical-note">Technical note</a></li>
  <li><a href="#models" id="toc-models" class="nav-link" data-scroll-target="#models">Models</a>
  <ul class="collapse">
  <li><a href="#vector-autoregressions-var" id="toc-vector-autoregressions-var" class="nav-link" data-scroll-target="#vector-autoregressions-var">Vector Autoregressions (VAR)</a></li>
  <li><a href="#factor-augmented-var-fa-var" id="toc-factor-augmented-var-fa-var" class="nav-link" data-scroll-target="#factor-augmented-var-fa-var">Factor-Augmented VAR (FA-VAR)</a></li>
  <li><a href="#dynamic-factor-model-dfm" id="toc-dynamic-factor-model-dfm" class="nav-link" data-scroll-target="#dynamic-factor-model-dfm">Dynamic Factor Model (DFM)</a></li>
  <li><a href="#forecast-comparison-metrics" id="toc-forecast-comparison-metrics" class="nav-link" data-scroll-target="#forecast-comparison-metrics">Forecast Comparison Metrics</a>
  <ul class="collapse">
  <li><a href="#root-mean-squared-forecast-error-rmsfe" id="toc-root-mean-squared-forecast-error-rmsfe" class="nav-link" data-scroll-target="#root-mean-squared-forecast-error-rmsfe">Root Mean Squared Forecast Error (RMSFE)</a></li>
  <li><a href="#mean-absolute-error-mae" id="toc-mean-absolute-error-mae" class="nav-link" data-scroll-target="#mean-absolute-error-mae">Mean Absolute Error (MAE)</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a></li>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation">Data preparation</a></li>
  <li><a href="#estimate-a-var-model" id="toc-estimate-a-var-model" class="nav-link" data-scroll-target="#estimate-a-var-model">Estimate a VAR model</a></li>
  <li><a href="#estimate-a-fa-var-model" id="toc-estimate-a-fa-var-model" class="nav-link" data-scroll-target="#estimate-a-fa-var-model">Estimate a FA-VAR model</a></li>
  <li><a href="#estimate-a-dfm-model" id="toc-estimate-a-dfm-model" class="nav-link" data-scroll-target="#estimate-a-dfm-model">Estimate a DFM model</a></li>
  <li><a href="#c-code" id="toc-c-code" class="nav-link" data-scroll-target="#c-code">C++ code</a>
  <ul class="collapse">
  <li><a href="#model-metrics" id="toc-model-metrics" class="nav-link" data-scroll-target="#model-metrics">Model metrics</a></li>
  <li><a href="#var-model" id="toc-var-model" class="nav-link" data-scroll-target="#var-model">VAR model</a></li>
  <li><a href="#fa-var-model" id="toc-fa-var-model" class="nav-link" data-scroll-target="#fa-var-model">FA-VAR model</a></li>
  <li><a href="#dfm-model" id="toc-dfm-model" class="nav-link" data-scroll-target="#dfm-model">DFM model</a></li>
  </ul></li>
  <li><a href="#references" id="toc-references" class="nav-link" data-scroll-target="#references">References</a></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content column-page-right" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Problem Set 1</h1>
</div>



<div class="quarto-title-meta column-page-right">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Mauricio Vargas Sepulveda </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="problem" class="level1">
<h1>Problem</h1>
<p>Recent headlines emphasize the challenges faced by central banks: inflation remains persistent in the U.S., global supply chain uncertainties continue, and growth forecasts remain fragile amid geopolitical risks.</p>
</section>
<section id="goal" class="level1">
<h1>Goal</h1>
<p>Provide policy recommendations for the Federal Reserve (Fed) new forecasting system.</p>
</section>
<section id="github-repository" class="level1">
<h1>GitHub repository</h1>
<p>All the codes and data for this problem set are available in the GitHub repository: <a href="https://github.com/pachadotdev/ecod025">https://github.com/pachadotdev/ecod025</a></p>
</section>
<section id="technical-note" class="level1">
<h1>Technical note</h1>
<p>For this problem set, the models were written in C++ using the Armadillo library for linear algebra <span class="citation" data-cites="sanderson16 sanderson24">(<a href="#ref-sanderson16" role="doc-biblioref">Sanderson and Curtin 2016</a>; <a href="#ref-sanderson24" role="doc-biblioref">Sanderson 2024</a>)</span>.</p>
<p>To run the model functions, you need to change this boolean to “TRUE”, otherwise when rendering the file it will load pre-computed results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>run_models <span class="ot">&lt;-</span> F</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The functions were made available in the R package <code>ecod025ps1</code> which can be installed from this same repository:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"ecod025ps1"</span>) <span class="sc">&amp;&amp;</span> run_models) {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>    repository <span class="ot">&lt;-</span> <span class="st">"https://cran.rstudio.com"</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"pak"</span>)) <span class="fu">install.packages</span>(<span class="st">"pak"</span>, <span class="at">repos =</span> repository)</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    pak<span class="sc">::</span><span class="fu">pkg_install</span>(<span class="st">"pachadotdev/ecod025/ecod025ps1"</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"dynlm"</span>)) <span class="fu">install.packages</span>(<span class="st">"dynlm"</span>)</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (run_models) {</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(ecod025ps1)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">library</span>(dynlm)</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>R package for accessing the data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"alfred"</span>)) <span class="fu">install.packages</span>(<span class="st">"alfred"</span>)</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(alfred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Additional packages for data manipulation and plotting:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"dplyr"</span>)) <span class="fu">install.packages</span>(<span class="st">"dplyr"</span>)</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"lubridate"</span>)) <span class="fu">install.packages</span>(<span class="st">"lubridate"</span>)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"rlang"</span>)) <span class="fu">install.packages</span>(<span class="st">"rlang"</span>)</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"purrr"</span>)) <span class="fu">install.packages</span>(<span class="st">"purrr"</span>)</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"ggplot2"</span>)) <span class="fu">install.packages</span>(<span class="st">"ggplot2"</span>)</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"tintin"</span>)) <span class="fu">install.packages</span>(<span class="st">"tintin"</span>)</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rlang)</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tintin)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="models" class="level1">
<h1>Models</h1>
<section id="vector-autoregressions-var" class="level2">
<h2 class="anchored" data-anchor-id="vector-autoregressions-var">Vector Autoregressions (VAR)</h2>
<p><span class="math inline">\(\text{VAR}(p)\)</span> for inflation (<span class="math inline">\(\pi_t\)</span>) and growth (<span class="math inline">\(g_t\)</span>):</p>
<p><span class="math display">\[
y_t = A_1 y_{t-1} + \ldots + Ap y_{t-p} + u_t,\: y_t = [\pi_t, g_t]^T.
\]</span></p>
</section>
<section id="factor-augmented-var-fa-var" class="level2">
<h2 class="anchored" data-anchor-id="factor-augmented-var-fa-var">Factor-Augmented VAR (FA-VAR)</h2>
<p><span class="math display">\[
\begin{aligned}
X_t &amp;= \Lambda F_t + e_t, \cr
F_t &amp;= \Phi_1 F_{t-1} + \ldots + \Phi_p F_{t-p} + v_t, \cr
y_t &amp;= B(L)y_{t-1} + C(L)F_{t} + u_t
\end{aligned}
\]</span></p>
</section>
<section id="dynamic-factor-model-dfm" class="level2">
<h2 class="anchored" data-anchor-id="dynamic-factor-model-dfm">Dynamic Factor Model (DFM)</h2>
<p><span class="math display">\[
\begin{aligned}
X_t &amp;= \Lambda F_t + e_t,\: e_t \sim N(0, R), \cr
F_t &amp;= AF_{t-1} + \eta_t,\: \eta_t \sim N(0, Q).
\end{aligned}
\]</span></p>
</section>
<section id="forecast-comparison-metrics" class="level2">
<h2 class="anchored" data-anchor-id="forecast-comparison-metrics">Forecast Comparison Metrics</h2>
<section id="root-mean-squared-forecast-error-rmsfe" class="level3">
<h3 class="anchored" data-anchor-id="root-mean-squared-forecast-error-rmsfe">Root Mean Squared Forecast Error (RMSFE)</h3>
<p><span class="math display">\[
\text{RMSFE} = \sqrt{\frac{1}{T} \sum_{t=1}^{T} (y_{t+h} - \hat{y}_{t+h \mid t})^2}.
\]</span></p>
</section>
<section id="mean-absolute-error-mae" class="level3">
<h3 class="anchored" data-anchor-id="mean-absolute-error-mae">Mean Absolute Error (MAE)</h3>
<p><span class="math display">\[
\text{MAE} = \frac{1}{T} \sum_{t=1}^{T} |y_{t+h} - \hat{y}_{t+h \mid t}|.
\]</span></p>
</section>
</section>
</section>
<section id="data" class="level1">
<h1>Data</h1>
<p>Get the different series used to measure inflation according to <a href="https://files.stlouisfed.org/files/htdocs/pageone-economics/uploads/Lessons/DataPracticeFRED_Measures_of_Inflation.pdf">FED</a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="fu">try</span>(<span class="fu">dir.create</span>(<span class="st">"data"</span>), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>download_data <span class="ot">&lt;-</span> <span class="cf">function</span>(series_id) {</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>    fout <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"data/"</span>, series_id, <span class="st">".rds"</span>)</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(fout)) {</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>        data <span class="ot">&lt;-</span> <span class="fu">get_alfred_series</span>(series_id)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>        data <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(data)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">saveRDS</span>(data, fout, <span class="at">compress =</span> <span class="st">"xz"</span>)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    } <span class="cf">else</span> {</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>        data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(fout)</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">return</span>(data)</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Consumer Price Index for All Urban Consumers: All Items</span></span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>cpiaucsl <span class="ot">&lt;-</span> <span class="fu">download_data</span>(<span class="st">"CPIAUCSL"</span>)</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Consumer Price Index for All Urban Consumers: All Items Less Food &amp; Energy</span></span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a>cpilfesl <span class="ot">&lt;-</span> <span class="fu">download_data</span>(<span class="st">"CPILFESL"</span>)</span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Consumer Price Index for All Urban Consumers: Energy</span></span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a>cpiengsl <span class="ot">&lt;-</span> <span class="fu">download_data</span>(<span class="st">"CPIENGSL"</span>)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Consumer Price Index for All Urban Consumers: Food</span></span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a>cpifood <span class="ot">&lt;-</span> <span class="fu">download_data</span>(<span class="st">"CPIUFDSL"</span>)</span>
<span id="cb5-26"><a href="#cb5-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-27"><a href="#cb5-27" aria-hidden="true" tabindex="-1"></a><span class="co"># GDP Deflator</span></span>
<span id="cb5-28"><a href="#cb5-28" aria-hidden="true" tabindex="-1"></a>gdpdef <span class="ot">&lt;-</span> <span class="fu">download_data</span>(<span class="st">"GDPDEF"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also require the ‘University of Michigan: Inflation Expectation (Median expected price change next 12 months)’ as a covariate:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># University of Michigan: Inflation Expectation (Median expected price change next 12 months)</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>michigan <span class="ot">&lt;-</span> <span class="fu">download_data</span>(<span class="st">"MICH"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-preparation" class="level1">
<h1>Data preparation</h1>
<p>We need to filter and differentiate to get inflation rates as</p>
<p><span class="math display">\[
\text{Inflation Rate}_t = 100 \times \frac{C_t - C_{t-1}}{C_{t-1}}
\]</span></p>
<p>We will use October data to compute the inflation rate to match the reported quarterly GDP data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>inflation_mm <span class="ot">&lt;-</span> <span class="cf">function</span>(data, col) {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>    data <span class="sc">%&gt;%</span></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">arrange</span>(<span class="fu">desc</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># keep the most updated figure</span></span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">group_by</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(realtime_period <span class="sc">==</span> <span class="fu">max</span>(realtime_period)) <span class="sc">%&gt;%</span></span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>        <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(date), <span class="at">month =</span> <span class="fu">month</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">filter</span>(month <span class="sc">==</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">inflation =</span> <span class="dv">100</span> <span class="sc">*</span> (<span class="sc">!!</span><span class="fu">sym</span>(col) <span class="sc">-</span> <span class="fu">lead</span>(<span class="sc">!!</span><span class="fu">sym</span>(col))) <span class="sc">/</span> <span class="fu">lead</span>(<span class="sc">!!</span><span class="fu">sym</span>(col)))</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>cpiaucsl_mm <span class="ot">&lt;-</span> <span class="fu">inflation_mm</span>(cpiaucsl, <span class="st">"CPIAUCSL"</span>)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>cpilfesl_mm <span class="ot">&lt;-</span> <span class="fu">inflation_mm</span>(cpilfesl, <span class="st">"CPILFESL"</span>)</span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>cpiengsl_mm <span class="ot">&lt;-</span> <span class="fu">inflation_mm</span>(cpiengsl, <span class="st">"CPIENGSL"</span>)</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>cpifood_mm <span class="ot">&lt;-</span> <span class="fu">inflation_mm</span>(cpifood, <span class="st">"CPIUFDSL"</span>)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>gdpdef_mm <span class="ot">&lt;-</span> <span class="fu">inflation_mm</span>(gdpdef, <span class="st">"GDPDEF"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>UM data has a different format (it is already in percentage base 100):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>michigan_mm <span class="ot">&lt;-</span> michigan <span class="sc">%&gt;%</span></span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(realtime_period <span class="sc">==</span> <span class="fu">max</span>(realtime_period)) <span class="sc">%&gt;%</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(date), <span class="at">month =</span> <span class="fu">month</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(month <span class="sc">==</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">date =</span> date <span class="sc">+</span> <span class="fu">years</span>(<span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(<span class="at">inflation =</span> MICH)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Merge all into one data frame for plotting:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>merge_inflation <span class="ot">&lt;-</span> <span class="cf">function</span>(data, name) {</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>    data <span class="sc">%&gt;%</span></span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>        <span class="fu">select</span>(date, <span class="sc">!!</span><span class="fu">sym</span>(col)) <span class="sc">%&gt;%</span></span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>        <span class="fu">mutate</span>(<span class="at">series =</span> name)</span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>inflation <span class="ot">&lt;-</span> <span class="fu">map2_df</span>(</span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(cpiaucsl_mm, cpilfesl_mm, cpiengsl_mm, cpifood_mm, gdpdef_mm, michigan_mm),</span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">c</span>(<span class="st">"I-CPIAUCSL"</span>, <span class="st">"I-CPILFESL"</span>, <span class="st">"I-CPIENGSL"</span>, <span class="st">"I-CPIUFDSL"</span>, <span class="st">"I-GDPDEF"</span>, <span class="st">"I-MICH"</span>),</span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x, y) {</span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>        x <span class="sc">%&gt;%</span></span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>            <span class="fu">select</span>(date, inflation) <span class="sc">%&gt;%</span></span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>            <span class="fu">mutate</span>(<span class="at">series =</span> y)</span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Plot of the different inflation measures:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(inflation, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> inflation, <span class="at">color =</span> series)) <span class="sc">+</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Inflation Measures"</span>,</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Inflation Rate (%)"</span>,</span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Series"</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_tintin_d</span>() <span class="sc">+</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> series, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/plots3-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>The plots show some level of similarity between all series except for the CPIENGSL (energy prices) which is more volatile. The series without food and energy (CPILFESL) is more stable and is similar to the GDP deflator (GDPDEF) while the other series have more volatility.</p>
<p>Because energy depends on external factors (e.g., geopolitical events that affect oil prices) and food prices are affected by seasonal patterns, we will use the CPILFESL and GDP deflator as our main inflation measure.</p>
<p>UM survey reflects a relatively accurate forward-looking measure of inflation expectations.</p>
</section>
<section id="estimate-a-var-model" class="level1">
<h1>Estimate a VAR model</h1>
<p>The goal is to choose the lag length based on information criteria.</p>
<p>The first step is to determine the lag length using information criteria.</p>
<p>For CPILFESL and adapting from <a href="https://www.econometrics-with-r.org/14.6-llsuic.html">Econometrics with R</a>, which uses BIC, we will use the AIC criterion.</p>
<p><span class="math display">\[
\text{AIC}(p) = \log \left( \frac{\text{SSR}(p)}{T} \right) + (p+1)\frac{2}{T}.
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compute AIC for AR model objects of class 'dynlm'</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>AIC <span class="ot">&lt;-</span> <span class="cf">function</span>(model) {</span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  ssr <span class="ot">&lt;-</span> <span class="fu">sum</span>(model<span class="sc">$</span>residuals<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  t <span class="ot">&lt;-</span> <span class="fu">length</span>(model<span class="sc">$</span>residuals)</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  npar <span class="ot">&lt;-</span> <span class="fu">length</span>(model<span class="sc">$</span>coef)</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(<span class="fu">c</span>(<span class="st">"AIC"</span> <span class="ot">=</span> <span class="fu">log</span>(ssr<span class="sc">/</span>t) <span class="sc">+</span> npar <span class="sc">*</span> <span class="dv">2</span><span class="sc">/</span>t), <span class="dv">4</span>)</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a><span class="co"># intercept only AR model</span></span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(<span class="fu">dynlm</span>(<span class="fu">ts</span>(cpilfesl_mm<span class="sc">$</span>inflation) <span class="sc">~</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Looping over different model orders:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># loop AIC over models of different orders</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>order <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>AICs <span class="ot">&lt;-</span> <span class="fu">vapply</span>(</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>    order,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) {</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>        <span class="fu">AIC</span>(<span class="fu">dynlm</span>(<span class="fu">ts</span>(cpilfesl_mm<span class="sc">$</span>inflation) <span class="sc">~</span> <span class="fu">L</span>(<span class="fu">ts</span>(cpilfesl_mm<span class="sc">$</span>inflation), <span class="dv">1</span><span class="sc">:</span>x)))</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">FUN.VALUE =</span> <span class="fu">numeric</span>(<span class="dv">1</span>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a><span class="fu">which.min</span>(AICs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Based on the AIC criterion, we select a lag length of 4 for CPILFESL.</p>
<p>Similarly, for GDPDEF:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a><span class="co"># loop AIC over models of different orders</span></span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>AICs_gdpdef <span class="ot">&lt;-</span> <span class="fu">vapply</span>(</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    order,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    <span class="cf">function</span>(x) {</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>        <span class="fu">AIC</span>(<span class="fu">dynlm</span>(<span class="fu">ts</span>(gdpdef_mm<span class="sc">$</span>inflation) <span class="sc">~</span> <span class="fu">L</span>(<span class="fu">ts</span>(gdpdef_mm<span class="sc">$</span>inflation), <span class="dv">1</span><span class="sc">:</span>x)))</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    },</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">FUN.VALUE =</span> <span class="fu">numeric</span>(<span class="dv">1</span>)</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a><span class="fu">which.min</span>(AICs_gdpdef)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Based on the AIC criterion, we select a lag length of 6 for GDPDEF.</p>
<p>Now we can estimate the VAR model using <code>var_model()</code> from the <code>ecod025ps1</code> package:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># remove the last value as it is NA after the the lagged difference</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="dv">12</span>L</span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>l1 <span class="ot">&lt;-</span> <span class="dv">4</span>L</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>l2 <span class="ot">&lt;-</span> <span class="dv">6</span>L</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>fit_cpilfesl <span class="ot">&lt;-</span> <span class="fu">var_model</span>(<span class="fu">na.omit</span>(<span class="fu">as.matrix</span>(cpilfesl_mm<span class="sc">$</span>inflation)), <span class="at">p =</span> l1,</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>    <span class="at">include_const =</span> <span class="cn">TRUE</span>, <span class="at">forecast_h =</span> h)</span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>fit_gdpdef <span class="ot">&lt;-</span> <span class="fu">var_model</span>(<span class="fu">na.omit</span>(<span class="fu">as.matrix</span>(gdpdef_mm<span class="sc">$</span>inflation)), <span class="at">p =</span> l2,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">include_const =</span> <span class="cn">TRUE</span>, <span class="at">forecast_h =</span> h)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fit_cpilfesl, <span class="st">"data/fit_cpilfesl.rds"</span>)</span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fit_gdpdef, <span class="st">"data/fit_gdpdef.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We can plot the forecasts for <span class="math inline">\(T=1,\ldots, 12\)</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>run_models) {</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>    fit_cpilfesl <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/fit_cpilfesl.rds"</span>)</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>    fit_gdpdef <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/fit_gdpdef.rds"</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>fit_predictions <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">horizon =</span> <span class="fu">paste0</span>(<span class="st">"CPILFESL-"</span>, fit_cpilfesl<span class="sc">$</span>forecast_h),</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">predicted_inflation =</span> <span class="fu">as.numeric</span>(fit_cpilfesl<span class="sc">$</span>forecasts),</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">max</span>(cpilfesl_mm<span class="sc">$</span>date) <span class="sc">+</span> <span class="fu">years</span>(<span class="fu">seq_len</span>(fit_cpilfesl<span class="sc">$</span>forecast_h))</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tibble</span>(</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">horizon =</span> <span class="fu">paste0</span>(<span class="st">"GDPDEF-"</span>, fit_gdpdef<span class="sc">$</span>forecast_h),</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">predicted_inflation =</span> <span class="fu">as.numeric</span>(fit_gdpdef<span class="sc">$</span>forecasts),</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">date =</span> <span class="fu">max</span>(gdpdef_mm<span class="sc">$</span>date) <span class="sc">+</span> <span class="fu">years</span>(<span class="fu">seq_len</span>(fit_gdpdef<span class="sc">$</span>forecast_h))</span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fit_predictions, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> predicted_inflation, <span class="at">color =</span> horizon)) <span class="sc">+</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">size =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Future VAR Forecasts for CPILFESL"</span>,</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Predicted Inflation Rate (%)"</span>,</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Series"</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_tintin_d</span>() <span class="sc">+</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span>horizon, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/var5-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>The interesting part is to compare the forecasts from the VAR model by subsetting the data “T” years before the end date and compare the predictions with the actual values. One problem in this time horizon is that we have the COVID-19 pandemic (2020) external shock.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># subset data</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>cpilfesl_mm_subset <span class="ot">&lt;-</span> cpilfesl_mm <span class="sc">%&gt;%</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(date <span class="sc">&lt;=</span> (<span class="fu">max</span>(date) <span class="sc">-</span> <span class="fu">years</span>(h)))</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>gdpdef_mm_subset <span class="ot">&lt;-</span> gdpdef_mm <span class="sc">%&gt;%</span></span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(date <span class="sc">&lt;=</span> (<span class="fu">max</span>(date) <span class="sc">-</span> <span class="fu">years</span>(h)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># re-estimate the VAR model</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>fit_cpilfesl_subset <span class="ot">&lt;-</span> <span class="fu">var_model</span>(<span class="fu">na.omit</span>(<span class="fu">as.matrix</span>(cpilfesl_mm_subset<span class="sc">$</span>inflation)),</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span> l1, <span class="at">include_const =</span> <span class="cn">TRUE</span>, <span class="at">forecast_h =</span> h)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>fit_gdpdef_subset <span class="ot">&lt;-</span> <span class="fu">var_model</span>(<span class="fu">na.omit</span>(<span class="fu">as.matrix</span>(gdpdef_mm_subset<span class="sc">$</span>inflation)),</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span> l2, <span class="at">include_const =</span> <span class="cn">TRUE</span>, <span class="at">forecast_h =</span> h)</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fit_cpilfesl_subset, <span class="st">"data/fit_cpilfesl_subset.rds"</span>)</span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fit_gdpdef_subset, <span class="st">"data/fit_gdpdef_subset.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb19"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>run_models) {</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>    fit_cpilfesl_subset <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/fit_cpilfesl_subset.rds"</span>)</span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>    fit_gdpdef_subset <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/fit_gdpdef_subset.rds"</span>)</span>
<span id="cb19-4"><a href="#cb19-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb19-5"><a href="#cb19-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-6"><a href="#cb19-6" aria-hidden="true" tabindex="-1"></a>inflation2 <span class="ot">&lt;-</span> inflation <span class="sc">%&gt;%</span></span>
<span id="cb19-7"><a href="#cb19-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(series <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"I-CPILFESL"</span>, <span class="st">"I-GDPDEF"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb19-8"><a href="#cb19-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(<span class="fu">year</span>(date) <span class="sc">&gt;</span> <span class="fu">max</span>(<span class="fu">year</span>(date) <span class="sc">-</span> h))</span>
<span id="cb19-9"><a href="#cb19-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-10"><a href="#cb19-10" aria-hidden="true" tabindex="-1"></a>fit_predictions2 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb19-11"><a href="#cb19-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">date =</span> <span class="fu">max</span>(cpilfesl_mm_subset<span class="sc">$</span>date) <span class="sc">+</span> <span class="fu">years</span>(<span class="fu">seq_len</span>(fit_cpilfesl_subset<span class="sc">$</span>forecast_h)),</span>
<span id="cb19-12"><a href="#cb19-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">inflation =</span> <span class="fu">as.numeric</span>(fit_cpilfesl_subset<span class="sc">$</span>forecasts),</span>
<span id="cb19-13"><a href="#cb19-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">series =</span> <span class="st">"I-CPILFESL"</span></span>
<span id="cb19-14"><a href="#cb19-14" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb19-15"><a href="#cb19-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb19-16"><a href="#cb19-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tibble</span>(</span>
<span id="cb19-17"><a href="#cb19-17" aria-hidden="true" tabindex="-1"></a>            <span class="at">date =</span> <span class="fu">max</span>(gdpdef_mm_subset<span class="sc">$</span>date) <span class="sc">+</span> <span class="fu">years</span>(<span class="fu">seq_len</span>(fit_gdpdef_subset<span class="sc">$</span>forecast_h)),</span>
<span id="cb19-18"><a href="#cb19-18" aria-hidden="true" tabindex="-1"></a>            <span class="at">inflation =</span> <span class="fu">as.numeric</span>(fit_gdpdef_subset<span class="sc">$</span>forecasts),</span>
<span id="cb19-19"><a href="#cb19-19" aria-hidden="true" tabindex="-1"></a>            <span class="at">series =</span> <span class="st">"I-GDPDEF"</span></span>
<span id="cb19-20"><a href="#cb19-20" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb19-21"><a href="#cb19-21" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-22"><a href="#cb19-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-23"><a href="#cb19-23" aria-hidden="true" tabindex="-1"></a>fit_predictions2 <span class="ot">&lt;-</span> fit_predictions2 <span class="sc">%&gt;%</span></span>
<span id="cb19-24"><a href="#cb19-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(inflation2, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"series"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb19-25"><a href="#cb19-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(</span>
<span id="cb19-26"><a href="#cb19-26" aria-hidden="true" tabindex="-1"></a>        <span class="at">inflation =</span> inflation.y,</span>
<span id="cb19-27"><a href="#cb19-27" aria-hidden="true" tabindex="-1"></a>        <span class="at">prediction =</span> inflation.x</span>
<span id="cb19-28"><a href="#cb19-28" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb19-29"><a href="#cb19-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-30"><a href="#cb19-30" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(inflation2) <span class="sc">+</span></span>
<span id="cb19-31"><a href="#cb19-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> fit_predictions2, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> inflation, <span class="at">color =</span> series),</span>
<span id="cb19-32"><a href="#cb19-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb19-33"><a href="#cb19-33" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> fit_predictions2, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> inflation, <span class="at">color =</span> series),</span>
<span id="cb19-34"><a href="#cb19-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb19-35"><a href="#cb19-35" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb19-36"><a href="#cb19-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> fit_predictions2, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> prediction, <span class="at">color =</span> series),</span>
<span id="cb19-37"><a href="#cb19-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"gray70"</span>) <span class="sc">+</span></span>
<span id="cb19-38"><a href="#cb19-38" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> fit_predictions2, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> prediction, <span class="at">color =</span> series),</span>
<span id="cb19-39"><a href="#cb19-39" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"gray70"</span>) <span class="sc">+</span></span>
<span id="cb19-40"><a href="#cb19-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-41"><a href="#cb19-41" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_segment</span>(<span class="at">data =</span> fit_predictions2,</span>
<span id="cb19-42"><a href="#cb19-42" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">xend =</span> date, <span class="at">y =</span> inflation, <span class="at">yend =</span> prediction),</span>
<span id="cb19-43"><a href="#cb19-43" aria-hidden="true" tabindex="-1"></a>        <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb19-44"><a href="#cb19-44" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"gray50"</span></span>
<span id="cb19-45"><a href="#cb19-45" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb19-46"><a href="#cb19-46" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb19-47"><a href="#cb19-47" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb19-48"><a href="#cb19-48" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Inflation Measures and Past VAR Predictions"</span>,</span>
<span id="cb19-49"><a href="#cb19-49" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"Predictions in gray"</span>,</span>
<span id="cb19-50"><a href="#cb19-50" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb19-51"><a href="#cb19-51" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Inflation Rate (%)"</span>,</span>
<span id="cb19-52"><a href="#cb19-52" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Series"</span></span>
<span id="cb19-53"><a href="#cb19-53" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb19-54"><a href="#cb19-54" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_tintin_d</span>() <span class="sc">+</span></span>
<span id="cb19-55"><a href="#cb19-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> series, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb19-56"><a href="#cb19-56" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb19-57"><a href="#cb19-57" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/var6c-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>The RMSFE and MAE metrics are the following:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="co"># CPILFESL model</span></span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="st">"RMFSE"</span> <span class="ot">=</span> fit_cpilfesl<span class="sc">$</span>rmsfe, <span class="st">"MAE"</span> <span class="ot">=</span> fit_cpilfesl<span class="sc">$</span>mae)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>   RMFSE      MAE 
1.371924 0.848142 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="co"># GDPDEF model</span></span>
<span id="cb22-2"><a href="#cb22-2" aria-hidden="true" tabindex="-1"></a><span class="fu">c</span>(<span class="st">"RMFSE"</span> <span class="ot">=</span> fit_gdpdef<span class="sc">$</span>rmsfe, <span class="st">"MAE"</span> <span class="ot">=</span> fit_gdpdef<span class="sc">$</span>mae)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>    RMFSE       MAE 
1.3001212 0.9055657 </code></pre>
</div>
</div>
<p>We can compute a side RMSFE and MAE in a counterfactual way by using the last observed values and the forecast for the next 12 months (we need an R-side RMSFE and MAE functions as their C++ counterparts are not exported):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a>RMSFE <span class="ot">&lt;-</span> <span class="cf">function</span>(actual, predicted) {</span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">sqrt</span>(<span class="fu">mean</span>((actual <span class="sc">-</span> predicted)<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>MAE <span class="ot">&lt;-</span> <span class="cf">function</span>(actual, predicted) {</span>
<span id="cb24-6"><a href="#cb24-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mean</span>(<span class="fu">abs</span>(actual <span class="sc">-</span> predicted), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb24-7"><a href="#cb24-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb24-8"><a href="#cb24-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb24-9"><a href="#cb24-9" aria-hidden="true" tabindex="-1"></a>fit_predictions2 <span class="sc">%&gt;%</span></span>
<span id="cb24-10"><a href="#cb24-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(series <span class="sc">==</span> <span class="st">"I-CPILFESL"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-11"><a href="#cb24-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"CPILFESL"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb24-12"><a href="#cb24-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(model) <span class="sc">%&gt;%</span></span>
<span id="cb24-13"><a href="#cb24-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb24-14"><a href="#cb24-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">RMSFE =</span> <span class="fu">RMSFE</span>(inflation, prediction),</span>
<span id="cb24-15"><a href="#cb24-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">MAE =</span> <span class="fu">MAE</span>(inflation, prediction)</span>
<span id="cb24-16"><a href="#cb24-16" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  model    RMSFE   MAE
  &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt;
1 CPILFESL  1.19 0.803</code></pre>
</div>
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>fit_predictions2 <span class="sc">%&gt;%</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(series <span class="sc">==</span> <span class="st">"I-GDPDEF"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"GDPDEF"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(model) <span class="sc">%&gt;%</span></span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">RMSFE =</span> <span class="fu">RMSFE</span>(inflation, prediction),</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">MAE =</span> <span class="fu">MAE</span>(inflation, prediction)</span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 3
  model  RMSFE   MAE
  &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt;
1 GDPDEF  1.75  1.42</code></pre>
</div>
</div>
<p>For the GDPDEF model, the MAE reveals hat this model does not predict accurately out of sample.</p>
</section>
<section id="estimate-a-fa-var-model" class="level1">
<h1>Estimate a FA-VAR model</h1>
<p>We will use the <code>favar_model()</code> from the <code>ecod025ps1</code> package to estimate a FA-VAR model.</p>
<p>The data is the same as before but we require an extra variable <span class="math inline">\(X_t\)</span>. To use a covariate, we will use the University of Michigan inflation expectation (MICH) as it is a forward-looking variable. The justification for this choice is that the Fed mandate is to keep the expectation of inflation low and stable. This is the general rule for central banks, which do not directly control inflation.</p>
<p>Furthermore, we can use the expected inflation and its 2,3-year lag as predictors (the variable is already lagged).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>yx <span class="ot">&lt;-</span> michigan_mm <span class="sc">%&gt;%</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(date, <span class="at">mich =</span> inflation) <span class="sc">%&gt;%</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>        <span class="at">mich_lag1 =</span> <span class="fu">lead</span>(mich, <span class="dv">1</span>),</span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">mich_lag2 =</span> <span class="fu">lead</span>(mich, <span class="dv">2</span>)</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>        <span class="co"># mich_lag3 = lead(mich, 3)</span></span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(</span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>        cpilfesl_mm_subset <span class="sc">%&gt;%</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>            <span class="fu">select</span>(date, <span class="at">cpilfesl =</span> inflation),</span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"date"</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>        gdpdef_mm_subset <span class="sc">%&gt;%</span></span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>            <span class="fu">select</span>(date, <span class="at">gdpdef =</span> inflation),</span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">by =</span> <span class="st">"date"</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(<span class="sc">-</span>date) <span class="sc">%&gt;%</span></span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as.matrix</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>l_order <span class="ot">&lt;-</span> <span class="fu">which</span>(<span class="fu">colnames</span>(yx) <span class="sc">==</span> <span class="st">"mich_lag2"</span>)</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Use p_f = 0: only contemporaneous factors (no factor dynamics)</span></span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a><span class="co"># This estimates: y_t = B(L)y_{t-1} + CF_t + u_t</span></span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>fit_cpilfesl_favar <span class="ot">&lt;-</span> <span class="fu">favar_model</span>(yx[, <span class="st">"cpilfesl"</span>], yx[, <span class="dv">1</span><span class="sc">:</span>l_order], </span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_factors =</span> <span class="dv">1</span>L, <span class="at">p_y =</span> l1, <span class="at">p_f =</span> <span class="dv">0</span>L,</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">include_const =</span> <span class="cn">TRUE</span>, <span class="at">forecast_h =</span> h)</span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>fit_gdpdef_favar <span class="ot">&lt;-</span> <span class="fu">favar_model</span>(yx[, <span class="st">"gdpdef"</span>], yx[, <span class="dv">1</span><span class="sc">:</span>l_order], </span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_factors =</span> <span class="dv">1</span>L, <span class="at">p_y =</span> l2, <span class="at">p_f =</span> <span class="dv">0</span>L,</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">include_const =</span> <span class="cn">TRUE</span>, <span class="at">forecast_h =</span> h)</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fit_cpilfesl_favar, <span class="st">"data/fit_cpilfesl_favar.rds"</span>)</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fit_gdpdef_favar, <span class="st">"data/fit_gdpdef_favar.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>run_models) {</span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>    fit_cpilfesl_favar <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/fit_cpilfesl_favar.rds"</span>)</span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>    fit_gdpdef_favar <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/fit_gdpdef_favar.rds"</span>)</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>fit_predictions3 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">date =</span> <span class="fu">max</span>(cpilfesl_mm_subset<span class="sc">$</span>date) <span class="sc">+</span> <span class="fu">years</span>(<span class="fu">seq_len</span>(fit_cpilfesl_favar<span class="sc">$</span>forecast_h)),</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">inflation =</span> <span class="fu">as.numeric</span>(fit_cpilfesl_favar<span class="sc">$</span>forecasts),</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">series =</span> <span class="st">"I-CPILFESL"</span></span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tibble</span>(</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">date =</span> <span class="fu">max</span>(gdpdef_mm_subset<span class="sc">$</span>date) <span class="sc">+</span> <span class="fu">years</span>(<span class="fu">seq_len</span>(fit_gdpdef_favar<span class="sc">$</span>forecast_h)),</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">inflation =</span> <span class="fu">as.numeric</span>(fit_gdpdef_favar<span class="sc">$</span>forecasts),</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">series =</span> <span class="st">"I-GDPDEF"</span></span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb29-17"><a href="#cb29-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-18"><a href="#cb29-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-19"><a href="#cb29-19" aria-hidden="true" tabindex="-1"></a>fit_predictions3 <span class="ot">&lt;-</span> fit_predictions3 <span class="sc">%&gt;%</span></span>
<span id="cb29-20"><a href="#cb29-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(inflation2, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"series"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb29-21"><a href="#cb29-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(</span>
<span id="cb29-22"><a href="#cb29-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">inflation =</span> inflation.y,</span>
<span id="cb29-23"><a href="#cb29-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">prediction =</span> inflation.x</span>
<span id="cb29-24"><a href="#cb29-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb29-25"><a href="#cb29-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-26"><a href="#cb29-26" aria-hidden="true" tabindex="-1"></a><span class="co"># RMSFE and MAE</span></span>
<span id="cb29-27"><a href="#cb29-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb29-28"><a href="#cb29-28" aria-hidden="true" tabindex="-1"></a>fit_predictions3 <span class="sc">%&gt;%</span></span>
<span id="cb29-29"><a href="#cb29-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(series <span class="sc">==</span> <span class="st">"I-CPILFESL"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-30"><a href="#cb29-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"CPILFESL"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb29-31"><a href="#cb29-31" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(model) <span class="sc">%&gt;%</span></span>
<span id="cb29-32"><a href="#cb29-32" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb29-33"><a href="#cb29-33" aria-hidden="true" tabindex="-1"></a>        <span class="at">RMSFE =</span> <span class="fu">RMSFE</span>(inflation, prediction),</span>
<span id="cb29-34"><a href="#cb29-34" aria-hidden="true" tabindex="-1"></a>        <span class="at">MAE =</span> <span class="fu">MAE</span>(inflation, prediction)</span>
<span id="cb29-35"><a href="#cb29-35" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb29-36"><a href="#cb29-36" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb29-37"><a href="#cb29-37" aria-hidden="true" tabindex="-1"></a>        <span class="at">AIC =</span> fit_cpilfesl_favar<span class="sc">$</span>aic</span>
<span id="cb29-38"><a href="#cb29-38" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
  model    RMSFE   MAE   AIC
  &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 CPILFESL  1.95  1.78 0.154</code></pre>
</div>
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>fit_predictions3 <span class="sc">%&gt;%</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(series <span class="sc">==</span> <span class="st">"I-GDPDEF"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"GDPDEF"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(model) <span class="sc">%&gt;%</span></span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">RMSFE =</span> <span class="fu">RMSFE</span>(inflation, prediction),</span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">MAE =</span> <span class="fu">MAE</span>(inflation, prediction)</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">AIC =</span> fit_gdpdef_favar<span class="sc">$</span>aic</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
  model  RMSFE   MAE    AIC
  &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1 GDPDEF  1.42  1.12 -0.792</code></pre>
</div>
</div>
<p>The model does not improve the forecasts evaluation metrics compared to the VAR model.</p>
<p>Now we can plot the forecast on the censored data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> fit_predictions3, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> inflation, <span class="at">color =</span> series),</span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> fit_predictions3, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> inflation, <span class="at">color =</span> series),</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> fit_predictions3, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> prediction, <span class="at">color =</span> series),</span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"gray70"</span>) <span class="sc">+</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> fit_predictions3, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> prediction, <span class="at">color =</span> series),</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"gray70"</span>) <span class="sc">+</span></span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_segment</span>(<span class="at">data =</span> fit_predictions3,</span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">xend =</span> date, <span class="at">y =</span> inflation, <span class="at">yend =</span> prediction),</span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>        <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"gray50"</span></span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Inflation Measures and Past VAR Predictions"</span>,</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"Predictions in gray"</span>,</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Inflation Rate (%)"</span>,</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Series"</span></span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_tintin_d</span>() <span class="sc">+</span></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> series, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/favar3-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="estimate-a-dfm-model" class="level1">
<h1>Estimate a DFM model</h1>
<p>The predictive DFM uses the same structure as FA-VAR but with DFM-based factor extraction:</p>
<p><span class="math display">\[
\begin{aligned}
X_t &amp;= [\text{MICH}_t, \text{MICH}_{t-1}, \text{MICH}_{t-2}] \cr
F_t &amp;= \text{Factors extracted from } X_t \cr
y_t &amp;= B(L)y_{t-1} + C(L) F_t + u_t
\end{aligned}
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Predictive DFM: uses MICH + lags as covariates (like FA-VAR)</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a><span class="co"># p_f = 0: only contemporaneous factors (no factor dynamics)</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>l_order <span class="ot">&lt;-</span> <span class="dv">3</span></span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>fit_cpilfesl_dfm <span class="ot">&lt;-</span> <span class="fu">dfm_predict_model</span>(yx[, <span class="st">"cpilfesl"</span>], yx[, <span class="dv">1</span><span class="sc">:</span>l_order], </span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_factors =</span> <span class="dv">2</span>L, <span class="at">p_y =</span> l1, <span class="at">p_f =</span> <span class="dv">0</span>L,</span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">include_const =</span> <span class="cn">TRUE</span>, <span class="at">max_iter =</span> <span class="dv">100</span>L, <span class="at">tol =</span> <span class="fl">1e-6</span>, <span class="at">forecast_h =</span> h)</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a>fit_gdpdef_dfm <span class="ot">&lt;-</span> <span class="fu">dfm_predict_model</span>(yx[, <span class="st">"gdpdef"</span>], yx[, <span class="dv">1</span><span class="sc">:</span>l_order], </span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_factors =</span> <span class="dv">2</span>, <span class="at">p_y =</span> l2, <span class="at">p_f =</span> <span class="dv">0</span>L,</span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">include_const =</span> <span class="cn">TRUE</span>, <span class="at">max_iter =</span> <span class="dv">100</span>L, <span class="at">tol =</span> <span class="fl">1e-6</span>, <span class="at">forecast_h =</span> h)</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fit_cpilfesl_dfm, <span class="st">"data/fit_cpilfesl_dfm.rds"</span>)</span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fit_gdpdef_dfm, <span class="st">"data/fit_gdpdef_dfm.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>run_models) {</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>    fit_cpilfesl_dfm <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/fit_cpilfesl_dfm.rds"</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>    fit_gdpdef_dfm <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/fit_gdpdef_dfm.rds"</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>fit_predictions4 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">date =</span> <span class="fu">max</span>(cpilfesl_mm_subset<span class="sc">$</span>date) <span class="sc">+</span> <span class="fu">years</span>(<span class="fu">seq_len</span>(fit_cpilfesl_dfm<span class="sc">$</span>forecast_h)),</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>        <span class="at">inflation =</span> <span class="fu">as.numeric</span>(fit_cpilfesl_dfm<span class="sc">$</span>forecasts),  <span class="co"># Now a vector like FA-VAR</span></span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">series =</span> <span class="st">"I-CPILFESL"</span></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">bind_rows</span>(</span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>        <span class="fu">tibble</span>(</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>            <span class="at">date =</span> <span class="fu">max</span>(gdpdef_mm_subset<span class="sc">$</span>date) <span class="sc">+</span> <span class="fu">years</span>(<span class="fu">seq_len</span>(fit_gdpdef_dfm<span class="sc">$</span>forecast_h)),</span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>            <span class="at">inflation =</span> <span class="fu">as.numeric</span>(fit_gdpdef_dfm<span class="sc">$</span>forecasts),  <span class="co"># Now a vector like FA-VAR</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>            <span class="at">series =</span> <span class="st">"I-GDPDEF"</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>        )</span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>fit_predictions4 <span class="ot">&lt;-</span> fit_predictions4 <span class="sc">%&gt;%</span></span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>    <span class="fu">left_join</span>(inflation2, <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"series"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>    <span class="fu">rename</span>(</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>        <span class="at">inflation =</span> inflation.y,</span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>        <span class="at">prediction =</span> inflation.x</span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>fit_predictions4 <span class="sc">%&gt;%</span></span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(series <span class="sc">==</span> <span class="st">"I-CPILFESL"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"CPILFESL"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(model) <span class="sc">%&gt;%</span></span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>        <span class="at">RMSFE =</span> <span class="fu">RMSFE</span>(inflation, prediction),</span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>        <span class="at">MAE =</span> <span class="fu">MAE</span>(inflation, prediction)</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>        <span class="at">AIC =</span> fit_cpilfesl_dfm<span class="sc">$</span>aic</span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
  model    RMSFE   MAE    AIC
  &lt;chr&gt;    &lt;dbl&gt; &lt;dbl&gt;  &lt;dbl&gt;
1 CPILFESL  3.28  2.99 -0.558</code></pre>
</div>
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a>fit_predictions4 <span class="sc">%&gt;%</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(series <span class="sc">==</span> <span class="st">"I-GDPDEF"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">model =</span> <span class="st">"GDPDEF"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(model) <span class="sc">%&gt;%</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">summarise</span>(</span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>        <span class="at">RMSFE =</span> <span class="fu">RMSFE</span>(inflation, prediction),</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">MAE =</span> <span class="fu">MAE</span>(inflation, prediction)</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>        <span class="at">AIC =</span> fit_gdpdef_dfm<span class="sc">$</span>aic</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 4
  model  RMSFE   MAE   AIC
  &lt;chr&gt;  &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
1 GDPDEF  1.58  1.23 -1.37</code></pre>
</div>
</div>
<p>Now we can plot the forecast on the censored data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>() <span class="sc">+</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> fit_predictions4, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> inflation, <span class="at">color =</span> series),</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>        <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> fit_predictions4, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> inflation, <span class="at">color =</span> series),</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_line</span>(<span class="at">data =</span> fit_predictions4, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> prediction, <span class="at">color =</span> series),</span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>        <span class="at">linewidth =</span> <span class="dv">1</span>, <span class="at">color =</span> <span class="st">"gray70"</span>) <span class="sc">+</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_point</span>(<span class="at">data =</span> fit_predictions4, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> prediction, <span class="at">color =</span> series),</span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>        <span class="at">size =</span> <span class="dv">2</span>, <span class="at">color =</span> <span class="st">"gray70"</span>) <span class="sc">+</span></span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_segment</span>(<span class="at">data =</span> fit_predictions4,</span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>        <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">xend =</span> date, <span class="at">y =</span> inflation, <span class="at">yend =</span> prediction),</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a>        <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"gray50"</span></span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">labs</span>(</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a>        <span class="at">title =</span> <span class="st">"Inflation Measures and Past DFM Predictions"</span>,</span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>        <span class="at">subtitle =</span> <span class="st">"Predictions in gray"</span>,</span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>        <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>        <span class="at">y =</span> <span class="st">"Inflation Rate (%)"</span>,</span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>        <span class="at">color =</span> <span class="st">"Series"</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">+</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">scale_colour_tintin_d</span>() <span class="sc">+</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>    <span class="fu">facet_wrap</span>(<span class="sc">~</span> series, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/dfm3-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>This model does not improve the forecasts evaluation metrics compared to the VAR and FA-VAR models.</p>
<p>One valuable lesson from this excercise is that adding more factors does not necessarily improve the forecast evaluation metrics. With a similar RMSFE and MAE, the VAR model is preferred due to its simplicity according to the Occam’s razor principle.</p>
</section>
<section id="c-code" class="level1">
<h1>C++ code</h1>
<section id="model-metrics" class="level2">
<h2 class="anchored" data-anchor-id="model-metrics">Model metrics</h2>
<div class="sourceCode" id="cb40"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a><span class="co">==============================================</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a><span class="co">Root Mean Squared Forecast Error (RMSFE)</span></span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a><span class="co">===========================================</span></span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> rmsfe<span class="op">(</span><span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> actual<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> forecast<span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a>  <span class="co">// if (actual.n_rows != forecast.n_rows || actual.n_cols != forecast.n_cols) {</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">//   throw std::runtime_error("Actual and forecast matrices must have the same dimensions");</span></span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>  <span class="co">// }</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> errors <span class="op">=</span> actual <span class="op">-</span> forecast<span class="op">;</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> squared_errors <span class="op">=</span> square<span class="op">(</span>errors<span class="op">);</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> mean_squared_errors <span class="op">=</span> mean<span class="op">(</span>squared_errors<span class="op">,</span> <span class="dv">0</span><span class="op">);</span> <span class="co">// Mean across rows for each variable</span></span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> rmsfe_values <span class="op">=</span> sqrt<span class="op">(</span>mean_squared_errors<span class="op">);</span></span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Return average RMSFE across all variables</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> as_scalar<span class="op">(</span>mean<span class="op">(</span>rmsfe_values<span class="op">));</span></span>
<span id="cb40-19"><a href="#cb40-19" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb40-20"><a href="#cb40-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-21"><a href="#cb40-21" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb40-22"><a href="#cb40-22" aria-hidden="true" tabindex="-1"></a><span class="co">==============================================</span></span>
<span id="cb40-23"><a href="#cb40-23" aria-hidden="true" tabindex="-1"></a><span class="co">Mean Absolute Error (MAE)</span></span>
<span id="cb40-24"><a href="#cb40-24" aria-hidden="true" tabindex="-1"></a><span class="co">==============================================</span></span>
<span id="cb40-25"><a href="#cb40-25" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb40-26"><a href="#cb40-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-27"><a href="#cb40-27" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> mae<span class="op">(</span><span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> actual<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> forecast<span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-28"><a href="#cb40-28" aria-hidden="true" tabindex="-1"></a>  <span class="co">// if (actual.n_rows != forecast.n_rows || actual.n_cols != forecast.n_cols) {</span></span>
<span id="cb40-29"><a href="#cb40-29" aria-hidden="true" tabindex="-1"></a>  <span class="co">//   throw std::runtime_error("Actual and forecast matrices must have the same dimensions");</span></span>
<span id="cb40-30"><a href="#cb40-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">// }</span></span>
<span id="cb40-31"><a href="#cb40-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-32"><a href="#cb40-32" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> errors <span class="op">=</span> abs<span class="op">(</span>actual <span class="op">-</span> forecast<span class="op">);</span></span>
<span id="cb40-33"><a href="#cb40-33" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> mean_absolute_errors <span class="op">=</span> mean<span class="op">(</span>errors<span class="op">,</span> <span class="dv">0</span><span class="op">);</span> <span class="co">// Mean across rows for each variable</span></span>
<span id="cb40-34"><a href="#cb40-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-35"><a href="#cb40-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Return average MAE across all variables</span></span>
<span id="cb40-36"><a href="#cb40-36" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> as_scalar<span class="op">(</span>mean<span class="op">(</span>mean_absolute_errors<span class="op">));</span></span>
<span id="cb40-37"><a href="#cb40-37" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb40-38"><a href="#cb40-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-39"><a href="#cb40-39" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb40-40"><a href="#cb40-40" aria-hidden="true" tabindex="-1"></a><span class="co">==============================================</span></span>
<span id="cb40-41"><a href="#cb40-41" aria-hidden="true" tabindex="-1"></a><span class="co">Akaike Information Criterion (AIC)</span></span>
<span id="cb40-42"><a href="#cb40-42" aria-hidden="true" tabindex="-1"></a><span class="co">==============================================</span></span>
<span id="cb40-43"><a href="#cb40-43" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb40-44"><a href="#cb40-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-45"><a href="#cb40-45" aria-hidden="true" tabindex="-1"></a><span class="dt">double</span> aic_metric<span class="op">(</span><span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> residuals<span class="op">,</span> <span class="dt">int</span> n_params<span class="op">)</span> <span class="op">{</span></span>
<span id="cb40-46"><a href="#cb40-46" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> residuals<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb40-47"><a href="#cb40-47" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-48"><a href="#cb40-48" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Sum of squared residuals</span></span>
<span id="cb40-49"><a href="#cb40-49" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> ssr <span class="op">=</span> accu<span class="op">(</span>square<span class="op">(</span>residuals<span class="op">));</span></span>
<span id="cb40-50"><a href="#cb40-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-51"><a href="#cb40-51" aria-hidden="true" tabindex="-1"></a>  <span class="co">// AIC = log(SSR/T) + (p+1) * 2/T</span></span>
<span id="cb40-52"><a href="#cb40-52" aria-hidden="true" tabindex="-1"></a>  <span class="co">// For multivariate models, use total SSR across all equations</span></span>
<span id="cb40-53"><a href="#cb40-53" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> aic <span class="op">=</span> log<span class="op">(</span>ssr <span class="op">/</span> T<span class="op">)</span> <span class="op">+</span> n_params <span class="op">*</span> <span class="fl">2.0</span> <span class="op">/</span> T<span class="op">;</span></span>
<span id="cb40-54"><a href="#cb40-54" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb40-55"><a href="#cb40-55" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> aic<span class="op">;</span></span>
<span id="cb40-56"><a href="#cb40-56" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="var-model" class="level2">
<h2 class="anchored" data-anchor-id="var-model">VAR model</h2>
<div class="sourceCode" id="cb41"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a><span class="co">==============================================</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a><span class="co">Vector Autoregressions (VAR)</span></span>
<span id="cb41-4"><a href="#cb41-4" aria-hidden="true" tabindex="-1"></a><span class="co">===========================================</span></span>
<span id="cb41-5"><a href="#cb41-5" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb41-6"><a href="#cb41-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-7"><a href="#cb41-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Create lagged matrix for VAR model</span></span>
<span id="cb41-8"><a href="#cb41-8" aria-hidden="true" tabindex="-1"></a>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> <span class="va">create_lags_</span><span class="op">(</span><span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> Y<span class="op">,</span> <span class="dt">int</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-9"><a href="#cb41-9" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> Y<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb41-10"><a href="#cb41-10" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> K <span class="op">=</span> Y<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb41-11"><a href="#cb41-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-12"><a href="#cb41-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Effective sample size after lagging</span></span>
<span id="cb41-13"><a href="#cb41-13" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T_eff <span class="op">=</span> T <span class="op">-</span> p<span class="op">;</span></span>
<span id="cb41-14"><a href="#cb41-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-15"><a href="#cb41-15" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create lagged matrix: [Y_{t-1}, Y_{t-2}, ..., Y_{t-p}]</span></span>
<span id="cb41-16"><a href="#cb41-16" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X_lag<span class="op">(</span>T_eff<span class="op">,</span> K <span class="op">*</span> p<span class="op">);</span></span>
<span id="cb41-17"><a href="#cb41-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-18"><a href="#cb41-18" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> lag <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> lag <span class="op">&lt;=</span> p<span class="op">;</span> <span class="op">++</span>lag<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-19"><a href="#cb41-19" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> t <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> t <span class="op">&lt;</span> T_eff<span class="op">;</span> <span class="op">++</span>t<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-20"><a href="#cb41-20" aria-hidden="true" tabindex="-1"></a>      X_lag<span class="op">.</span>submat<span class="op">(</span>t<span class="op">,</span> <span class="op">(</span>lag<span class="op">-</span><span class="dv">1</span><span class="op">)*</span>K<span class="op">,</span> t<span class="op">,</span> lag<span class="op">*</span>K<span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">=</span> Y<span class="op">.</span>row<span class="op">(</span>t <span class="op">+</span> p <span class="op">-</span> lag<span class="op">);</span></span>
<span id="cb41-21"><a href="#cb41-21" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb41-22"><a href="#cb41-22" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb41-23"><a href="#cb41-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-24"><a href="#cb41-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> X_lag<span class="op">;</span></span>
<span id="cb41-25"><a href="#cb41-25" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb41-26"><a href="#cb41-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-27"><a href="#cb41-27" aria-hidden="true" tabindex="-1"></a><span class="co">// Estimate VAR model using equation-by-equation OLS</span></span>
<span id="cb41-28"><a href="#cb41-28" aria-hidden="true" tabindex="-1"></a>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> <span class="va">var_estimate_</span><span class="op">(</span><span class="at">const</span> doubles_matrix<span class="op">&lt;&gt;&amp;</span> y<span class="op">,</span> <span class="dt">int</span> p<span class="op">,</span> <span class="dt">bool</span> include_const <span class="op">=</span> <span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-29"><a href="#cb41-29" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Y <span class="op">=</span> as_Mat<span class="op">(</span>y<span class="op">);</span></span>
<span id="cb41-30"><a href="#cb41-30" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> Y<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb41-31"><a href="#cb41-31" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-32"><a href="#cb41-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>T <span class="op">&lt;=</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-33"><a href="#cb41-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span><span class="st">"Sample size must be greater than lag order p"</span><span class="op">);</span></span>
<span id="cb41-34"><a href="#cb41-34" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb41-35"><a href="#cb41-35" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-36"><a href="#cb41-36" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create lagged regressors</span></span>
<span id="cb41-37"><a href="#cb41-37" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Y_lag <span class="op">=</span> <span class="va">create_lags_</span><span class="op">(</span>Y<span class="op">,</span> p<span class="op">);</span></span>
<span id="cb41-38"><a href="#cb41-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-39"><a href="#cb41-39" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Dependent variable (after losing p observations)</span></span>
<span id="cb41-40"><a href="#cb41-40" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Y_dep <span class="op">=</span> Y<span class="op">.</span>rows<span class="op">(</span>p<span class="op">,</span> T<span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb41-41"><a href="#cb41-41" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-42"><a href="#cb41-42" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add constant if requested</span></span>
<span id="cb41-43"><a href="#cb41-43" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X<span class="op">;</span></span>
<span id="cb41-44"><a href="#cb41-44" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>include_const<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-45"><a href="#cb41-45" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> ones<span class="op">(</span>Y_lag<span class="op">.</span>n_rows<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> fill<span class="op">::</span>ones<span class="op">);</span></span>
<span id="cb41-46"><a href="#cb41-46" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> join_horiz<span class="op">(</span>ones<span class="op">,</span> Y_lag<span class="op">);</span></span>
<span id="cb41-47"><a href="#cb41-47" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb41-48"><a href="#cb41-48" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> Y_lag<span class="op">;</span></span>
<span id="cb41-49"><a href="#cb41-49" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb41-50"><a href="#cb41-50" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-51"><a href="#cb41-51" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Estimate VAR coefficients: A = (X'X)^(-1)(X'Y)</span></span>
<span id="cb41-52"><a href="#cb41-52" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> XtX <span class="op">=</span> X<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> X<span class="op">;</span></span>
<span id="cb41-53"><a href="#cb41-53" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> XtX_inv <span class="op">=</span> inv<span class="op">(</span>XtX<span class="op">);</span></span>
<span id="cb41-54"><a href="#cb41-54" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> A <span class="op">=</span> XtX_inv <span class="op">*</span> X<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> Y_dep<span class="op">;</span></span>
<span id="cb41-55"><a href="#cb41-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-56"><a href="#cb41-56" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> A<span class="op">;</span></span>
<span id="cb41-57"><a href="#cb41-57" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb41-58"><a href="#cb41-58" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-59"><a href="#cb41-59" aria-hidden="true" tabindex="-1"></a><span class="co">// Compute VAR residuals and fitted values</span></span>
<span id="cb41-60"><a href="#cb41-60" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>pair<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;</span> <span class="va">var_fitted_resid_</span><span class="op">(</span><span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> Y<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> A<span class="op">,</span> </span>
<span id="cb41-61"><a href="#cb41-61" aria-hidden="true" tabindex="-1"></a>                                                      <span class="dt">int</span> p<span class="op">,</span> <span class="dt">bool</span> include_const <span class="op">=</span> <span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-62"><a href="#cb41-62" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> Y<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb41-63"><a href="#cb41-63" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-64"><a href="#cb41-64" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create lagged regressors</span></span>
<span id="cb41-65"><a href="#cb41-65" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Y_lag <span class="op">=</span> <span class="va">create_lags_</span><span class="op">(</span>Y<span class="op">,</span> p<span class="op">);</span></span>
<span id="cb41-66"><a href="#cb41-66" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-67"><a href="#cb41-67" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Dependent variable (after losing p observations)</span></span>
<span id="cb41-68"><a href="#cb41-68" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Y_dep <span class="op">=</span> Y<span class="op">.</span>rows<span class="op">(</span>p<span class="op">,</span> T<span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb41-69"><a href="#cb41-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-70"><a href="#cb41-70" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add constant if requested</span></span>
<span id="cb41-71"><a href="#cb41-71" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X<span class="op">;</span></span>
<span id="cb41-72"><a href="#cb41-72" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>include_const<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-73"><a href="#cb41-73" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> ones<span class="op">(</span>Y_lag<span class="op">.</span>n_rows<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> fill<span class="op">::</span>ones<span class="op">);</span></span>
<span id="cb41-74"><a href="#cb41-74" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> join_horiz<span class="op">(</span>ones<span class="op">,</span> Y_lag<span class="op">);</span></span>
<span id="cb41-75"><a href="#cb41-75" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb41-76"><a href="#cb41-76" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> Y_lag<span class="op">;</span></span>
<span id="cb41-77"><a href="#cb41-77" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb41-78"><a href="#cb41-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-79"><a href="#cb41-79" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute fitted values and residuals</span></span>
<span id="cb41-80"><a href="#cb41-80" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Y_fitted <span class="op">=</span> X <span class="op">*</span> A<span class="op">;</span></span>
<span id="cb41-81"><a href="#cb41-81" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> residuals <span class="op">=</span> Y_dep <span class="op">-</span> Y_fitted<span class="op">;</span></span>
<span id="cb41-82"><a href="#cb41-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-83"><a href="#cb41-83" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">std::</span>make_pair<span class="op">(</span>Y_fitted<span class="op">,</span> residuals<span class="op">);</span></span>
<span id="cb41-84"><a href="#cb41-84" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb41-85"><a href="#cb41-85" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-86"><a href="#cb41-86" aria-hidden="true" tabindex="-1"></a><span class="co">// Create VAR companion matrix for analysis and forecasting</span></span>
<span id="cb41-87"><a href="#cb41-87" aria-hidden="true" tabindex="-1"></a>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> <span class="va">var_companion_</span><span class="op">(</span><span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> A<span class="op">,</span> <span class="dt">int</span> p<span class="op">,</span> <span class="dt">int</span> K<span class="op">,</span> <span class="dt">bool</span> include_const <span class="op">=</span> <span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-88"><a href="#cb41-88" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Extract coefficient matrices (exclude constant if present)</span></span>
<span id="cb41-89"><a href="#cb41-89" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> A_coeff<span class="op">;</span></span>
<span id="cb41-90"><a href="#cb41-90" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>include_const<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-91"><a href="#cb41-91" aria-hidden="true" tabindex="-1"></a>    A_coeff <span class="op">=</span> A<span class="op">.</span>rows<span class="op">(</span><span class="dv">1</span><span class="op">,</span> A<span class="op">.</span>n_rows<span class="op">-</span><span class="dv">1</span><span class="op">);</span>  <span class="co">// Skip first row (constants)</span></span>
<span id="cb41-92"><a href="#cb41-92" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb41-93"><a href="#cb41-93" aria-hidden="true" tabindex="-1"></a>    A_coeff <span class="op">=</span> A<span class="op">;</span></span>
<span id="cb41-94"><a href="#cb41-94" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb41-95"><a href="#cb41-95" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-96"><a href="#cb41-96" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create companion matrix</span></span>
<span id="cb41-97"><a href="#cb41-97" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F<span class="op">(</span>K<span class="op">*</span>p<span class="op">,</span> K<span class="op">*</span>p<span class="op">,</span> fill<span class="op">::</span>zeros<span class="op">);</span></span>
<span id="cb41-98"><a href="#cb41-98" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-99"><a href="#cb41-99" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Fill first K rows with coefficient matrices A1, A2, ..., Ap</span></span>
<span id="cb41-100"><a href="#cb41-100" aria-hidden="true" tabindex="-1"></a>  F<span class="op">.</span>submat<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> K<span class="op">-</span><span class="dv">1</span><span class="op">,</span> K<span class="op">*</span>p<span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">=</span> A_coeff<span class="op">.</span>t<span class="op">();</span></span>
<span id="cb41-101"><a href="#cb41-101" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-102"><a href="#cb41-102" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Fill identity blocks for lagged terms</span></span>
<span id="cb41-103"><a href="#cb41-103" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>p <span class="op">&gt;</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-104"><a href="#cb41-104" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> I_K <span class="op">=</span> eye<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;(</span>K<span class="op">,</span> K<span class="op">);</span></span>
<span id="cb41-105"><a href="#cb41-105" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> i <span class="op">&lt;</span> p<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-106"><a href="#cb41-106" aria-hidden="true" tabindex="-1"></a>      F<span class="op">.</span>submat<span class="op">(</span>i<span class="op">*</span>K<span class="op">,</span> <span class="op">(</span>i<span class="op">-</span><span class="dv">1</span><span class="op">)*</span>K<span class="op">,</span> <span class="op">(</span>i<span class="op">+</span><span class="dv">1</span><span class="op">)*</span>K<span class="op">-</span><span class="dv">1</span><span class="op">,</span> i<span class="op">*</span>K<span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">=</span> I_K<span class="op">;</span></span>
<span id="cb41-107"><a href="#cb41-107" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb41-108"><a href="#cb41-108" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb41-109"><a href="#cb41-109" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-110"><a href="#cb41-110" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> F<span class="op">;</span></span>
<span id="cb41-111"><a href="#cb41-111" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb41-112"><a href="#cb41-112" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-113"><a href="#cb41-113" aria-hidden="true" tabindex="-1"></a><span class="co">// VAR forecasting function</span></span>
<span id="cb41-114"><a href="#cb41-114" aria-hidden="true" tabindex="-1"></a>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> <span class="va">var_forecast_</span><span class="op">(</span><span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> Y<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> A<span class="op">,</span> </span>
<span id="cb41-115"><a href="#cb41-115" aria-hidden="true" tabindex="-1"></a>                         <span class="dt">int</span> p<span class="op">,</span> <span class="dt">int</span> h<span class="op">,</span> <span class="dt">bool</span> include_const <span class="op">=</span> <span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-116"><a href="#cb41-116" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> Y<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb41-117"><a href="#cb41-117" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> K <span class="op">=</span> Y<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb41-118"><a href="#cb41-118" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-119"><a href="#cb41-119" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Get last p observations for initialization</span></span>
<span id="cb41-120"><a href="#cb41-120" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Y_init <span class="op">=</span> Y<span class="op">.</span>rows<span class="op">(</span>T<span class="op">-</span>p<span class="op">,</span> T<span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb41-121"><a href="#cb41-121" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-122"><a href="#cb41-122" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Initialize forecast container</span></span>
<span id="cb41-123"><a href="#cb41-123" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> forecasts<span class="op">(</span>h<span class="op">,</span> K<span class="op">);</span></span>
<span id="cb41-124"><a href="#cb41-124" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-125"><a href="#cb41-125" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Current state vector (flatten last p observations)</span></span>
<span id="cb41-126"><a href="#cb41-126" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> y_current <span class="op">=</span> vectorise<span class="op">(</span>Y_init<span class="op">.</span>t<span class="op">()).</span>t<span class="op">();</span>  <span class="co">// Reshape to row vector</span></span>
<span id="cb41-127"><a href="#cb41-127" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-128"><a href="#cb41-128" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Extract coefficients</span></span>
<span id="cb41-129"><a href="#cb41-129" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> const_term<span class="op">;</span></span>
<span id="cb41-130"><a href="#cb41-130" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> A_coeff<span class="op">;</span></span>
<span id="cb41-131"><a href="#cb41-131" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-132"><a href="#cb41-132" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>include_const<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-133"><a href="#cb41-133" aria-hidden="true" tabindex="-1"></a>    const_term <span class="op">=</span> A<span class="op">.</span>row<span class="op">(</span><span class="dv">0</span><span class="op">);</span></span>
<span id="cb41-134"><a href="#cb41-134" aria-hidden="true" tabindex="-1"></a>    A_coeff <span class="op">=</span> A<span class="op">.</span>rows<span class="op">(</span><span class="dv">1</span><span class="op">,</span> A<span class="op">.</span>n_rows<span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb41-135"><a href="#cb41-135" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb41-136"><a href="#cb41-136" aria-hidden="true" tabindex="-1"></a>    const_term <span class="op">=</span> zeros<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;(</span><span class="dv">1</span><span class="op">,</span> K<span class="op">);</span></span>
<span id="cb41-137"><a href="#cb41-137" aria-hidden="true" tabindex="-1"></a>    A_coeff <span class="op">=</span> A<span class="op">;</span></span>
<span id="cb41-138"><a href="#cb41-138" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb41-139"><a href="#cb41-139" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-140"><a href="#cb41-140" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create lagged design matrix for current state</span></span>
<span id="cb41-141"><a href="#cb41-141" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X_lag <span class="op">=</span> y_current<span class="op">;</span></span>
<span id="cb41-142"><a href="#cb41-142" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-143"><a href="#cb41-143" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Forecast h periods ahead</span></span>
<span id="cb41-144"><a href="#cb41-144" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> h<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-145"><a href="#cb41-145" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Forecast: y_{T+i+1} = c + A1*y_{T+i} + ... + Ap*y_{T+i-p+1}</span></span>
<span id="cb41-146"><a href="#cb41-146" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> y_forecast <span class="op">=</span> const_term <span class="op">+</span> X_lag <span class="op">*</span> A_coeff<span class="op">;</span></span>
<span id="cb41-147"><a href="#cb41-147" aria-hidden="true" tabindex="-1"></a>    forecasts<span class="op">.</span>row<span class="op">(</span>i<span class="op">)</span> <span class="op">=</span> y_forecast<span class="op">;</span></span>
<span id="cb41-148"><a href="#cb41-148" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb41-149"><a href="#cb41-149" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update lagged matrix for next forecast</span></span>
<span id="cb41-150"><a href="#cb41-150" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>i <span class="op">&lt;</span> h<span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-151"><a href="#cb41-151" aria-hidden="true" tabindex="-1"></a>      Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> new_X_lag <span class="op">=</span> join_horiz<span class="op">(</span>y_forecast<span class="op">,</span> X_lag<span class="op">.</span>cols<span class="op">(</span><span class="dv">0</span><span class="op">,</span> K<span class="op">*(</span>p<span class="op">-</span><span class="dv">1</span><span class="op">)-</span><span class="dv">1</span><span class="op">));</span></span>
<span id="cb41-152"><a href="#cb41-152" aria-hidden="true" tabindex="-1"></a>      X_lag <span class="op">=</span> new_X_lag<span class="op">;</span></span>
<span id="cb41-153"><a href="#cb41-153" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb41-154"><a href="#cb41-154" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb41-155"><a href="#cb41-155" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-156"><a href="#cb41-156" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> forecasts<span class="op">;</span></span>
<span id="cb41-157"><a href="#cb41-157" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb41-158"><a href="#cb41-158" aria-hidden="true" tabindex="-1"></a><span class="co">/* roxygen</span></span>
<span id="cb41-159"><a href="#cb41-159" aria-hidden="true" tabindex="-1"></a><span class="co">@title Main VAR estimation function that returns everything</span></span>
<span id="cb41-160"><a href="#cb41-160" aria-hidden="true" tabindex="-1"></a><span class="co">@export</span></span>
<span id="cb41-161"><a href="#cb41-161" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb41-162"><a href="#cb41-162" aria-hidden="true" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp4r</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span> list var_model<span class="op">(</span><span class="at">const</span> doubles_matrix<span class="op">&lt;&gt;&amp;</span> y<span class="op">,</span> <span class="dt">int</span> p<span class="op">,</span> </span>
<span id="cb41-163"><a href="#cb41-163" aria-hidden="true" tabindex="-1"></a>                                   <span class="dt">bool</span> include_const <span class="op">=</span> <span class="kw">true</span><span class="op">,</span> <span class="dt">int</span> forecast_h <span class="op">=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-164"><a href="#cb41-164" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Y <span class="op">=</span> as_Mat<span class="op">(</span>y<span class="op">);</span></span>
<span id="cb41-165"><a href="#cb41-165" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> Y<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb41-166"><a href="#cb41-166" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> K <span class="op">=</span> Y<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb41-167"><a href="#cb41-167" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-168"><a href="#cb41-168" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>T <span class="op">&lt;=</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-169"><a href="#cb41-169" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span><span class="st">"Sample size must be greater than lag order p"</span><span class="op">);</span></span>
<span id="cb41-170"><a href="#cb41-170" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb41-171"><a href="#cb41-171" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-172"><a href="#cb41-172" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Estimate VAR coefficients</span></span>
<span id="cb41-173"><a href="#cb41-173" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> A <span class="op">=</span> <span class="va">var_estimate_</span><span class="op">(</span>y<span class="op">,</span> p<span class="op">,</span> include_const<span class="op">);</span></span>
<span id="cb41-174"><a href="#cb41-174" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-175"><a href="#cb41-175" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute fitted values and residuals</span></span>
<span id="cb41-176"><a href="#cb41-176" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> fitted_resid <span class="op">=</span> <span class="va">var_fitted_resid_</span><span class="op">(</span>Y<span class="op">,</span> A<span class="op">,</span> p<span class="op">,</span> include_const<span class="op">);</span></span>
<span id="cb41-177"><a href="#cb41-177" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Y_fitted <span class="op">=</span> fitted_resid<span class="op">.</span>first<span class="op">;</span></span>
<span id="cb41-178"><a href="#cb41-178" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> residuals <span class="op">=</span> fitted_resid<span class="op">.</span>second<span class="op">;</span></span>
<span id="cb41-179"><a href="#cb41-179" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-180"><a href="#cb41-180" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute residual covariance matrix</span></span>
<span id="cb41-181"><a href="#cb41-181" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Sigma <span class="op">=</span> <span class="op">(</span>residuals<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> residuals<span class="op">)</span> <span class="op">/</span> <span class="op">(</span>residuals<span class="op">.</span>n_rows <span class="op">-</span> A<span class="op">.</span>n_rows<span class="op">);</span></span>
<span id="cb41-182"><a href="#cb41-182" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-183"><a href="#cb41-183" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create companion matrix</span></span>
<span id="cb41-184"><a href="#cb41-184" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F <span class="op">=</span> <span class="va">var_companion_</span><span class="op">(</span>A<span class="op">,</span> p<span class="op">,</span> K<span class="op">,</span> include_const<span class="op">);</span></span>
<span id="cb41-185"><a href="#cb41-185" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-186"><a href="#cb41-186" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute AIC</span></span>
<span id="cb41-187"><a href="#cb41-187" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n_params <span class="op">=</span> A<span class="op">.</span>n_rows <span class="op">*</span> K<span class="op">;</span>  <span class="co">// Total number of parameters</span></span>
<span id="cb41-188"><a href="#cb41-188" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> aic <span class="op">=</span> aic_metric<span class="op">(</span>residuals<span class="op">,</span> n_params<span class="op">);</span></span>
<span id="cb41-189"><a href="#cb41-189" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-190"><a href="#cb41-190" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Prepare results list</span></span>
<span id="cb41-191"><a href="#cb41-191" aria-hidden="true" tabindex="-1"></a>  writable<span class="op">::</span>list result<span class="op">(</span><span class="dv">9</span><span class="op">);</span></span>
<span id="cb41-192"><a href="#cb41-192" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-193"><a href="#cb41-193" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>A<span class="op">);</span></span>
<span id="cb41-194"><a href="#cb41-194" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>Y_fitted<span class="op">);</span></span>
<span id="cb41-195"><a href="#cb41-195" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>residuals<span class="op">);</span></span>
<span id="cb41-196"><a href="#cb41-196" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>Sigma<span class="op">);</span></span>
<span id="cb41-197"><a href="#cb41-197" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">4</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>F<span class="op">);</span></span>
<span id="cb41-198"><a href="#cb41-198" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">5</span><span class="op">]</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>p<span class="op">);</span></span>
<span id="cb41-199"><a href="#cb41-199" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">6</span><span class="op">]</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>K<span class="op">);</span></span>
<span id="cb41-200"><a href="#cb41-200" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">7</span><span class="op">]</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>T <span class="op">-</span> p<span class="op">);</span>  <span class="co">// Effective sample size</span></span>
<span id="cb41-201"><a href="#cb41-201" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">8</span><span class="op">]</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>include_const<span class="op">);</span></span>
<span id="cb41-202"><a href="#cb41-202" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-203"><a href="#cb41-203" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>names<span class="op">()</span> <span class="op">=</span> <span class="op">{</span><span class="st">"coefficients"</span><span class="op">,</span> <span class="st">"fitted_values"</span><span class="op">,</span> <span class="st">"residuals"</span><span class="op">,</span> <span class="st">"sigma"</span><span class="op">,</span> </span>
<span id="cb41-204"><a href="#cb41-204" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"companion_matrix"</span><span class="op">,</span> <span class="st">"lag_order"</span><span class="op">,</span> <span class="st">"n_variables"</span><span class="op">,</span> </span>
<span id="cb41-205"><a href="#cb41-205" aria-hidden="true" tabindex="-1"></a>                         <span class="st">"n_obs"</span><span class="op">,</span> <span class="st">"include_const"</span><span class="op">};</span></span>
<span id="cb41-206"><a href="#cb41-206" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-207"><a href="#cb41-207" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add forecasts if requested</span></span>
<span id="cb41-208"><a href="#cb41-208" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>forecast_h <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb41-209"><a href="#cb41-209" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> forecasts <span class="op">=</span> <span class="va">var_forecast_</span><span class="op">(</span>Y<span class="op">,</span> A<span class="op">,</span> p<span class="op">,</span> forecast_h<span class="op">,</span> include_const<span class="op">);</span></span>
<span id="cb41-210"><a href="#cb41-210" aria-hidden="true" tabindex="-1"></a>    result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"forecasts"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>forecasts<span class="op">)});</span></span>
<span id="cb41-211"><a href="#cb41-211" aria-hidden="true" tabindex="-1"></a>    result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"forecast_horizon"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>forecast_h<span class="op">)});</span></span>
<span id="cb41-212"><a href="#cb41-212" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb41-213"><a href="#cb41-213" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb41-214"><a href="#cb41-214" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add model metrics</span></span>
<span id="cb41-215"><a href="#cb41-215" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"rmsfe"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>rmsfe<span class="op">(</span>Y<span class="op">.</span>rows<span class="op">(</span>p<span class="op">,</span> T<span class="op">-</span><span class="dv">1</span><span class="op">),</span> Y_fitted<span class="op">))});</span></span>
<span id="cb41-216"><a href="#cb41-216" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"mae"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>mae<span class="op">(</span>Y<span class="op">.</span>rows<span class="op">(</span>p<span class="op">,</span> T<span class="op">-</span><span class="dv">1</span><span class="op">),</span> Y_fitted<span class="op">))});</span></span>
<span id="cb41-217"><a href="#cb41-217" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"aic"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>aic<span class="op">)});</span></span>
<span id="cb41-218"><a href="#cb41-218" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb41-219"><a href="#cb41-219" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb41-220"><a href="#cb41-220" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="fa-var-model" class="level2">
<h2 class="anchored" data-anchor-id="fa-var-model">FA-VAR model</h2>
<div class="sourceCode" id="cb42"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a><span class="co">==============================================</span></span>
<span id="cb42-3"><a href="#cb42-3" aria-hidden="true" tabindex="-1"></a><span class="co">Factor-Augmented VAR (FA-VAR)</span></span>
<span id="cb42-4"><a href="#cb42-4" aria-hidden="true" tabindex="-1"></a><span class="co">==============================================</span></span>
<span id="cb42-5"><a href="#cb42-5" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb42-6"><a href="#cb42-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-7"><a href="#cb42-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Extract factors using PCA from large dataset</span></span>
<span id="cb42-8"><a href="#cb42-8" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>pair<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;</span> <span class="va">favar_extract_factors_</span><span class="op">(</span><span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> X<span class="op">,</span> <span class="dt">int</span> n_factors<span class="op">)</span> <span class="op">{</span>  </span>
<span id="cb42-9"><a href="#cb42-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Center the data</span></span>
<span id="cb42-10"><a href="#cb42-10" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X_centered <span class="op">=</span> X<span class="op">.</span>each_row<span class="op">()</span> <span class="op">-</span> mean<span class="op">(</span>X<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb42-11"><a href="#cb42-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-12"><a href="#cb42-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Perform SVD on X' (N x T matrix)</span></span>
<span id="cb42-13"><a href="#cb42-13" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> U<span class="op">,</span> V<span class="op">;</span></span>
<span id="cb42-14"><a href="#cb42-14" aria-hidden="true" tabindex="-1"></a>  vec s<span class="op">;</span></span>
<span id="cb42-15"><a href="#cb42-15" aria-hidden="true" tabindex="-1"></a>  svd_econ<span class="op">(</span>U<span class="op">,</span> s<span class="op">,</span> V<span class="op">,</span> X_centered<span class="op">.</span>t<span class="op">());</span></span>
<span id="cb42-16"><a href="#cb42-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-17"><a href="#cb42-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Factor loadings (first n_factors principal components)</span></span>
<span id="cb42-18"><a href="#cb42-18" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Lambda <span class="op">=</span> U<span class="op">.</span>cols<span class="op">(</span><span class="dv">0</span><span class="op">,</span> n_factors<span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb42-19"><a href="#cb42-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-20"><a href="#cb42-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Common factors (T x n_factors)</span></span>
<span id="cb42-21"><a href="#cb42-21" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F <span class="op">=</span> X_centered <span class="op">*</span> Lambda<span class="op">;</span></span>
<span id="cb42-22"><a href="#cb42-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-23"><a href="#cb42-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">std::</span>make_pair<span class="op">(</span>F<span class="op">,</span> Lambda<span class="op">);</span></span>
<span id="cb42-24"><a href="#cb42-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb42-25"><a href="#cb42-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-26"><a href="#cb42-26" aria-hidden="true" tabindex="-1"></a><span class="co">// Estimate factor VAR: F_t = Phi_1*F_{t-1} + ... + Phi_p*F_{t-p} + v_t</span></span>
<span id="cb42-27"><a href="#cb42-27" aria-hidden="true" tabindex="-1"></a>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> <span class="va">favar_factor_var_</span><span class="op">(</span><span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> F<span class="op">,</span> <span class="dt">int</span> p_f<span class="op">,</span> <span class="dt">bool</span> include_const <span class="op">=</span> <span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-28"><a href="#cb42-28" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> N <span class="op">=</span> F<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb42-29"><a href="#cb42-29" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n_factors <span class="op">=</span> F<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb42-30"><a href="#cb42-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-31"><a href="#cb42-31" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Handle p_f = 0 case: no factor dynamics, just return constant term</span></span>
<span id="cb42-32"><a href="#cb42-32" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>p_f <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-33"><a href="#cb42-33" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>include_const<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-34"><a href="#cb42-34" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Return mean of factors as constant</span></span>
<span id="cb42-35"><a href="#cb42-35" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> mean<span class="op">(</span>F<span class="op">,</span> <span class="dv">0</span><span class="op">).</span>t<span class="op">();</span>  <span class="co">// Column vector of means</span></span>
<span id="cb42-36"><a href="#cb42-36" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb42-37"><a href="#cb42-37" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Return zeros</span></span>
<span id="cb42-38"><a href="#cb42-38" aria-hidden="true" tabindex="-1"></a>      <span class="cf">return</span> zeros<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;(</span><span class="dv">1</span><span class="op">,</span> n_factors<span class="op">);</span></span>
<span id="cb42-39"><a href="#cb42-39" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-40"><a href="#cb42-40" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-41"><a href="#cb42-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-42"><a href="#cb42-42" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>N <span class="op">&lt;=</span> p_f<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-43"><a href="#cb42-43" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span><span class="st">"Sample size must be greater than factor lag order p_f"</span><span class="op">);</span></span>
<span id="cb42-44"><a href="#cb42-44" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-45"><a href="#cb42-45" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-46"><a href="#cb42-46" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create lagged factors</span></span>
<span id="cb42-47"><a href="#cb42-47" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_lag <span class="op">=</span> <span class="va">create_lags_</span><span class="op">(</span>F<span class="op">,</span> p_f<span class="op">);</span></span>
<span id="cb42-48"><a href="#cb42-48" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-49"><a href="#cb42-49" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Dependent variable (after losing p_f observations)</span></span>
<span id="cb42-50"><a href="#cb42-50" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_dep <span class="op">=</span> F<span class="op">.</span>rows<span class="op">(</span>p_f<span class="op">,</span> F<span class="op">.</span>n_rows<span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb42-51"><a href="#cb42-51" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-52"><a href="#cb42-52" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add constant if requested</span></span>
<span id="cb42-53"><a href="#cb42-53" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X<span class="op">;</span></span>
<span id="cb42-54"><a href="#cb42-54" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>include_const<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-55"><a href="#cb42-55" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> ones<span class="op">(</span>F_lag<span class="op">.</span>n_rows<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> fill<span class="op">::</span>ones<span class="op">);</span></span>
<span id="cb42-56"><a href="#cb42-56" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> join_horiz<span class="op">(</span>ones<span class="op">,</span> F_lag<span class="op">);</span></span>
<span id="cb42-57"><a href="#cb42-57" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb42-58"><a href="#cb42-58" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> F_lag<span class="op">;</span></span>
<span id="cb42-59"><a href="#cb42-59" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-60"><a href="#cb42-60" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-61"><a href="#cb42-61" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Estimate factor VAR coefficients: Phi = (X'X)^(-1)(X'F)</span></span>
<span id="cb42-62"><a href="#cb42-62" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> XtX <span class="op">=</span> X<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> X<span class="op">;</span></span>
<span id="cb42-63"><a href="#cb42-63" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> XtX_inv <span class="op">=</span> inv<span class="op">(</span>XtX<span class="op">);</span></span>
<span id="cb42-64"><a href="#cb42-64" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Phi <span class="op">=</span> XtX_inv <span class="op">*</span> X<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> F_dep<span class="op">;</span></span>
<span id="cb42-65"><a href="#cb42-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-66"><a href="#cb42-66" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> Phi<span class="op">;</span></span>
<span id="cb42-67"><a href="#cb42-67" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb42-68"><a href="#cb42-68" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-69"><a href="#cb42-69" aria-hidden="true" tabindex="-1"></a><span class="co">// Estimate augmented VAR: y_t = B(L)*y_{t-1} + C(L)*F_t + u_t</span></span>
<span id="cb42-70"><a href="#cb42-70" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>tuple<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;</span> <span class="va">favar_augmented_var_</span><span class="op">(</span></span>
<span id="cb42-71"><a href="#cb42-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> y<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> F<span class="op">,</span> <span class="dt">int</span> p_y<span class="op">,</span> <span class="dt">int</span> p_f<span class="op">,</span> <span class="dt">bool</span> include_const <span class="op">=</span> <span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-72"><a href="#cb42-72" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-73"><a href="#cb42-73" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> y<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb42-74"><a href="#cb42-74" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> K <span class="op">=</span> y<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb42-75"><a href="#cb42-75" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-76"><a href="#cb42-76" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> max_p <span class="op">=</span> <span class="bu">std::</span>max<span class="op">(</span>p_y<span class="op">,</span> p_f<span class="op">);</span></span>
<span id="cb42-77"><a href="#cb42-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-78"><a href="#cb42-78" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>T <span class="op">&lt;=</span> max_p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-79"><a href="#cb42-79" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span><span class="st">"Sample size must be greater than maximum lag order"</span><span class="op">);</span></span>
<span id="cb42-80"><a href="#cb42-80" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-81"><a href="#cb42-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-82"><a href="#cb42-82" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create lagged y variables</span></span>
<span id="cb42-83"><a href="#cb42-83" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> y_lag<span class="op">;</span></span>
<span id="cb42-84"><a href="#cb42-84" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>p_y <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-85"><a href="#cb42-85" aria-hidden="true" tabindex="-1"></a>    y_lag <span class="op">=</span> <span class="va">create_lags_</span><span class="op">(</span>y<span class="op">,</span> p_y<span class="op">);</span></span>
<span id="cb42-86"><a href="#cb42-86" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Align with maximum lag</span></span>
<span id="cb42-87"><a href="#cb42-87" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>p_y <span class="op">&lt;</span> max_p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-88"><a href="#cb42-88" aria-hidden="true" tabindex="-1"></a>      Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> y_lag_aligned <span class="op">=</span> y_lag<span class="op">.</span>rows<span class="op">(</span>max_p <span class="op">-</span> p_y<span class="op">,</span> y_lag<span class="op">.</span>n_rows <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb42-89"><a href="#cb42-89" aria-hidden="true" tabindex="-1"></a>      y_lag <span class="op">=</span> y_lag_aligned<span class="op">;</span></span>
<span id="cb42-90"><a href="#cb42-90" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-91"><a href="#cb42-91" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-92"><a href="#cb42-92" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-93"><a href="#cb42-93" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create lagged and contemporaneous factors</span></span>
<span id="cb42-94"><a href="#cb42-94" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_regressors<span class="op">;</span></span>
<span id="cb42-95"><a href="#cb42-95" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>p_f <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-96"><a href="#cb42-96" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Include lagged factors: F_{t-1}, ..., F_{t-p_f}</span></span>
<span id="cb42-97"><a href="#cb42-97" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_lag <span class="op">=</span> <span class="va">create_lags_</span><span class="op">(</span>F<span class="op">,</span> p_f<span class="op">);</span></span>
<span id="cb42-98"><a href="#cb42-98" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Align with maximum lag</span></span>
<span id="cb42-99"><a href="#cb42-99" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>p_f <span class="op">&lt;</span> max_p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-100"><a href="#cb42-100" aria-hidden="true" tabindex="-1"></a>      Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_lag_aligned <span class="op">=</span> F_lag<span class="op">.</span>rows<span class="op">(</span>max_p <span class="op">-</span> p_f<span class="op">,</span> F_lag<span class="op">.</span>n_rows <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb42-101"><a href="#cb42-101" aria-hidden="true" tabindex="-1"></a>      F_lag <span class="op">=</span> F_lag_aligned<span class="op">;</span></span>
<span id="cb42-102"><a href="#cb42-102" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-103"><a href="#cb42-103" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-104"><a href="#cb42-104" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Include contemporaneous factors: F_t</span></span>
<span id="cb42-105"><a href="#cb42-105" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_contemp <span class="op">=</span> F<span class="op">.</span>rows<span class="op">(</span>max_p<span class="op">,</span> F<span class="op">.</span>n_rows <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb42-106"><a href="#cb42-106" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-107"><a href="#cb42-107" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Combine: [F_t, F_{t-1}, ..., F_{t-p_f}]</span></span>
<span id="cb42-108"><a href="#cb42-108" aria-hidden="true" tabindex="-1"></a>    F_regressors <span class="op">=</span> join_horiz<span class="op">(</span>F_contemp<span class="op">,</span> F_lag<span class="op">);</span></span>
<span id="cb42-109"><a href="#cb42-109" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb42-110"><a href="#cb42-110" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Only contemporaneous factors</span></span>
<span id="cb42-111"><a href="#cb42-111" aria-hidden="true" tabindex="-1"></a>    F_regressors <span class="op">=</span> F<span class="op">.</span>rows<span class="op">(</span>max_p<span class="op">,</span> F<span class="op">.</span>n_rows <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb42-112"><a href="#cb42-112" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-113"><a href="#cb42-113" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-114"><a href="#cb42-114" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Dependent variable (after losing max_p observations)</span></span>
<span id="cb42-115"><a href="#cb42-115" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> y_dep <span class="op">=</span> y<span class="op">.</span>rows<span class="op">(</span>max_p<span class="op">,</span> T <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb42-116"><a href="#cb42-116" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-117"><a href="#cb42-117" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Combine regressors: [y_{t-1}, ..., y_{t-p_y}, F_t, F_{t-1}, ..., F_{t-p_f}]</span></span>
<span id="cb42-118"><a href="#cb42-118" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X<span class="op">;</span></span>
<span id="cb42-119"><a href="#cb42-119" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>p_y <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-120"><a href="#cb42-120" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> join_horiz<span class="op">(</span>y_lag<span class="op">,</span> F_regressors<span class="op">);</span></span>
<span id="cb42-121"><a href="#cb42-121" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb42-122"><a href="#cb42-122" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> F_regressors<span class="op">;</span></span>
<span id="cb42-123"><a href="#cb42-123" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-124"><a href="#cb42-124" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-125"><a href="#cb42-125" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add constant if requested</span></span>
<span id="cb42-126"><a href="#cb42-126" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>include_const<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-127"><a href="#cb42-127" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> ones<span class="op">(</span>X<span class="op">.</span>n_rows<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> fill<span class="op">::</span>ones<span class="op">);</span></span>
<span id="cb42-128"><a href="#cb42-128" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> join_horiz<span class="op">(</span>ones<span class="op">,</span> X<span class="op">);</span></span>
<span id="cb42-129"><a href="#cb42-129" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-130"><a href="#cb42-130" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-131"><a href="#cb42-131" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Estimate coefficients: [B, C] = (X'X)^(-1)(X'y)</span></span>
<span id="cb42-132"><a href="#cb42-132" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> XtX <span class="op">=</span> X<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> X<span class="op">;</span></span>
<span id="cb42-133"><a href="#cb42-133" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> XtX_inv <span class="op">=</span> inv<span class="op">(</span>XtX<span class="op">);</span></span>
<span id="cb42-134"><a href="#cb42-134" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> beta <span class="op">=</span> XtX_inv <span class="op">*</span> X<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> y_dep<span class="op">;</span></span>
<span id="cb42-135"><a href="#cb42-135" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-136"><a href="#cb42-136" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Split coefficients into B (for y lags) and C (for factors)</span></span>
<span id="cb42-137"><a href="#cb42-137" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> B<span class="op">,</span> C<span class="op">;</span></span>
<span id="cb42-138"><a href="#cb42-138" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> start_idx <span class="op">=</span> include_const <span class="op">?</span> <span class="dv">1</span> <span class="op">:</span> <span class="dv">0</span><span class="op">;</span></span>
<span id="cb42-139"><a href="#cb42-139" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-140"><a href="#cb42-140" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>p_y <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-141"><a href="#cb42-141" aria-hidden="true" tabindex="-1"></a>    B <span class="op">=</span> beta<span class="op">.</span>rows<span class="op">(</span>start_idx<span class="op">,</span> start_idx <span class="op">+</span> K <span class="op">*</span> p_y <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb42-142"><a href="#cb42-142" aria-hidden="true" tabindex="-1"></a>    C <span class="op">=</span> beta<span class="op">.</span>rows<span class="op">(</span>start_idx <span class="op">+</span> K <span class="op">*</span> p_y<span class="op">,</span> beta<span class="op">.</span>n_rows <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb42-143"><a href="#cb42-143" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb42-144"><a href="#cb42-144" aria-hidden="true" tabindex="-1"></a>    B <span class="op">=</span> zeros<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;(</span><span class="dv">0</span><span class="op">,</span> K<span class="op">);</span>  <span class="co">// No y lags</span></span>
<span id="cb42-145"><a href="#cb42-145" aria-hidden="true" tabindex="-1"></a>    C <span class="op">=</span> beta<span class="op">.</span>rows<span class="op">(</span>start_idx<span class="op">,</span> beta<span class="op">.</span>n_rows <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb42-146"><a href="#cb42-146" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-147"><a href="#cb42-147" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-148"><a href="#cb42-148" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">std::</span>make_tuple<span class="op">(</span>beta<span class="op">,</span> C<span class="op">);</span>  <span class="co">// Return full coefficient matrix and factor coefficients</span></span>
<span id="cb42-149"><a href="#cb42-149" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb42-150"><a href="#cb42-150" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-151"><a href="#cb42-151" aria-hidden="true" tabindex="-1"></a><span class="co">// Compute FAVAR fitted values and residuals</span></span>
<span id="cb42-152"><a href="#cb42-152" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>pair<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;</span> <span class="va">favar_fitted_resid_</span><span class="op">(</span></span>
<span id="cb42-153"><a href="#cb42-153" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> y<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> F<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> beta<span class="op">,</span></span>
<span id="cb42-154"><a href="#cb42-154" aria-hidden="true" tabindex="-1"></a>    <span class="dt">int</span> p_y<span class="op">,</span> <span class="dt">int</span> p_f<span class="op">,</span> <span class="dt">bool</span> include_const <span class="op">=</span> <span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-155"><a href="#cb42-155" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-156"><a href="#cb42-156" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> y<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb42-157"><a href="#cb42-157" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> max_p <span class="op">=</span> <span class="bu">std::</span>max<span class="op">(</span>p_y<span class="op">,</span> p_f<span class="op">);</span></span>
<span id="cb42-158"><a href="#cb42-158" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-159"><a href="#cb42-159" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create same regressor matrix as in estimation</span></span>
<span id="cb42-160"><a href="#cb42-160" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> y_lag<span class="op">;</span></span>
<span id="cb42-161"><a href="#cb42-161" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>p_y <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-162"><a href="#cb42-162" aria-hidden="true" tabindex="-1"></a>    y_lag <span class="op">=</span> <span class="va">create_lags_</span><span class="op">(</span>y<span class="op">,</span> p_y<span class="op">);</span></span>
<span id="cb42-163"><a href="#cb42-163" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>p_y <span class="op">&lt;</span> max_p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-164"><a href="#cb42-164" aria-hidden="true" tabindex="-1"></a>      y_lag <span class="op">=</span> y_lag<span class="op">.</span>rows<span class="op">(</span>max_p <span class="op">-</span> p_y<span class="op">,</span> y_lag<span class="op">.</span>n_rows <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb42-165"><a href="#cb42-165" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-166"><a href="#cb42-166" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-167"><a href="#cb42-167" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-168"><a href="#cb42-168" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_regressors<span class="op">;</span></span>
<span id="cb42-169"><a href="#cb42-169" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>p_f <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-170"><a href="#cb42-170" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_lag <span class="op">=</span> <span class="va">create_lags_</span><span class="op">(</span>F<span class="op">,</span> p_f<span class="op">);</span></span>
<span id="cb42-171"><a href="#cb42-171" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>p_f <span class="op">&lt;</span> max_p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-172"><a href="#cb42-172" aria-hidden="true" tabindex="-1"></a>      F_lag <span class="op">=</span> F_lag<span class="op">.</span>rows<span class="op">(</span>max_p <span class="op">-</span> p_f<span class="op">,</span> F_lag<span class="op">.</span>n_rows <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb42-173"><a href="#cb42-173" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-174"><a href="#cb42-174" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_contemp <span class="op">=</span> F<span class="op">.</span>rows<span class="op">(</span>max_p<span class="op">,</span> F<span class="op">.</span>n_rows <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb42-175"><a href="#cb42-175" aria-hidden="true" tabindex="-1"></a>    F_regressors <span class="op">=</span> join_horiz<span class="op">(</span>F_contemp<span class="op">,</span> F_lag<span class="op">);</span></span>
<span id="cb42-176"><a href="#cb42-176" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb42-177"><a href="#cb42-177" aria-hidden="true" tabindex="-1"></a>    F_regressors <span class="op">=</span> F<span class="op">.</span>rows<span class="op">(</span>max_p<span class="op">,</span> F<span class="op">.</span>n_rows <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb42-178"><a href="#cb42-178" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-179"><a href="#cb42-179" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-180"><a href="#cb42-180" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X<span class="op">;</span></span>
<span id="cb42-181"><a href="#cb42-181" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>p_y <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-182"><a href="#cb42-182" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> join_horiz<span class="op">(</span>y_lag<span class="op">,</span> F_regressors<span class="op">);</span></span>
<span id="cb42-183"><a href="#cb42-183" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb42-184"><a href="#cb42-184" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> F_regressors<span class="op">;</span></span>
<span id="cb42-185"><a href="#cb42-185" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-186"><a href="#cb42-186" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-187"><a href="#cb42-187" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>include_const<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-188"><a href="#cb42-188" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> ones<span class="op">(</span>X<span class="op">.</span>n_rows<span class="op">,</span> <span class="dv">1</span><span class="op">,</span> fill<span class="op">::</span>ones<span class="op">);</span></span>
<span id="cb42-189"><a href="#cb42-189" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> join_horiz<span class="op">(</span>ones<span class="op">,</span> X<span class="op">);</span></span>
<span id="cb42-190"><a href="#cb42-190" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-191"><a href="#cb42-191" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-192"><a href="#cb42-192" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Dependent variable</span></span>
<span id="cb42-193"><a href="#cb42-193" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> y_dep <span class="op">=</span> y<span class="op">.</span>rows<span class="op">(</span>max_p<span class="op">,</span> T <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb42-194"><a href="#cb42-194" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-195"><a href="#cb42-195" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute fitted values and residuals</span></span>
<span id="cb42-196"><a href="#cb42-196" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> y_fitted <span class="op">=</span> X <span class="op">*</span> beta<span class="op">;</span></span>
<span id="cb42-197"><a href="#cb42-197" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> residuals <span class="op">=</span> y_dep <span class="op">-</span> y_fitted<span class="op">;</span></span>
<span id="cb42-198"><a href="#cb42-198" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-199"><a href="#cb42-199" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">std::</span>make_pair<span class="op">(</span>y_fitted<span class="op">,</span> residuals<span class="op">);</span></span>
<span id="cb42-200"><a href="#cb42-200" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb42-201"><a href="#cb42-201" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-202"><a href="#cb42-202" aria-hidden="true" tabindex="-1"></a><span class="co">// FAVAR forecasting</span></span>
<span id="cb42-203"><a href="#cb42-203" aria-hidden="true" tabindex="-1"></a>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> <span class="va">favar_forecast_</span><span class="op">(</span><span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> y<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> F<span class="op">,</span></span>
<span id="cb42-204"><a href="#cb42-204" aria-hidden="true" tabindex="-1"></a>                           <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> beta_y<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> Phi_f<span class="op">,</span></span>
<span id="cb42-205"><a href="#cb42-205" aria-hidden="true" tabindex="-1"></a>                           <span class="dt">int</span> p_y<span class="op">,</span> <span class="dt">int</span> p_f<span class="op">,</span> <span class="dt">int</span> h<span class="op">,</span> <span class="dt">bool</span> include_const <span class="op">=</span> <span class="kw">true</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-206"><a href="#cb42-206" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-207"><a href="#cb42-207" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> y<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb42-208"><a href="#cb42-208" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> K <span class="op">=</span> y<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb42-209"><a href="#cb42-209" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n_factors <span class="op">=</span> F<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb42-210"><a href="#cb42-210" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-211"><a href="#cb42-211" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> Phi_r <span class="op">=</span> Phi_f<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb42-212"><a href="#cb42-212" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> Phi_c <span class="op">=</span> Phi_f<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb42-213"><a href="#cb42-213" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-214"><a href="#cb42-214" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Initialize forecasts</span></span>
<span id="cb42-215"><a href="#cb42-215" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> y_forecast<span class="op">(</span>h<span class="op">,</span> K<span class="op">);</span></span>
<span id="cb42-216"><a href="#cb42-216" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_forecast<span class="op">(</span>h<span class="op">,</span> n_factors<span class="op">);</span></span>
<span id="cb42-217"><a href="#cb42-217" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-218"><a href="#cb42-218" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Get initial conditions</span></span>
<span id="cb42-219"><a href="#cb42-219" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> y_init <span class="op">=</span> y<span class="op">.</span>rows<span class="op">(</span>T <span class="op">-</span> <span class="bu">std::</span>max<span class="op">(</span>p_y<span class="op">,</span> <span class="dv">1</span><span class="op">),</span> T <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb42-220"><a href="#cb42-220" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-221"><a href="#cb42-221" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Handle factor forecasting based on p_f</span></span>
<span id="cb42-222"><a href="#cb42-222" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>p_f <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-223"><a href="#cb42-223" aria-hidden="true" tabindex="-1"></a>    <span class="co">// No factor dynamics: use constant (mean or zero)</span></span>
<span id="cb42-224"><a href="#cb42-224" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> h<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-225"><a href="#cb42-225" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>Phi_r <span class="op">==</span> <span class="dv">1</span> <span class="op">&amp;&amp;</span> Phi_c <span class="op">==</span> n_factors<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-226"><a href="#cb42-226" aria-hidden="true" tabindex="-1"></a>        F_forecast<span class="op">.</span>row<span class="op">(</span>i<span class="op">)</span> <span class="op">=</span> Phi_f<span class="op">;</span>  <span class="co">// Constant term</span></span>
<span id="cb42-227"><a href="#cb42-227" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb42-228"><a href="#cb42-228" aria-hidden="true" tabindex="-1"></a>        F_forecast<span class="op">.</span>row<span class="op">(</span>i<span class="op">)</span> <span class="op">=</span> zeros<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;(</span><span class="dv">1</span><span class="op">,</span> n_factors<span class="op">);</span></span>
<span id="cb42-229"><a href="#cb42-229" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb42-230"><a href="#cb42-230" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-231"><a href="#cb42-231" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb42-232"><a href="#cb42-232" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Forecast factors using factor VAR</span></span>
<span id="cb42-233"><a href="#cb42-233" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_init <span class="op">=</span> F<span class="op">.</span>rows<span class="op">(</span>T <span class="op">-</span> <span class="bu">std::</span>max<span class="op">(</span>p_f<span class="op">,</span> <span class="dv">1</span><span class="op">),</span> T <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb42-234"><a href="#cb42-234" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_current <span class="op">=</span> vectorise<span class="op">(</span>F_init<span class="op">.</span>t<span class="op">()).</span>t<span class="op">();</span></span>
<span id="cb42-235"><a href="#cb42-235" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-236"><a href="#cb42-236" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> h<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-237"><a href="#cb42-237" aria-hidden="true" tabindex="-1"></a>      Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X_f<span class="op">;</span></span>
<span id="cb42-238"><a href="#cb42-238" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>include_const<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-239"><a href="#cb42-239" aria-hidden="true" tabindex="-1"></a>        Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> ones<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> fill<span class="op">::</span>ones<span class="op">);</span></span>
<span id="cb42-240"><a href="#cb42-240" aria-hidden="true" tabindex="-1"></a>        X_f <span class="op">=</span> join_horiz<span class="op">(</span>ones<span class="op">,</span> F_current<span class="op">);</span></span>
<span id="cb42-241"><a href="#cb42-241" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb42-242"><a href="#cb42-242" aria-hidden="true" tabindex="-1"></a>        X_f <span class="op">=</span> F_current<span class="op">;</span></span>
<span id="cb42-243"><a href="#cb42-243" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb42-244"><a href="#cb42-244" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb42-245"><a href="#cb42-245" aria-hidden="true" tabindex="-1"></a>      Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_pred <span class="op">=</span> X_f <span class="op">*</span> Phi_f<span class="op">;</span></span>
<span id="cb42-246"><a href="#cb42-246" aria-hidden="true" tabindex="-1"></a>      F_forecast<span class="op">.</span>row<span class="op">(</span>i<span class="op">)</span> <span class="op">=</span> F_pred<span class="op">;</span></span>
<span id="cb42-247"><a href="#cb42-247" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb42-248"><a href="#cb42-248" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Update for next iteration</span></span>
<span id="cb42-249"><a href="#cb42-249" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>i <span class="op">&lt;</span> h <span class="op">-</span> <span class="dv">1</span> <span class="op">&amp;&amp;</span> p_f <span class="op">&gt;</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-250"><a href="#cb42-250" aria-hidden="true" tabindex="-1"></a>        Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> new_F_current <span class="op">=</span> join_horiz<span class="op">(</span>F_pred<span class="op">,</span> F_current<span class="op">.</span>cols<span class="op">(</span><span class="dv">0</span><span class="op">,</span> n_factors <span class="op">*</span> <span class="op">(</span>p_f <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">-</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb42-251"><a href="#cb42-251" aria-hidden="true" tabindex="-1"></a>        F_current <span class="op">=</span> new_F_current<span class="op">;</span></span>
<span id="cb42-252"><a href="#cb42-252" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>p_f <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-253"><a href="#cb42-253" aria-hidden="true" tabindex="-1"></a>        F_current <span class="op">=</span> F_pred<span class="op">;</span></span>
<span id="cb42-254"><a href="#cb42-254" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb42-255"><a href="#cb42-255" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-256"><a href="#cb42-256" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-257"><a href="#cb42-257" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-258"><a href="#cb42-258" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Now forecast y using factor forecasts</span></span>
<span id="cb42-259"><a href="#cb42-259" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> y_current <span class="op">=</span> vectorise<span class="op">(</span>y_init<span class="op">.</span>t<span class="op">()).</span>t<span class="op">();</span></span>
<span id="cb42-260"><a href="#cb42-260" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_extended <span class="op">=</span> join_vert<span class="op">(</span>F<span class="op">,</span> F_forecast<span class="op">);</span></span>
<span id="cb42-261"><a href="#cb42-261" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-262"><a href="#cb42-262" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> h<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-263"><a href="#cb42-263" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X_y<span class="op">;</span></span>
<span id="cb42-264"><a href="#cb42-264" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-265"><a href="#cb42-265" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add y lags if p_y &gt; 0</span></span>
<span id="cb42-266"><a href="#cb42-266" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>p_y <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-267"><a href="#cb42-267" aria-hidden="true" tabindex="-1"></a>      X_y <span class="op">=</span> y_current<span class="op">;</span></span>
<span id="cb42-268"><a href="#cb42-268" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-269"><a href="#cb42-269" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-270"><a href="#cb42-270" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add factors (contemporaneous and lagged)</span></span>
<span id="cb42-271"><a href="#cb42-271" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_for_pred <span class="op">=</span> F_extended<span class="op">.</span>row<span class="op">(</span>T <span class="op">+</span> i<span class="op">);</span></span>
<span id="cb42-272"><a href="#cb42-272" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>p_f <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-273"><a href="#cb42-273" aria-hidden="true" tabindex="-1"></a>      <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> lag <span class="op">=</span> <span class="dv">1</span><span class="op">;</span> lag <span class="op">&lt;=</span> p_f<span class="op">;</span> <span class="op">++</span>lag<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-274"><a href="#cb42-274" aria-hidden="true" tabindex="-1"></a>        <span class="cf">if</span> <span class="op">(</span>T <span class="op">+</span> i <span class="op">-</span> lag <span class="op">&gt;=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-275"><a href="#cb42-275" aria-hidden="true" tabindex="-1"></a>          Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> <span class="dt">F_lag_t</span> <span class="op">=</span> F_extended<span class="op">.</span>row<span class="op">(</span>T <span class="op">+</span> i <span class="op">-</span> lag<span class="op">);</span></span>
<span id="cb42-276"><a href="#cb42-276" aria-hidden="true" tabindex="-1"></a>          F_for_pred <span class="op">=</span> join_horiz<span class="op">(</span>F_for_pred<span class="op">,</span> <span class="dt">F_lag_t</span><span class="op">);</span></span>
<span id="cb42-277"><a href="#cb42-277" aria-hidden="true" tabindex="-1"></a>        <span class="op">}</span></span>
<span id="cb42-278"><a href="#cb42-278" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb42-279"><a href="#cb42-279" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-280"><a href="#cb42-280" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-281"><a href="#cb42-281" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>p_y <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-282"><a href="#cb42-282" aria-hidden="true" tabindex="-1"></a>      X_y <span class="op">=</span> join_horiz<span class="op">(</span>X_y<span class="op">,</span> F_for_pred<span class="op">);</span></span>
<span id="cb42-283"><a href="#cb42-283" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb42-284"><a href="#cb42-284" aria-hidden="true" tabindex="-1"></a>      X_y <span class="op">=</span> F_for_pred<span class="op">;</span></span>
<span id="cb42-285"><a href="#cb42-285" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-286"><a href="#cb42-286" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-287"><a href="#cb42-287" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Add constant</span></span>
<span id="cb42-288"><a href="#cb42-288" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>include_const<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-289"><a href="#cb42-289" aria-hidden="true" tabindex="-1"></a>      Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> ones<span class="op">(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">,</span> fill<span class="op">::</span>ones<span class="op">);</span></span>
<span id="cb42-290"><a href="#cb42-290" aria-hidden="true" tabindex="-1"></a>      X_y <span class="op">=</span> join_horiz<span class="op">(</span>ones<span class="op">,</span> X_y<span class="op">);</span></span>
<span id="cb42-291"><a href="#cb42-291" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-292"><a href="#cb42-292" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-293"><a href="#cb42-293" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> y_pred <span class="op">=</span> X_y <span class="op">*</span> beta_y<span class="op">;</span></span>
<span id="cb42-294"><a href="#cb42-294" aria-hidden="true" tabindex="-1"></a>    y_forecast<span class="op">.</span>row<span class="op">(</span>i<span class="op">)</span> <span class="op">=</span> y_pred<span class="op">;</span></span>
<span id="cb42-295"><a href="#cb42-295" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb42-296"><a href="#cb42-296" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update y_current for next iteration</span></span>
<span id="cb42-297"><a href="#cb42-297" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>i <span class="op">&lt;</span> h <span class="op">-</span> <span class="dv">1</span> <span class="op">&amp;&amp;</span> p_y <span class="op">&gt;</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-298"><a href="#cb42-298" aria-hidden="true" tabindex="-1"></a>      Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> new_y_current <span class="op">=</span> join_horiz<span class="op">(</span>y_pred<span class="op">,</span> y_current<span class="op">.</span>cols<span class="op">(</span><span class="dv">0</span><span class="op">,</span> K <span class="op">*</span> <span class="op">(</span>p_y <span class="op">-</span> <span class="dv">1</span><span class="op">)</span> <span class="op">-</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb42-299"><a href="#cb42-299" aria-hidden="true" tabindex="-1"></a>      y_current <span class="op">=</span> new_y_current<span class="op">;</span></span>
<span id="cb42-300"><a href="#cb42-300" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>p_y <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-301"><a href="#cb42-301" aria-hidden="true" tabindex="-1"></a>      y_current <span class="op">=</span> y_pred<span class="op">;</span></span>
<span id="cb42-302"><a href="#cb42-302" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb42-303"><a href="#cb42-303" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-304"><a href="#cb42-304" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-305"><a href="#cb42-305" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> y_forecast<span class="op">;</span></span>
<span id="cb42-306"><a href="#cb42-306" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb42-307"><a href="#cb42-307" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-308"><a href="#cb42-308" aria-hidden="true" tabindex="-1"></a><span class="co">/* roxygen</span></span>
<span id="cb42-309"><a href="#cb42-309" aria-hidden="true" tabindex="-1"></a><span class="co">@title Main FAVAR estimation function</span></span>
<span id="cb42-310"><a href="#cb42-310" aria-hidden="true" tabindex="-1"></a><span class="co">@export</span></span>
<span id="cb42-311"><a href="#cb42-311" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb42-312"><a href="#cb42-312" aria-hidden="true" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp4r</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span> list favar_model<span class="op">(</span><span class="at">const</span> doubles_matrix<span class="op">&lt;&gt;&amp;</span> y<span class="op">,</span> <span class="at">const</span> doubles_matrix<span class="op">&lt;&gt;&amp;</span> x<span class="op">,</span></span>
<span id="cb42-313"><a href="#cb42-313" aria-hidden="true" tabindex="-1"></a>                                     <span class="dt">int</span> n_factors<span class="op">,</span> <span class="dt">int</span> p_y <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">int</span> p_f <span class="op">=</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb42-314"><a href="#cb42-314" aria-hidden="true" tabindex="-1"></a>                                     <span class="dt">bool</span> include_const <span class="op">=</span> <span class="kw">true</span><span class="op">,</span> <span class="dt">int</span> forecast_h <span class="op">=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-315"><a href="#cb42-315" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-316"><a href="#cb42-316" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Y <span class="op">=</span> as_Mat<span class="op">(</span>y<span class="op">);</span></span>
<span id="cb42-317"><a href="#cb42-317" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X <span class="op">=</span> as_Mat<span class="op">(</span>x<span class="op">);</span></span>
<span id="cb42-318"><a href="#cb42-318" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-319"><a href="#cb42-319" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> Y<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb42-320"><a href="#cb42-320" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> K <span class="op">=</span> Y<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb42-321"><a href="#cb42-321" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> N <span class="op">=</span> X<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb42-322"><a href="#cb42-322" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> P <span class="op">=</span> X<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb42-323"><a href="#cb42-323" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-324"><a href="#cb42-324" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>T <span class="op">!=</span> N<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-325"><a href="#cb42-325" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span><span class="st">"y and X must have the same number of observations"</span><span class="op">);</span></span>
<span id="cb42-326"><a href="#cb42-326" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-327"><a href="#cb42-327" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-328"><a href="#cb42-328" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>T <span class="op">&lt;=</span> <span class="bu">std::</span>max<span class="op">(</span>p_y<span class="op">,</span> p_f<span class="op">))</span> <span class="op">{</span></span>
<span id="cb42-329"><a href="#cb42-329" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span><span class="st">"Sample size must be greater than maximum lag order"</span><span class="op">);</span></span>
<span id="cb42-330"><a href="#cb42-330" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-331"><a href="#cb42-331" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-332"><a href="#cb42-332" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>n_factors <span class="op">&gt;=</span> P<span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-333"><a href="#cb42-333" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span><span class="st">"Number of factors must be less than number of X variables"</span><span class="op">);</span></span>
<span id="cb42-334"><a href="#cb42-334" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-335"><a href="#cb42-335" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-336"><a href="#cb42-336" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Step 1: Extract factors from large dataset X</span></span>
<span id="cb42-337"><a href="#cb42-337" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> factor_result <span class="op">=</span> <span class="va">favar_extract_factors_</span><span class="op">(</span>X<span class="op">,</span> n_factors<span class="op">);</span></span>
<span id="cb42-338"><a href="#cb42-338" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F <span class="op">=</span> factor_result<span class="op">.</span>first<span class="op">;</span></span>
<span id="cb42-339"><a href="#cb42-339" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Lambda <span class="op">=</span> factor_result<span class="op">.</span>second<span class="op">;</span></span>
<span id="cb42-340"><a href="#cb42-340" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-341"><a href="#cb42-341" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Step 2: Estimate factor VAR</span></span>
<span id="cb42-342"><a href="#cb42-342" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Phi <span class="op">=</span> <span class="va">favar_factor_var_</span><span class="op">(</span>F<span class="op">,</span> p_f<span class="op">,</span> include_const<span class="op">);</span></span>
<span id="cb42-343"><a href="#cb42-343" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-344"><a href="#cb42-344" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Step 3: Estimate augmented VAR</span></span>
<span id="cb42-345"><a href="#cb42-345" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> var_result <span class="op">=</span> <span class="va">favar_augmented_var_</span><span class="op">(</span>Y<span class="op">,</span> F<span class="op">,</span> p_y<span class="op">,</span> p_f<span class="op">,</span> include_const<span class="op">);</span></span>
<span id="cb42-346"><a href="#cb42-346" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> beta <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">0</span><span class="op">&gt;(</span>var_result<span class="op">);</span></span>
<span id="cb42-347"><a href="#cb42-347" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> C <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">1</span><span class="op">&gt;(</span>var_result<span class="op">);</span></span>
<span id="cb42-348"><a href="#cb42-348" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-349"><a href="#cb42-349" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Step 4: Compute fitted values and residuals</span></span>
<span id="cb42-350"><a href="#cb42-350" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> fitted_resid <span class="op">=</span> <span class="va">favar_fitted_resid_</span><span class="op">(</span>Y<span class="op">,</span> F<span class="op">,</span> beta<span class="op">,</span> p_y<span class="op">,</span> p_f<span class="op">,</span> include_const<span class="op">);</span></span>
<span id="cb42-351"><a href="#cb42-351" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> y_fitted <span class="op">=</span> fitted_resid<span class="op">.</span>first<span class="op">;</span></span>
<span id="cb42-352"><a href="#cb42-352" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> residuals <span class="op">=</span> fitted_resid<span class="op">.</span>second<span class="op">;</span></span>
<span id="cb42-353"><a href="#cb42-353" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-354"><a href="#cb42-354" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute residual covariance matrix</span></span>
<span id="cb42-355"><a href="#cb42-355" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Sigma <span class="op">=</span> <span class="op">(</span>residuals<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> residuals<span class="op">)</span> <span class="op">/</span> <span class="op">(</span>residuals<span class="op">.</span>n_rows <span class="op">-</span> beta<span class="op">.</span>n_rows<span class="op">);</span></span>
<span id="cb42-356"><a href="#cb42-356" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-357"><a href="#cb42-357" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute factor residuals</span></span>
<span id="cb42-358"><a href="#cb42-358" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> factor_fitted_resid <span class="op">=</span> <span class="va">var_fitted_resid_</span><span class="op">(</span>F<span class="op">,</span> Phi<span class="op">,</span> p_f<span class="op">,</span> include_const<span class="op">);</span></span>
<span id="cb42-359"><a href="#cb42-359" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_residuals <span class="op">=</span> factor_fitted_resid<span class="op">.</span>second<span class="op">;</span></span>
<span id="cb42-360"><a href="#cb42-360" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Omega <span class="op">=</span> <span class="op">(</span>F_residuals<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> F_residuals<span class="op">)</span> <span class="op">/</span> <span class="op">(</span>F_residuals<span class="op">.</span>n_rows <span class="op">-</span> Phi<span class="op">.</span>n_rows<span class="op">);</span></span>
<span id="cb42-361"><a href="#cb42-361" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-362"><a href="#cb42-362" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute AIC</span></span>
<span id="cb42-363"><a href="#cb42-363" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n_params <span class="op">=</span> beta<span class="op">.</span>n_rows <span class="op">*</span> K<span class="op">;</span>  <span class="co">// Total number of parameters in augmented VAR</span></span>
<span id="cb42-364"><a href="#cb42-364" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> aic <span class="op">=</span> aic_metric<span class="op">(</span>residuals<span class="op">,</span> n_params<span class="op">);</span></span>
<span id="cb42-365"><a href="#cb42-365" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-366"><a href="#cb42-366" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Prepare results list</span></span>
<span id="cb42-367"><a href="#cb42-367" aria-hidden="true" tabindex="-1"></a>  writable<span class="op">::</span>list result<span class="op">(</span><span class="dv">16</span><span class="op">);</span></span>
<span id="cb42-368"><a href="#cb42-368" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-369"><a href="#cb42-369" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>beta<span class="op">);</span></span>
<span id="cb42-370"><a href="#cb42-370" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>Phi<span class="op">);</span></span>
<span id="cb42-371"><a href="#cb42-371" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>Lambda<span class="op">);</span></span>
<span id="cb42-372"><a href="#cb42-372" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>F<span class="op">);</span></span>
<span id="cb42-373"><a href="#cb42-373" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">4</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>y_fitted<span class="op">);</span></span>
<span id="cb42-374"><a href="#cb42-374" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">5</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>residuals<span class="op">);</span></span>
<span id="cb42-375"><a href="#cb42-375" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">6</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>F_residuals<span class="op">);</span></span>
<span id="cb42-376"><a href="#cb42-376" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">7</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>Sigma<span class="op">);</span></span>
<span id="cb42-377"><a href="#cb42-377" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">8</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>Omega<span class="op">);</span></span>
<span id="cb42-378"><a href="#cb42-378" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">9</span><span class="op">]</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>n_factors<span class="op">);</span></span>
<span id="cb42-379"><a href="#cb42-379" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">10</span><span class="op">]</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>p_y<span class="op">);</span></span>
<span id="cb42-380"><a href="#cb42-380" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">11</span><span class="op">]</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>p_f<span class="op">);</span></span>
<span id="cb42-381"><a href="#cb42-381" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">12</span><span class="op">]</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>K<span class="op">);</span></span>
<span id="cb42-382"><a href="#cb42-382" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">13</span><span class="op">]</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>N<span class="op">);</span></span>
<span id="cb42-383"><a href="#cb42-383" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">14</span><span class="op">]</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>T <span class="op">-</span> <span class="bu">std::</span>max<span class="op">(</span>p_y<span class="op">,</span> p_f<span class="op">));</span></span>
<span id="cb42-384"><a href="#cb42-384" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">15</span><span class="op">]</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>include_const<span class="op">);</span></span>
<span id="cb42-385"><a href="#cb42-385" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-386"><a href="#cb42-386" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>names<span class="op">()</span> <span class="op">=</span> <span class="op">{</span><span class="st">"coefficients"</span><span class="op">,</span> <span class="st">"factor_coefficients"</span><span class="op">,</span> <span class="st">"factor_loadings"</span><span class="op">,</span> <span class="st">"factors"</span><span class="op">,</span></span>
<span id="cb42-387"><a href="#cb42-387" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"fitted_values"</span><span class="op">,</span> <span class="st">"residuals"</span><span class="op">,</span> <span class="st">"factor_residuals"</span><span class="op">,</span> <span class="st">"sigma"</span><span class="op">,</span> <span class="st">"omega"</span><span class="op">,</span></span>
<span id="cb42-388"><a href="#cb42-388" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"n_factors"</span><span class="op">,</span> <span class="st">"lag_order_y"</span><span class="op">,</span> <span class="st">"lag_order_f"</span><span class="op">,</span> <span class="st">"n_variables"</span><span class="op">,</span> <span class="st">"n_observables"</span><span class="op">,</span></span>
<span id="cb42-389"><a href="#cb42-389" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"n_obs"</span><span class="op">,</span> <span class="st">"include_const"</span><span class="op">};</span></span>
<span id="cb42-390"><a href="#cb42-390" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-391"><a href="#cb42-391" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add forecasts if requested</span></span>
<span id="cb42-392"><a href="#cb42-392" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>forecast_h <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb42-393"><a href="#cb42-393" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> forecasts <span class="op">=</span> <span class="va">favar_forecast_</span><span class="op">(</span>Y<span class="op">,</span> F<span class="op">,</span> beta<span class="op">,</span> Phi<span class="op">,</span> p_y<span class="op">,</span> p_f<span class="op">,</span> forecast_h<span class="op">,</span> include_const<span class="op">);</span></span>
<span id="cb42-394"><a href="#cb42-394" aria-hidden="true" tabindex="-1"></a>    result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"forecasts"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>forecasts<span class="op">)});</span></span>
<span id="cb42-395"><a href="#cb42-395" aria-hidden="true" tabindex="-1"></a>    result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"forecast_horizon"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>forecast_h<span class="op">)});</span></span>
<span id="cb42-396"><a href="#cb42-396" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb42-397"><a href="#cb42-397" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb42-398"><a href="#cb42-398" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add model metrics</span></span>
<span id="cb42-399"><a href="#cb42-399" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"rmsfe"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>rmsfe<span class="op">(</span>Y<span class="op">.</span>rows<span class="op">(</span><span class="bu">std::</span>max<span class="op">(</span>p_y<span class="op">,</span> p_f<span class="op">),</span> T<span class="op">-</span><span class="dv">1</span><span class="op">),</span> y_fitted<span class="op">))});</span></span>
<span id="cb42-400"><a href="#cb42-400" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"mae"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>mae<span class="op">(</span>Y<span class="op">.</span>rows<span class="op">(</span><span class="bu">std::</span>max<span class="op">(</span>p_y<span class="op">,</span> p_f<span class="op">),</span> T<span class="op">-</span><span class="dv">1</span><span class="op">),</span> y_fitted<span class="op">))});</span></span>
<span id="cb42-401"><a href="#cb42-401" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"aic"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>aic<span class="op">)});</span></span>
<span id="cb42-402"><a href="#cb42-402" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb42-403"><a href="#cb42-403" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb42-404"><a href="#cb42-404" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
<section id="dfm-model" class="level2">
<h2 class="anchored" data-anchor-id="dfm-model">DFM model</h2>
<div class="sourceCode" id="cb43"><pre class="sourceCode cpp code-with-copy"><code class="sourceCode cpp"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="co">/*</span></span>
<span id="cb43-2"><a href="#cb43-2" aria-hidden="true" tabindex="-1"></a><span class="co">==============================================</span></span>
<span id="cb43-3"><a href="#cb43-3" aria-hidden="true" tabindex="-1"></a><span class="co">Dynamic Factor Model (DFM)</span></span>
<span id="cb43-4"><a href="#cb43-4" aria-hidden="true" tabindex="-1"></a><span class="co">==============================================</span></span>
<span id="cb43-5"><a href="#cb43-5" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb43-6"><a href="#cb43-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-7"><a href="#cb43-7" aria-hidden="true" tabindex="-1"></a><span class="co">// Simple PCA factor extraction (similar to FA-VAR)</span></span>
<span id="cb43-8"><a href="#cb43-8" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>pair<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;</span> <span class="va">dfm_extract_factors_</span><span class="op">(</span><span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> X<span class="op">,</span> <span class="dt">int</span> n_factors<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-9"><a href="#cb43-9" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Center the data</span></span>
<span id="cb43-10"><a href="#cb43-10" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X_centered <span class="op">=</span> X<span class="op">.</span>each_row<span class="op">()</span> <span class="op">-</span> mean<span class="op">(</span>X<span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb43-11"><a href="#cb43-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-12"><a href="#cb43-12" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Perform SVD on X' (N x T matrix)</span></span>
<span id="cb43-13"><a href="#cb43-13" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> U<span class="op">,</span> V<span class="op">;</span></span>
<span id="cb43-14"><a href="#cb43-14" aria-hidden="true" tabindex="-1"></a>  vec s<span class="op">;</span></span>
<span id="cb43-15"><a href="#cb43-15" aria-hidden="true" tabindex="-1"></a>  svd_econ<span class="op">(</span>U<span class="op">,</span> s<span class="op">,</span> V<span class="op">,</span> X_centered<span class="op">.</span>t<span class="op">());</span></span>
<span id="cb43-16"><a href="#cb43-16" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-17"><a href="#cb43-17" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Factor loadings (first n_factors principal components)</span></span>
<span id="cb43-18"><a href="#cb43-18" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Lambda <span class="op">=</span> U<span class="op">.</span>cols<span class="op">(</span><span class="dv">0</span><span class="op">,</span> n_factors<span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb43-19"><a href="#cb43-19" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-20"><a href="#cb43-20" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Common factors (T x n_factors)</span></span>
<span id="cb43-21"><a href="#cb43-21" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F <span class="op">=</span> X_centered <span class="op">*</span> Lambda<span class="op">;</span></span>
<span id="cb43-22"><a href="#cb43-22" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-23"><a href="#cb43-23" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">std::</span>make_pair<span class="op">(</span>F<span class="op">,</span> Lambda<span class="op">);</span></span>
<span id="cb43-24"><a href="#cb43-24" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb43-25"><a href="#cb43-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-26"><a href="#cb43-26" aria-hidden="true" tabindex="-1"></a><span class="co">// Initialize DFM parameters using PCA and simple VAR</span></span>
<span id="cb43-27"><a href="#cb43-27" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>tuple<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;</span> <span class="va">dfm_init_</span><span class="op">(</span></span>
<span id="cb43-28"><a href="#cb43-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> X<span class="op">,</span> <span class="dt">int</span> n_factors<span class="op">,</span> <span class="dt">int</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-29"><a href="#cb43-29" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-30"><a href="#cb43-30" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Step 1: Extract factors using PCA</span></span>
<span id="cb43-31"><a href="#cb43-31" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> factor_result <span class="op">=</span> <span class="va">dfm_extract_factors_</span><span class="op">(</span>X<span class="op">,</span> n_factors<span class="op">);</span></span>
<span id="cb43-32"><a href="#cb43-32" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F <span class="op">=</span> factor_result<span class="op">.</span>first<span class="op">;</span></span>
<span id="cb43-33"><a href="#cb43-33" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Lambda <span class="op">=</span> factor_result<span class="op">.</span>second<span class="op">;</span></span>
<span id="cb43-34"><a href="#cb43-34" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-35"><a href="#cb43-35" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Step 2: Estimate factor VAR (reuse existing functions)</span></span>
<span id="cb43-36"><a href="#cb43-36" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> A<span class="op">;</span></span>
<span id="cb43-37"><a href="#cb43-37" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Q<span class="op">;</span></span>
<span id="cb43-38"><a href="#cb43-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-39"><a href="#cb43-39" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>p <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-40"><a href="#cb43-40" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Use same approach as FA-VAR for factor dynamics</span></span>
<span id="cb43-41"><a href="#cb43-41" aria-hidden="true" tabindex="-1"></a>    A <span class="op">=</span> <span class="va">var_estimate_</span><span class="op">(</span>as_doubles_matrix<span class="op">(</span>F<span class="op">),</span> p<span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb43-42"><a href="#cb43-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-43"><a href="#cb43-43" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Compute residual covariance</span></span>
<span id="cb43-44"><a href="#cb43-44" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> fitted_resid <span class="op">=</span> <span class="va">var_fitted_resid_</span><span class="op">(</span>F<span class="op">,</span> A<span class="op">,</span> p<span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb43-45"><a href="#cb43-45" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> eta <span class="op">=</span> fitted_resid<span class="op">.</span>second<span class="op">;</span></span>
<span id="cb43-46"><a href="#cb43-46" aria-hidden="true" tabindex="-1"></a>    Q <span class="op">=</span> <span class="op">(</span>eta<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> eta<span class="op">)</span> <span class="op">/</span> <span class="op">(</span>eta<span class="op">.</span>n_rows <span class="op">-</span> A<span class="op">.</span>n_rows<span class="op">);</span></span>
<span id="cb43-47"><a href="#cb43-47" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb43-48"><a href="#cb43-48" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Static factor model: no dynamics, just return mean</span></span>
<span id="cb43-49"><a href="#cb43-49" aria-hidden="true" tabindex="-1"></a>    A <span class="op">=</span> mean<span class="op">(</span>F<span class="op">,</span> <span class="dv">0</span><span class="op">).</span>t<span class="op">();</span>  <span class="co">// Column vector of factor means</span></span>
<span id="cb43-50"><a href="#cb43-50" aria-hidden="true" tabindex="-1"></a>    Q <span class="op">=</span> eye<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;(</span>n_factors<span class="op">,</span> n_factors<span class="op">)</span> <span class="op">*</span> <span class="fl">0.1</span><span class="op">;</span></span>
<span id="cb43-51"><a href="#cb43-51" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-52"><a href="#cb43-52" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-53"><a href="#cb43-53" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Initialize R as diagonal</span></span>
<span id="cb43-54"><a href="#cb43-54" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X_fitted <span class="op">=</span> F <span class="op">*</span> Lambda<span class="op">.</span>t<span class="op">();</span></span>
<span id="cb43-55"><a href="#cb43-55" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> residuals <span class="op">=</span> X <span class="op">-</span> X_fitted<span class="op">;</span></span>
<span id="cb43-56"><a href="#cb43-56" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> R <span class="op">=</span> diagmat<span class="op">(</span>sum<span class="op">(</span>square<span class="op">(</span>residuals<span class="op">),</span> <span class="dv">0</span><span class="op">)</span> <span class="op">/</span> X<span class="op">.</span>n_rows<span class="op">);</span></span>
<span id="cb43-57"><a href="#cb43-57" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-58"><a href="#cb43-58" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">std::</span>make_tuple<span class="op">(</span>Lambda<span class="op">,</span> A<span class="op">,</span> Q<span class="op">,</span> R<span class="op">);</span></span>
<span id="cb43-59"><a href="#cb43-59" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb43-60"><a href="#cb43-60" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-61"><a href="#cb43-61" aria-hidden="true" tabindex="-1"></a><span class="co">// Kalman Filter for DFM</span></span>
<span id="cb43-62"><a href="#cb43-62" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>tuple<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;</span> <span class="va">dfm_kalman_</span><span class="op">(</span></span>
<span id="cb43-63"><a href="#cb43-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> X<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> Lambda<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> A<span class="op">,</span></span>
<span id="cb43-64"><a href="#cb43-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> Q<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> R<span class="op">,</span> <span class="dt">int</span> n_factors<span class="op">,</span> <span class="dt">int</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-65"><a href="#cb43-65" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-66"><a href="#cb43-66" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> X<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb43-67"><a href="#cb43-67" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> N <span class="op">=</span> X<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb43-68"><a href="#cb43-68" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-69"><a href="#cb43-69" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Initialize state variables</span></span>
<span id="cb43-70"><a href="#cb43-70" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_pred<span class="op">(</span>T<span class="op">,</span> n_factors <span class="op">*</span> <span class="bu">std::</span>max<span class="op">(</span>p<span class="op">,</span> <span class="dv">1</span><span class="op">));</span>  <span class="co">// Predicted factors</span></span>
<span id="cb43-71"><a href="#cb43-71" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_upd<span class="op">(</span>T<span class="op">,</span> n_factors <span class="op">*</span> <span class="bu">std::</span>max<span class="op">(</span>p<span class="op">,</span> <span class="dv">1</span><span class="op">));</span>   <span class="co">// Updated factors</span></span>
<span id="cb43-72"><a href="#cb43-72" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> P_pred<span class="op">(</span>n_factors <span class="op">*</span> <span class="bu">std::</span>max<span class="op">(</span>p<span class="op">,</span> <span class="dv">1</span><span class="op">),</span> n_factors <span class="op">*</span> <span class="bu">std::</span>max<span class="op">(</span>p<span class="op">,</span> <span class="dv">1</span><span class="op">));</span> <span class="co">// Predicted covariance</span></span>
<span id="cb43-73"><a href="#cb43-73" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> P_upd<span class="op">(</span>n_factors <span class="op">*</span> <span class="bu">std::</span>max<span class="op">(</span>p<span class="op">,</span> <span class="dv">1</span><span class="op">),</span> n_factors <span class="op">*</span> <span class="bu">std::</span>max<span class="op">(</span>p<span class="op">,</span> <span class="dv">1</span><span class="op">));</span>  <span class="co">// Updated covariance</span></span>
<span id="cb43-74"><a href="#cb43-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-75"><a href="#cb43-75" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Log likelihood</span></span>
<span id="cb43-76"><a href="#cb43-76" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> loglik <span class="op">=</span> <span class="fl">0.0</span><span class="op">;</span></span>
<span id="cb43-77"><a href="#cb43-77" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-78"><a href="#cb43-78" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Observation matrix H (maps states to factors)</span></span>
<span id="cb43-79"><a href="#cb43-79" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> H <span class="op">=</span> zeros<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;(</span>N<span class="op">,</span> n_factors <span class="op">*</span> <span class="bu">std::</span>max<span class="op">(</span>p<span class="op">,</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb43-80"><a href="#cb43-80" aria-hidden="true" tabindex="-1"></a>  H<span class="op">.</span>submat<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> N<span class="op">-</span><span class="dv">1</span><span class="op">,</span> n_factors<span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">=</span> Lambda<span class="op">;</span></span>
<span id="cb43-81"><a href="#cb43-81" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-82"><a href="#cb43-82" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Transition matrix F_trans</span></span>
<span id="cb43-83"><a href="#cb43-83" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_trans<span class="op">;</span></span>
<span id="cb43-84"><a href="#cb43-84" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>p <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-85"><a href="#cb43-85" aria-hidden="true" tabindex="-1"></a>    F_trans <span class="op">=</span> <span class="va">var_companion_</span><span class="op">(</span>A<span class="op">,</span> p<span class="op">,</span> n_factors<span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb43-86"><a href="#cb43-86" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb43-87"><a href="#cb43-87" aria-hidden="true" tabindex="-1"></a>    F_trans <span class="op">=</span> eye<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;(</span>n_factors<span class="op">,</span> n_factors<span class="op">);</span></span>
<span id="cb43-88"><a href="#cb43-88" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-89"><a href="#cb43-89" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-90"><a href="#cb43-90" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Process noise covariance</span></span>
<span id="cb43-91"><a href="#cb43-91" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Q_full <span class="op">=</span> zeros<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;(</span>n_factors <span class="op">*</span> <span class="bu">std::</span>max<span class="op">(</span>p<span class="op">,</span> <span class="dv">1</span><span class="op">),</span> n_factors <span class="op">*</span> <span class="bu">std::</span>max<span class="op">(</span>p<span class="op">,</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb43-92"><a href="#cb43-92" aria-hidden="true" tabindex="-1"></a>  Q_full<span class="op">.</span>submat<span class="op">(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">,</span> n_factors<span class="op">-</span><span class="dv">1</span><span class="op">,</span> n_factors<span class="op">-</span><span class="dv">1</span><span class="op">)</span> <span class="op">=</span> Q<span class="op">;</span></span>
<span id="cb43-93"><a href="#cb43-93" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-94"><a href="#cb43-94" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Initial conditions</span></span>
<span id="cb43-95"><a href="#cb43-95" aria-hidden="true" tabindex="-1"></a>  vec mu0 <span class="op">=</span> zeros<span class="op">&lt;</span>vec<span class="op">&gt;(</span>n_factors <span class="op">*</span> <span class="bu">std::</span>max<span class="op">(</span>p<span class="op">,</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb43-96"><a href="#cb43-96" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> P0 <span class="op">=</span> eye<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;(</span>n_factors <span class="op">*</span> <span class="bu">std::</span>max<span class="op">(</span>p<span class="op">,</span> <span class="dv">1</span><span class="op">),</span> n_factors <span class="op">*</span> <span class="bu">std::</span>max<span class="op">(</span>p<span class="op">,</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb43-97"><a href="#cb43-97" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-98"><a href="#cb43-98" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Kalman filter loop</span></span>
<span id="cb43-99"><a href="#cb43-99" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> t <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> t <span class="op">&lt;</span> T<span class="op">;</span> <span class="op">++</span>t<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-100"><a href="#cb43-100" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>t <span class="op">==</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-101"><a href="#cb43-101" aria-hidden="true" tabindex="-1"></a>      F_pred<span class="op">.</span>row<span class="op">(</span>t<span class="op">)</span> <span class="op">=</span> mu0<span class="op">.</span>t<span class="op">();</span></span>
<span id="cb43-102"><a href="#cb43-102" aria-hidden="true" tabindex="-1"></a>      P_pred <span class="op">=</span> P0<span class="op">;</span></span>
<span id="cb43-103"><a href="#cb43-103" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb43-104"><a href="#cb43-104" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Prediction step</span></span>
<span id="cb43-105"><a href="#cb43-105" aria-hidden="true" tabindex="-1"></a>      F_pred<span class="op">.</span>row<span class="op">(</span>t<span class="op">)</span> <span class="op">=</span> <span class="op">(</span>F_trans <span class="op">*</span> F_upd<span class="op">.</span>row<span class="op">(</span>t<span class="op">-</span><span class="dv">1</span><span class="op">).</span>t<span class="op">()).</span>t<span class="op">();</span></span>
<span id="cb43-106"><a href="#cb43-106" aria-hidden="true" tabindex="-1"></a>      P_pred <span class="op">=</span> F_trans <span class="op">*</span> P_upd <span class="op">*</span> F_trans<span class="op">.</span>t<span class="op">()</span> <span class="op">+</span> Q_full<span class="op">;</span></span>
<span id="cb43-107"><a href="#cb43-107" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-108"><a href="#cb43-108" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-109"><a href="#cb43-109" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update step</span></span>
<span id="cb43-110"><a href="#cb43-110" aria-hidden="true" tabindex="-1"></a>    vec <span class="dt">y_t</span> <span class="op">=</span> X<span class="op">.</span>row<span class="op">(</span>t<span class="op">).</span>t<span class="op">();</span></span>
<span id="cb43-111"><a href="#cb43-111" aria-hidden="true" tabindex="-1"></a>    vec y_pred <span class="op">=</span> H <span class="op">*</span> F_pred<span class="op">.</span>row<span class="op">(</span>t<span class="op">).</span>t<span class="op">();</span></span>
<span id="cb43-112"><a href="#cb43-112" aria-hidden="true" tabindex="-1"></a>    vec innov <span class="op">=</span> <span class="dt">y_t</span> <span class="op">-</span> y_pred<span class="op">;</span></span>
<span id="cb43-113"><a href="#cb43-113" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-114"><a href="#cb43-114" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> S <span class="op">=</span> H <span class="op">*</span> P_pred <span class="op">*</span> H<span class="op">.</span>t<span class="op">()</span> <span class="op">+</span> R<span class="op">;</span></span>
<span id="cb43-115"><a href="#cb43-115" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> K <span class="op">=</span> P_pred <span class="op">*</span> H<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> inv<span class="op">(</span>S<span class="op">);</span></span>
<span id="cb43-116"><a href="#cb43-116" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-117"><a href="#cb43-117" aria-hidden="true" tabindex="-1"></a>    F_upd<span class="op">.</span>row<span class="op">(</span>t<span class="op">)</span> <span class="op">=</span> F_pred<span class="op">.</span>row<span class="op">(</span>t<span class="op">)</span> <span class="op">+</span> <span class="op">(</span>K <span class="op">*</span> innov<span class="op">).</span>t<span class="op">();</span></span>
<span id="cb43-118"><a href="#cb43-118" aria-hidden="true" tabindex="-1"></a>    P_upd <span class="op">=</span> <span class="op">(</span>eye<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;(</span>P_pred<span class="op">.</span>n_rows<span class="op">,</span> P_pred<span class="op">.</span>n_cols<span class="op">)</span> <span class="op">-</span> K <span class="op">*</span> H<span class="op">)</span> <span class="op">*</span> P_pred<span class="op">;</span></span>
<span id="cb43-119"><a href="#cb43-119" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-120"><a href="#cb43-120" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Log likelihood</span></span>
<span id="cb43-121"><a href="#cb43-121" aria-hidden="true" tabindex="-1"></a>    loglik <span class="op">+=</span> <span class="op">-</span><span class="fl">0.5</span> <span class="op">*</span> <span class="op">(</span>N <span class="op">*</span> log<span class="op">(</span><span class="dv">2</span> <span class="op">*</span> datum<span class="op">::</span>pi<span class="op">)</span> <span class="op">+</span> log<span class="op">(</span>det<span class="op">(</span>S<span class="op">))</span> <span class="op">+</span> dot<span class="op">(</span>innov<span class="op">,</span> solve<span class="op">(</span>S<span class="op">,</span> innov<span class="op">)));</span></span>
<span id="cb43-122"><a href="#cb43-122" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-123"><a href="#cb43-123" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-124"><a href="#cb43-124" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Extract just the factors (first n_factors columns)</span></span>
<span id="cb43-125"><a href="#cb43-125" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_smooth <span class="op">=</span> F_upd<span class="op">.</span>cols<span class="op">(</span><span class="dv">0</span><span class="op">,</span> n_factors<span class="op">-</span><span class="dv">1</span><span class="op">);</span></span>
<span id="cb43-126"><a href="#cb43-126" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-127"><a href="#cb43-127" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">std::</span>make_tuple<span class="op">(</span>F_smooth<span class="op">,</span> F_upd<span class="op">,</span> loglik <span class="op">*</span> arma<span class="op">::</span>ones<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;(</span><span class="dv">1</span><span class="op">,</span> <span class="dv">1</span><span class="op">));</span></span>
<span id="cb43-128"><a href="#cb43-128" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb43-129"><a href="#cb43-129" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-130"><a href="#cb43-130" aria-hidden="true" tabindex="-1"></a><span class="co">// Simplified EM Algorithm for DFM parameter estimation</span></span>
<span id="cb43-131"><a href="#cb43-131" aria-hidden="true" tabindex="-1"></a><span class="bu">std::</span>tuple<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;,</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;</span> <span class="va">dfm_em_</span><span class="op">(</span></span>
<span id="cb43-132"><a href="#cb43-132" aria-hidden="true" tabindex="-1"></a>    <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> X<span class="op">,</span> <span class="dt">int</span> n_factors<span class="op">,</span> <span class="dt">int</span> p<span class="op">,</span> <span class="dt">int</span> max_iter <span class="op">=</span> <span class="dv">50</span><span class="op">,</span> <span class="dt">double</span> tol <span class="op">=</span> <span class="fl">1e-4</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-133"><a href="#cb43-133" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-134"><a href="#cb43-134" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> X<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb43-135"><a href="#cb43-135" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-136"><a href="#cb43-136" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Initialize parameters (simplified)</span></span>
<span id="cb43-137"><a href="#cb43-137" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> init_params <span class="op">=</span> <span class="va">dfm_init_</span><span class="op">(</span>X<span class="op">,</span> n_factors<span class="op">,</span> p<span class="op">);</span></span>
<span id="cb43-138"><a href="#cb43-138" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Lambda <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">0</span><span class="op">&gt;(</span>init_params<span class="op">);</span></span>
<span id="cb43-139"><a href="#cb43-139" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> A <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">1</span><span class="op">&gt;(</span>init_params<span class="op">);</span></span>
<span id="cb43-140"><a href="#cb43-140" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Q <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">2</span><span class="op">&gt;(</span>init_params<span class="op">);</span></span>
<span id="cb43-141"><a href="#cb43-141" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> R <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">3</span><span class="op">&gt;(</span>init_params<span class="op">);</span></span>
<span id="cb43-142"><a href="#cb43-142" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-143"><a href="#cb43-143" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> prev_loglik <span class="op">=</span> <span class="op">-</span>datum<span class="op">::</span>inf<span class="op">;</span></span>
<span id="cb43-144"><a href="#cb43-144" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-145"><a href="#cb43-145" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Simplified EM iterations</span></span>
<span id="cb43-146"><a href="#cb43-146" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> iter <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> iter <span class="op">&lt;</span> max_iter<span class="op">;</span> <span class="op">++</span>iter<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-147"><a href="#cb43-147" aria-hidden="true" tabindex="-1"></a>    <span class="co">// E-step: Kalman filter and smoother</span></span>
<span id="cb43-148"><a href="#cb43-148" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> kalman_result <span class="op">=</span> <span class="va">dfm_kalman_</span><span class="op">(</span>X<span class="op">,</span> Lambda<span class="op">,</span> A<span class="op">,</span> Q<span class="op">,</span> R<span class="op">,</span> n_factors<span class="op">,</span> p<span class="op">);</span></span>
<span id="cb43-149"><a href="#cb43-149" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_smooth <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">0</span><span class="op">&gt;(</span>kalman_result<span class="op">);</span></span>
<span id="cb43-150"><a href="#cb43-150" aria-hidden="true" tabindex="-1"></a>    <span class="dt">double</span> loglik <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">2</span><span class="op">&gt;(</span>kalman_result<span class="op">)(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb43-151"><a href="#cb43-151" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-152"><a href="#cb43-152" aria-hidden="true" tabindex="-1"></a>    <span class="co">// M-step: Simplified parameter updates</span></span>
<span id="cb43-153"><a href="#cb43-153" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-154"><a href="#cb43-154" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update Lambda (factor loadings) - simplified</span></span>
<span id="cb43-155"><a href="#cb43-155" aria-hidden="true" tabindex="-1"></a>    Lambda <span class="op">=</span> solve<span class="op">(</span>F_smooth<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> F_smooth<span class="op">,</span> F_smooth<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> X<span class="op">).</span>t<span class="op">();</span></span>
<span id="cb43-156"><a href="#cb43-156" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-157"><a href="#cb43-157" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update R (diagonal only) - simplified  </span></span>
<span id="cb43-158"><a href="#cb43-158" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> residuals <span class="op">=</span> X <span class="op">-</span> F_smooth <span class="op">*</span> Lambda<span class="op">.</span>t<span class="op">();</span></span>
<span id="cb43-159"><a href="#cb43-159" aria-hidden="true" tabindex="-1"></a>    R <span class="op">=</span> diagmat<span class="op">(</span>sum<span class="op">(</span>square<span class="op">(</span>residuals<span class="op">),</span> <span class="dv">0</span><span class="op">)</span> <span class="op">/</span> T<span class="op">);</span></span>
<span id="cb43-160"><a href="#cb43-160" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-161"><a href="#cb43-161" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Update A and Q (factor dynamics) - reuse VAR functions</span></span>
<span id="cb43-162"><a href="#cb43-162" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>p <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-163"><a href="#cb43-163" aria-hidden="true" tabindex="-1"></a>      A <span class="op">=</span> <span class="va">var_estimate_</span><span class="op">(</span>as_doubles_matrix<span class="op">(</span>F_smooth<span class="op">),</span> p<span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb43-164"><a href="#cb43-164" aria-hidden="true" tabindex="-1"></a>      <span class="kw">auto</span> factor_resid <span class="op">=</span> <span class="va">var_fitted_resid_</span><span class="op">(</span>F_smooth<span class="op">,</span> A<span class="op">,</span> p<span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb43-165"><a href="#cb43-165" aria-hidden="true" tabindex="-1"></a>      Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> eta <span class="op">=</span> factor_resid<span class="op">.</span>second<span class="op">;</span></span>
<span id="cb43-166"><a href="#cb43-166" aria-hidden="true" tabindex="-1"></a>      Q <span class="op">=</span> <span class="op">(</span>eta<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> eta<span class="op">)</span> <span class="op">/</span> <span class="op">(</span>eta<span class="op">.</span>n_rows <span class="op">-</span> A<span class="op">.</span>n_rows<span class="op">);</span></span>
<span id="cb43-167"><a href="#cb43-167" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb43-168"><a href="#cb43-168" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Static model: update mean</span></span>
<span id="cb43-169"><a href="#cb43-169" aria-hidden="true" tabindex="-1"></a>      A <span class="op">=</span> mean<span class="op">(</span>F_smooth<span class="op">,</span> <span class="dv">0</span><span class="op">).</span>t<span class="op">();</span></span>
<span id="cb43-170"><a href="#cb43-170" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Keep Q constant for static model</span></span>
<span id="cb43-171"><a href="#cb43-171" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-172"><a href="#cb43-172" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-173"><a href="#cb43-173" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Simple convergence check</span></span>
<span id="cb43-174"><a href="#cb43-174" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>iter <span class="op">&gt;</span> <span class="dv">0</span> <span class="op">&amp;&amp;</span> abs<span class="op">(</span>loglik <span class="op">-</span> prev_loglik<span class="op">)</span> <span class="op">&lt;</span> tol<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-175"><a href="#cb43-175" aria-hidden="true" tabindex="-1"></a>      <span class="cf">break</span><span class="op">;</span></span>
<span id="cb43-176"><a href="#cb43-176" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-177"><a href="#cb43-177" aria-hidden="true" tabindex="-1"></a>    prev_loglik <span class="op">=</span> loglik<span class="op">;</span></span>
<span id="cb43-178"><a href="#cb43-178" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-179"><a href="#cb43-179" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-180"><a href="#cb43-180" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> <span class="bu">std::</span>make_tuple<span class="op">(</span>Lambda<span class="op">,</span> A<span class="op">,</span> Q<span class="op">,</span> R<span class="op">);</span></span>
<span id="cb43-181"><a href="#cb43-181" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb43-182"><a href="#cb43-182" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-183"><a href="#cb43-183" aria-hidden="true" tabindex="-1"></a><span class="co">// DFM forecasting using state-space representation</span></span>
<span id="cb43-184"><a href="#cb43-184" aria-hidden="true" tabindex="-1"></a>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> <span class="va">dfm_forecast_</span><span class="op">(</span><span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> F<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> Lambda<span class="op">,</span></span>
<span id="cb43-185"><a href="#cb43-185" aria-hidden="true" tabindex="-1"></a>                         <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> A<span class="op">,</span> <span class="at">const</span> Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&amp;</span> Q<span class="op">,</span> </span>
<span id="cb43-186"><a href="#cb43-186" aria-hidden="true" tabindex="-1"></a>                         <span class="dt">int</span> n_factors<span class="op">,</span> <span class="dt">int</span> p<span class="op">,</span> <span class="dt">int</span> h<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-187"><a href="#cb43-187" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-188"><a href="#cb43-188" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> F<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb43-189"><a href="#cb43-189" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> N <span class="op">=</span> Lambda<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb43-190"><a href="#cb43-190" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-191"><a href="#cb43-191" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> A_r <span class="op">=</span> A<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb43-192"><a href="#cb43-192" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> A_c <span class="op">=</span> A<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb43-193"><a href="#cb43-193" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-194"><a href="#cb43-194" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Initialize forecasts</span></span>
<span id="cb43-195"><a href="#cb43-195" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_forecast<span class="op">(</span>h<span class="op">,</span> n_factors<span class="op">);</span></span>
<span id="cb43-196"><a href="#cb43-196" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X_forecast<span class="op">(</span>h<span class="op">,</span> N<span class="op">);</span></span>
<span id="cb43-197"><a href="#cb43-197" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-198"><a href="#cb43-198" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Get initial conditions for factors</span></span>
<span id="cb43-199"><a href="#cb43-199" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_init <span class="op">=</span> F<span class="op">.</span>rows<span class="op">(</span>T <span class="op">-</span> <span class="bu">std::</span>max<span class="op">(</span>p<span class="op">,</span> <span class="dv">1</span><span class="op">),</span> T <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb43-200"><a href="#cb43-200" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-201"><a href="#cb43-201" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Create transition matrix for factor dynamics</span></span>
<span id="cb43-202"><a href="#cb43-202" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_trans<span class="op">;</span></span>
<span id="cb43-203"><a href="#cb43-203" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>p <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-204"><a href="#cb43-204" aria-hidden="true" tabindex="-1"></a>    F_trans <span class="op">=</span> <span class="va">var_companion_</span><span class="op">(</span>A<span class="op">,</span> p<span class="op">,</span> n_factors<span class="op">,</span> <span class="kw">true</span><span class="op">);</span></span>
<span id="cb43-205"><a href="#cb43-205" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb43-206"><a href="#cb43-206" aria-hidden="true" tabindex="-1"></a>    F_trans <span class="op">=</span> eye<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;(</span>n_factors<span class="op">,</span> n_factors<span class="op">);</span></span>
<span id="cb43-207"><a href="#cb43-207" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-208"><a href="#cb43-208" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-209"><a href="#cb43-209" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Forecast factors using VAR dynamics</span></span>
<span id="cb43-210"><a href="#cb43-210" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_state<span class="op">;</span></span>
<span id="cb43-211"><a href="#cb43-211" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>p <span class="op">&gt;</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-212"><a href="#cb43-212" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Initialize with companion form state</span></span>
<span id="cb43-213"><a href="#cb43-213" aria-hidden="true" tabindex="-1"></a>    F_state <span class="op">=</span> vectorise<span class="op">(</span>F_init<span class="op">.</span>t<span class="op">()).</span>t<span class="op">();</span></span>
<span id="cb43-214"><a href="#cb43-214" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="cf">if</span> <span class="op">(</span>p <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-215"><a href="#cb43-215" aria-hidden="true" tabindex="-1"></a>    <span class="co">// For p=1, just use last observation</span></span>
<span id="cb43-216"><a href="#cb43-216" aria-hidden="true" tabindex="-1"></a>    F_state <span class="op">=</span> F<span class="op">.</span>row<span class="op">(</span>T <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb43-217"><a href="#cb43-217" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-218"><a href="#cb43-218" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-219"><a href="#cb43-219" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> <span class="op">(</span><span class="dt">int</span> i <span class="op">=</span> <span class="dv">0</span><span class="op">;</span> i <span class="op">&lt;</span> h<span class="op">;</span> <span class="op">++</span>i<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-220"><a href="#cb43-220" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>p <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-221"><a href="#cb43-221" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Predict next period factors using transition matrix</span></span>
<span id="cb43-222"><a href="#cb43-222" aria-hidden="true" tabindex="-1"></a>      Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_pred_state <span class="op">=</span> <span class="op">(</span>F_trans <span class="op">*</span> F_state<span class="op">.</span>t<span class="op">()).</span>t<span class="op">();</span></span>
<span id="cb43-223"><a href="#cb43-223" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb43-224"><a href="#cb43-224" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Extract actual factors (first n_factors columns)</span></span>
<span id="cb43-225"><a href="#cb43-225" aria-hidden="true" tabindex="-1"></a>      Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_pred <span class="op">=</span> F_pred_state<span class="op">.</span>cols<span class="op">(</span><span class="dv">0</span><span class="op">,</span> n_factors <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb43-226"><a href="#cb43-226" aria-hidden="true" tabindex="-1"></a>      F_forecast<span class="op">.</span>row<span class="op">(</span>i<span class="op">)</span> <span class="op">=</span> F_pred<span class="op">;</span></span>
<span id="cb43-227"><a href="#cb43-227" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb43-228"><a href="#cb43-228" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Update state for next iteration</span></span>
<span id="cb43-229"><a href="#cb43-229" aria-hidden="true" tabindex="-1"></a>      F_state <span class="op">=</span> F_pred_state<span class="op">;</span></span>
<span id="cb43-230"><a href="#cb43-230" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb43-231"><a href="#cb43-231" aria-hidden="true" tabindex="-1"></a>      <span class="co">// Static factor model - use constant (mean from A)</span></span>
<span id="cb43-232"><a href="#cb43-232" aria-hidden="true" tabindex="-1"></a>      <span class="cf">if</span> <span class="op">(</span>A_r <span class="op">==</span> n_factors <span class="op">&amp;&amp;</span> A_c <span class="op">==</span> <span class="dv">1</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-233"><a href="#cb43-233" aria-hidden="true" tabindex="-1"></a>        F_forecast<span class="op">.</span>row<span class="op">(</span>i<span class="op">)</span> <span class="op">=</span> A<span class="op">.</span>t<span class="op">();</span>  <span class="co">// Use mean as constant</span></span>
<span id="cb43-234"><a href="#cb43-234" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb43-235"><a href="#cb43-235" aria-hidden="true" tabindex="-1"></a>        F_forecast<span class="op">.</span>row<span class="op">(</span>i<span class="op">)</span> <span class="op">=</span> F<span class="op">.</span>row<span class="op">(</span>T <span class="op">-</span> <span class="dv">1</span><span class="op">);</span>  <span class="co">// Fallback to last observation</span></span>
<span id="cb43-236"><a href="#cb43-236" aria-hidden="true" tabindex="-1"></a>      <span class="op">}</span></span>
<span id="cb43-237"><a href="#cb43-237" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-238"><a href="#cb43-238" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb43-239"><a href="#cb43-239" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Forecast observables using factor loadings</span></span>
<span id="cb43-240"><a href="#cb43-240" aria-hidden="true" tabindex="-1"></a>    X_forecast<span class="op">.</span>row<span class="op">(</span>i<span class="op">)</span> <span class="op">=</span> <span class="op">(</span>Lambda <span class="op">*</span> F_forecast<span class="op">.</span>row<span class="op">(</span>i<span class="op">).</span>t<span class="op">()).</span>t<span class="op">();</span></span>
<span id="cb43-241"><a href="#cb43-241" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-242"><a href="#cb43-242" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-243"><a href="#cb43-243" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> X_forecast<span class="op">;</span></span>
<span id="cb43-244"><a href="#cb43-244" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb43-245"><a href="#cb43-245" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-246"><a href="#cb43-246" aria-hidden="true" tabindex="-1"></a><span class="co">/* roxygen</span></span>
<span id="cb43-247"><a href="#cb43-247" aria-hidden="true" tabindex="-1"></a><span class="co">@title Main DFM estimation function</span></span>
<span id="cb43-248"><a href="#cb43-248" aria-hidden="true" tabindex="-1"></a><span class="co">@export</span></span>
<span id="cb43-249"><a href="#cb43-249" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb43-250"><a href="#cb43-250" aria-hidden="true" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp4r</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span> list dfm_model<span class="op">(</span><span class="at">const</span> doubles_matrix<span class="op">&lt;&gt;&amp;</span> x<span class="op">,</span> <span class="dt">int</span> n_factors<span class="op">,</span> <span class="dt">int</span> p <span class="op">=</span> <span class="dv">1</span><span class="op">,</span></span>
<span id="cb43-251"><a href="#cb43-251" aria-hidden="true" tabindex="-1"></a>                                   <span class="dt">bool</span> include_const <span class="op">=</span> <span class="kw">true</span><span class="op">,</span> <span class="dt">int</span> max_iter <span class="op">=</span> <span class="dv">25</span><span class="op">,</span> <span class="dt">double</span> tol <span class="op">=</span> <span class="fl">1e-4</span><span class="op">,</span></span>
<span id="cb43-252"><a href="#cb43-252" aria-hidden="true" tabindex="-1"></a>                                   <span class="dt">int</span> forecast_h <span class="op">=</span> <span class="dv">0</span><span class="op">,</span> <span class="dt">int</span> n_lags <span class="op">=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-253"><a href="#cb43-253" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X_raw <span class="op">=</span> as_Mat<span class="op">(</span>x<span class="op">);</span></span>
<span id="cb43-254"><a href="#cb43-254" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> X_raw<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb43-255"><a href="#cb43-255" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> N_raw <span class="op">=</span> X_raw<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb43-256"><a href="#cb43-256" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-257"><a href="#cb43-257" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X<span class="op">;</span></span>
<span id="cb43-258"><a href="#cb43-258" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> N<span class="op">;</span></span>
<span id="cb43-259"><a href="#cb43-259" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-260"><a href="#cb43-260" aria-hidden="true" tabindex="-1"></a>  <span class="co">// If univariate (N=1) and n_lags specified, create lagged matrix</span></span>
<span id="cb43-261"><a href="#cb43-261" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>N_raw <span class="op">==</span> <span class="dv">1</span> <span class="op">&amp;&amp;</span> n_lags <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-262"><a href="#cb43-262" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X_lagged <span class="op">=</span> <span class="va">create_lags_</span><span class="op">(</span>X_raw<span class="op">,</span> n_lags<span class="op">);</span></span>
<span id="cb43-263"><a href="#cb43-263" aria-hidden="true" tabindex="-1"></a>    <span class="co">// Join original with lags: [X_t, X_{t-1}, ..., X_{t-n_lags}]</span></span>
<span id="cb43-264"><a href="#cb43-264" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X_contemp <span class="op">=</span> X_raw<span class="op">.</span>rows<span class="op">(</span>n_lags<span class="op">,</span> T <span class="op">-</span> <span class="dv">1</span><span class="op">);</span></span>
<span id="cb43-265"><a href="#cb43-265" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> join_horiz<span class="op">(</span>X_contemp<span class="op">,</span> X_lagged<span class="op">);</span></span>
<span id="cb43-266"><a href="#cb43-266" aria-hidden="true" tabindex="-1"></a>    T <span class="op">=</span> X<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb43-267"><a href="#cb43-267" aria-hidden="true" tabindex="-1"></a>    N <span class="op">=</span> X<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb43-268"><a href="#cb43-268" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb43-269"><a href="#cb43-269" aria-hidden="true" tabindex="-1"></a>    X <span class="op">=</span> X_raw<span class="op">;</span></span>
<span id="cb43-270"><a href="#cb43-270" aria-hidden="true" tabindex="-1"></a>    N <span class="op">=</span> N_raw<span class="op">;</span></span>
<span id="cb43-271"><a href="#cb43-271" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-272"><a href="#cb43-272" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-273"><a href="#cb43-273" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>T <span class="op">&lt;=</span> p<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-274"><a href="#cb43-274" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span><span class="st">"Sample size must be greater than lag order p"</span><span class="op">);</span></span>
<span id="cb43-275"><a href="#cb43-275" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-276"><a href="#cb43-276" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-277"><a href="#cb43-277" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>n_factors <span class="op">&gt;=</span> N<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-278"><a href="#cb43-278" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span><span class="st">"Number of factors must be less than number of variables"</span><span class="op">);</span></span>
<span id="cb43-279"><a href="#cb43-279" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-280"><a href="#cb43-280" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-281"><a href="#cb43-281" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Estimate DFM parameters using EM algorithm</span></span>
<span id="cb43-282"><a href="#cb43-282" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> em_result <span class="op">=</span> <span class="va">dfm_em_</span><span class="op">(</span>X<span class="op">,</span> n_factors<span class="op">,</span> p<span class="op">,</span> max_iter<span class="op">,</span> tol<span class="op">);</span></span>
<span id="cb43-283"><a href="#cb43-283" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Lambda <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">0</span><span class="op">&gt;(</span>em_result<span class="op">);</span></span>
<span id="cb43-284"><a href="#cb43-284" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> A <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">1</span><span class="op">&gt;(</span>em_result<span class="op">);</span></span>
<span id="cb43-285"><a href="#cb43-285" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Q <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">2</span><span class="op">&gt;(</span>em_result<span class="op">);</span></span>
<span id="cb43-286"><a href="#cb43-286" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> R <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">3</span><span class="op">&gt;(</span>em_result<span class="op">);</span></span>
<span id="cb43-287"><a href="#cb43-287" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-288"><a href="#cb43-288" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Final Kalman filter to get factors</span></span>
<span id="cb43-289"><a href="#cb43-289" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> kalman_result <span class="op">=</span> <span class="va">dfm_kalman_</span><span class="op">(</span>X<span class="op">,</span> Lambda<span class="op">,</span> A<span class="op">,</span> Q<span class="op">,</span> R<span class="op">,</span> n_factors<span class="op">,</span> p<span class="op">);</span></span>
<span id="cb43-290"><a href="#cb43-290" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">0</span><span class="op">&gt;(</span>kalman_result<span class="op">);</span></span>
<span id="cb43-291"><a href="#cb43-291" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> loglik <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">2</span><span class="op">&gt;(</span>kalman_result<span class="op">)(</span><span class="dv">0</span><span class="op">,</span> <span class="dv">0</span><span class="op">);</span></span>
<span id="cb43-292"><a href="#cb43-292" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-293"><a href="#cb43-293" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute fitted values and residuals</span></span>
<span id="cb43-294"><a href="#cb43-294" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X_fitted <span class="op">=</span> F <span class="op">*</span> Lambda<span class="op">.</span>t<span class="op">();</span></span>
<span id="cb43-295"><a href="#cb43-295" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> residuals <span class="op">=</span> X <span class="op">-</span> X_fitted<span class="op">;</span></span>
<span id="cb43-296"><a href="#cb43-296" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-297"><a href="#cb43-297" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Information criteria</span></span>
<span id="cb43-298"><a href="#cb43-298" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n_params <span class="op">=</span> N <span class="op">*</span> n_factors <span class="op">+</span> n_factors <span class="op">*</span> n_factors <span class="op">*</span> p <span class="op">+</span> n_factors <span class="op">+</span> N<span class="op">;</span>  <span class="co">// Lambda + A + Q + R</span></span>
<span id="cb43-299"><a href="#cb43-299" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> aic <span class="op">=</span> aic_metric<span class="op">(</span>residuals<span class="op">,</span> n_params<span class="op">);</span>  <span class="co">// SSR-based AIC</span></span>
<span id="cb43-300"><a href="#cb43-300" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-301"><a href="#cb43-301" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Prepare results list</span></span>
<span id="cb43-302"><a href="#cb43-302" aria-hidden="true" tabindex="-1"></a>  writable<span class="op">::</span>list result<span class="op">(</span><span class="dv">12</span><span class="op">);</span></span>
<span id="cb43-303"><a href="#cb43-303" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-304"><a href="#cb43-304" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>F<span class="op">);</span></span>
<span id="cb43-305"><a href="#cb43-305" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>Lambda<span class="op">);</span></span>
<span id="cb43-306"><a href="#cb43-306" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>A<span class="op">);</span></span>
<span id="cb43-307"><a href="#cb43-307" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>Q<span class="op">);</span></span>
<span id="cb43-308"><a href="#cb43-308" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">4</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>R<span class="op">);</span></span>
<span id="cb43-309"><a href="#cb43-309" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">5</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>X_fitted<span class="op">);</span></span>
<span id="cb43-310"><a href="#cb43-310" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">6</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>residuals<span class="op">);</span></span>
<span id="cb43-311"><a href="#cb43-311" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">7</span><span class="op">]</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>loglik<span class="op">);</span></span>
<span id="cb43-312"><a href="#cb43-312" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">8</span><span class="op">]</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>n_factors<span class="op">);</span></span>
<span id="cb43-313"><a href="#cb43-313" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">9</span><span class="op">]</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>p<span class="op">);</span></span>
<span id="cb43-314"><a href="#cb43-314" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">10</span><span class="op">]</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>N<span class="op">);</span></span>
<span id="cb43-315"><a href="#cb43-315" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">11</span><span class="op">]</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>T<span class="op">);</span></span>
<span id="cb43-316"><a href="#cb43-316" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-317"><a href="#cb43-317" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>names<span class="op">()</span> <span class="op">=</span> <span class="op">{</span><span class="st">"factors"</span><span class="op">,</span> <span class="st">"loadings"</span><span class="op">,</span> <span class="st">"transition"</span><span class="op">,</span> <span class="st">"factor_cov"</span><span class="op">,</span> <span class="st">"idiosync_cov"</span><span class="op">,</span></span>
<span id="cb43-318"><a href="#cb43-318" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"fitted_values"</span><span class="op">,</span> <span class="st">"residuals"</span><span class="op">,</span> <span class="st">"loglik"</span><span class="op">,</span></span>
<span id="cb43-319"><a href="#cb43-319" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"n_factors"</span><span class="op">,</span> <span class="st">"lag_order"</span><span class="op">,</span> <span class="st">"n_variables"</span><span class="op">,</span> <span class="st">"n_obs"</span><span class="op">};</span></span>
<span id="cb43-320"><a href="#cb43-320" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-321"><a href="#cb43-321" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add forecasts if requested</span></span>
<span id="cb43-322"><a href="#cb43-322" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>forecast_h <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-323"><a href="#cb43-323" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> forecasts <span class="op">=</span> <span class="va">dfm_forecast_</span><span class="op">(</span>F<span class="op">,</span> Lambda<span class="op">,</span> A<span class="op">,</span> Q<span class="op">,</span> n_factors<span class="op">,</span> p<span class="op">,</span> forecast_h<span class="op">);</span></span>
<span id="cb43-324"><a href="#cb43-324" aria-hidden="true" tabindex="-1"></a>    result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"forecasts"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>forecasts<span class="op">)});</span></span>
<span id="cb43-325"><a href="#cb43-325" aria-hidden="true" tabindex="-1"></a>    result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"forecast_horizon"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>forecast_h<span class="op">)});</span></span>
<span id="cb43-326"><a href="#cb43-326" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-327"><a href="#cb43-327" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-328"><a href="#cb43-328" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add model metrics (only for first variable/column which is the contemporaneous value)</span></span>
<span id="cb43-329"><a href="#cb43-329" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"rmsfe"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>rmsfe<span class="op">(</span>X<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">),</span> X_fitted<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">)))});</span></span>
<span id="cb43-330"><a href="#cb43-330" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"mae"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>mae<span class="op">(</span>X<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">),</span> X_fitted<span class="op">.</span>col<span class="op">(</span><span class="dv">0</span><span class="op">)))});</span></span>
<span id="cb43-331"><a href="#cb43-331" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"aic"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>aic<span class="op">)});</span></span>
<span id="cb43-332"><a href="#cb43-332" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-333"><a href="#cb43-333" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb43-334"><a href="#cb43-334" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span>
<span id="cb43-335"><a href="#cb43-335" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-336"><a href="#cb43-336" aria-hidden="true" tabindex="-1"></a><span class="co">/* roxygen</span></span>
<span id="cb43-337"><a href="#cb43-337" aria-hidden="true" tabindex="-1"></a><span class="co">@title Predictive DFM</span></span>
<span id="cb43-338"><a href="#cb43-338" aria-hidden="true" tabindex="-1"></a><span class="co">@description Uses factors from covariates X to predict target variable y. This is similar to FA-VAR but uses DFM factor</span></span>
<span id="cb43-339"><a href="#cb43-339" aria-hidden="true" tabindex="-1"></a><span class="co">  extraction</span></span>
<span id="cb43-340"><a href="#cb43-340" aria-hidden="true" tabindex="-1"></a><span class="co">@export</span></span>
<span id="cb43-341"><a href="#cb43-341" aria-hidden="true" tabindex="-1"></a><span class="co">*/</span></span>
<span id="cb43-342"><a href="#cb43-342" aria-hidden="true" tabindex="-1"></a><span class="op">[[</span><span class="at">cpp4r</span><span class="op">::</span><span class="at">register</span><span class="op">]]</span> list dfm_predict_model<span class="op">(</span><span class="at">const</span> doubles_matrix<span class="op">&lt;&gt;&amp;</span> y<span class="op">,</span> <span class="at">const</span> doubles_matrix<span class="op">&lt;&gt;&amp;</span> x<span class="op">,</span></span>
<span id="cb43-343"><a href="#cb43-343" aria-hidden="true" tabindex="-1"></a>                                           <span class="dt">int</span> n_factors<span class="op">,</span> <span class="dt">int</span> p_y <span class="op">=</span> <span class="dv">1</span><span class="op">,</span> <span class="dt">int</span> p_f <span class="op">=</span> <span class="dv">0</span><span class="op">,</span></span>
<span id="cb43-344"><a href="#cb43-344" aria-hidden="true" tabindex="-1"></a>                                           <span class="dt">bool</span> include_const <span class="op">=</span> <span class="kw">true</span><span class="op">,</span> <span class="dt">int</span> max_iter <span class="op">=</span> <span class="dv">25</span><span class="op">,</span> </span>
<span id="cb43-345"><a href="#cb43-345" aria-hidden="true" tabindex="-1"></a>                                           <span class="dt">double</span> tol <span class="op">=</span> <span class="fl">1e-4</span><span class="op">,</span> <span class="dt">int</span> forecast_h <span class="op">=</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-346"><a href="#cb43-346" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-347"><a href="#cb43-347" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Y <span class="op">=</span> as_Mat<span class="op">(</span>y<span class="op">);</span></span>
<span id="cb43-348"><a href="#cb43-348" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> X <span class="op">=</span> as_Mat<span class="op">(</span>x<span class="op">);</span></span>
<span id="cb43-349"><a href="#cb43-349" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-350"><a href="#cb43-350" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> T <span class="op">=</span> Y<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb43-351"><a href="#cb43-351" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> K <span class="op">=</span> Y<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb43-352"><a href="#cb43-352" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> N <span class="op">=</span> X<span class="op">.</span>n_rows<span class="op">;</span></span>
<span id="cb43-353"><a href="#cb43-353" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> P <span class="op">=</span> X<span class="op">.</span>n_cols<span class="op">;</span></span>
<span id="cb43-354"><a href="#cb43-354" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-355"><a href="#cb43-355" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>T <span class="op">!=</span> N<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-356"><a href="#cb43-356" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span><span class="st">"y and X must have the same number of observations"</span><span class="op">);</span></span>
<span id="cb43-357"><a href="#cb43-357" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-358"><a href="#cb43-358" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-359"><a href="#cb43-359" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>T <span class="op">&lt;=</span> <span class="bu">std::</span>max<span class="op">(</span>p_y<span class="op">,</span> p_f<span class="op">))</span> <span class="op">{</span></span>
<span id="cb43-360"><a href="#cb43-360" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span><span class="st">"Sample size must be greater than maximum lag order"</span><span class="op">);</span></span>
<span id="cb43-361"><a href="#cb43-361" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-362"><a href="#cb43-362" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-363"><a href="#cb43-363" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>n_factors <span class="op">&gt;=</span> P<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-364"><a href="#cb43-364" aria-hidden="true" tabindex="-1"></a>    <span class="cf">throw</span> <span class="bu">std::</span>runtime_error<span class="op">(</span><span class="st">"Number of factors must be less than number of X variables"</span><span class="op">);</span></span>
<span id="cb43-365"><a href="#cb43-365" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-366"><a href="#cb43-366" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-367"><a href="#cb43-367" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Step 1: Extract factors from covariates X using DFM approach</span></span>
<span id="cb43-368"><a href="#cb43-368" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> factor_result <span class="op">=</span> <span class="va">dfm_extract_factors_</span><span class="op">(</span>X<span class="op">,</span> n_factors<span class="op">);</span></span>
<span id="cb43-369"><a href="#cb43-369" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F <span class="op">=</span> factor_result<span class="op">.</span>first<span class="op">;</span></span>
<span id="cb43-370"><a href="#cb43-370" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Lambda <span class="op">=</span> factor_result<span class="op">.</span>second<span class="op">;</span></span>
<span id="cb43-371"><a href="#cb43-371" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-372"><a href="#cb43-372" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Step 2: Estimate factor dynamics (if p_f &gt; 0)</span></span>
<span id="cb43-373"><a href="#cb43-373" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Phi<span class="op">;</span></span>
<span id="cb43-374"><a href="#cb43-374" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> F_residuals<span class="op">;</span></span>
<span id="cb43-375"><a href="#cb43-375" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Omega<span class="op">;</span></span>
<span id="cb43-376"><a href="#cb43-376" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-377"><a href="#cb43-377" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>p_f <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-378"><a href="#cb43-378" aria-hidden="true" tabindex="-1"></a>    Phi <span class="op">=</span> <span class="va">var_estimate_</span><span class="op">(</span>as_doubles_matrix<span class="op">(</span>F<span class="op">),</span> p_f<span class="op">,</span> include_const<span class="op">);</span></span>
<span id="cb43-379"><a href="#cb43-379" aria-hidden="true" tabindex="-1"></a>    <span class="kw">auto</span> factor_fitted_resid <span class="op">=</span> <span class="va">var_fitted_resid_</span><span class="op">(</span>F<span class="op">,</span> Phi<span class="op">,</span> p_f<span class="op">,</span> include_const<span class="op">);</span></span>
<span id="cb43-380"><a href="#cb43-380" aria-hidden="true" tabindex="-1"></a>    F_residuals <span class="op">=</span> factor_fitted_resid<span class="op">.</span>second<span class="op">;</span></span>
<span id="cb43-381"><a href="#cb43-381" aria-hidden="true" tabindex="-1"></a>    Omega <span class="op">=</span> <span class="op">(</span>F_residuals<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> F_residuals<span class="op">)</span> <span class="op">/</span> <span class="op">(</span>F_residuals<span class="op">.</span>n_rows <span class="op">-</span> Phi<span class="op">.</span>n_rows<span class="op">);</span></span>
<span id="cb43-382"><a href="#cb43-382" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb43-383"><a href="#cb43-383" aria-hidden="true" tabindex="-1"></a>    <span class="co">// No factor dynamics: use mean as constant</span></span>
<span id="cb43-384"><a href="#cb43-384" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> <span class="op">(</span>include_const<span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-385"><a href="#cb43-385" aria-hidden="true" tabindex="-1"></a>      Phi <span class="op">=</span> mean<span class="op">(</span>F<span class="op">,</span> <span class="dv">0</span><span class="op">).</span>t<span class="op">();</span></span>
<span id="cb43-386"><a href="#cb43-386" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span> <span class="cf">else</span> <span class="op">{</span></span>
<span id="cb43-387"><a href="#cb43-387" aria-hidden="true" tabindex="-1"></a>      Phi <span class="op">=</span> zeros<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;(</span><span class="dv">1</span><span class="op">,</span> n_factors<span class="op">);</span></span>
<span id="cb43-388"><a href="#cb43-388" aria-hidden="true" tabindex="-1"></a>    <span class="op">}</span></span>
<span id="cb43-389"><a href="#cb43-389" aria-hidden="true" tabindex="-1"></a>    F_residuals <span class="op">=</span> zeros<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;(</span>T <span class="op">-</span> <span class="bu">std::</span>max<span class="op">(</span>p_y<span class="op">,</span> p_f<span class="op">),</span> n_factors<span class="op">);</span></span>
<span id="cb43-390"><a href="#cb43-390" aria-hidden="true" tabindex="-1"></a>    Omega <span class="op">=</span> eye<span class="op">&lt;</span>Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;&gt;(</span>n_factors<span class="op">,</span> n_factors<span class="op">)</span> <span class="op">*</span> <span class="fl">0.01</span><span class="op">;</span></span>
<span id="cb43-391"><a href="#cb43-391" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-392"><a href="#cb43-392" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-393"><a href="#cb43-393" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Step 3: Estimate predictive regression: y_t = B(L)y_{t-1} + C(L)F_t + u_t</span></span>
<span id="cb43-394"><a href="#cb43-394" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Reuse FA-VAR augmented VAR function</span></span>
<span id="cb43-395"><a href="#cb43-395" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> var_result <span class="op">=</span> <span class="va">favar_augmented_var_</span><span class="op">(</span>Y<span class="op">,</span> F<span class="op">,</span> p_y<span class="op">,</span> p_f<span class="op">,</span> include_const<span class="op">);</span></span>
<span id="cb43-396"><a href="#cb43-396" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> beta <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">0</span><span class="op">&gt;(</span>var_result<span class="op">);</span></span>
<span id="cb43-397"><a href="#cb43-397" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> C <span class="op">=</span> <span class="bu">std::</span>get<span class="op">&lt;</span><span class="dv">1</span><span class="op">&gt;(</span>var_result<span class="op">);</span></span>
<span id="cb43-398"><a href="#cb43-398" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-399"><a href="#cb43-399" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Step 4: Compute fitted values and residuals</span></span>
<span id="cb43-400"><a href="#cb43-400" aria-hidden="true" tabindex="-1"></a>  <span class="kw">auto</span> fitted_resid <span class="op">=</span> <span class="va">favar_fitted_resid_</span><span class="op">(</span>Y<span class="op">,</span> F<span class="op">,</span> beta<span class="op">,</span> p_y<span class="op">,</span> p_f<span class="op">,</span> include_const<span class="op">);</span></span>
<span id="cb43-401"><a href="#cb43-401" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> y_fitted <span class="op">=</span> fitted_resid<span class="op">.</span>first<span class="op">;</span></span>
<span id="cb43-402"><a href="#cb43-402" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> residuals <span class="op">=</span> fitted_resid<span class="op">.</span>second<span class="op">;</span></span>
<span id="cb43-403"><a href="#cb43-403" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-404"><a href="#cb43-404" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute residual covariance matrix</span></span>
<span id="cb43-405"><a href="#cb43-405" aria-hidden="true" tabindex="-1"></a>  Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> Sigma <span class="op">=</span> <span class="op">(</span>residuals<span class="op">.</span>t<span class="op">()</span> <span class="op">*</span> residuals<span class="op">)</span> <span class="op">/</span> <span class="op">(</span>residuals<span class="op">.</span>n_rows <span class="op">-</span> beta<span class="op">.</span>n_rows<span class="op">);</span></span>
<span id="cb43-406"><a href="#cb43-406" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-407"><a href="#cb43-407" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Compute AIC</span></span>
<span id="cb43-408"><a href="#cb43-408" aria-hidden="true" tabindex="-1"></a>  <span class="dt">int</span> n_params <span class="op">=</span> beta<span class="op">.</span>n_rows <span class="op">*</span> K<span class="op">;</span>  <span class="co">// Total number of parameters in augmented VAR</span></span>
<span id="cb43-409"><a href="#cb43-409" aria-hidden="true" tabindex="-1"></a>  <span class="dt">double</span> aic <span class="op">=</span> aic_metric<span class="op">(</span>residuals<span class="op">,</span> n_params<span class="op">);</span></span>
<span id="cb43-410"><a href="#cb43-410" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-411"><a href="#cb43-411" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Prepare results list</span></span>
<span id="cb43-412"><a href="#cb43-412" aria-hidden="true" tabindex="-1"></a>  writable<span class="op">::</span>list result<span class="op">(</span><span class="dv">16</span><span class="op">);</span></span>
<span id="cb43-413"><a href="#cb43-413" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-414"><a href="#cb43-414" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">0</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>beta<span class="op">);</span></span>
<span id="cb43-415"><a href="#cb43-415" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">1</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>Phi<span class="op">);</span></span>
<span id="cb43-416"><a href="#cb43-416" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">2</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>Lambda<span class="op">);</span></span>
<span id="cb43-417"><a href="#cb43-417" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">3</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>F<span class="op">);</span></span>
<span id="cb43-418"><a href="#cb43-418" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">4</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>y_fitted<span class="op">);</span></span>
<span id="cb43-419"><a href="#cb43-419" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">5</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>residuals<span class="op">);</span></span>
<span id="cb43-420"><a href="#cb43-420" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">6</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>F_residuals<span class="op">);</span></span>
<span id="cb43-421"><a href="#cb43-421" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">7</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>Sigma<span class="op">);</span></span>
<span id="cb43-422"><a href="#cb43-422" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">8</span><span class="op">]</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>Omega<span class="op">);</span></span>
<span id="cb43-423"><a href="#cb43-423" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">9</span><span class="op">]</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>n_factors<span class="op">);</span></span>
<span id="cb43-424"><a href="#cb43-424" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">10</span><span class="op">]</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>p_y<span class="op">);</span></span>
<span id="cb43-425"><a href="#cb43-425" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">11</span><span class="op">]</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>p_f<span class="op">);</span></span>
<span id="cb43-426"><a href="#cb43-426" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">12</span><span class="op">]</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>K<span class="op">);</span></span>
<span id="cb43-427"><a href="#cb43-427" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">13</span><span class="op">]</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>P<span class="op">);</span></span>
<span id="cb43-428"><a href="#cb43-428" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">14</span><span class="op">]</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>T <span class="op">-</span> <span class="bu">std::</span>max<span class="op">(</span>p_y<span class="op">,</span> p_f<span class="op">));</span></span>
<span id="cb43-429"><a href="#cb43-429" aria-hidden="true" tabindex="-1"></a>  result<span class="op">[</span><span class="dv">15</span><span class="op">]</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>include_const<span class="op">);</span></span>
<span id="cb43-430"><a href="#cb43-430" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-431"><a href="#cb43-431" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>names<span class="op">()</span> <span class="op">=</span> <span class="op">{</span><span class="st">"coefficients"</span><span class="op">,</span> <span class="st">"factor_coefficients"</span><span class="op">,</span> <span class="st">"factor_loadings"</span><span class="op">,</span> <span class="st">"factors"</span><span class="op">,</span></span>
<span id="cb43-432"><a href="#cb43-432" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"fitted_values"</span><span class="op">,</span> <span class="st">"residuals"</span><span class="op">,</span> <span class="st">"factor_residuals"</span><span class="op">,</span> <span class="st">"sigma"</span><span class="op">,</span> <span class="st">"omega"</span><span class="op">,</span></span>
<span id="cb43-433"><a href="#cb43-433" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"n_factors"</span><span class="op">,</span> <span class="st">"lag_order_y"</span><span class="op">,</span> <span class="st">"lag_order_f"</span><span class="op">,</span> <span class="st">"n_variables"</span><span class="op">,</span> <span class="st">"n_covariates"</span><span class="op">,</span></span>
<span id="cb43-434"><a href="#cb43-434" aria-hidden="true" tabindex="-1"></a>                    <span class="st">"n_obs"</span><span class="op">,</span> <span class="st">"include_const"</span><span class="op">};</span></span>
<span id="cb43-435"><a href="#cb43-435" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-436"><a href="#cb43-436" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add forecasts if requested</span></span>
<span id="cb43-437"><a href="#cb43-437" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> <span class="op">(</span>forecast_h <span class="op">&gt;</span> <span class="dv">0</span><span class="op">)</span> <span class="op">{</span></span>
<span id="cb43-438"><a href="#cb43-438" aria-hidden="true" tabindex="-1"></a>    Mat<span class="op">&lt;</span><span class="dt">double</span><span class="op">&gt;</span> forecasts <span class="op">=</span> <span class="va">favar_forecast_</span><span class="op">(</span>Y<span class="op">,</span> F<span class="op">,</span> beta<span class="op">,</span> Phi<span class="op">,</span> p_y<span class="op">,</span> p_f<span class="op">,</span> forecast_h<span class="op">,</span> include_const<span class="op">);</span></span>
<span id="cb43-439"><a href="#cb43-439" aria-hidden="true" tabindex="-1"></a>    result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"forecasts"</span><span class="op">_nm</span> <span class="op">=</span> as_doubles_matrix<span class="op">(</span>forecasts<span class="op">)});</span></span>
<span id="cb43-440"><a href="#cb43-440" aria-hidden="true" tabindex="-1"></a>    result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"forecast_horizon"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>forecast_h<span class="op">)});</span></span>
<span id="cb43-441"><a href="#cb43-441" aria-hidden="true" tabindex="-1"></a>  <span class="op">}</span></span>
<span id="cb43-442"><a href="#cb43-442" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb43-443"><a href="#cb43-443" aria-hidden="true" tabindex="-1"></a>  <span class="co">// Add model metrics</span></span>
<span id="cb43-444"><a href="#cb43-444" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"rmsfe"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>rmsfe<span class="op">(</span>Y<span class="op">.</span>rows<span class="op">(</span><span class="bu">std::</span>max<span class="op">(</span>p_y<span class="op">,</span> p_f<span class="op">),</span> T<span class="op">-</span><span class="dv">1</span><span class="op">),</span> y_fitted<span class="op">))});</span></span>
<span id="cb43-445"><a href="#cb43-445" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"mae"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>mae<span class="op">(</span>Y<span class="op">.</span>rows<span class="op">(</span><span class="bu">std::</span>max<span class="op">(</span>p_y<span class="op">,</span> p_f<span class="op">),</span> T<span class="op">-</span><span class="dv">1</span><span class="op">),</span> y_fitted<span class="op">))});</span></span>
<span id="cb43-446"><a href="#cb43-446" aria-hidden="true" tabindex="-1"></a>  result<span class="op">.</span>push_back<span class="op">({</span><span class="st">"aic"</span><span class="op">_nm</span> <span class="op">=</span> cpp4r<span class="op">::</span>as_sexp<span class="op">(</span>aic<span class="op">)});</span></span>
<span id="cb43-447"><a href="#cb43-447" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb43-448"><a href="#cb43-448" aria-hidden="true" tabindex="-1"></a>  <span class="cf">return</span> result<span class="op">;</span></span>
<span id="cb43-449"><a href="#cb43-449" aria-hidden="true" tabindex="-1"></a><span class="op">}</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</section>
</section>
<section id="references" class="level1 unnumbered">


</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-sanderson24" class="csl-entry" role="listitem">
Sanderson, Conrad. 2024. <span>“Armadillo: <span>C</span>++ Library for Linear Algebra &amp; Scientific Computing.”</span> <a href="https://arma.sourceforge.net/speed.html">https://arma.sourceforge.net/speed.html</a>.
</div>
<div id="ref-sanderson16" class="csl-entry" role="listitem">
Sanderson, Conrad, and Ryan Curtin. 2016. <span>“Armadillo: A Template-Based <span>C</span>++ Library for Linear Algebra.”</span> <em>Journal of Open Source Software</em> 1 (2): 26. <a href="https://doi.org/10.21105/joss.00026">https://doi.org/10.21105/joss.00026</a>.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>