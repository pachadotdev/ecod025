<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.7.33">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">

<meta name="author" content="Mauricio Vargas Sepulveda; Orlaith Onoh; Budara Wickramasinghe">

<title>Problem Set 1</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
html { -webkit-text-size-adjust: 100%; }
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
/* CSS for citations */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging-indent div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}</style>


<script src="index_files/libs/clipboard/clipboard.min.js"></script>
<script src="index_files/libs/quarto-html/quarto.js" type="module"></script>
<script src="index_files/libs/quarto-html/tabsets/tabsets.js" type="module"></script>
<script src="index_files/libs/quarto-html/popper.min.js"></script>
<script src="index_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="index_files/libs/quarto-html/anchor.min.js"></script>
<link href="index_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="index_files/libs/quarto-html/quarto-syntax-highlighting-ea385d0e468b0dd5ea5bf0780b1290d9.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="index_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="index_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="index_files/libs/bootstrap/bootstrap-813c323200a87c37e262811031999de4.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">

  <script src="https://cdnjs.cloudflare.com/polyfill/v3/polyfill.min.js?features=es6"></script>
  <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml-full.js" type="text/javascript"></script>

<script type="text/javascript">
const typesetMath = (el) => {
  if (window.MathJax) {
    // MathJax Typeset
    window.MathJax.typeset([el]);
  } else if (window.katex) {
    // KaTeX Render
    var mathElements = el.getElementsByClassName("math");
    var macros = [];
    for (var i = 0; i < mathElements.length; i++) {
      var texText = mathElements[i].firstChild;
      if (mathElements[i].tagName == "SPAN") {
        window.katex.render(texText.data, mathElements[i], {
          displayMode: mathElements[i].classList.contains('display'),
          throwOnError: false,
          macros: macros,
          fleqn: false
        });
      }
    }
  }
}
window.Quarto = {
  typesetMath
};
</script>

</head>

<body class="quarto-light">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-full toc-left">
<div id="quarto-sidebar-toc-left" class="sidebar toc-left">
  <nav id="TOC" role="doc-toc" class="toc-active">
    <h2 id="toc-title">Contents</h2>
   
  <ul>
  <li><a href="#problem" id="toc-problem" class="nav-link active" data-scroll-target="#problem">Problem</a></li>
  <li><a href="#goal" id="toc-goal" class="nav-link" data-scroll-target="#goal">Goal</a></li>
  <li><a href="#before-running-the-code" id="toc-before-running-the-code" class="nav-link" data-scroll-target="#before-running-the-code">Before running the code</a></li>
  <li><a href="#github-repository" id="toc-github-repository" class="nav-link" data-scroll-target="#github-repository">GitHub repository</a></li>
  <li><a href="#technical-note" id="toc-technical-note" class="nav-link" data-scroll-target="#technical-note">Technical note</a></li>
  <li><a href="#models" id="toc-models" class="nav-link" data-scroll-target="#models">Models</a>
  <ul class="collapse">
  <li><a href="#vector-autoregressions-var" id="toc-vector-autoregressions-var" class="nav-link" data-scroll-target="#vector-autoregressions-var">Vector Autoregressions (VAR)</a></li>
  <li><a href="#factor-augmented-var-fa-var" id="toc-factor-augmented-var-fa-var" class="nav-link" data-scroll-target="#factor-augmented-var-fa-var">Factor-Augmented VAR (FA-VAR)</a></li>
  <li><a href="#dynamic-factor-model-dfm" id="toc-dynamic-factor-model-dfm" class="nav-link" data-scroll-target="#dynamic-factor-model-dfm">Dynamic Factor Model (DFM)</a></li>
  <li><a href="#state-space-representation" id="toc-state-space-representation" class="nav-link" data-scroll-target="#state-space-representation">State-space representation</a>
  <ul class="collapse">
  <li><a href="#vector-autoregressions-var-1" id="toc-vector-autoregressions-var-1" class="nav-link" data-scroll-target="#vector-autoregressions-var-1">Vector Autoregressions (VAR)</a></li>
  <li><a href="#factor-augmented-var-fa-var-1" id="toc-factor-augmented-var-fa-var-1" class="nav-link" data-scroll-target="#factor-augmented-var-fa-var-1">Factor-Augmented VAR (FA-VAR)</a></li>
  <li><a href="#dynamic-factor-model-dfm-1" id="toc-dynamic-factor-model-dfm-1" class="nav-link" data-scroll-target="#dynamic-factor-model-dfm-1">Dynamic Factor Model (DFM)</a></li>
  </ul></li>
  <li><a href="#forecast-comparison-metrics" id="toc-forecast-comparison-metrics" class="nav-link" data-scroll-target="#forecast-comparison-metrics">Forecast Comparison Metrics</a>
  <ul class="collapse">
  <li><a href="#root-mean-squared-forecast-error-rmsfe" id="toc-root-mean-squared-forecast-error-rmsfe" class="nav-link" data-scroll-target="#root-mean-squared-forecast-error-rmsfe">Root Mean Squared Forecast Error (RMSFE)</a></li>
  <li><a href="#mean-absolute-error-mae" id="toc-mean-absolute-error-mae" class="nav-link" data-scroll-target="#mean-absolute-error-mae">Mean Absolute Error (MAE)</a></li>
  </ul></li>
  </ul></li>
  <li><a href="#data" id="toc-data" class="nav-link" data-scroll-target="#data">Data</a></li>
  <li><a href="#data-preparation" id="toc-data-preparation" class="nav-link" data-scroll-target="#data-preparation">Data preparation</a></li>
  <li><a href="#estimate-a-var-model" id="toc-estimate-a-var-model" class="nav-link" data-scroll-target="#estimate-a-var-model">Estimate a VAR model</a></li>
  <li><a href="#estimate-a-fa-var-model" id="toc-estimate-a-fa-var-model" class="nav-link" data-scroll-target="#estimate-a-fa-var-model">Estimate a FA-VAR model</a></li>
  <li><a href="#estimate-a-dfm-model" id="toc-estimate-a-dfm-model" class="nav-link" data-scroll-target="#estimate-a-dfm-model">Estimate a DFM model</a></li>
  <li><a href="#bonus-bayesian-var" id="toc-bonus-bayesian-var" class="nav-link" data-scroll-target="#bonus-bayesian-var">Bonus: Bayesian VAR</a></li>
  <li><a href="#model-comparison" id="toc-model-comparison" class="nav-link" data-scroll-target="#model-comparison">Model Comparison</a>
  <ul class="collapse">
  <li><a href="#forecast-evaluation" id="toc-forecast-evaluation" class="nav-link" data-scroll-target="#forecast-evaluation">Forecast Evaluation</a></li>
  <li><a href="#evaluation-of-the-models" id="toc-evaluation-of-the-models" class="nav-link" data-scroll-target="#evaluation-of-the-models">Evaluation of the Models</a></li>
  </ul></li>
  <li><a href="#c-codes" id="toc-c-codes" class="nav-link" data-scroll-target="#c-codes">C++ codes</a>
  <ul class="collapse">
  <li><a href="#model-metrics" id="toc-model-metrics" class="nav-link" data-scroll-target="#model-metrics">Model metrics</a></li>
  <li><a href="#var-model" id="toc-var-model" class="nav-link" data-scroll-target="#var-model">VAR model</a></li>
  <li><a href="#fa-var-model" id="toc-fa-var-model" class="nav-link" data-scroll-target="#fa-var-model">FA-VAR model</a></li>
  <li><a href="#dfm-model" id="toc-dfm-model" class="nav-link" data-scroll-target="#dfm-model">DFM model</a></li>
  <li><a href="#bayesian-var-model" id="toc-bayesian-var-model" class="nav-link" data-scroll-target="#bayesian-var-model">Bayesian VAR model</a></li>
  </ul></li>
  </ul>
</nav>
</div>
<div id="quarto-margin-sidebar" class="sidebar margin-sidebar zindex-bottom">
</div>
<main class="content column-page-right" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Problem Set 1</h1>
</div>



<div class="quarto-title-meta column-page-right">

    <div>
    <div class="quarto-title-meta-heading">Author</div>
    <div class="quarto-title-meta-contents">
             <p>Mauricio Vargas Sepulveda; Orlaith Onoh; Budara Wickramasinghe </p>
          </div>
  </div>
    
  
    
  </div>
  


</header>


<section id="problem" class="level1">
<h1>Problem</h1>
<p>Recent headlines emphasize the challenges faced by central banks: inflation remains persistent in the U.S., global supply chain uncertainties continue, and growth forecasts remain fragile amid geopolitical risks.</p>
</section>
<section id="goal" class="level1">
<h1>Goal</h1>
<p>Provide policy recommendations for the Federal Reserve (Fed) new forecasting system.</p>
</section>
<section id="before-running-the-code" class="level1">
<h1>Before running the code</h1>
<p><strong>Please please please open “problem-set-1.Rproj” in RStudio.</strong></p>
<p><strong>Do not open the QMD file directly or it can re-download all the datasets to the wrong directory.</strong></p>
</section>
<section id="github-repository" class="level1">
<h1>GitHub repository</h1>
<p>All the codes and data for this problem set are available in the GitHub repository: <a href="https://github.com/pachadotdev/ecod025">https://github.com/pachadotdev/ecod025</a>.</p>
<p>The zip file with the project is here: <a href="https://github.com/pachadotdev/ecod025/archive/refs/heads/main.zip">https://github.com/pachadotdev/ecod025/archive/refs/heads/main.zip</a>.</p>
</section>
<section id="technical-note" class="level1">
<h1>Technical note</h1>
<p>For this problem set, the models were written in C++ using the Armadillo library for linear algebra <span class="citation" data-cites="sanderson16 sanderson24">(<a href="#ref-sanderson16" role="doc-biblioref">Sanderson and Curtin 2016</a>; <a href="#ref-sanderson24" role="doc-biblioref">Sanderson 2024</a>)</span>.</p>
<p>To run the model functions, you need to change this boolean to “TRUE”, otherwise when rendering the file it will load pre-computed results.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a>run_models <span class="ot">&lt;-</span> F</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a>reinstall_ecod025ps1 <span class="ot">&lt;-</span> F</span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>repos <span class="ot">&lt;-</span> <span class="st">"https://cran.rstudio.com"</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The functions were made available in the R package <code>ecod025ps1</code> which can be installed from this same repository:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (run_models) {</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>  <span class="co"># devtools::install("../ecod025ps1/")</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (reinstall_ecod025ps1) {</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="fu">require</span>(<span class="st">"ecod025ps1"</span>)) <span class="fu">remove.packages</span>(<span class="st">"ecod025ps1"</span>)</span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"ecod025ps1"</span>) <span class="sc">&amp;&amp;</span> run_models) {</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"cpp4r"</span>)) <span class="fu">install.packages</span>(<span class="st">"cpp4r"</span>, <span class="at">repos =</span> <span class="st">"https://pachadotdev.r-universe.dev"</span>)</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"armadillo4r"</span>)) <span class="fu">install.packages</span>(<span class="st">"armadillo4r"</span>, <span class="at">repos =</span> <span class="st">"https://pachadotdev.r-universe.dev"</span>)</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">install.packages</span>(<span class="st">"ecod025ps1"</span>, <span class="at">repos =</span> <span class="st">"https://pachadotdev.r-universe.dev"</span>)</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"dynlm"</span>) <span class="sc">&amp;&amp;</span> run_models) <span class="fu">install.packages</span>(<span class="st">"dynlm"</span>, <span class="at">repos =</span> repos)</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb3"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (run_models) {</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(ecod025ps1)</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">library</span>(dynlm)</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>R package for accessing the data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"alfred"</span>)) {</span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"alfred"</span>, <span class="at">repos =</span> repos)</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(alfred)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Additional packages for data manipulation and plotting:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb5"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"dplyr"</span>)) {</span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"dplyr"</span>, <span class="at">repos =</span> repos)</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"lubridate"</span>)) {</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"lubridate"</span>, <span class="at">repos =</span> repos)</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"rlang"</span>)) {</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"rlang"</span>, <span class="at">repos =</span> repos)</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"purrr"</span>)) {</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"purrr"</span>, <span class="at">repos =</span> repos)</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"ggplot2"</span>)) {</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"ggplot2"</span>, <span class="at">repos =</span> repos)</span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"tintin"</span>)) {</span>
<span id="cb5-17"><a href="#cb5-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"tintin"</span>, <span class="at">repos =</span> repos)</span>
<span id="cb5-18"><a href="#cb5-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb5-19"><a href="#cb5-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-20"><a href="#cb5-20" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb5-21"><a href="#cb5-21" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(lubridate)</span>
<span id="cb5-22"><a href="#cb5-22" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(rlang)</span>
<span id="cb5-23"><a href="#cb5-23" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(purrr)</span>
<span id="cb5-24"><a href="#cb5-24" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb5-25"><a href="#cb5-25" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tintin)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Additional package for the Bayesian VAR model:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span><span class="fu">require</span>(<span class="st">"cmdstanr"</span>)) {</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install.packages</span>(<span class="st">"cmdstanr"</span>,</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">repos =</span> <span class="fu">c</span>(<span class="st">"https://mc-stan.org/r-packages/"</span>, <span class="fu">getOption</span>(<span class="st">"repos"</span>)))</span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(cmdstanr)</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a><span class="co"># do we need to install Stan?</span></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="fu">is.null</span>(cmdstanr<span class="sc">::</span><span class="fu">cmdstan_path</span>())) {</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">install_cmdstan</span>()</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="models" class="level1">
<h1>Models</h1>
<section id="vector-autoregressions-var" class="level2">
<h2 class="anchored" data-anchor-id="vector-autoregressions-var">Vector Autoregressions (VAR)</h2>
<p><span class="math inline">\(\text{VAR}(p)\)</span> for inflation (<span class="math inline">\(\pi_t\)</span>) and growth (<span class="math inline">\(g_t\)</span>):</p>
<p><span class="math display">\[
y_t = A_1 y_{t-1} + \ldots + Ap y_{t-p} + u_t = A(L) y_t + u_t,\: y_t = [\pi_t, g_t]^T.
\]</span></p>
</section>
<section id="factor-augmented-var-fa-var" class="level2">
<h2 class="anchored" data-anchor-id="factor-augmented-var-fa-var">Factor-Augmented VAR (FA-VAR)</h2>
<p><span class="math display">\[
\begin{aligned}
X_t &amp;= \Lambda F_t + e_t, \cr
F_t &amp;= \Phi_1 F_{t-1} + \ldots + \Phi_p F_{t-p} + v_t, \cr
y_t &amp;= B(L)y_{t-1} + C(L)F_{t} + u_t
\end{aligned}
\]</span></p>
</section>
<section id="dynamic-factor-model-dfm" class="level2">
<h2 class="anchored" data-anchor-id="dynamic-factor-model-dfm">Dynamic Factor Model (DFM)</h2>
<p><span class="math display">\[
\begin{aligned}
X_t &amp;= \Lambda F_t + u_t,\: u_t \sim N(0, R), \cr
F_t &amp;= AF_{t-1} + \eta_t,\: \eta_t \sim N(0, Q).
\end{aligned}
\]</span></p>
<p>For DFM, we consider VAR models that are identified and that can be written using lag polynomials such that besides <span class="math inline">\(F_t\)</span> lagged definition we have</p>
<p><span class="math display">\[
\begin{aligned}
A(L) F_t &amp;= v_t \cr
B(L) u_t &amp;= e_t,
\end{aligned}
\]</span></p>
<p>where <span class="math inline">\(A(L)\)</span> and <span class="math inline">\(B(L)\)</span> are lag polynomials with <span class="math inline">\(p\)</span> and <span class="math inline">\(q\)</span> lags, respectively <span class="citation" data-cites="hansen22">(<a href="#ref-hansen22" role="doc-biblioref">Hansen 2022</a>)</span>.</p>
<p>To avoid identification issues, we will restrict the lag polynomial <span class="math inline">\(B(L)\)</span> to be diagonal.</p>
<p>Defining the inverse lag operators</p>
<p><span class="math display">\[
\begin{aligned}
D(L) &amp;= A(L)^{-1} \cr
C(L) &amp;= B(L)^{-1}
\end{aligned},
\]</span></p>
<p>then we have</p>
<p><span class="math display">\[
\begin{aligned}
X_t &amp;= \Lambda F_t + u_t \cr
\implies C(L) X_t &amp;= C(L) \Lambda F_t + C(L) u_t
\implies C(L) X_t &amp;= C(L) \Lambda D(L) v_t + e_t \cr
\implies C(L) X_t &amp;= \Lambda(L) v_t + e_t.
\end{aligned}
\]</span></p>
<p>Furthermore, we will restrict <span class="math inline">\(\Lambda(L) = C(L) \Lambda D(L)\)</span> to be a polynomial of <span class="math inline">\(l\)</span> lags.</p>
<p>The static form of the dynamic model is</p>
<p><span class="math display">\[
C(L) X_t = HV_t + e_t
\]</span></p>
<p>for a matrix <span class="math inline">\(H\)</span> with dimensions <span class="math inline">\(N \times rl\)</span> columns provided that <span class="math inline">\(X_t\)</span> and u_t$ are <span class="math inline">\(N \times 1\)</span>, <span class="math inline">\(\Lambda\)</span> is <span class="math inline">\(N \times r\)</span> (<span class="math inline">\(r &lt; N\)</span>), and <span class="math inline">\(F_t\)</span> is <span class="math inline">\(r \times 1\)</span>.</p>
<p>To avoid scaling issues, we will transform the elements of <span class="math inline">\(X_t\)</span> to have mean 0 and common variance.</p>
</section>
<section id="state-space-representation" class="level2">
<h2 class="anchored" data-anchor-id="state-space-representation">State-space representation</h2>
<section id="vector-autoregressions-var-1" class="level3">
<h3 class="anchored" data-anchor-id="vector-autoregressions-var-1">Vector Autoregressions (VAR)</h3>
<p>Model specification (reduced form):</p>
<ul>
<li><span class="math inline">\(y_t = A(L) \cdot y_t + u_t\)</span></li>
</ul>
<p>State-space form (companion representation):</p>
<ul>
<li>Observation: <span class="math inline">\(y_t = [I_K, 0, \ldots, 0] \cdot \chi_t + u_t\)</span></li>
<li>Transition: <span class="math inline">\(\chi_t = F \cdot \chi_{t-1} + \eta_t\)</span></li>
</ul>
<p>where: - <span class="math inline">\(\chi_t = [y_t', y_{t-1}', \ldots, y_{t-p+1}']'\)</span> is the state vector (<span class="math inline">\(Kp \times 1\)</span>) and <span class="math inline">\(F\)</span> is the companion matrix (<span class="math inline">\(Kp \times Kp\)</span>) - <span class="math inline">\(y_t\)</span> is <span class="math inline">\(K \times 1\)</span> (observed variables) - <span class="math inline">\(A_i\)</span> are <span class="math inline">\(K \times K\)</span> (coefficient matrices for <span class="math inline">\(i = 1, \ldots, p\)</span>) - <span class="math inline">\(u_t \sim N(0, \Sigma)\)</span> (error term) - <span class="math inline">\(\Sigma\)</span> is <span class="math inline">\(K \times K\)</span> (covariance matrix)</p>
<p>Estimation: Equation-by-equation OLS</p>
</section>
<section id="factor-augmented-var-fa-var-1" class="level3">
<h3 class="anchored" data-anchor-id="factor-augmented-var-fa-var-1">Factor-Augmented VAR (FA-VAR)</h3>
<p>Model specification:</p>
<ul>
<li><span class="math inline">\(X_t = \Lambda F_t + e_t\)</span></li>
<li><span class="math inline">\(F_t = \Phi_1 F_{t-1} + \ldots + \Phi_p F_{t-p} + v_t\)</span></li>
<li><span class="math inline">\(y_t = B(L) y_{t-1} + C(L) F_{t-1} + u_t\)</span></li>
</ul>
<p>where <span class="math inline">\(X_t = [y_t, y_{t-1}, \ldots, y_{t-n}]\)</span> is the information set constructed from current and lagged values of the target variable.</p>
<p>We use lagged factors <span class="math inline">\(F_{t-1}\)</span> (not contemporaneous <span class="math inline">\(F_t\)</span>) in the augmented VAR to avoid data leakage, since <span class="math inline">\(F_t\)</span> is extracted from <span class="math inline">\(X_t\)</span> which contains <span class="math inline">\(y_t\)</span>.</p>
<p>State-space form (companion representation):</p>
<ul>
<li>Observation: <span class="math inline">\(X_t = [\Lambda, 0, \ldots, 0] \cdot \chi_t + e_t\)</span></li>
<li>Transition: <span class="math inline">\(\chi_t = A \cdot \chi_{t-1} + \eta_t\)</span></li>
</ul>
<p>where: - <span class="math inline">\(\chi_t = [F_t', F_{t-1}', \ldots, F_{t-p+1}']'\)</span> is the state vector and <span class="math inline">\(A\)</span> is the companion matrix for the factor VAR - <span class="math inline">\(X_t\)</span> is <span class="math inline">\(N \times 1\)</span> (information set: current and lagged <span class="math inline">\(y\)</span>) - <span class="math inline">\(F_t\)</span> is <span class="math inline">\(r \times 1\)</span> (latent factors extracted from <span class="math inline">\(X_t\)</span>, with <span class="math inline">\(r &lt; N\)</span>) - <span class="math inline">\(y_t\)</span> is <span class="math inline">\(K \times 1\)</span> (target variable of interest, <span class="math inline">\(K=1\)</span> for univariate) - <span class="math inline">\(\Lambda\)</span> is <span class="math inline">\(N \times r\)</span> (factor loadings) - <span class="math inline">\(B(L) = B_1 L + \ldots + B_{p_y} L^{p_y}\)</span> (lag polynomial for <span class="math inline">\(y\)</span> dynamics) - <span class="math inline">\(\Phi(L) = \Phi_1 L + \ldots + \Phi_{p_f} L^{p_f}\)</span> (lag polynomial for factor dynamics) - <span class="math inline">\(C(L) = C_1 L + \ldots + C_{p_f} L^{p_f}\)</span> (lag polynomial for factor impact on <span class="math inline">\(y\)</span>)</p>
<p>Estimation: PCA for factor extraction, OLS for VARs</p>
</section>
<section id="dynamic-factor-model-dfm-1" class="level3">
<h3 class="anchored" data-anchor-id="dynamic-factor-model-dfm-1">Dynamic Factor Model (DFM)</h3>
<p>Model specification (state-space form):</p>
<ul>
<li>Observation equation: <span class="math inline">\(X_t = \Lambda \cdot F_t + u_t\)</span>, <span class="math inline">\(u_t \sim N(0, R)\)</span></li>
<li>State equation: <span class="math inline">\(F_t = A \cdot F_{t-1} + \eta_t\)</span>, <span class="math inline">\(\eta_t \sim N(0, Q)\)</span></li>
</ul>
<p>For VAR(p) factor dynamics, use companion form:</p>
<ul>
<li>Observation: <span class="math inline">\(X_t = [\Lambda, 0, \ldots, 0] \cdot \chi_t + u_t\)</span></li>
<li>Transition: <span class="math inline">\(\chi_t = A \cdot \chi_{t-1} + \eta_t\)</span></li>
</ul>
<p>where: - <span class="math inline">\(\chi_t = [F_t', F_{t-1}', \ldots, F_{t-p+1}']'\)</span> is the state vector (<span class="math inline">\(rp \times 1\)</span>) and <span class="math inline">\(A\)</span> is the companion matrix (<span class="math inline">\(rp \times rp\)</span>) - <span class="math inline">\(X_t\)</span> is <span class="math inline">\(N \times 1\)</span> (observed variables, standardized to mean 0, common variance) - <span class="math inline">\(F_t\)</span> is <span class="math inline">\(r \times 1\)</span> (latent factors, <span class="math inline">\(r &lt; N\)</span>) - <span class="math inline">\(\Lambda\)</span> is <span class="math inline">\(N \times r\)</span> (factor loadings) - <span class="math inline">\(A\)</span> is <span class="math inline">\(r \times r\)</span> (transition matrix for VAR(1)) or <span class="math inline">\(rp \times rp\)</span> (companion form for VAR(p)) - <span class="math inline">\(R\)</span> is <span class="math inline">\(N \times N\)</span> (idiosyncratic covariance, diagonal) - <span class="math inline">\(Q\)</span> is <span class="math inline">\(r \times r\)</span> (factor innovation covariance) or <span class="math inline">\(rp \times rp\)</span> (companion form)</p>
<p>Estimation: EM algorithm with Kalman filter for state estimation</p>
</section>
</section>
<section id="forecast-comparison-metrics" class="level2">
<h2 class="anchored" data-anchor-id="forecast-comparison-metrics">Forecast Comparison Metrics</h2>
<section id="root-mean-squared-forecast-error-rmsfe" class="level3">
<h3 class="anchored" data-anchor-id="root-mean-squared-forecast-error-rmsfe">Root Mean Squared Forecast Error (RMSFE)</h3>
<p><span class="math display">\[
\text{RMSFE} = \sqrt{\frac{1}{T} \sum_{t=1}^{T} (y_{t+h} - \hat{y}_{t+h \mid t})^2}.
\]</span></p>
</section>
<section id="mean-absolute-error-mae" class="level3">
<h3 class="anchored" data-anchor-id="mean-absolute-error-mae">Mean Absolute Error (MAE)</h3>
<p><span class="math display">\[
\text{MAE} = \frac{1}{T} \sum_{t=1}^{T} |y_{t+h} - \hat{y}_{t+h \mid t}|.
\]</span></p>
</section>
</section>
</section>
<section id="data" class="level1">
<h1>Data</h1>
<p>The data analysis begins with multiple measures of inflation and real GDP growth obtained from FRED. The inflation indicators include headline CPI, core CPI (excluding food and energy), food prices, energy prices, the GDP deflator, and the University of Michigan’s survey-based inflation expectations. The plotted series reveal distinct dynamics: energy inflation is highly volatile, largely driven by geopolitical shocks, while core inflation (CPILFESL) and the GDP deflator (GDPDEF) exhibit smoother, more persistent trends that better capture underlying price pressures. The Michigan expectations series serves as a forward-looking indicator of inflation sentiment. Real GDP growth displays a pronounced cyclical pattern, with notable contractions during major downturns such as the 2008 financial crisis and the 2020 pandemic. These observations motivate the use of CPILFESL and GDPDEF as the primary inflation measures, and real GDP growth as the output indicator, for the subsequent forecasting models.</p>
<p>Get the different series used to measure inflation according to <a href="https://files.stlouisfed.org/files/htdocs/pageone-economics/uploads/Lessons/DataPracticeFRED_Measures_of_Inflation.pdf">FED</a>:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb7"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a><span class="fu">try</span>(<span class="fu">dir.create</span>(<span class="st">"data"</span>), <span class="at">silent =</span> <span class="cn">TRUE</span>)</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>download_data <span class="ot">&lt;-</span> <span class="cf">function</span>(series_id) {</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  fout <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"data/"</span>, series_id, <span class="st">".rds"</span>)</span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span> (<span class="sc">!</span><span class="fu">file.exists</span>(fout)) {</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> <span class="fu">get_alfred_series</span>(series_id)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(data)</span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">saveRDS</span>(data, fout, <span class="at">compress =</span> <span class="st">"xz"</span>)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>  } <span class="cf">else</span> {</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a>    data <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(fout)</span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(data)</span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a><span class="co"># Consumer Price Index for All Urban Consumers: All Items</span></span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>cpiaucsl <span class="ot">&lt;-</span> <span class="fu">download_data</span>(<span class="st">"CPIAUCSL"</span>)</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a><span class="co"># Consumer Price Index for All Urban Consumers: All Items Less Food &amp; Energy</span></span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a>cpilfesl <span class="ot">&lt;-</span> <span class="fu">download_data</span>(<span class="st">"CPILFESL"</span>)</span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a><span class="co"># Consumer Price Index for All Urban Consumers: Energy</span></span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>cpiengsl <span class="ot">&lt;-</span> <span class="fu">download_data</span>(<span class="st">"CPIENGSL"</span>)</span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a><span class="co"># Consumer Price Index for All Urban Consumers: Food</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>cpifood <span class="ot">&lt;-</span> <span class="fu">download_data</span>(<span class="st">"CPIUFDSL"</span>)</span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a><span class="co"># GDP Deflator</span></span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a>gdpdef <span class="ot">&lt;-</span> <span class="fu">download_data</span>(<span class="st">"GDPDEF"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Get the quarterly real GDP data to compute growth rates:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a>gdpc1 <span class="ot">&lt;-</span> <span class="fu">download_data</span>(<span class="st">"GDPC1"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>We also require the ‘University of Michigan: Inflation Expectation (Median expected price change next 12 months)’ as a covariate for DFM:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb9"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a><span class="co"># University of Michigan: Inflation Expectation (Median expected price change next 12 months)</span></span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>michigan <span class="ot">&lt;-</span> <span class="fu">download_data</span>(<span class="st">"MICH"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
</section>
<section id="data-preparation" class="level1">
<h1>Data preparation</h1>
<p>We need to filter and differentiate to get inflation rates as</p>
<p><span class="math display">\[
\text{Inflation Rate}_t = 100 \times \frac{C_t - C_{t-1}}{C_{t-1}}
\]</span></p>
<p>We will use October data to compute the inflation rate to match the reported quarterly GDP data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>inflation_mm <span class="ot">&lt;-</span> <span class="cf">function</span>(data, col) {</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>  data <span class="sc">%&gt;%</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">as_tibble</span>() <span class="sc">%&gt;%</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(<span class="fu">desc</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># keep the most updated figure</span></span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="fu">group_by</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(realtime_period <span class="sc">==</span> <span class="fu">max</span>(realtime_period)) <span class="sc">%&gt;%</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(date), <span class="at">month =</span> <span class="fu">month</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">filter</span>(month <span class="sc">==</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb10-11"><a href="#cb10-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">mutate</span>(</span>
<span id="cb10-12"><a href="#cb10-12" aria-hidden="true" tabindex="-1"></a>      <span class="at">inflation =</span> <span class="dv">100</span> <span class="sc">*</span> (<span class="sc">!!</span><span class="fu">sym</span>(col) <span class="sc">-</span> <span class="fu">lead</span>(<span class="sc">!!</span><span class="fu">sym</span>(col))) <span class="sc">/</span> <span class="fu">lead</span>(<span class="sc">!!</span><span class="fu">sym</span>(col))</span>
<span id="cb10-13"><a href="#cb10-13" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb10-14"><a href="#cb10-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb10-15"><a href="#cb10-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb10-16"><a href="#cb10-16" aria-hidden="true" tabindex="-1"></a>cpiaucsl_mm <span class="ot">&lt;-</span> <span class="fu">inflation_mm</span>(cpiaucsl, <span class="st">"CPIAUCSL"</span>)</span>
<span id="cb10-17"><a href="#cb10-17" aria-hidden="true" tabindex="-1"></a>cpilfesl_mm <span class="ot">&lt;-</span> <span class="fu">inflation_mm</span>(cpilfesl, <span class="st">"CPILFESL"</span>)</span>
<span id="cb10-18"><a href="#cb10-18" aria-hidden="true" tabindex="-1"></a>cpiengsl_mm <span class="ot">&lt;-</span> <span class="fu">inflation_mm</span>(cpiengsl, <span class="st">"CPIENGSL"</span>)</span>
<span id="cb10-19"><a href="#cb10-19" aria-hidden="true" tabindex="-1"></a>cpifood_mm <span class="ot">&lt;-</span> <span class="fu">inflation_mm</span>(cpifood, <span class="st">"CPIUFDSL"</span>)</span>
<span id="cb10-20"><a href="#cb10-20" aria-hidden="true" tabindex="-1"></a>gdpdef_mm <span class="ot">&lt;-</span> <span class="fu">inflation_mm</span>(gdpdef, <span class="st">"GDPDEF"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The GDP data has a different frequency (quarterly) so we need to adjust the code:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb11"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a>gdpc1_yy <span class="ot">&lt;-</span> gdpc1 <span class="sc">%&gt;%</span></span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(realtime_period <span class="sc">==</span> <span class="fu">max</span>(realtime_period)) <span class="sc">%&gt;%</span></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(year <span class="sc">&lt;</span> <span class="dv">2025</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(year) <span class="sc">%&gt;%</span></span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(<span class="at">gdp =</span> <span class="fu">sum</span>(GDPC1), <span class="at">.groups =</span> <span class="st">"drop"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">ymd</span>(<span class="fu">paste0</span>(year, <span class="st">"-10-01"</span>)),</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">gdpgrowth =</span> <span class="dv">100</span> <span class="sc">*</span> (gdp <span class="sc">-</span> <span class="fu">lag</span>(gdp)) <span class="sc">/</span> <span class="fu">lag</span>(gdp)</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>UM data has a different format (it is already in percentage base 100 and lagged 1 year):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a>michigan_mm <span class="ot">&lt;-</span> michigan <span class="sc">%&gt;%</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(<span class="fu">desc</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(realtime_period <span class="sc">==</span> <span class="fu">max</span>(realtime_period)) <span class="sc">%&gt;%</span></span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">year =</span> <span class="fu">year</span>(date), <span class="at">month =</span> <span class="fu">month</span>(date)) <span class="sc">%&gt;%</span></span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(month <span class="sc">==</span> <span class="dv">10</span>) <span class="sc">%&gt;%</span></span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> date <span class="sc">+</span> <span class="fu">years</span>(<span class="dv">1</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">rename</span>(<span class="at">inflation =</span> MICH)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Merge all into one data frame for plotting:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb13"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>inflation <span class="ot">&lt;-</span> <span class="fu">map2_df</span>(</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">list</span>(</span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>    cpiaucsl_mm,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>    cpilfesl_mm,</span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>    cpiengsl_mm,</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    cpifood_mm,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    gdpdef_mm,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    michigan_mm</span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>  ),</span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">c</span>(<span class="st">"CPIAUCSL"</span>, <span class="st">"CPILFESL"</span>, <span class="st">"CPIENGSL"</span>, <span class="st">"CPIUFDSL"</span>, <span class="st">"GDPDEF"</span>, <span class="st">"MICH"</span>),</span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(x, y) {</span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    x <span class="sc">%&gt;%</span></span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(date, <span class="at">value =</span> inflation) <span class="sc">%&gt;%</span></span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>      <span class="fu">mutate</span>(<span class="at">series =</span> y)</span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Plot of the different inflation measures:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(inflation, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> value, <span class="at">color =</span> series)) <span class="sc">+</span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Inflation Measures"</span>,</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Year"</span>,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Inflation rate (%)"</span>,</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Series"</span></span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_tintin_d</span>() <span class="sc">+</span></span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>series, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>) <span class="sc">+</span></span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/plots2-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
<div class="sourceCode cell-code" id="cb15"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(gdpc1_yy, <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> gdpgrowth)) <span class="sc">+</span></span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Real GDP Change"</span>,</span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Year"</span>,</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Growth rate (%)"</span>,</span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Series"</span></span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb15-10"><a href="#cb15-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>) <span class="sc">+</span></span>
<span id="cb15-11"><a href="#cb15-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/plots2-2.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>The plots show some level of similarity between all series except for CPIENGSL (energy prices) which is more volatile. The series without food and energy (CPILFESL) is more stable and is similar to the GDP deflator (GDPDEF) while the other series have more volatility. The Michigan survey (MICH) shows a proper forward-looking measure of inflation expectations.</p>
<p>Because energy depends on external factors (e.g., geopolitical events that affect oil prices) and food prices are affected by seasonal patterns, we will use the CPILFESL and GDP deflator as our main inflation measure.</p>
<p>GDP is also affected by external factors (e.g., the <span class="math inline">\(X - M\)</span> component of GDP) but we do not have another measure of GDP growth.</p>
</section>
<section id="estimate-a-var-model" class="level1">
<h1>Estimate a VAR model</h1>
<p>The Vector Autoregression (VAR) model was estimated to capture the interdependence between inflation and output growth. Optimal lag lengths were selected using the Akaike Information Criterion (AIC), resulting in four lags for core inflation and GDP growth, and six lags for the GDP deflator. The resulting forecasts show that the VAR effectively tracks short-term fluctuations but struggles to capture large structural shocks, particularly around the pandemic period. Forecast errors are more pronounced during volatile episodes, reflecting the VAR’s limited ability to incorporate external influences or latent factors. Nonetheless, it provides a useful benchmark for short-horizon predictions and serves as the foundation for more advanced models.</p>
<p>The goal is to choose the lag length based on information criteria.</p>
<p>The first step is to determine the lag length using information criteria.</p>
<p>For CPILFESL and adapting from <a href="https://www.econometrics-with-r.org/14.6-llsuic.html">Econometrics with R</a>, which uses BIC, we will use the AIC criterion.</p>
<p><span class="math display">\[
\text{AIC}(p) = \log \left( \frac{\text{SSR}(p)}{T} \right) + (p+1)\frac{2}{T}.
\]</span></p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a><span class="co"># compute AIC for AR model objects of class 'dynlm'</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>AIC <span class="ot">&lt;-</span> <span class="cf">function</span>(model) {</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  ssr <span class="ot">&lt;-</span> <span class="fu">sum</span>(model<span class="sc">$</span>residuals<span class="sc">^</span><span class="dv">2</span>)</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  t <span class="ot">&lt;-</span> <span class="fu">length</span>(model<span class="sc">$</span>residuals)</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  npar <span class="ot">&lt;-</span> <span class="fu">length</span>(model<span class="sc">$</span>coef)</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">round</span>(<span class="fu">c</span>(<span class="st">"AIC"</span> <span class="ot">=</span> <span class="fu">log</span>(ssr <span class="sc">/</span> t) <span class="sc">+</span> npar <span class="sc">*</span> <span class="dv">2</span> <span class="sc">/</span> t), <span class="dv">4</span>)</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a><span class="co"># intercept only AR model</span></span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(<span class="fu">dynlm</span>(<span class="fu">ts</span>(cpilfesl_mm<span class="sc">$</span>inflation) <span class="sc">~</span> <span class="dv">1</span>))</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a><span class="fu">AIC</span>(<span class="fu">dynlm</span>(<span class="fu">ts</span>(gdpc1_yy<span class="sc">$</span>gdpgrowth) <span class="sc">~</span> <span class="dv">1</span>))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Looping over different model orders:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb17"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a><span class="co"># loop AIC over models of different orders</span></span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>order <span class="ot">&lt;-</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">10</span></span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>inflation_AICs <span class="ot">&lt;-</span> <span class="fu">vapply</span>(</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>  order,</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(x) {</span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">AIC</span>(<span class="fu">dynlm</span>(</span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a>      <span class="fu">ts</span>(cpilfesl_mm<span class="sc">$</span>inflation) <span class="sc">~</span> <span class="fu">L</span>(<span class="fu">ts</span>(cpilfesl_mm<span class="sc">$</span>inflation), <span class="dv">1</span><span class="sc">:</span>x)</span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a>    ))</span>
<span id="cb17-10"><a href="#cb17-10" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb17-11"><a href="#cb17-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">FUN.VALUE =</span> <span class="fu">numeric</span>(<span class="dv">1</span>)</span>
<span id="cb17-12"><a href="#cb17-12" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-13"><a href="#cb17-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-14"><a href="#cb17-14" aria-hidden="true" tabindex="-1"></a>gdpdef_AICs <span class="ot">&lt;-</span> <span class="fu">vapply</span>(</span>
<span id="cb17-15"><a href="#cb17-15" aria-hidden="true" tabindex="-1"></a>  order,</span>
<span id="cb17-16"><a href="#cb17-16" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(x) {</span>
<span id="cb17-17"><a href="#cb17-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">AIC</span>(<span class="fu">dynlm</span>(<span class="fu">ts</span>(gdpdef_mm<span class="sc">$</span>inflation) <span class="sc">~</span> <span class="fu">L</span>(<span class="fu">ts</span>(gdpdef_mm<span class="sc">$</span>inflation), <span class="dv">1</span><span class="sc">:</span>x)))</span>
<span id="cb17-18"><a href="#cb17-18" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb17-19"><a href="#cb17-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">FUN.VALUE =</span> <span class="fu">numeric</span>(<span class="dv">1</span>)</span>
<span id="cb17-20"><a href="#cb17-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-21"><a href="#cb17-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-22"><a href="#cb17-22" aria-hidden="true" tabindex="-1"></a>gdpgrowth_AICs <span class="ot">&lt;-</span> <span class="fu">vapply</span>(</span>
<span id="cb17-23"><a href="#cb17-23" aria-hidden="true" tabindex="-1"></a>  order,</span>
<span id="cb17-24"><a href="#cb17-24" aria-hidden="true" tabindex="-1"></a>  <span class="cf">function</span>(x) {</span>
<span id="cb17-25"><a href="#cb17-25" aria-hidden="true" tabindex="-1"></a>    <span class="fu">AIC</span>(<span class="fu">dynlm</span>(<span class="fu">ts</span>(gdpc1_yy<span class="sc">$</span>gdpgrowth) <span class="sc">~</span> <span class="fu">L</span>(<span class="fu">ts</span>(gdpc1_yy<span class="sc">$</span>gdpgrowth), <span class="dv">1</span><span class="sc">:</span>x)))</span>
<span id="cb17-26"><a href="#cb17-26" aria-hidden="true" tabindex="-1"></a>  },</span>
<span id="cb17-27"><a href="#cb17-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">FUN.VALUE =</span> <span class="fu">numeric</span>(<span class="dv">1</span>)</span>
<span id="cb17-28"><a href="#cb17-28" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb17-29"><a href="#cb17-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-30"><a href="#cb17-30" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(inflation_AICs, <span class="st">"data/aics_cpilfesl.rds"</span>)</span>
<span id="cb17-31"><a href="#cb17-31" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(gdpdef_AICs, <span class="st">"data/aics_gdpdef.rds"</span>)</span>
<span id="cb17-32"><a href="#cb17-32" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(gdpgrowth_AICs, <span class="st">"data/aics_gdpgrowth.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>run_models) {</span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  inflation_AICs <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/aics_cpilfesl.rds"</span>)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  gdpdef_AICs <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/aics_gdpdef.rds"</span>)</span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>  gdpgrowth_AICs <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/aics_gdpgrowth.rds"</span>)</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a><span class="fu">which.min</span>(inflation_AICs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4</code></pre>
</div>
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a><span class="fu">which.min</span>(gdpdef_AICs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 6</code></pre>
</div>
<div class="sourceCode cell-code" id="cb22"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" aria-hidden="true" tabindex="-1"></a><span class="fu">which.min</span>(gdpgrowth_AICs)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>[1] 4</code></pre>
</div>
</div>
<p>Based on the AIC criterion, we select a lag length of:</p>
<ul>
<li>4 for CPILFESL</li>
<li>6 for GDPDEF</li>
<li>4 for GDP growth</li>
</ul>
<p>Now we can estimate the VAR model using <code>var_model()</code> from the <code>ecod025ps1</code> package:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="co"># remove the last value as it is NA after the the lagged difference</span></span>
<span id="cb24-2"><a href="#cb24-2" aria-hidden="true" tabindex="-1"></a>h <span class="ot">&lt;-</span> <span class="dv">12</span>L</span>
<span id="cb24-3"><a href="#cb24-3" aria-hidden="true" tabindex="-1"></a>l1 <span class="ot">&lt;-</span> <span class="dv">4</span>L</span>
<span id="cb24-4"><a href="#cb24-4" aria-hidden="true" tabindex="-1"></a>l2 <span class="ot">&lt;-</span> <span class="dv">6</span>L</span>
<span id="cb24-5"><a href="#cb24-5" aria-hidden="true" tabindex="-1"></a>l3 <span class="ot">&lt;-</span> <span class="dv">4</span>L</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>The interesting exercise is to evaluate the forecasts from the VAR model by subsetting the data “T” years before the end date and compare the predictions with the actual values. One problem in this time horizon is that we have the COVID-19 pandemic (2020) external shock.</p>
<p>In other words, we will consider both in and out of sample model metrics. Because of the GDP data, we need to trim the series before 2025.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb25"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" aria-hidden="true" tabindex="-1"></a>common_years <span class="ot">&lt;-</span> cpilfesl_mm <span class="sc">%&gt;%</span></span>
<span id="cb25-2"><a href="#cb25-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb25-3"><a href="#cb25-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(<span class="fu">select</span>(gdpdef_mm, date), <span class="at">by =</span> <span class="st">"date"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-4"><a href="#cb25-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(<span class="fu">select</span>(gdpc1_yy, date), <span class="at">by =</span> <span class="st">"date"</span>)</span>
<span id="cb25-5"><a href="#cb25-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-6"><a href="#cb25-6" aria-hidden="true" tabindex="-1"></a><span class="co"># subset data</span></span>
<span id="cb25-7"><a href="#cb25-7" aria-hidden="true" tabindex="-1"></a>cpilfesl_mm_subset <span class="ot">&lt;-</span> cpilfesl_mm <span class="sc">%&gt;%</span></span>
<span id="cb25-8"><a href="#cb25-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(common_years, <span class="at">by =</span> <span class="st">"date"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-9"><a href="#cb25-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(date <span class="sc">&lt;=</span> (<span class="fu">max</span>(date) <span class="sc">-</span> <span class="fu">years</span>(h)))</span>
<span id="cb25-10"><a href="#cb25-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-11"><a href="#cb25-11" aria-hidden="true" tabindex="-1"></a>gdpdef_mm_subset <span class="ot">&lt;-</span> gdpdef_mm <span class="sc">%&gt;%</span></span>
<span id="cb25-12"><a href="#cb25-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(common_years, <span class="at">by =</span> <span class="st">"date"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-13"><a href="#cb25-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(date <span class="sc">&lt;=</span> (<span class="fu">max</span>(date) <span class="sc">-</span> <span class="fu">years</span>(h)))</span>
<span id="cb25-14"><a href="#cb25-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb25-15"><a href="#cb25-15" aria-hidden="true" tabindex="-1"></a>gdpc1_yy_subset <span class="ot">&lt;-</span> gdpc1_yy <span class="sc">%&gt;%</span></span>
<span id="cb25-16"><a href="#cb25-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(common_years, <span class="at">by =</span> <span class="st">"date"</span>) <span class="sc">%&gt;%</span></span>
<span id="cb25-17"><a href="#cb25-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(date <span class="sc">&lt;=</span> (<span class="fu">max</span>(date) <span class="sc">-</span> <span class="fu">years</span>(h)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>fit_cpilfesl_subset <span class="ot">&lt;-</span> <span class="fu">var_model</span>(</span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>(<span class="fu">as.matrix</span>(cpilfesl_mm_subset<span class="sc">$</span>inflation)),</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> l1,</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">include_const =</span> <span class="cn">TRUE</span>,</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">forecast_h =</span> h</span>
<span id="cb26-6"><a href="#cb26-6" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-7"><a href="#cb26-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-8"><a href="#cb26-8" aria-hidden="true" tabindex="-1"></a>fit_gdpdef_subset <span class="ot">&lt;-</span> <span class="fu">var_model</span>(</span>
<span id="cb26-9"><a href="#cb26-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>(<span class="fu">as.matrix</span>(gdpdef_mm_subset<span class="sc">$</span>inflation)),</span>
<span id="cb26-10"><a href="#cb26-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> l2,</span>
<span id="cb26-11"><a href="#cb26-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">include_const =</span> <span class="cn">TRUE</span>,</span>
<span id="cb26-12"><a href="#cb26-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">forecast_h =</span> h</span>
<span id="cb26-13"><a href="#cb26-13" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-14"><a href="#cb26-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-15"><a href="#cb26-15" aria-hidden="true" tabindex="-1"></a>fit_gdpgrowth_subset <span class="ot">&lt;-</span> <span class="fu">var_model</span>(</span>
<span id="cb26-16"><a href="#cb26-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>(<span class="fu">as.matrix</span>(gdpc1_yy_subset<span class="sc">$</span>gdpgrowth)),</span>
<span id="cb26-17"><a href="#cb26-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> l3,</span>
<span id="cb26-18"><a href="#cb26-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">include_const =</span> <span class="cn">TRUE</span>,</span>
<span id="cb26-19"><a href="#cb26-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">forecast_h =</span> h</span>
<span id="cb26-20"><a href="#cb26-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb26-21"><a href="#cb26-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb26-22"><a href="#cb26-22" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fit_cpilfesl_subset, <span class="st">"data/fit_cpilfesl_subset.rds"</span>)</span>
<span id="cb26-23"><a href="#cb26-23" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fit_gdpdef_subset, <span class="st">"data/fit_gdpdef_subset.rds"</span>)</span>
<span id="cb26-24"><a href="#cb26-24" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fit_gdpgrowth_subset, <span class="st">"data/fit_gdpgrowth_subset.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>run_models) {</span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>  fit_cpilfesl_subset <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/fit_cpilfesl_subset.rds"</span>)</span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  fit_gdpdef_subset <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/fit_gdpdef_subset.rds"</span>)</span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>  fit_gdpgrowth_subset <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/fit_gdpgrowth_subset.rds"</span>)</span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>fit_predictions2 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">date =</span> <span class="fu">max</span>(cpilfesl_mm_subset<span class="sc">$</span>date) <span class="sc">+</span></span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">years</span>(<span class="fu">seq_len</span>(fit_cpilfesl_subset<span class="sc">$</span>forecast_h)),</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">prediction =</span> <span class="fu">as.numeric</span>(fit_cpilfesl_subset<span class="sc">$</span>forecasts),</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">series =</span> <span class="st">"CPILFESL"</span></span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">date =</span> <span class="fu">max</span>(gdpdef_mm_subset<span class="sc">$</span>date) <span class="sc">+</span></span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">years</span>(<span class="fu">seq_len</span>(fit_gdpdef_subset<span class="sc">$</span>forecast_h)),</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">prediction =</span> <span class="fu">as.numeric</span>(fit_gdpdef_subset<span class="sc">$</span>forecasts),</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">series =</span> <span class="st">"GDPDEF"</span></span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb27-22"><a href="#cb27-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb27-23"><a href="#cb27-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">date =</span> <span class="fu">max</span>(gdpc1_yy_subset<span class="sc">$</span>date) <span class="sc">+</span></span>
<span id="cb27-24"><a href="#cb27-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">years</span>(<span class="fu">seq_len</span>(fit_gdpgrowth_subset<span class="sc">$</span>forecast_h)),</span>
<span id="cb27-25"><a href="#cb27-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">prediction =</span> <span class="fu">as.numeric</span>(fit_gdpgrowth_subset<span class="sc">$</span>forecasts),</span>
<span id="cb27-26"><a href="#cb27-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">series =</span> <span class="st">"GDPGROWTH"</span></span>
<span id="cb27-27"><a href="#cb27-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb27-28"><a href="#cb27-28" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-29"><a href="#cb27-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-30"><a href="#cb27-30" aria-hidden="true" tabindex="-1"></a>fit_predictions2 <span class="ot">&lt;-</span> fit_predictions2 <span class="sc">%&gt;%</span></span>
<span id="cb27-31"><a href="#cb27-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb27-32"><a href="#cb27-32" aria-hidden="true" tabindex="-1"></a>    inflation <span class="sc">%&gt;%</span></span>
<span id="cb27-33"><a href="#cb27-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(series <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"CPILFESL"</span>, <span class="st">"GDPDEF"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb27-34"><a href="#cb27-34" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="fu">year</span>(date) <span class="sc">&gt;</span> <span class="fu">max</span>(<span class="fu">year</span>(date) <span class="sc">-</span> h)) <span class="sc">%&gt;%</span></span>
<span id="cb27-35"><a href="#cb27-35" aria-hidden="true" tabindex="-1"></a>      <span class="fu">rename</span>(<span class="at">observed =</span> value) <span class="sc">%&gt;%</span></span>
<span id="cb27-36"><a href="#cb27-36" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_rows</span>(</span>
<span id="cb27-37"><a href="#cb27-37" aria-hidden="true" tabindex="-1"></a>        gdpc1_yy <span class="sc">%&gt;%</span></span>
<span id="cb27-38"><a href="#cb27-38" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(<span class="fu">year</span>(date) <span class="sc">&gt;</span> <span class="fu">max</span>(<span class="fu">year</span>(date) <span class="sc">-</span> h)) <span class="sc">%&gt;%</span></span>
<span id="cb27-39"><a href="#cb27-39" aria-hidden="true" tabindex="-1"></a>          <span class="fu">select</span>(date, <span class="at">observed =</span> gdpgrowth) <span class="sc">%&gt;%</span></span>
<span id="cb27-40"><a href="#cb27-40" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">series =</span> <span class="st">"GDPGROWTH"</span>)</span>
<span id="cb27-41"><a href="#cb27-41" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb27-42"><a href="#cb27-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"series"</span>)</span>
<span id="cb27-43"><a href="#cb27-43" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb27-44"><a href="#cb27-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-45"><a href="#cb27-45" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fit_predictions2) <span class="sc">+</span></span>
<span id="cb27-46"><a href="#cb27-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> observed, <span class="at">color =</span> series), <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb27-47"><a href="#cb27-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> observed, <span class="at">color =</span> series), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb27-48"><a href="#cb27-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb27-49"><a href="#cb27-49" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> prediction, <span class="at">color =</span> series),</span>
<span id="cb27-50"><a href="#cb27-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">linewidth =</span> <span class="dv">1</span>,</span>
<span id="cb27-51"><a href="#cb27-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"gray70"</span></span>
<span id="cb27-52"><a href="#cb27-52" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb27-53"><a href="#cb27-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb27-54"><a href="#cb27-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> fit_predictions2,</span>
<span id="cb27-55"><a href="#cb27-55" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> prediction, <span class="at">color =</span> series),</span>
<span id="cb27-56"><a href="#cb27-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">2</span>,</span>
<span id="cb27-57"><a href="#cb27-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"gray70"</span></span>
<span id="cb27-58"><a href="#cb27-58" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb27-59"><a href="#cb27-59" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(</span>
<span id="cb27-60"><a href="#cb27-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> fit_predictions2,</span>
<span id="cb27-61"><a href="#cb27-61" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">xend =</span> date, <span class="at">y =</span> observed, <span class="at">yend =</span> prediction),</span>
<span id="cb27-62"><a href="#cb27-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb27-63"><a href="#cb27-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"gray50"</span></span>
<span id="cb27-64"><a href="#cb27-64" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb27-65"><a href="#cb27-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb27-66"><a href="#cb27-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Observed Past Magnitudes vs VAR Predictions"</span>,</span>
<span id="cb27-67"><a href="#cb27-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Predictions in gray"</span>,</span>
<span id="cb27-68"><a href="#cb27-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb27-69"><a href="#cb27-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Change Rate (%)"</span>,</span>
<span id="cb27-70"><a href="#cb27-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Series"</span></span>
<span id="cb27-71"><a href="#cb27-71" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb27-72"><a href="#cb27-72" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_tintin_d</span>() <span class="sc">+</span></span>
<span id="cb27-73"><a href="#cb27-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>series, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb27-74"><a href="#cb27-74" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb27-75"><a href="#cb27-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>) <span class="sc">+</span></span>
<span id="cb27-76"><a href="#cb27-76" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/var5c-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
<p>For the out-of-sample RMSFE and MAE metrics we need an R-side RMSFE and MAE functions as their C++ counterparts are not exported):</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>RMSFE <span class="ot">&lt;-</span> <span class="cf">function</span>(actual, predicted) {</span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">sqrt</span>(<span class="fu">mean</span>((actual <span class="sc">-</span> predicted)<span class="sc">^</span><span class="dv">2</span>, <span class="at">na.rm =</span> <span class="cn">TRUE</span>))</span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-5"><a href="#cb28-5" aria-hidden="true" tabindex="-1"></a>MAE <span class="ot">&lt;-</span> <span class="cf">function</span>(actual, predicted) {</span>
<span id="cb28-6"><a href="#cb28-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mean</span>(<span class="fu">abs</span>(actual <span class="sc">-</span> predicted), <span class="at">na.rm =</span> <span class="cn">TRUE</span>)</span>
<span id="cb28-7"><a href="#cb28-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb28-8"><a href="#cb28-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb28-9"><a href="#cb28-9" aria-hidden="true" tabindex="-1"></a>fit_predictions2 <span class="sc">%&gt;%</span></span>
<span id="cb28-10"><a href="#cb28-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(series <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"CPILFESL"</span>, <span class="st">"GDPDEF"</span>, <span class="st">"GDPGROWTH"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb28-11"><a href="#cb28-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(series) <span class="sc">%&gt;%</span></span>
<span id="cb28-12"><a href="#cb28-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb28-13"><a href="#cb28-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">RMSFE_out_of_sample =</span> <span class="fu">RMSFE</span>(observed, prediction),</span>
<span id="cb28-14"><a href="#cb28-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">MAE_out_of_sample =</span> <span class="fu">MAE</span>(observed, prediction)</span>
<span id="cb28-15"><a href="#cb28-15" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb28-16"><a href="#cb28-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb28-17"><a href="#cb28-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb28-18"><a href="#cb28-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">RMSFE_in_sample =</span> <span class="fu">c</span>(</span>
<span id="cb28-19"><a href="#cb28-19" aria-hidden="true" tabindex="-1"></a>      fit_gdpgrowth_subset<span class="sc">$</span>rmsfe,</span>
<span id="cb28-20"><a href="#cb28-20" aria-hidden="true" tabindex="-1"></a>      fit_gdpdef_subset<span class="sc">$</span>rmsfe,</span>
<span id="cb28-21"><a href="#cb28-21" aria-hidden="true" tabindex="-1"></a>      fit_gdpgrowth_subset<span class="sc">$</span>rmsfe</span>
<span id="cb28-22"><a href="#cb28-22" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb28-23"><a href="#cb28-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">MAE_in_sample =</span> <span class="fu">c</span>(</span>
<span id="cb28-24"><a href="#cb28-24" aria-hidden="true" tabindex="-1"></a>      fit_gdpgrowth_subset<span class="sc">$</span>mae,</span>
<span id="cb28-25"><a href="#cb28-25" aria-hidden="true" tabindex="-1"></a>      fit_gdpdef_subset<span class="sc">$</span>mae,</span>
<span id="cb28-26"><a href="#cb28-26" aria-hidden="true" tabindex="-1"></a>      fit_gdpgrowth_subset<span class="sc">$</span>mae</span>
<span id="cb28-27"><a href="#cb28-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb28-28"><a href="#cb28-28" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb28-29"><a href="#cb28-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb28-30"><a href="#cb28-30" aria-hidden="true" tabindex="-1"></a>    series,</span>
<span id="cb28-31"><a href="#cb28-31" aria-hidden="true" tabindex="-1"></a>    RMSFE_in_sample,</span>
<span id="cb28-32"><a href="#cb28-32" aria-hidden="true" tabindex="-1"></a>    RMSFE_out_of_sample,</span>
<span id="cb28-33"><a href="#cb28-33" aria-hidden="true" tabindex="-1"></a>    MAE_in_sample,</span>
<span id="cb28-34"><a href="#cb28-34" aria-hidden="true" tabindex="-1"></a>    MAE_out_of_sample</span>
<span id="cb28-35"><a href="#cb28-35" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 5
  series    RMSFE_in_sample RMSFE_out_of_sample MAE_in_sample MAE_out_of_sample
  &lt;chr&gt;               &lt;dbl&gt;               &lt;dbl&gt;         &lt;dbl&gt;             &lt;dbl&gt;
1 CPILFESL            1.97                 1.19         1.57              0.803
2 GDPDEF              0.975                1.57         0.660             1.27 
3 GDPGROWTH           1.97                 1.94         1.57              1.34 </code></pre>
</div>
</div>
</section>
<section id="estimate-a-fa-var-model" class="level1">
<h1>Estimate a FA-VAR model</h1>
<p>The Factor Augmented VAR model is an extension of the standard VAR model seen above. It incorporates latent common factors using the PCA method, allowing one to capture the dynamic relationships among the variables used in the analysis. The FA-VAR predictions can be seen in the forecast above. For the variables CPILFESL, GDPDEF, GDPGROWTH the FA-VAR captures the trends somewhat accurately up until there is a prominent spike. The FA-VAR slightly underestimates any structural shocks, suggesting that the latent factors are not fully capturing their magnitudes. The FA-VAR acts quite similarly to the VAR model estimated. It provides a good benchmark for short-horizon predictions, and it is important to note that it has lower forecast errors than the basic VAR, suggesting that adding latent factors enhances predictive performance.</p>
<p>The FA-VAR model follows a pure time series approach: it creates an information set <span class="math inline">\(X_t\)</span> from the target variable and its lags, extracts latent factors via PCA, and augments a VAR with these factors.</p>
<p>Model specification: - <span class="math inline">\(X_t = [y_t, y_{t-1}, \ldots, y_{t-L}]\)</span> (information set created from y and its lags) - Extract <span class="math inline">\(r\)</span> factors from <span class="math inline">\(X_t\)</span> using PCA - Estimate: <span class="math inline">\(y_t = B(L) y_{t-1} + C(L) F_t + u_t\)</span> (augmented VAR with factor lags)</p>
<p>This approach captures nonlinear patterns in the autocorrelation structure through factor extraction.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a><span class="co"># FA-VAR parameters (simplified to avoid overfitting)</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>n_lags <span class="ot">&lt;-</span> <span class="dv">3</span>L <span class="co"># Number of lags to create information set X (creates 4 variables)</span></span>
<span id="cb30-3"><a href="#cb30-3" aria-hidden="true" tabindex="-1"></a>n_factors <span class="ot">&lt;-</span> <span class="dv">2</span>L <span class="co"># Number of factors to extract from X</span></span>
<span id="cb30-4"><a href="#cb30-4" aria-hidden="true" tabindex="-1"></a>p_f <span class="ot">&lt;-</span> <span class="dv">2</span>L <span class="co"># Factor lags</span></span>
<span id="cb30-5"><a href="#cb30-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-6"><a href="#cb30-6" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(<span class="fu">as.matrix</span>(cpilfesl_mm_subset<span class="sc">$</span>inflation))</span>
<span id="cb30-7"><a href="#cb30-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-8"><a href="#cb30-8" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate FA-VAR models</span></span>
<span id="cb30-9"><a href="#cb30-9" aria-hidden="true" tabindex="-1"></a>fit_cpilfesl_favar <span class="ot">&lt;-</span> <span class="fu">favar_model</span>(</span>
<span id="cb30-10"><a href="#cb30-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> y,</span>
<span id="cb30-11"><a href="#cb30-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_lags =</span> n_lags,</span>
<span id="cb30-12"><a href="#cb30-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_factors =</span> n_factors,</span>
<span id="cb30-13"><a href="#cb30-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">p_y =</span> l1,</span>
<span id="cb30-14"><a href="#cb30-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">p_f =</span> p_f,</span>
<span id="cb30-15"><a href="#cb30-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">include_const =</span> <span class="cn">TRUE</span>,</span>
<span id="cb30-16"><a href="#cb30-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">forecast_h =</span> h</span>
<span id="cb30-17"><a href="#cb30-17" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-18"><a href="#cb30-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-19"><a href="#cb30-19" aria-hidden="true" tabindex="-1"></a><span class="co"># Tuned parameters for GDPDEF</span></span>
<span id="cb30-20"><a href="#cb30-20" aria-hidden="true" tabindex="-1"></a>n_lags <span class="ot">&lt;-</span> <span class="dv">3</span>L</span>
<span id="cb30-21"><a href="#cb30-21" aria-hidden="true" tabindex="-1"></a>n_factors <span class="ot">&lt;-</span> <span class="dv">2</span>L</span>
<span id="cb30-22"><a href="#cb30-22" aria-hidden="true" tabindex="-1"></a>p_f <span class="ot">&lt;-</span> <span class="dv">1</span>L</span>
<span id="cb30-23"><a href="#cb30-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-24"><a href="#cb30-24" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(<span class="fu">as.matrix</span>(gdpdef_mm_subset<span class="sc">$</span>inflation))</span>
<span id="cb30-25"><a href="#cb30-25" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-26"><a href="#cb30-26" aria-hidden="true" tabindex="-1"></a>fit_gdpdef_favar <span class="ot">&lt;-</span> <span class="fu">favar_model</span>(</span>
<span id="cb30-27"><a href="#cb30-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> y,</span>
<span id="cb30-28"><a href="#cb30-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_lags =</span> n_lags,</span>
<span id="cb30-29"><a href="#cb30-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_factors =</span> n_factors,</span>
<span id="cb30-30"><a href="#cb30-30" aria-hidden="true" tabindex="-1"></a>  <span class="at">p_y =</span> l2,</span>
<span id="cb30-31"><a href="#cb30-31" aria-hidden="true" tabindex="-1"></a>  <span class="at">p_f =</span> p_f,</span>
<span id="cb30-32"><a href="#cb30-32" aria-hidden="true" tabindex="-1"></a>  <span class="at">include_const =</span> <span class="cn">TRUE</span>,</span>
<span id="cb30-33"><a href="#cb30-33" aria-hidden="true" tabindex="-1"></a>  <span class="at">forecast_h =</span> h</span>
<span id="cb30-34"><a href="#cb30-34" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-35"><a href="#cb30-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-36"><a href="#cb30-36" aria-hidden="true" tabindex="-1"></a><span class="co"># Tuned parameters for GDP growth</span></span>
<span id="cb30-37"><a href="#cb30-37" aria-hidden="true" tabindex="-1"></a>n_lags <span class="ot">&lt;-</span> <span class="dv">3</span>L</span>
<span id="cb30-38"><a href="#cb30-38" aria-hidden="true" tabindex="-1"></a>n_factors <span class="ot">&lt;-</span> <span class="dv">2</span>L</span>
<span id="cb30-39"><a href="#cb30-39" aria-hidden="true" tabindex="-1"></a>p_f <span class="ot">&lt;-</span> <span class="dv">1</span>L</span>
<span id="cb30-40"><a href="#cb30-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-41"><a href="#cb30-41" aria-hidden="true" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">na.omit</span>(<span class="fu">as.matrix</span>(gdpc1_yy_subset<span class="sc">$</span>gdpgrowth))</span>
<span id="cb30-42"><a href="#cb30-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-43"><a href="#cb30-43" aria-hidden="true" tabindex="-1"></a>fit_gdpc1_favar <span class="ot">&lt;-</span> <span class="fu">favar_model</span>(</span>
<span id="cb30-44"><a href="#cb30-44" aria-hidden="true" tabindex="-1"></a>  <span class="at">y =</span> y,</span>
<span id="cb30-45"><a href="#cb30-45" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_lags =</span> n_lags,</span>
<span id="cb30-46"><a href="#cb30-46" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_factors =</span> n_factors,</span>
<span id="cb30-47"><a href="#cb30-47" aria-hidden="true" tabindex="-1"></a>  <span class="at">p_y =</span> l3,</span>
<span id="cb30-48"><a href="#cb30-48" aria-hidden="true" tabindex="-1"></a>  <span class="at">p_f =</span> p_f,</span>
<span id="cb30-49"><a href="#cb30-49" aria-hidden="true" tabindex="-1"></a>  <span class="at">include_const =</span> <span class="cn">TRUE</span>,</span>
<span id="cb30-50"><a href="#cb30-50" aria-hidden="true" tabindex="-1"></a>  <span class="at">forecast_h =</span> h</span>
<span id="cb30-51"><a href="#cb30-51" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb30-52"><a href="#cb30-52" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb30-53"><a href="#cb30-53" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fit_cpilfesl_favar, <span class="st">"data/fit_cpilfesl_favar.rds"</span>)</span>
<span id="cb30-54"><a href="#cb30-54" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fit_gdpdef_favar, <span class="st">"data/fit_gdpdef_favar.rds"</span>)</span>
<span id="cb30-55"><a href="#cb30-55" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fit_gdpc1_favar, <span class="st">"data/fit_gdpc1_favar.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>run_models) {</span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  fit_cpilfesl_favar <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/fit_cpilfesl_favar.rds"</span>)</span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  fit_gdpdef_favar <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/fit_gdpdef_favar.rds"</span>)</span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  fit_gdpc1_favar <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/fit_gdpc1_favar.rds"</span>)</span>
<span id="cb31-5"><a href="#cb31-5" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb31-6"><a href="#cb31-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-7"><a href="#cb31-7" aria-hidden="true" tabindex="-1"></a>fit_predictions3 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb31-8"><a href="#cb31-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">date =</span> <span class="fu">max</span>(cpilfesl_mm_subset<span class="sc">$</span>date) <span class="sc">+</span></span>
<span id="cb31-9"><a href="#cb31-9" aria-hidden="true" tabindex="-1"></a>    <span class="fu">years</span>(<span class="fu">seq_len</span>(fit_cpilfesl_favar<span class="sc">$</span>forecast_horizon)),</span>
<span id="cb31-10"><a href="#cb31-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">prediction =</span> <span class="fu">as.numeric</span>(fit_cpilfesl_favar<span class="sc">$</span>forecasts),</span>
<span id="cb31-11"><a href="#cb31-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">series =</span> <span class="st">"CPILFESL"</span></span>
<span id="cb31-12"><a href="#cb31-12" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb31-13"><a href="#cb31-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb31-14"><a href="#cb31-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb31-15"><a href="#cb31-15" aria-hidden="true" tabindex="-1"></a>      <span class="at">date =</span> <span class="fu">max</span>(gdpdef_mm_subset<span class="sc">$</span>date) <span class="sc">+</span></span>
<span id="cb31-16"><a href="#cb31-16" aria-hidden="true" tabindex="-1"></a>        <span class="fu">years</span>(<span class="fu">seq_len</span>(fit_gdpdef_favar<span class="sc">$</span>forecast_horizon)),</span>
<span id="cb31-17"><a href="#cb31-17" aria-hidden="true" tabindex="-1"></a>      <span class="at">prediction =</span> <span class="fu">as.numeric</span>(fit_gdpdef_favar<span class="sc">$</span>forecasts),</span>
<span id="cb31-18"><a href="#cb31-18" aria-hidden="true" tabindex="-1"></a>      <span class="at">series =</span> <span class="st">"GDPDEF"</span></span>
<span id="cb31-19"><a href="#cb31-19" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-20"><a href="#cb31-20" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-21"><a href="#cb31-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb31-22"><a href="#cb31-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb31-23"><a href="#cb31-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">date =</span> <span class="fu">max</span>(gdpc1_yy_subset<span class="sc">$</span>date) <span class="sc">+</span></span>
<span id="cb31-24"><a href="#cb31-24" aria-hidden="true" tabindex="-1"></a>        <span class="fu">years</span>(<span class="fu">seq_len</span>(fit_gdpc1_favar<span class="sc">$</span>forecast_horizon)),</span>
<span id="cb31-25"><a href="#cb31-25" aria-hidden="true" tabindex="-1"></a>      <span class="at">prediction =</span> <span class="fu">as.numeric</span>(fit_gdpc1_favar<span class="sc">$</span>forecasts),</span>
<span id="cb31-26"><a href="#cb31-26" aria-hidden="true" tabindex="-1"></a>      <span class="at">series =</span> <span class="st">"GDPGROWTH"</span></span>
<span id="cb31-27"><a href="#cb31-27" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-28"><a href="#cb31-28" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-29"><a href="#cb31-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-30"><a href="#cb31-30" aria-hidden="true" tabindex="-1"></a>fit_predictions3 <span class="ot">&lt;-</span> fit_predictions3 <span class="sc">%&gt;%</span></span>
<span id="cb31-31"><a href="#cb31-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb31-32"><a href="#cb31-32" aria-hidden="true" tabindex="-1"></a>    inflation <span class="sc">%&gt;%</span></span>
<span id="cb31-33"><a href="#cb31-33" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(series <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"CPILFESL"</span>, <span class="st">"GDPDEF"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-34"><a href="#cb31-34" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="fu">year</span>(date) <span class="sc">&gt;</span> <span class="fu">max</span>(<span class="fu">year</span>(date) <span class="sc">-</span> h)) <span class="sc">%&gt;%</span></span>
<span id="cb31-35"><a href="#cb31-35" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(date, <span class="at">observed =</span> value, series) <span class="sc">%&gt;%</span></span>
<span id="cb31-36"><a href="#cb31-36" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_rows</span>(</span>
<span id="cb31-37"><a href="#cb31-37" aria-hidden="true" tabindex="-1"></a>        gdpc1_yy <span class="sc">%&gt;%</span></span>
<span id="cb31-38"><a href="#cb31-38" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(<span class="fu">year</span>(date) <span class="sc">&gt;</span> <span class="fu">max</span>(<span class="fu">year</span>(date) <span class="sc">-</span> h)) <span class="sc">%&gt;%</span></span>
<span id="cb31-39"><a href="#cb31-39" aria-hidden="true" tabindex="-1"></a>          <span class="fu">select</span>(date, <span class="at">observed =</span> gdpgrowth) <span class="sc">%&gt;%</span></span>
<span id="cb31-40"><a href="#cb31-40" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">series =</span> <span class="st">"GDPGROWTH"</span>)</span>
<span id="cb31-41"><a href="#cb31-41" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb31-42"><a href="#cb31-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"series"</span>)</span>
<span id="cb31-43"><a href="#cb31-43" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb31-44"><a href="#cb31-44" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb31-45"><a href="#cb31-45" aria-hidden="true" tabindex="-1"></a>fit_predictions3 <span class="sc">%&gt;%</span></span>
<span id="cb31-46"><a href="#cb31-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(series <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"CPILFESL"</span>, <span class="st">"GDPDEF"</span>, <span class="st">"GDPGROWTH"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb31-47"><a href="#cb31-47" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(series) <span class="sc">%&gt;%</span></span>
<span id="cb31-48"><a href="#cb31-48" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb31-49"><a href="#cb31-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">RMSFE_out_of_sample =</span> <span class="fu">RMSFE</span>(observed, prediction),</span>
<span id="cb31-50"><a href="#cb31-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">MAE_out_of_sample =</span> <span class="fu">MAE</span>(observed, prediction)</span>
<span id="cb31-51"><a href="#cb31-51" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-52"><a href="#cb31-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb31-53"><a href="#cb31-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb31-54"><a href="#cb31-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">RMSFE_in_sample =</span> <span class="fu">c</span>(</span>
<span id="cb31-55"><a href="#cb31-55" aria-hidden="true" tabindex="-1"></a>      fit_cpilfesl_favar<span class="sc">$</span>rmsfe,</span>
<span id="cb31-56"><a href="#cb31-56" aria-hidden="true" tabindex="-1"></a>      fit_gdpdef_favar<span class="sc">$</span>rmsfe,</span>
<span id="cb31-57"><a href="#cb31-57" aria-hidden="true" tabindex="-1"></a>      fit_gdpc1_favar<span class="sc">$</span>rmsfe</span>
<span id="cb31-58"><a href="#cb31-58" aria-hidden="true" tabindex="-1"></a>    ),</span>
<span id="cb31-59"><a href="#cb31-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">MAE_in_sample =</span> <span class="fu">c</span>(</span>
<span id="cb31-60"><a href="#cb31-60" aria-hidden="true" tabindex="-1"></a>      fit_cpilfesl_favar<span class="sc">$</span>mae,</span>
<span id="cb31-61"><a href="#cb31-61" aria-hidden="true" tabindex="-1"></a>      fit_gdpdef_favar<span class="sc">$</span>mae,</span>
<span id="cb31-62"><a href="#cb31-62" aria-hidden="true" tabindex="-1"></a>      fit_gdpc1_favar<span class="sc">$</span>mae</span>
<span id="cb31-63"><a href="#cb31-63" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb31-64"><a href="#cb31-64" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb31-65"><a href="#cb31-65" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb31-66"><a href="#cb31-66" aria-hidden="true" tabindex="-1"></a>    series,</span>
<span id="cb31-67"><a href="#cb31-67" aria-hidden="true" tabindex="-1"></a>    RMSFE_in_sample,</span>
<span id="cb31-68"><a href="#cb31-68" aria-hidden="true" tabindex="-1"></a>    RMSFE_out_of_sample,</span>
<span id="cb31-69"><a href="#cb31-69" aria-hidden="true" tabindex="-1"></a>    MAE_in_sample,</span>
<span id="cb31-70"><a href="#cb31-70" aria-hidden="true" tabindex="-1"></a>    MAE_out_of_sample</span>
<span id="cb31-71"><a href="#cb31-71" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 5
  series    RMSFE_in_sample RMSFE_out_of_sample MAE_in_sample MAE_out_of_sample
  &lt;chr&gt;               &lt;dbl&gt;               &lt;dbl&gt;         &lt;dbl&gt;             &lt;dbl&gt;
1 CPILFESL            1.47                 1.19         0.883             0.855
2 GDPDEF              0.997                1.70         0.686             1.22 
3 GDPGROWTH           2.00                 1.98         1.60              1.59 </code></pre>
</div>
</div>
<p>Plot the FA-VAR forecasts on the censored data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fit_predictions3) <span class="sc">+</span></span>
<span id="cb33-2"><a href="#cb33-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> observed, <span class="at">color =</span> series), <span class="at">linewidth =</span> <span class="fl">1.5</span>) <span class="sc">+</span></span>
<span id="cb33-3"><a href="#cb33-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(<span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> observed, <span class="at">color =</span> series), <span class="at">size =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb33-4"><a href="#cb33-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb33-5"><a href="#cb33-5" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> prediction, <span class="at">color =</span> series),</span>
<span id="cb33-6"><a href="#cb33-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">linewidth =</span> <span class="dv">1</span>,</span>
<span id="cb33-7"><a href="#cb33-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"gray70"</span></span>
<span id="cb33-8"><a href="#cb33-8" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb33-9"><a href="#cb33-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb33-10"><a href="#cb33-10" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> prediction, <span class="at">color =</span> series),</span>
<span id="cb33-11"><a href="#cb33-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">2</span>,</span>
<span id="cb33-12"><a href="#cb33-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"gray70"</span></span>
<span id="cb33-13"><a href="#cb33-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb33-14"><a href="#cb33-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(</span>
<span id="cb33-15"><a href="#cb33-15" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">xend =</span> date, <span class="at">y =</span> observed, <span class="at">yend =</span> prediction),</span>
<span id="cb33-16"><a href="#cb33-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb33-17"><a href="#cb33-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"gray50"</span></span>
<span id="cb33-18"><a href="#cb33-18" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb33-19"><a href="#cb33-19" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb33-20"><a href="#cb33-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Observed Past Magnitudes vs FA-VAR Predictions"</span>,</span>
<span id="cb33-21"><a href="#cb33-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Predictions in gray"</span>,</span>
<span id="cb33-22"><a href="#cb33-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb33-23"><a href="#cb33-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Change Rate (%)"</span>,</span>
<span id="cb33-24"><a href="#cb33-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Series"</span></span>
<span id="cb33-25"><a href="#cb33-25" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb33-26"><a href="#cb33-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_tintin_d</span>() <span class="sc">+</span></span>
<span id="cb33-27"><a href="#cb33-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>series, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb33-28"><a href="#cb33-28" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb33-29"><a href="#cb33-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/favar3-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="estimate-a-dfm-model" class="level1">
<h1>Estimate a DFM model</h1>
<p>The Dynamic Factor Model (DFM) was estimated using a state-space representation with PCA initialization and the Kalman filter for forecasting. By extracting a common latent factor from inflation-related series such as core CPI and food prices, the DFM isolates shared movements that represent underlying macroeconomic pressures. The resulting forecasts align closely with observed inflation dynamics but exhibit mild lagging behavior during sharp turning points, indicating a slower adjustment to sudden shocks. The DFM’s strong in-sample fit demonstrates its ability to summarize complex information into a few latent components, offering valuable structural insights into inflation dynamics even if short-term forecast precision remains modest.</p>
<p>The DFM uses a state-space representation with PCA initialization and Kalman filter for parameter estimation.</p>
<p>DFM is designed for multivariate data where we want to extract common factors across different economic variables. Unlike FA-VAR (which uses autoregressive lags), DFM works best with actual multivariate series that share common dynamics.</p>
<p>We’ll use two inflation measures <span class="math inline">\([CPILFESL/GDPDEF, CPIFOOD]\)</span> to extract common factors.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb34"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" aria-hidden="true" tabindex="-1"></a>dfm_data_cpilfesl <span class="ot">&lt;-</span> cpilfesl_mm_subset <span class="sc">%&gt;%</span></span>
<span id="cb34-2"><a href="#cb34-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date, <span class="at">cpilfesl =</span> inflation) <span class="sc">%&gt;%</span></span>
<span id="cb34-3"><a href="#cb34-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(</span>
<span id="cb34-4"><a href="#cb34-4" aria-hidden="true" tabindex="-1"></a>    cpifood_mm <span class="sc">%&gt;%</span> <span class="fu">select</span>(date, <span class="at">cpifood =</span> inflation),</span>
<span id="cb34-5"><a href="#cb34-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"date"</span></span>
<span id="cb34-6"><a href="#cb34-6" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb34-7"><a href="#cb34-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>()</span>
<span id="cb34-8"><a href="#cb34-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-9"><a href="#cb34-9" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(dfm_data_cpilfesl, <span class="st">"data/dfm_data_cpilfesl.rds"</span>)</span>
<span id="cb34-10"><a href="#cb34-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-11"><a href="#cb34-11" aria-hidden="true" tabindex="-1"></a>x_cpilfesl_dfm <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(dfm_data_cpilfesl[, <span class="fu">c</span>(<span class="st">"cpilfesl"</span>, <span class="st">"cpifood"</span>)])</span>
<span id="cb34-12"><a href="#cb34-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-13"><a href="#cb34-13" aria-hidden="true" tabindex="-1"></a><span class="co"># Estimate DFM (1 common inflation factor from 2 variables)</span></span>
<span id="cb34-14"><a href="#cb34-14" aria-hidden="true" tabindex="-1"></a>fit_cpilfesl_dfm <span class="ot">&lt;-</span> <span class="fu">dfm_model</span>(</span>
<span id="cb34-15"><a href="#cb34-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> x_cpilfesl_dfm,</span>
<span id="cb34-16"><a href="#cb34-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_factors =</span> <span class="dv">1</span>L,</span>
<span id="cb34-17"><a href="#cb34-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> <span class="dv">1</span>L,</span>
<span id="cb34-18"><a href="#cb34-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">max_iter =</span> <span class="dv">50</span>L,</span>
<span id="cb34-19"><a href="#cb34-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">tol =</span> <span class="fl">1e-6</span>,</span>
<span id="cb34-20"><a href="#cb34-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">forecast_h =</span> h</span>
<span id="cb34-21"><a href="#cb34-21" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-22"><a href="#cb34-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-23"><a href="#cb34-23" aria-hidden="true" tabindex="-1"></a>dfm_data_gdpdef <span class="ot">&lt;-</span> gdpdef_mm_subset <span class="sc">%&gt;%</span></span>
<span id="cb34-24"><a href="#cb34-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date, <span class="at">gdpdef =</span> inflation) <span class="sc">%&gt;%</span></span>
<span id="cb34-25"><a href="#cb34-25" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(</span>
<span id="cb34-26"><a href="#cb34-26" aria-hidden="true" tabindex="-1"></a>    cpifood_mm <span class="sc">%&gt;%</span> <span class="fu">select</span>(date, <span class="at">cpifood =</span> inflation),</span>
<span id="cb34-27"><a href="#cb34-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"date"</span></span>
<span id="cb34-28"><a href="#cb34-28" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb34-29"><a href="#cb34-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>()</span>
<span id="cb34-30"><a href="#cb34-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-31"><a href="#cb34-31" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(dfm_data_gdpdef, <span class="st">"data/dfm_data_gdpdef.rds"</span>)</span>
<span id="cb34-32"><a href="#cb34-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-33"><a href="#cb34-33" aria-hidden="true" tabindex="-1"></a>x_gdpdef_dfm <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(dfm_data_gdpdef[, <span class="fu">c</span>(<span class="st">"gdpdef"</span>, <span class="st">"cpifood"</span>)])</span>
<span id="cb34-34"><a href="#cb34-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-35"><a href="#cb34-35" aria-hidden="true" tabindex="-1"></a>fit_gdpdef_dfm <span class="ot">&lt;-</span> <span class="fu">dfm_model</span>(</span>
<span id="cb34-36"><a href="#cb34-36" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> x_gdpdef_dfm,</span>
<span id="cb34-37"><a href="#cb34-37" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_factors =</span> <span class="dv">1</span>L,</span>
<span id="cb34-38"><a href="#cb34-38" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> <span class="dv">1</span>L,</span>
<span id="cb34-39"><a href="#cb34-39" aria-hidden="true" tabindex="-1"></a>  <span class="at">max_iter =</span> <span class="dv">50</span>L,</span>
<span id="cb34-40"><a href="#cb34-40" aria-hidden="true" tabindex="-1"></a>  <span class="at">tol =</span> <span class="fl">1e-6</span>,</span>
<span id="cb34-41"><a href="#cb34-41" aria-hidden="true" tabindex="-1"></a>  <span class="at">forecast_h =</span> h</span>
<span id="cb34-42"><a href="#cb34-42" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-43"><a href="#cb34-43" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-44"><a href="#cb34-44" aria-hidden="true" tabindex="-1"></a>dfm_data_gdpc1 <span class="ot">&lt;-</span> gdpc1_yy_subset <span class="sc">%&gt;%</span></span>
<span id="cb34-45"><a href="#cb34-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(date, <span class="at">gdpgrowth =</span> gdpgrowth) <span class="sc">%&gt;%</span></span>
<span id="cb34-46"><a href="#cb34-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(</span>
<span id="cb34-47"><a href="#cb34-47" aria-hidden="true" tabindex="-1"></a>    cpifood_mm <span class="sc">%&gt;%</span> <span class="fu">select</span>(date, <span class="at">cpifood =</span> inflation),</span>
<span id="cb34-48"><a href="#cb34-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="st">"date"</span></span>
<span id="cb34-49"><a href="#cb34-49" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb34-50"><a href="#cb34-50" aria-hidden="true" tabindex="-1"></a>  <span class="fu">na.omit</span>()</span>
<span id="cb34-51"><a href="#cb34-51" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-52"><a href="#cb34-52" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(dfm_data_gdpc1, <span class="st">"data/dfm_data_gdpc1.rds"</span>)</span>
<span id="cb34-53"><a href="#cb34-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-54"><a href="#cb34-54" aria-hidden="true" tabindex="-1"></a>x_gdpc1_dfm <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(dfm_data_gdpc1[, <span class="fu">c</span>(<span class="st">"gdpgrowth"</span>, <span class="st">"cpifood"</span>)])</span>
<span id="cb34-55"><a href="#cb34-55" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-56"><a href="#cb34-56" aria-hidden="true" tabindex="-1"></a>fit_gdpc1_dfm <span class="ot">&lt;-</span> <span class="fu">dfm_model</span>(</span>
<span id="cb34-57"><a href="#cb34-57" aria-hidden="true" tabindex="-1"></a>  <span class="at">x =</span> x_gdpc1_dfm,</span>
<span id="cb34-58"><a href="#cb34-58" aria-hidden="true" tabindex="-1"></a>  <span class="at">n_factors =</span> <span class="dv">1</span>L,</span>
<span id="cb34-59"><a href="#cb34-59" aria-hidden="true" tabindex="-1"></a>  <span class="at">p =</span> <span class="dv">2</span>L,</span>
<span id="cb34-60"><a href="#cb34-60" aria-hidden="true" tabindex="-1"></a>  <span class="at">max_iter =</span> <span class="dv">50</span>L,</span>
<span id="cb34-61"><a href="#cb34-61" aria-hidden="true" tabindex="-1"></a>  <span class="at">tol =</span> <span class="fl">1e-6</span>,</span>
<span id="cb34-62"><a href="#cb34-62" aria-hidden="true" tabindex="-1"></a>  <span class="at">forecast_h =</span> h</span>
<span id="cb34-63"><a href="#cb34-63" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb34-64"><a href="#cb34-64" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb34-65"><a href="#cb34-65" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fit_cpilfesl_dfm, <span class="st">"data/fit_cpilfesl_dfm.rds"</span>)</span>
<span id="cb34-66"><a href="#cb34-66" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fit_gdpdef_dfm, <span class="st">"data/fit_gdpdef_dfm.rds"</span>)</span>
<span id="cb34-67"><a href="#cb34-67" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(fit_gdpc1_dfm, <span class="st">"data/fit_gdpc1_dfm.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>run_models) {</span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>  dfm_data_cpilfesl <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/dfm_data_cpilfesl.rds"</span>)</span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a>  dfm_data_gdpdef <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/dfm_data_gdpdef.rds"</span>)</span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a>  dfm_data_gdpc1 <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/dfm_data_gdpc1.rds"</span>)</span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a>  fit_cpilfesl_dfm <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/fit_cpilfesl_dfm.rds"</span>)</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  fit_gdpdef_dfm <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/fit_gdpdef_dfm.rds"</span>)</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  fit_gdpc1_dfm <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/fit_gdpc1_dfm.rds"</span>)</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a><span class="co"># Extract forecasts for the FIRST variable only (our target)</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a><span class="co"># DFM forecasts all variables, but we only want the first one</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>fit_predictions4 <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">date =</span> <span class="fu">max</span>(dfm_data_cpilfesl<span class="sc">$</span>date) <span class="sc">+</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>    <span class="fu">years</span>(<span class="fu">seq_len</span>(fit_cpilfesl_dfm<span class="sc">$</span>forecast_horizon)),</span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">prediction =</span> <span class="fu">as.numeric</span>(fit_cpilfesl_dfm<span class="sc">$</span>forecasts[, <span class="dv">1</span>]), <span class="co"># First column is CPILFESL</span></span>
<span id="cb35-16"><a href="#cb35-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">series =</span> <span class="st">"CPILFESL"</span></span>
<span id="cb35-17"><a href="#cb35-17" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span></span>
<span id="cb35-18"><a href="#cb35-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb35-19"><a href="#cb35-19" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb35-20"><a href="#cb35-20" aria-hidden="true" tabindex="-1"></a>      <span class="at">date =</span> <span class="fu">max</span>(dfm_data_gdpdef<span class="sc">$</span>date) <span class="sc">+</span></span>
<span id="cb35-21"><a href="#cb35-21" aria-hidden="true" tabindex="-1"></a>        <span class="fu">years</span>(<span class="fu">seq_len</span>(fit_gdpdef_dfm<span class="sc">$</span>forecast_horizon)),</span>
<span id="cb35-22"><a href="#cb35-22" aria-hidden="true" tabindex="-1"></a>      <span class="at">prediction =</span> <span class="fu">as.numeric</span>(fit_gdpdef_dfm<span class="sc">$</span>forecasts[, <span class="dv">1</span>]), <span class="co"># First column is GDPDEF</span></span>
<span id="cb35-23"><a href="#cb35-23" aria-hidden="true" tabindex="-1"></a>      <span class="at">series =</span> <span class="st">"GDPDEF"</span></span>
<span id="cb35-24"><a href="#cb35-24" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-25"><a href="#cb35-25" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb35-26"><a href="#cb35-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">bind_rows</span>(</span>
<span id="cb35-27"><a href="#cb35-27" aria-hidden="true" tabindex="-1"></a>    <span class="fu">tibble</span>(</span>
<span id="cb35-28"><a href="#cb35-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">date =</span> <span class="fu">max</span>(dfm_data_gdpc1<span class="sc">$</span>date) <span class="sc">+</span></span>
<span id="cb35-29"><a href="#cb35-29" aria-hidden="true" tabindex="-1"></a>        <span class="fu">years</span>(<span class="fu">seq_len</span>(fit_gdpc1_dfm<span class="sc">$</span>forecast_horizon)),</span>
<span id="cb35-30"><a href="#cb35-30" aria-hidden="true" tabindex="-1"></a>      <span class="at">prediction =</span> <span class="fu">as.numeric</span>(fit_gdpc1_dfm<span class="sc">$</span>forecasts[, <span class="dv">1</span>]), <span class="co"># First column is GDP growth</span></span>
<span id="cb35-31"><a href="#cb35-31" aria-hidden="true" tabindex="-1"></a>      <span class="at">series =</span> <span class="st">"GDPGROWTH"</span></span>
<span id="cb35-32"><a href="#cb35-32" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb35-33"><a href="#cb35-33" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb35-34"><a href="#cb35-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-35"><a href="#cb35-35" aria-hidden="true" tabindex="-1"></a>fit_predictions4 <span class="ot">&lt;-</span> fit_predictions4 <span class="sc">%&gt;%</span></span>
<span id="cb35-36"><a href="#cb35-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">left_join</span>(</span>
<span id="cb35-37"><a href="#cb35-37" aria-hidden="true" tabindex="-1"></a>    inflation <span class="sc">%&gt;%</span></span>
<span id="cb35-38"><a href="#cb35-38" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(series <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"CPILFESL"</span>, <span class="st">"GDPDEF"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb35-39"><a href="#cb35-39" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="fu">year</span>(date) <span class="sc">&gt;</span> <span class="fu">max</span>(<span class="fu">year</span>(date) <span class="sc">-</span> h)) <span class="sc">%&gt;%</span></span>
<span id="cb35-40"><a href="#cb35-40" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(date, <span class="at">observed =</span> value, series) <span class="sc">%&gt;%</span></span>
<span id="cb35-41"><a href="#cb35-41" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_rows</span>(</span>
<span id="cb35-42"><a href="#cb35-42" aria-hidden="true" tabindex="-1"></a>        gdpc1_yy <span class="sc">%&gt;%</span></span>
<span id="cb35-43"><a href="#cb35-43" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(<span class="fu">year</span>(date) <span class="sc">&gt;</span> <span class="fu">max</span>(<span class="fu">year</span>(date) <span class="sc">-</span> h)) <span class="sc">%&gt;%</span></span>
<span id="cb35-44"><a href="#cb35-44" aria-hidden="true" tabindex="-1"></a>          <span class="fu">select</span>(date, <span class="at">observed =</span> gdpgrowth) <span class="sc">%&gt;%</span></span>
<span id="cb35-45"><a href="#cb35-45" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">series =</span> <span class="st">"GDPGROWTH"</span>)</span>
<span id="cb35-46"><a href="#cb35-46" aria-hidden="true" tabindex="-1"></a>      ),</span>
<span id="cb35-47"><a href="#cb35-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"series"</span>)</span>
<span id="cb35-48"><a href="#cb35-48" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb35-49"><a href="#cb35-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-50"><a href="#cb35-50" aria-hidden="true" tabindex="-1"></a>fit_predictions4 <span class="sc">%&gt;%</span></span>
<span id="cb35-51"><a href="#cb35-51" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(series <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"CPILFESL"</span>, <span class="st">"GDPDEF"</span>, <span class="st">"GDPGROWTH"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb35-52"><a href="#cb35-52" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(series) <span class="sc">%&gt;%</span></span>
<span id="cb35-53"><a href="#cb35-53" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb35-54"><a href="#cb35-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">RMSFE_out_of_sample =</span> <span class="fu">RMSFE</span>(observed, prediction),</span>
<span id="cb35-55"><a href="#cb35-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">MAE_out_of_sample =</span> <span class="fu">MAE</span>(observed, prediction)</span>
<span id="cb35-56"><a href="#cb35-56" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb35-57"><a href="#cb35-57" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() <span class="sc">%&gt;%</span></span>
<span id="cb35-58"><a href="#cb35-58" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb35-59"><a href="#cb35-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">RMSFE_in_sample =</span> <span class="fu">c</span>(fit_cpilfesl_dfm<span class="sc">$</span>rmsfe, fit_gdpdef_dfm<span class="sc">$</span>rmsfe, fit_gdpc1_dfm<span class="sc">$</span>rmsfe),</span>
<span id="cb35-60"><a href="#cb35-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">MAE_in_sample =</span> <span class="fu">c</span>(fit_cpilfesl_dfm<span class="sc">$</span>mae, fit_gdpdef_dfm<span class="sc">$</span>mae, fit_gdpc1_dfm<span class="sc">$</span>mae)</span>
<span id="cb35-61"><a href="#cb35-61" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb35-62"><a href="#cb35-62" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb35-63"><a href="#cb35-63" aria-hidden="true" tabindex="-1"></a>    series,</span>
<span id="cb35-64"><a href="#cb35-64" aria-hidden="true" tabindex="-1"></a>    RMSFE_in_sample,</span>
<span id="cb35-65"><a href="#cb35-65" aria-hidden="true" tabindex="-1"></a>    RMSFE_out_of_sample,</span>
<span id="cb35-66"><a href="#cb35-66" aria-hidden="true" tabindex="-1"></a>    MAE_in_sample,</span>
<span id="cb35-67"><a href="#cb35-67" aria-hidden="true" tabindex="-1"></a>    MAE_out_of_sample</span>
<span id="cb35-68"><a href="#cb35-68" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 3 × 5
  series    RMSFE_in_sample RMSFE_out_of_sample MAE_in_sample MAE_out_of_sample
  &lt;chr&gt;               &lt;dbl&gt;               &lt;dbl&gt;         &lt;dbl&gt;             &lt;dbl&gt;
1 CPILFESL           0.118                 1.38        0.0756              1.23
2 GDPDEF             0.0538                1.87        0.0358              1.73
3 GDPGROWTH          2.17                  1.84        1.70                1.16</code></pre>
</div>
</div>
<p>Now we can plot the forecast on the censored data:</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(fit_predictions4) <span class="sc">+</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> observed, <span class="at">color =</span> series),</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">linewidth =</span> <span class="fl">1.5</span></span>
<span id="cb37-5"><a href="#cb37-5" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-6"><a href="#cb37-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb37-7"><a href="#cb37-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> observed, <span class="at">color =</span> series),</span>
<span id="cb37-8"><a href="#cb37-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">3</span></span>
<span id="cb37-9"><a href="#cb37-9" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-10"><a href="#cb37-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(</span>
<span id="cb37-11"><a href="#cb37-11" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> prediction, <span class="at">color =</span> series),</span>
<span id="cb37-12"><a href="#cb37-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">linewidth =</span> <span class="dv">1</span>,</span>
<span id="cb37-13"><a href="#cb37-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"gray70"</span></span>
<span id="cb37-14"><a href="#cb37-14" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-15"><a href="#cb37-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>(</span>
<span id="cb37-16"><a href="#cb37-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">y =</span> prediction, <span class="at">color =</span> series),</span>
<span id="cb37-17"><a href="#cb37-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">size =</span> <span class="dv">2</span>,</span>
<span id="cb37-18"><a href="#cb37-18" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"gray70"</span></span>
<span id="cb37-19"><a href="#cb37-19" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-20"><a href="#cb37-20" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_segment</span>(</span>
<span id="cb37-21"><a href="#cb37-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> fit_predictions4,</span>
<span id="cb37-22"><a href="#cb37-22" aria-hidden="true" tabindex="-1"></a>    <span class="fu">aes</span>(<span class="at">x =</span> date, <span class="at">xend =</span> date, <span class="at">y =</span> observed, <span class="at">yend =</span> prediction),</span>
<span id="cb37-23"><a href="#cb37-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">linetype =</span> <span class="st">"dashed"</span>,</span>
<span id="cb37-24"><a href="#cb37-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"gray50"</span></span>
<span id="cb37-25"><a href="#cb37-25" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-26"><a href="#cb37-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(</span>
<span id="cb37-27"><a href="#cb37-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">title =</span> <span class="st">"Inflation Measures and Past DFM Predictions"</span>,</span>
<span id="cb37-28"><a href="#cb37-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">subtitle =</span> <span class="st">"Predictions in gray"</span>,</span>
<span id="cb37-29"><a href="#cb37-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">x =</span> <span class="st">"Date"</span>,</span>
<span id="cb37-30"><a href="#cb37-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">y =</span> <span class="st">"Inflation Rate (%)"</span>,</span>
<span id="cb37-31"><a href="#cb37-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">color =</span> <span class="st">"Series"</span></span>
<span id="cb37-32"><a href="#cb37-32" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">+</span></span>
<span id="cb37-33"><a href="#cb37-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">scale_colour_tintin_d</span>() <span class="sc">+</span></span>
<span id="cb37-34"><a href="#cb37-34" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>series, <span class="at">ncol =</span> <span class="dv">3</span>) <span class="sc">+</span></span>
<span id="cb37-35"><a href="#cb37-35" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb37-36"><a href="#cb37-36" aria-hidden="true" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">legend.position =</span> <span class="st">"top"</span>) <span class="sc">+</span></span>
<span id="cb37-37"><a href="#cb37-37" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/dfm3-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="bonus-bayesian-var" class="level1">
<h1>Bonus: Bayesian VAR</h1>
<p>The Bayesian VAR model was implemented using the Minnesota-Litterman prior to produce 12-step ahead forecasts for inflation and GDP growth (forecast horizon h = 12). This approach introduces prior beliefs about the size and direction of parameters, effectively shrinking estimates toward more plausible values. As a result, it mitigates issues of overfitting and improves stability in small samples. The forecasts are presented with 90% credible intervals, providing a clear visualization of uncertainty around the central projections. Compared to the traditional VAR, the Bayesian VAR produces smoother and more consistent projections, especially during volatile periods such as the post-pandemic recovery. The credible intervals capture most of the observed variation, demonstrating the model’s ability to account for forecast risk. Overall, the Bayesian VAR delivers the most balanced and policy-relevant predictions among all models, offering both precision and transparency by quantifying uncertainty which is essential for the FED’s decision-making framework.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a>prepare_stan_data <span class="ot">&lt;-</span> <span class="cf">function</span>(cpilfesl_data, gdpdef_data, gdpc1_data, </span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">p =</span> <span class="dv">4</span>, <span class="at">h =</span> <span class="dv">12</span>, </span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a>                               <span class="at">lambda =</span> <span class="fl">0.2</span>, <span class="at">tau =</span> <span class="fl">0.5</span>) {</span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Merge data ensuring common dates</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  data_merged <span class="ot">&lt;-</span> cpilfesl_data <span class="sc">%&gt;%</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>    <span class="fu">select</span>(date, <span class="at">cpi_inflation =</span> inflation) <span class="sc">%&gt;%</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(</span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>      gdpdef_data <span class="sc">%&gt;%</span> <span class="fu">select</span>(date, <span class="at">gdp_deflator =</span> inflation),</span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="st">"date"</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb38-12"><a href="#cb38-12" aria-hidden="true" tabindex="-1"></a>    <span class="fu">inner_join</span>(</span>
<span id="cb38-13"><a href="#cb38-13" aria-hidden="true" tabindex="-1"></a>      gdpc1_data <span class="sc">%&gt;%</span> <span class="fu">select</span>(date, <span class="at">gdp_growth =</span> gdpgrowth),</span>
<span id="cb38-14"><a href="#cb38-14" aria-hidden="true" tabindex="-1"></a>      <span class="at">by =</span> <span class="st">"date"</span></span>
<span id="cb38-15"><a href="#cb38-15" aria-hidden="true" tabindex="-1"></a>    ) <span class="sc">%&gt;%</span></span>
<span id="cb38-16"><a href="#cb38-16" aria-hidden="true" tabindex="-1"></a>    <span class="fu">arrange</span>(date) <span class="sc">%&gt;%</span></span>
<span id="cb38-17"><a href="#cb38-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">na.omit</span>()</span>
<span id="cb38-18"><a href="#cb38-18" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-19"><a href="#cb38-19" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create matrix of variables</span></span>
<span id="cb38-20"><a href="#cb38-20" aria-hidden="true" tabindex="-1"></a>  Y <span class="ot">&lt;-</span> <span class="fu">as.matrix</span>(data_merged[, <span class="fu">c</span>(<span class="st">"cpi_inflation"</span>, <span class="st">"gdp_deflator"</span>, <span class="st">"gdp_growth"</span>)])</span>
<span id="cb38-21"><a href="#cb38-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-22"><a href="#cb38-22" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Standardize variables (helps with convergence)</span></span>
<span id="cb38-23"><a href="#cb38-23" aria-hidden="true" tabindex="-1"></a>  Y_mean <span class="ot">&lt;-</span> <span class="fu">colMeans</span>(Y)</span>
<span id="cb38-24"><a href="#cb38-24" aria-hidden="true" tabindex="-1"></a>  Y_sd <span class="ot">&lt;-</span> <span class="fu">apply</span>(Y, <span class="dv">2</span>, sd)</span>
<span id="cb38-25"><a href="#cb38-25" aria-hidden="true" tabindex="-1"></a>  Y_std <span class="ot">&lt;-</span> <span class="fu">scale</span>(Y)</span>
<span id="cb38-26"><a href="#cb38-26" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-27"><a href="#cb38-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Prepare Stan data</span></span>
<span id="cb38-28"><a href="#cb38-28" aria-hidden="true" tabindex="-1"></a>  stan_data <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb38-29"><a href="#cb38-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">T =</span> <span class="fu">nrow</span>(Y_std),</span>
<span id="cb38-30"><a href="#cb38-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">K =</span> <span class="fu">ncol</span>(Y_std),</span>
<span id="cb38-31"><a href="#cb38-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span> p,</span>
<span id="cb38-32"><a href="#cb38-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">h =</span> h,</span>
<span id="cb38-33"><a href="#cb38-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y =</span> Y_std,</span>
<span id="cb38-34"><a href="#cb38-34" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda =</span> lambda,</span>
<span id="cb38-35"><a href="#cb38-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau =</span> tau,</span>
<span id="cb38-36"><a href="#cb38-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">epsilon =</span> <span class="fl">1e-6</span></span>
<span id="cb38-37"><a href="#cb38-37" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb38-38"><a href="#cb38-38" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-39"><a href="#cb38-39" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Return data with scaling info for back-transformation</span></span>
<span id="cb38-40"><a href="#cb38-40" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">list</span>(</span>
<span id="cb38-41"><a href="#cb38-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">stan_data =</span> stan_data,</span>
<span id="cb38-42"><a href="#cb38-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y_mean =</span> Y_mean,</span>
<span id="cb38-43"><a href="#cb38-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y_sd =</span> Y_sd,</span>
<span id="cb38-44"><a href="#cb38-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">dates =</span> data_merged<span class="sc">$</span>date,</span>
<span id="cb38-45"><a href="#cb38-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">Y_original =</span> Y</span>
<span id="cb38-46"><a href="#cb38-46" aria-hidden="true" tabindex="-1"></a>  ))</span>
<span id="cb38-47"><a href="#cb38-47" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb38-48"><a href="#cb38-48" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-49"><a href="#cb38-49" aria-hidden="true" tabindex="-1"></a>fit_bayesian_var <span class="ot">&lt;-</span> <span class="cf">function</span>(data_list, </span>
<span id="cb38-50"><a href="#cb38-50" aria-hidden="true" tabindex="-1"></a>                             <span class="at">stan_file =</span> <span class="st">"minnesota-litterman-var.stan"</span>,</span>
<span id="cb38-51"><a href="#cb38-51" aria-hidden="true" tabindex="-1"></a>                             <span class="at">chains =</span> <span class="dv">4</span>,</span>
<span id="cb38-52"><a href="#cb38-52" aria-hidden="true" tabindex="-1"></a>                             <span class="at">iter_warmup =</span> <span class="dv">1000</span>,</span>
<span id="cb38-53"><a href="#cb38-53" aria-hidden="true" tabindex="-1"></a>                             <span class="at">iter_sampling =</span> <span class="dv">2000</span>,</span>
<span id="cb38-54"><a href="#cb38-54" aria-hidden="true" tabindex="-1"></a>                             <span class="at">parallel_chains =</span> <span class="dv">4</span>) {</span>
<span id="cb38-55"><a href="#cb38-55" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-56"><a href="#cb38-56" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compile Stan model</span></span>
<span id="cb38-57"><a href="#cb38-57" aria-hidden="true" tabindex="-1"></a>  model <span class="ot">&lt;-</span> <span class="fu">cmdstan_model</span>(stan_file)</span>
<span id="cb38-58"><a href="#cb38-58" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-59"><a href="#cb38-59" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Fit the model</span></span>
<span id="cb38-60"><a href="#cb38-60" aria-hidden="true" tabindex="-1"></a>  fit <span class="ot">&lt;-</span> model<span class="sc">$</span><span class="fu">sample</span>(</span>
<span id="cb38-61"><a href="#cb38-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">data =</span> data_list<span class="sc">$</span>stan_data,</span>
<span id="cb38-62"><a href="#cb38-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">chains =</span> chains,</span>
<span id="cb38-63"><a href="#cb38-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">parallel_chains =</span> parallel_chains,</span>
<span id="cb38-64"><a href="#cb38-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter_warmup =</span> iter_warmup,</span>
<span id="cb38-65"><a href="#cb38-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">iter_sampling =</span> iter_sampling,</span>
<span id="cb38-66"><a href="#cb38-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">refresh =</span> <span class="dv">500</span>,</span>
<span id="cb38-67"><a href="#cb38-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">show_messages =</span> <span class="cn">TRUE</span></span>
<span id="cb38-68"><a href="#cb38-68" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb38-69"><a href="#cb38-69" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-70"><a href="#cb38-70" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(fit)</span>
<span id="cb38-71"><a href="#cb38-71" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb38-72"><a href="#cb38-72" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-73"><a href="#cb38-73" aria-hidden="true" tabindex="-1"></a>extract_forecasts <span class="ot">&lt;-</span> <span class="cf">function</span>(fit, data_list) {</span>
<span id="cb38-74"><a href="#cb38-74" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-75"><a href="#cb38-75" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract posterior draws using cmdstanr methods</span></span>
<span id="cb38-76"><a href="#cb38-76" aria-hidden="true" tabindex="-1"></a>  forecast_mean_draws <span class="ot">&lt;-</span> fit<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="st">"Y_forecast_mean"</span>, <span class="at">format =</span> <span class="st">"matrix"</span>)</span>
<span id="cb38-77"><a href="#cb38-77" aria-hidden="true" tabindex="-1"></a>  forecast_draws <span class="ot">&lt;-</span> fit<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> <span class="st">"Y_forecast"</span>, <span class="at">format =</span> <span class="st">"matrix"</span>)</span>
<span id="cb38-78"><a href="#cb38-78" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-79"><a href="#cb38-79" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get dimensions</span></span>
<span id="cb38-80"><a href="#cb38-80" aria-hidden="true" tabindex="-1"></a>  h <span class="ot">&lt;-</span> data_list<span class="sc">$</span>stan_data<span class="sc">$</span>h</span>
<span id="cb38-81"><a href="#cb38-81" aria-hidden="true" tabindex="-1"></a>  K <span class="ot">&lt;-</span> data_list<span class="sc">$</span>stan_data<span class="sc">$</span>K</span>
<span id="cb38-82"><a href="#cb38-82" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-83"><a href="#cb38-83" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute summary statistics across posterior samples</span></span>
<span id="cb38-84"><a href="#cb38-84" aria-hidden="true" tabindex="-1"></a>  <span class="co"># For each forecast horizon and variable, get median and quantiles</span></span>
<span id="cb38-85"><a href="#cb38-85" aria-hidden="true" tabindex="-1"></a>  forecast_mean <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> h, <span class="at">ncol =</span> K)</span>
<span id="cb38-86"><a href="#cb38-86" aria-hidden="true" tabindex="-1"></a>  forecast_lower <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> h, <span class="at">ncol =</span> K)</span>
<span id="cb38-87"><a href="#cb38-87" aria-hidden="true" tabindex="-1"></a>  forecast_upper <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> h, <span class="at">ncol =</span> K)</span>
<span id="cb38-88"><a href="#cb38-88" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-89"><a href="#cb38-89" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>h) {</span>
<span id="cb38-90"><a href="#cb38-90" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K) {</span>
<span id="cb38-91"><a href="#cb38-91" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Column name pattern: Y_forecast_mean[horizon,variable]</span></span>
<span id="cb38-92"><a href="#cb38-92" aria-hidden="true" tabindex="-1"></a>      col_name_mean <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Y_forecast_mean["</span>, i, <span class="st">","</span>, k, <span class="st">"]"</span>)</span>
<span id="cb38-93"><a href="#cb38-93" aria-hidden="true" tabindex="-1"></a>      col_name_forecast <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"Y_forecast["</span>, i, <span class="st">","</span>, k, <span class="st">"]"</span>)</span>
<span id="cb38-94"><a href="#cb38-94" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb38-95"><a href="#cb38-95" aria-hidden="true" tabindex="-1"></a>      forecast_mean[i, k] <span class="ot">&lt;-</span> <span class="fu">median</span>(forecast_mean_draws[, col_name_mean])</span>
<span id="cb38-96"><a href="#cb38-96" aria-hidden="true" tabindex="-1"></a>      forecast_lower[i, k] <span class="ot">&lt;-</span> <span class="fu">quantile</span>(forecast_draws[, col_name_forecast], <span class="at">probs =</span> <span class="fl">0.05</span>)</span>
<span id="cb38-97"><a href="#cb38-97" aria-hidden="true" tabindex="-1"></a>      forecast_upper[i, k] <span class="ot">&lt;-</span> <span class="fu">quantile</span>(forecast_draws[, col_name_forecast], <span class="at">probs =</span> <span class="fl">0.95</span>)</span>
<span id="cb38-98"><a href="#cb38-98" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb38-99"><a href="#cb38-99" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb38-100"><a href="#cb38-100" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-101"><a href="#cb38-101" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Back-transform from standardized scale</span></span>
<span id="cb38-102"><a href="#cb38-102" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K) {</span>
<span id="cb38-103"><a href="#cb38-103" aria-hidden="true" tabindex="-1"></a>    forecast_mean[, k] <span class="ot">&lt;-</span> forecast_mean[, k] <span class="sc">*</span> data_list<span class="sc">$</span>Y_sd[k] <span class="sc">+</span> data_list<span class="sc">$</span>Y_mean[k]</span>
<span id="cb38-104"><a href="#cb38-104" aria-hidden="true" tabindex="-1"></a>    forecast_lower[, k] <span class="ot">&lt;-</span> forecast_lower[, k] <span class="sc">*</span> data_list<span class="sc">$</span>Y_sd[k] <span class="sc">+</span> data_list<span class="sc">$</span>Y_mean[k]</span>
<span id="cb38-105"><a href="#cb38-105" aria-hidden="true" tabindex="-1"></a>    forecast_upper[, k] <span class="ot">&lt;-</span> forecast_upper[, k] <span class="sc">*</span> data_list<span class="sc">$</span>Y_sd[k] <span class="sc">+</span> data_list<span class="sc">$</span>Y_mean[k]</span>
<span id="cb38-106"><a href="#cb38-106" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb38-107"><a href="#cb38-107" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-108"><a href="#cb38-108" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create forecast dates</span></span>
<span id="cb38-109"><a href="#cb38-109" aria-hidden="true" tabindex="-1"></a>  last_date <span class="ot">&lt;-</span> <span class="fu">max</span>(data_list<span class="sc">$</span>dates)</span>
<span id="cb38-110"><a href="#cb38-110" aria-hidden="true" tabindex="-1"></a>  forecast_dates <span class="ot">&lt;-</span> last_date <span class="sc">+</span> <span class="fu">years</span>(<span class="dv">1</span><span class="sc">:</span>h)</span>
<span id="cb38-111"><a href="#cb38-111" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-112"><a href="#cb38-112" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Create output data frame</span></span>
<span id="cb38-113"><a href="#cb38-113" aria-hidden="true" tabindex="-1"></a>  forecasts <span class="ot">&lt;-</span> <span class="fu">tibble</span>(</span>
<span id="cb38-114"><a href="#cb38-114" aria-hidden="true" tabindex="-1"></a>    <span class="at">date =</span> <span class="fu">rep</span>(forecast_dates, K),</span>
<span id="cb38-115"><a href="#cb38-115" aria-hidden="true" tabindex="-1"></a>    <span class="at">variable =</span> <span class="fu">rep</span>(<span class="fu">c</span>(<span class="st">"CPILFESL"</span>, <span class="st">"GDPDEF"</span>, <span class="st">"GDPGROWTH"</span>), <span class="at">each =</span> h),</span>
<span id="cb38-116"><a href="#cb38-116" aria-hidden="true" tabindex="-1"></a>    <span class="at">forecast =</span> <span class="fu">as.vector</span>(forecast_mean),</span>
<span id="cb38-117"><a href="#cb38-117" aria-hidden="true" tabindex="-1"></a>    <span class="at">lower_90 =</span> <span class="fu">as.vector</span>(forecast_lower),</span>
<span id="cb38-118"><a href="#cb38-118" aria-hidden="true" tabindex="-1"></a>    <span class="at">upper_90 =</span> <span class="fu">as.vector</span>(forecast_upper)</span>
<span id="cb38-119"><a href="#cb38-119" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb38-120"><a href="#cb38-120" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-121"><a href="#cb38-121" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(forecasts)</span>
<span id="cb38-122"><a href="#cb38-122" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb38-123"><a href="#cb38-123" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-124"><a href="#cb38-124" aria-hidden="true" tabindex="-1"></a>stan_diagnostics <span class="ot">&lt;-</span> <span class="cf">function</span>(fit, data_list) {</span>
<span id="cb38-125"><a href="#cb38-125" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get dimensions</span></span>
<span id="cb38-126"><a href="#cb38-126" aria-hidden="true" tabindex="-1"></a>  T_eff <span class="ot">&lt;-</span> data_list<span class="sc">$</span>stan_data<span class="sc">$</span>T <span class="sc">-</span> data_list<span class="sc">$</span>stan_data<span class="sc">$</span>p</span>
<span id="cb38-127"><a href="#cb38-127" aria-hidden="true" tabindex="-1"></a>  K <span class="ot">&lt;-</span> data_list<span class="sc">$</span>stan_data<span class="sc">$</span>K</span>
<span id="cb38-128"><a href="#cb38-128" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-129"><a href="#cb38-129" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Extract fitted values - loop through each element</span></span>
<span id="cb38-130"><a href="#cb38-130" aria-hidden="true" tabindex="-1"></a>  fitted_matrix <span class="ot">&lt;-</span> <span class="fu">matrix</span>(<span class="cn">NA</span>, <span class="at">nrow =</span> T_eff, <span class="at">ncol =</span> K)</span>
<span id="cb38-131"><a href="#cb38-131" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-132"><a href="#cb38-132" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (t <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>T_eff) {</span>
<span id="cb38-133"><a href="#cb38-133" aria-hidden="true" tabindex="-1"></a>    <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K) {</span>
<span id="cb38-134"><a href="#cb38-134" aria-hidden="true" tabindex="-1"></a>      <span class="co"># Column name pattern: fitted[time,variable]</span></span>
<span id="cb38-135"><a href="#cb38-135" aria-hidden="true" tabindex="-1"></a>      col_name <span class="ot">&lt;-</span> <span class="fu">paste0</span>(<span class="st">"fitted["</span>, t, <span class="st">","</span>, k, <span class="st">"]"</span>)</span>
<span id="cb38-136"><a href="#cb38-136" aria-hidden="true" tabindex="-1"></a>      fitted_draws <span class="ot">&lt;-</span> fit<span class="sc">$</span><span class="fu">draws</span>(<span class="at">variables =</span> col_name, <span class="at">format =</span> <span class="st">"matrix"</span>)</span>
<span id="cb38-137"><a href="#cb38-137" aria-hidden="true" tabindex="-1"></a>      fitted_matrix[t, k] <span class="ot">&lt;-</span> <span class="fu">median</span>(fitted_draws[, col_name])</span>
<span id="cb38-138"><a href="#cb38-138" aria-hidden="true" tabindex="-1"></a>    }</span>
<span id="cb38-139"><a href="#cb38-139" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb38-140"><a href="#cb38-140" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-141"><a href="#cb38-141" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Back-transform from standardized scale</span></span>
<span id="cb38-142"><a href="#cb38-142" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K) {</span>
<span id="cb38-143"><a href="#cb38-143" aria-hidden="true" tabindex="-1"></a>    fitted_matrix[, k] <span class="ot">&lt;-</span> fitted_matrix[, k] <span class="sc">*</span> data_list<span class="sc">$</span>Y_sd[k] <span class="sc">+</span> data_list<span class="sc">$</span>Y_mean[k]</span>
<span id="cb38-144"><a href="#cb38-144" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb38-145"><a href="#cb38-145" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-146"><a href="#cb38-146" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Get actual values (after removing lags)</span></span>
<span id="cb38-147"><a href="#cb38-147" aria-hidden="true" tabindex="-1"></a>  p <span class="ot">&lt;-</span> data_list<span class="sc">$</span>stan_data<span class="sc">$</span>p</span>
<span id="cb38-148"><a href="#cb38-148" aria-hidden="true" tabindex="-1"></a>  Y_actual <span class="ot">&lt;-</span> data_list<span class="sc">$</span>Y_original[(p<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span><span class="fu">nrow</span>(data_list<span class="sc">$</span>Y_original), ]</span>
<span id="cb38-149"><a href="#cb38-149" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-150"><a href="#cb38-150" aria-hidden="true" tabindex="-1"></a>  <span class="co"># Compute RMSFE and MAE for each variable</span></span>
<span id="cb38-151"><a href="#cb38-151" aria-hidden="true" tabindex="-1"></a>  metrics <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(</span>
<span id="cb38-152"><a href="#cb38-152" aria-hidden="true" tabindex="-1"></a>    <span class="at">variable =</span> <span class="fu">c</span>(<span class="st">"CPILFESL"</span>, <span class="st">"GDPDEF"</span>, <span class="st">"GDPGROWTH"</span>),</span>
<span id="cb38-153"><a href="#cb38-153" aria-hidden="true" tabindex="-1"></a>    <span class="at">RMSFE =</span> <span class="fu">numeric</span>(<span class="dv">3</span>),</span>
<span id="cb38-154"><a href="#cb38-154" aria-hidden="true" tabindex="-1"></a>    <span class="at">MAE =</span> <span class="fu">numeric</span>(<span class="dv">3</span>)</span>
<span id="cb38-155"><a href="#cb38-155" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb38-156"><a href="#cb38-156" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-157"><a href="#cb38-157" aria-hidden="true" tabindex="-1"></a>  <span class="cf">for</span> (k <span class="cf">in</span> <span class="dv">1</span><span class="sc">:</span>K) {</span>
<span id="cb38-158"><a href="#cb38-158" aria-hidden="true" tabindex="-1"></a>    residuals <span class="ot">&lt;-</span> Y_actual[, k] <span class="sc">-</span> fitted_matrix[, k]</span>
<span id="cb38-159"><a href="#cb38-159" aria-hidden="true" tabindex="-1"></a>    metrics<span class="sc">$</span>RMSFE[k] <span class="ot">&lt;-</span> <span class="fu">sqrt</span>(<span class="fu">mean</span>(residuals<span class="sc">^</span><span class="dv">2</span>))</span>
<span id="cb38-160"><a href="#cb38-160" aria-hidden="true" tabindex="-1"></a>    metrics<span class="sc">$</span>MAE[k] <span class="ot">&lt;-</span> <span class="fu">mean</span>(<span class="fu">abs</span>(residuals))</span>
<span id="cb38-161"><a href="#cb38-161" aria-hidden="true" tabindex="-1"></a>  }</span>
<span id="cb38-162"><a href="#cb38-162" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb38-163"><a href="#cb38-163" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(metrics)</span>
<span id="cb38-164"><a href="#cb38-164" aria-hidden="true" tabindex="-1"></a>}</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a>data_list <span class="ot">&lt;-</span> <span class="fu">prepare_stan_data</span>(</span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>    cpilfesl_mm_subset,</span>
<span id="cb39-3"><a href="#cb39-3" aria-hidden="true" tabindex="-1"></a>    gdpdef_mm_subset,</span>
<span id="cb39-4"><a href="#cb39-4" aria-hidden="true" tabindex="-1"></a>    gdpc1_yy_subset,</span>
<span id="cb39-5"><a href="#cb39-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">p =</span> <span class="dv">4</span>,      <span class="co"># Number of lags</span></span>
<span id="cb39-6"><a href="#cb39-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">h =</span> <span class="dv">12</span>,     <span class="co"># Forecast horizon</span></span>
<span id="cb39-7"><a href="#cb39-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">lambda =</span> <span class="fl">0.2</span>,  <span class="co"># Minnesota-Litterman prior tightness</span></span>
<span id="cb39-8"><a href="#cb39-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">tau =</span> <span class="fl">0.5</span>      <span class="co"># Relative tightness for other variables</span></span>
<span id="cb39-9"><a href="#cb39-9" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb39-10"><a href="#cb39-10" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb39-11"><a href="#cb39-11" aria-hidden="true" tabindex="-1"></a>bayesian_fit <span class="ot">&lt;-</span> <span class="fu">fit_bayesian_var</span>(data_list)</span>
<span id="cb39-12"><a href="#cb39-12" aria-hidden="true" tabindex="-1"></a> </span>
<span id="cb39-13"><a href="#cb39-13" aria-hidden="true" tabindex="-1"></a>bayesian_fit<span class="sc">$</span><span class="fu">diagnostic_summary</span>()</span>
<span id="cb39-14"><a href="#cb39-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-15"><a href="#cb39-15" aria-hidden="true" tabindex="-1"></a>bayesian_forecasts <span class="ot">&lt;-</span> <span class="fu">extract_forecasts</span>(bayesian_fit, data_list)</span>
<span id="cb39-16"><a href="#cb39-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-17"><a href="#cb39-17" aria-hidden="true" tabindex="-1"></a>bayesian_forecasts <span class="ot">&lt;-</span> bayesian_forecasts <span class="sc">%&gt;%</span></span>
<span id="cb39-18"><a href="#cb39-18" aria-hidden="true" tabindex="-1"></a>  <span class="fu">inner_join</span>(</span>
<span id="cb39-19"><a href="#cb39-19" aria-hidden="true" tabindex="-1"></a>    inflation <span class="sc">%&gt;%</span></span>
<span id="cb39-20"><a href="#cb39-20" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(series <span class="sc">%in%</span> <span class="fu">c</span>(<span class="st">"CPILFESL"</span>, <span class="st">"GDPDEF"</span>)) <span class="sc">%&gt;%</span></span>
<span id="cb39-21"><a href="#cb39-21" aria-hidden="true" tabindex="-1"></a>      <span class="fu">filter</span>(<span class="fu">year</span>(date) <span class="sc">&gt;</span> <span class="fu">max</span>(<span class="fu">year</span>(date) <span class="sc">-</span> h)) <span class="sc">%&gt;%</span></span>
<span id="cb39-22"><a href="#cb39-22" aria-hidden="true" tabindex="-1"></a>      <span class="fu">select</span>(date, <span class="at">observed =</span> value, <span class="at">variable =</span> series) <span class="sc">%&gt;%</span></span>
<span id="cb39-23"><a href="#cb39-23" aria-hidden="true" tabindex="-1"></a>      <span class="fu">bind_rows</span>(</span>
<span id="cb39-24"><a href="#cb39-24" aria-hidden="true" tabindex="-1"></a>        gdpc1_yy <span class="sc">%&gt;%</span></span>
<span id="cb39-25"><a href="#cb39-25" aria-hidden="true" tabindex="-1"></a>          <span class="fu">filter</span>(<span class="fu">year</span>(date) <span class="sc">&gt;</span> <span class="fu">max</span>(<span class="fu">year</span>(date) <span class="sc">-</span> h)) <span class="sc">%&gt;%</span></span>
<span id="cb39-26"><a href="#cb39-26" aria-hidden="true" tabindex="-1"></a>          <span class="fu">select</span>(date, <span class="at">observed =</span> gdpgrowth) <span class="sc">%&gt;%</span></span>
<span id="cb39-27"><a href="#cb39-27" aria-hidden="true" tabindex="-1"></a>          <span class="fu">mutate</span>(<span class="at">variable =</span> <span class="st">"GDPGROWTH"</span>)</span>
<span id="cb39-28"><a href="#cb39-28" aria-hidden="true" tabindex="-1"></a>      ) <span class="sc">%&gt;%</span></span>
<span id="cb39-29"><a href="#cb39-29" aria-hidden="true" tabindex="-1"></a>      <span class="fu">arrange</span>(date, variable),</span>
<span id="cb39-30"><a href="#cb39-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">by =</span> <span class="fu">c</span>(<span class="st">"date"</span>, <span class="st">"variable"</span>)</span>
<span id="cb39-31"><a href="#cb39-31" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb39-32"><a href="#cb39-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-33"><a href="#cb39-33" aria-hidden="true" tabindex="-1"></a>stan_model_metrics <span class="ot">&lt;-</span> <span class="fu">stan_diagnostics</span>(bayesian_fit, data_list)</span>
<span id="cb39-34"><a href="#cb39-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb39-35"><a href="#cb39-35" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(bayesian_forecasts, <span class="st">"data/bayesian_forecasts.rds"</span>)</span>
<span id="cb39-36"><a href="#cb39-36" aria-hidden="true" tabindex="-1"></a><span class="fu">saveRDS</span>(stan_model_metrics, <span class="st">"data/stan_model_metrics.rds"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="cf">if</span> (<span class="sc">!</span>run_models) {</span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  bayesian_forecasts <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/bayesian_forecasts.rds"</span>)</span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  stan_model_metrics <span class="ot">&lt;-</span> <span class="fu">readRDS</span>(<span class="st">"data/stan_model_metrics.rds"</span>)</span>
<span id="cb40-4"><a href="#cb40-4" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb40-5"><a href="#cb40-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" aria-hidden="true" tabindex="-1"></a>clrs <span class="ot">&lt;-</span> <span class="fu">tintin_pal</span>()(<span class="dv">2</span>)</span>
<span id="cb40-7"><a href="#cb40-7" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb40-8"><a href="#cb40-8" aria-hidden="true" tabindex="-1"></a><span class="fu">ggplot</span>(bayesian_forecasts, <span class="fu">aes</span>(<span class="at">x =</span> date)) <span class="sc">+</span></span>
<span id="cb40-9"><a href="#cb40-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_ribbon</span>(<span class="fu">aes</span>(<span class="at">ymin =</span> lower_90, <span class="at">ymax =</span> upper_90), </span>
<span id="cb40-10"><a href="#cb40-10" aria-hidden="true" tabindex="-1"></a>              <span class="at">alpha =</span> <span class="fl">0.15</span>, <span class="at">fill =</span> clrs[<span class="dv">2</span>]) <span class="sc">+</span></span>
<span id="cb40-11"><a href="#cb40-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> forecast), <span class="at">color =</span> clrs[<span class="dv">2</span>], <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb40-12"><a href="#cb40-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>(<span class="fu">aes</span>(<span class="at">y =</span> observed), <span class="at">color =</span> clrs[<span class="dv">1</span>], <span class="at">linewidth =</span> <span class="dv">1</span>) <span class="sc">+</span></span>
<span id="cb40-13"><a href="#cb40-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>variable, <span class="at">ncol =</span> <span class="dv">1</span>, <span class="at">scales =</span> <span class="st">"free_y"</span>) <span class="sc">+</span></span>
<span id="cb40-14"><a href="#cb40-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Bayesian VAR Forecasts (90% Credible Intervals)"</span>,</span>
<span id="cb40-15"><a href="#cb40-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">subtitle =</span> <span class="st">"Red = observed; Blue = forecast"</span>,</span>
<span id="cb40-16"><a href="#cb40-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">x =</span> <span class="st">"Date"</span>, <span class="at">y =</span> <span class="st">"Value (%)"</span>) <span class="sc">+</span></span>
<span id="cb40-17"><a href="#cb40-17" aria-hidden="true" tabindex="-1"></a>    <span class="fu">theme_minimal</span>(<span class="at">base_size =</span> <span class="dv">10</span>) <span class="sc">+</span></span>
<span id="cb40-18"><a href="#cb40-18" aria-hidden="true" tabindex="-1"></a>    <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">0</span>, <span class="at">color =</span> <span class="st">"red"</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">alpha =</span> <span class="fl">0.5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="index_files/figure-html/bonus3-1.png" class="img-fluid figure-img" width="576"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="model-comparison" class="level1">
<h1>Model Comparison</h1>
<section id="forecast-evaluation" class="level2">
<h2 class="anchored" data-anchor-id="forecast-evaluation">Forecast Evaluation</h2>
<p>The accuracy of the forecasts was evaluated using two standard metrics: the Root Mean Squared Forecast Error (RMSFE) and the Mean Absolute Error (MAE). These measures were computed for both in-sample and out-of-sample periods to assess how well each model predicted inflation and GDP growth. The results show that the Factor-Augmented VAR (FA-VAR) consistently achieves lower forecast errors than the basic VAR, indicating that including latent factors extracted from broader information sets enhances predictive performance. The Dynamic Factor Model (DFM) provides an excellent in-sample fit, effectively capturing the common underlying trends across inflation indicators, but its out-of-sample performance weakens slightly due to slower adjustment to abrupt changes. In contrast, the Bayesian VAR delivers the most stable and reliable forecasts overall, with smaller RMSFE and MAE values across both inflation and growth series. This superior performance reflects the Bayesian model’s ability to incorporate prior information and mitigate overfitting, resulting in smoother forecasts and more realistic uncertainty quantification. Overall, the evaluation confirms that models combining richer informational content or Bayesian regularization produce more accurate and policy-relevant forecasts for the Federal Reserve.</p>
</section>
<section id="evaluation-of-the-models" class="level2">
<h2 class="anchored" data-anchor-id="evaluation-of-the-models">Evaluation of the Models</h2>
<p>The forecast comparison highlights that models incorporating richer information and prior structure provide more reliable guidance for monetary policy than a simple VAR. While the standard VAR captures short-term dynamics in inflation and output, it performs poorly during periods of structural change such as the COVID-19 shock. The Factor-Augmented VAR (FA-VAR) improves predictive accuracy by summarizing broader macroeconomic signals through latent factors, offering smoother and more stable forecasts for core inflation. The Dynamic Factor Model (DFM) effectively identifies common cyclical components across indicators but tends to lag during abrupt regime shifts. In contrast, the Bayesian VAR demonstrates the most robust and policy-relevant performance: it mitigates overfitting, stabilizes forecasts in volatile periods, and provides credible intervals that quantify uncertainty, an essential feature for risk-based decision-making. Overall, the Bayesian VAR emerges as the preferred tool for the Federal Reserve’s forecasting system, as it balances statistical precision with interpretability and supports transparent, data-driven communication of inflation and growth risks.</p>
</section>
</section>
<section id="c-codes" class="level1">
<h1>C++ codes</h1>
<section id="model-metrics" class="level2">
<h2 class="anchored" data-anchor-id="model-metrics">Model metrics</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">readLines</span>(<span class="st">"../ecod025ps1/src/00-model-metrics.h"</span>), <span class="at">sep =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>/* Root Mean Squared Forecast Error (RMSFE) */

double rmsfe(const Mat&lt;double&gt;&amp; actual, const Mat&lt;double&gt;&amp; forecast) {
  Mat&lt;double&gt; errors = actual - forecast;
  Mat&lt;double&gt; squared_errors = square(errors);
  
  double mse = accu(squared_errors) / squared_errors.n_elem;
  
  return sqrt(mse);
}

/* Mean Absolute Error (MAE) */

double mae(const Mat&lt;double&gt;&amp; actual, const Mat&lt;double&gt;&amp; forecast) {  
  Mat&lt;double&gt; errors = abs(actual - forecast);
  return accu(errors) / errors.n_elem;
}

/* Akaike Information Criterion (AIC) */

double aic_metric(const Mat&lt;double&gt;&amp; residuals, int n_params) {
  int T = residuals.n_rows;
  
  // Sum of squared residuals
  double ssr = accu(square(residuals));
  
  // AIC = log(SSR/T) + (p+1) * 2/T
  // For multivariate models, use total SSR across all equations
  double aic = log(ssr / T) + n_params * 2.0 / T;
  
  return aic;
}</code></pre>
</div>
</div>
</section>
<section id="var-model" class="level2">
<h2 class="anchored" data-anchor-id="var-model">VAR model</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb43"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">readLines</span>(<span class="st">"../ecod025ps1/src/01-var.h"</span>), <span class="at">sep =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>/* Vector Autoregressions (VAR) */

// Create lagged matrix for VAR model
Mat&lt;double&gt; create_lags_(const Mat&lt;double&gt;&amp; Y, int p) {
  int T = Y.n_rows;
  int K = Y.n_cols;
  
  // Effective sample size after lagging
  int T_eff = T - p;
  
  // Create lagged matrix: [Y_{t-1}, Y_{t-2}, ..., Y_{t-p}]
  Mat&lt;double&gt; X_lag(T_eff, K * p);
  
  for (int lag = 1; lag &lt;= p; ++lag) {
    for (int t = 0; t &lt; T_eff; ++t) {
      X_lag.submat(t, (lag-1)*K, t, lag*K-1) = Y.row(t + p - lag);
    }
  }
  
  return X_lag;
}

// Estimate VAR model using equation-by-equation OLS
Mat&lt;double&gt; var_estimate_(const doubles_matrix&lt;&gt;&amp; y, int p, bool include_const = true) {
  Mat&lt;double&gt; Y = as_Mat(y);
  int T = Y.n_rows;
  
  if (T &lt;= p) {
    throw std::runtime_error("Sample size must be greater than lag order p");
  }
  
  // Create lagged regressors
  Mat&lt;double&gt; Y_lag = create_lags_(Y, p);
  
  // Dependent variable (after losing p observations)
  Mat&lt;double&gt; Y_dep = Y.rows(p, T-1);
  
  // Add constant if requested
  Mat&lt;double&gt; X;
  if (include_const) {
    Mat&lt;double&gt; ones(Y_lag.n_rows, 1, fill::ones);
    X = join_horiz(ones, Y_lag);
  } else {
    X = Y_lag;
  }
  
  // Estimate VAR coefficients: A = (X'X)^(-1)(X'Y)
  Mat&lt;double&gt; XtX = X.t() * X;
  
  // Add small regularization for numerical stability
  XtX += eye&lt;Mat&lt;double&gt;&gt;(XtX.n_rows, XtX.n_cols) * 1e-8;
  
  Mat&lt;double&gt; A;
  bool solve_ok = solve(A, XtX, X.t() * Y_dep);
  
  if (!solve_ok) {
    // Fallback to explicit inversion if solve fails
    Mat&lt;double&gt; XtX_inv = inv(XtX);
    A = XtX_inv * X.t() * Y_dep;
  }
  
  return A;
}

// Compute VAR residuals and fitted values
std::pair&lt;Mat&lt;double&gt;, Mat&lt;double&gt;&gt; var_fitted_resid_(const Mat&lt;double&gt;&amp; Y, const Mat&lt;double&gt;&amp; A, 
                                                      int p, bool include_const = true) {
  int T = Y.n_rows;
  
  // Create lagged regressors
  Mat&lt;double&gt; Y_lag = create_lags_(Y, p);
  
  // Dependent variable (after losing p observations)
  Mat&lt;double&gt; Y_dep = Y.rows(p, T-1);
  
  // Add constant if requested
  Mat&lt;double&gt; X;
  if (include_const) {
    Mat&lt;double&gt; ones(Y_lag.n_rows, 1, fill::ones);
    X = join_horiz(ones, Y_lag);
  } else {
    X = Y_lag;
  }
  
  // Compute fitted values and residuals
  Mat&lt;double&gt; Y_fitted = X * A;
  Mat&lt;double&gt; residuals = Y_dep - Y_fitted;
  
  return std::make_pair(Y_fitted, residuals);
}

// Create VAR companion matrix for analysis and forecasting
Mat&lt;double&gt; var_companion_(const Mat&lt;double&gt;&amp; A, int p, int K, bool include_const = true) {
  // Extract coefficient matrices (exclude constant if present)
  Mat&lt;double&gt; A_coeff;
  if (include_const) {
    A_coeff = A.rows(1, A.n_rows-1);  // Skip first row (constants)
  } else {
    A_coeff = A;
  }
  
  // Create companion matrix
  Mat&lt;double&gt; F(K*p, K*p, fill::zeros);
  
  // Fill first K rows with coefficient matrices A1, A2, ..., Ap
  F.submat(0, 0, K-1, K*p-1) = A_coeff.t();
  
  // Fill identity blocks for lagged terms
  if (p &gt; 1) {
    Mat&lt;double&gt; I_K = eye&lt;Mat&lt;double&gt;&gt;(K, K);
    for (int i = 1; i &lt; p; ++i) {
      F.submat(i*K, (i-1)*K, (i+1)*K-1, i*K-1) = I_K;
    }
  }
  
  return F;
}

// VAR forecasting function
Mat&lt;double&gt; var_forecast_(const Mat&lt;double&gt;&amp; Y, const Mat&lt;double&gt;&amp; A, 
                         int p, int h, bool include_const = true) {
  int T = Y.n_rows;
  int K = Y.n_cols;
  
  if (T &lt; p) {
    throw std::runtime_error("Insufficient observations for VAR forecasting");
  }
  
  if (h &lt;= 0) {
    throw std::runtime_error("Forecast horizon must be positive");
  }
  
  // Get last p observations for initialization
  Mat&lt;double&gt; Y_init = Y.rows(T-p, T-1);
  
  // Initialize forecast container
  Mat&lt;double&gt; forecasts(h, K);
  
  // Current state vector (flatten last p observations)
  Mat&lt;double&gt; y_current = vectorise(Y_init.t()).t();  // Reshape to row vector
  
  // Extract coefficients
  Mat&lt;double&gt; const_term;
  Mat&lt;double&gt; A_coeff;
  
  if (include_const) {
    const_term = A.row(0);
    A_coeff = A.rows(1, A.n_rows-1);
  } else {
    const_term = zeros&lt;Mat&lt;double&gt;&gt;(1, K);
    A_coeff = A;
  }
  
  // Create lagged design matrix for current state
  Mat&lt;double&gt; X_lag = y_current;
  
  // Forecast h periods ahead
  for (int i = 0; i &lt; h; ++i) {
    // Forecast: y_{T+i+1} = c + A1*y_{T+i} + ... + Ap*y_{T+i-p+1}
    Mat&lt;double&gt; y_forecast = const_term + X_lag * A_coeff;
    forecasts.row(i) = y_forecast;
    
    // Update lagged matrix for next forecast
    if (i &lt; h-1 &amp;&amp; p &gt; 1) {
      Mat&lt;double&gt; new_X_lag = join_horiz(y_forecast, X_lag.cols(0, K*(p-1)-1));
      X_lag = new_X_lag;
    } else if (p == 1) {
      X_lag = y_forecast;
    }
  }
  
  return forecasts;
}
/* roxygen
@title Main VAR estimation function that returns everything
@description Estimates a VAR model using OLS.
@param y Time series vector (T x 1)
@param p Lag order
@param include_const Include constant term in VAR
@param forecast_h Forecast horizon (0 for no forecast)
@export
*/
[[cpp4r::register]] list var_model(const doubles_matrix&lt;&gt;&amp; y, int p, 
                                   bool include_const = true, int forecast_h = 0) {
  Mat&lt;double&gt; Y = as_Mat(y);
  int T = Y.n_rows;
  int K = Y.n_cols;
  
  if (T &lt;= p) {
    throw std::runtime_error("Sample size must be greater than lag order p");
  }
  
  // Estimate VAR coefficients
  Mat&lt;double&gt; A = var_estimate_(y, p, include_const);
  
  // Compute fitted values and residuals
  auto fitted_resid = var_fitted_resid_(Y, A, p, include_const);
  Mat&lt;double&gt; Y_fitted = fitted_resid.first;
  Mat&lt;double&gt; residuals = fitted_resid.second;
  
  // Compute residual covariance matrix
  Mat&lt;double&gt; Sigma = (residuals.t() * residuals) / (residuals.n_rows - A.n_rows);
  
  // Create companion matrix
  Mat&lt;double&gt; F = var_companion_(A, p, K, include_const);
  
  // Compute AIC
  int n_params = A.n_rows * K;  // Total number of parameters
  double aic = aic_metric(residuals, n_params);
  
  // Prepare results list
  writable::list result;

  result.push_back({"coefficients"_nm = as_doubles_matrix(A)});
  result.push_back({"fitted_values"_nm = as_doubles_matrix(Y_fitted)});
  result.push_back({"residuals"_nm = as_doubles_matrix(residuals)});
  result.push_back({"sigma"_nm = as_doubles_matrix(Sigma)});
  result.push_back({"companion_matrix"_nm = as_doubles_matrix(F)});

  result.push_back({"lag_order"_nm = cpp4r::as_sexp(p)});
  result.push_back({"n_variables"_nm = cpp4r::as_sexp(K)});
  result.push_back({"n_obs"_nm = cpp4r::as_sexp(T - p)});  // Effective sample size
  result.push_back({"include_const"_nm = cpp4r::as_sexp(include_const)});
  result.push_back({"rmsfe"_nm = cpp4r::as_sexp(rmsfe(Y.rows(p, T-1), Y_fitted))});
  
  result.push_back({"mae"_nm = cpp4r::as_sexp(mae(Y.rows(p, T-1), Y_fitted))});
  result.push_back({"aic"_nm = cpp4r::as_sexp(aic)});
  
  // Add forecasts if requested
  if (forecast_h &gt; 0) {
    Mat&lt;double&gt; forecasts = var_forecast_(Y, A, p, forecast_h, include_const);
    result.push_back({"forecasts"_nm = as_doubles_matrix(forecasts)});
    result.push_back({"forecast_horizon"_nm = cpp4r::as_sexp(forecast_h)});
  }  
  
  return result;
}</code></pre>
</div>
</div>
</section>
<section id="fa-var-model" class="level2">
<h2 class="anchored" data-anchor-id="fa-var-model">FA-VAR model</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb45"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">readLines</span>(<span class="st">"../ecod025ps1/src/02-favar.h"</span>), <span class="at">sep =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>// Factor-Augmented VAR (FA-VAR)

// Extract factors using PCA from time series data
std::pair&lt;Mat&lt;double&gt;, Mat&lt;double&gt;&gt; favar_extract_factors_(const Mat&lt;double&gt;&amp; X, int n_factors) {  
  // Center the data
  Mat&lt;double&gt; X_centered = X.each_row() - mean(X, 0);
  
  // Perform SVD on X' (N x T matrix)
  Mat&lt;double&gt; U, V;
  vec s;
  bool svd_ok = svd_econ(U, s, V, X_centered.t());
  
  if (!svd_ok) {
    throw std::runtime_error("SVD decomposition failed in factor extraction");
  }
  
  // Factor loadings (first n_factors principal components)
  Mat&lt;double&gt; Lambda = U.cols(0, n_factors-1);
  
  // Common factors (T x n_factors)
  Mat&lt;double&gt; F = X_centered * Lambda;
  
  // Normalize factors to have unit variance for numerical stability
  rowvec F_var = var(F, 0, 0);
  for (int j = 0; j &lt; n_factors; ++j) {
    double var_j = F_var(j);
    if (var_j &gt; 1e-10) {
      double sd_j = sqrt(var_j);
      F.col(j) /= sd_j;
      Lambda.col(j) *= sd_j;
    }
  }
  
  return std::make_pair(F, Lambda);
}

// Estimate factor VAR: F_t = Phi_1*F_{t-1} + ... + Phi_p*F_{t-p} + v_t
Mat&lt;double&gt; favar_factor_var_(const Mat&lt;double&gt;&amp; F, int p, bool include_const = false) {
  int T = F.n_rows;

  if (p == 0 || T &lt;= p) {
    throw std::runtime_error("Invalid lag order for factor VAR");
  }
  
  // Use existing VAR estimation function
  Mat&lt;double&gt; Phi = var_estimate_(as_doubles_matrix(F), p, include_const);
  
  return Phi;
}

// Estimate augmented VAR: y_t = B(L)*y_{t-1} + C(L)*F_{t-1} + u_t
// Uses only LAGGED factors to avoid data leakage
std::pair&lt;Mat&lt;double&gt;, Mat&lt;double&gt;&gt; favar_augmented_var_(
    const Mat&lt;double&gt;&amp; y, const Mat&lt;double&gt;&amp; F, int p_y, int p_f, bool include_const = false) {
  
  int T = y.n_rows;
  int K = y.n_cols;
  
  int max_p = std::max(p_y, p_f);
  
  if (T &lt;= max_p) {
    throw std::runtime_error("Sample size must be greater than lag order");
  }
  
  // Create lagged y variables
  Mat&lt;double&gt; y_lag;
  Mat&lt;double&gt; y_dep = y.rows(max_p, T - 1);
  
  if (p_y &gt; 0) {
    y_lag = create_lags_(y, p_y);
    // Align if needed
    if (p_y &lt; max_p) {
      y_lag = y_lag.rows(max_p - p_y, y_lag.n_rows - 1);
    }
  }
  
  // Create factor regressors: [F_{t-1}, ..., F_{t-p_f}] (only lagged factors)
  Mat&lt;double&gt; F_regressors;
  
  if (p_f &gt; 0) {
    Mat&lt;double&gt; F_lag = create_lags_(F, p_f);
    // Align if needed
    if (p_f &lt; max_p) {
      F_lag = F_lag.rows(max_p - p_f, F_lag.n_rows - 1);
    }
    F_regressors = F_lag;
  } else {
    throw std::runtime_error("p_f must be at least 1 for FAVAR");
  }
  
  // Combine regressors: [y_{t-1}, ..., y_{t-p_y}, F_{t-1}, ..., F_{t-p_f}]
  Mat&lt;double&gt; X;
  if (p_y &gt; 0) {
    X = join_horiz(y_lag, F_regressors);
  } else {
    X = F_regressors;
  }
  
  // Add constant if requested
  if (include_const) {
    Mat&lt;double&gt; ones(X.n_rows, 1, fill::ones);
    X = join_horiz(ones, X);
  }
  
  // Estimate coefficients: [B, C] = (X'X)^(-1)(X'y)
  Mat&lt;double&gt; XtX = X.t() * X;
  Mat&lt;double&gt; Xty = X.t() * y_dep;
  
  // Add small regularization for numerical stability
  XtX += eye&lt;Mat&lt;double&gt;&gt;(XtX.n_rows, XtX.n_cols) * 1e-8;
  
  Mat&lt;double&gt; beta;
  bool solve_ok = solve(beta, XtX, Xty);
  
  if (!solve_ok) {
    throw std::runtime_error("Failed to solve augmented VAR system");
  }
  
  // Extract factor coefficients C
  int start_idx = include_const ? 1 : 0;
  int factor_start = start_idx + (p_y &gt; 0 ? K * p_y : 0);
  Mat&lt;double&gt; C = beta.rows(factor_start, beta.n_rows - 1);
  
  return std::make_pair(beta, C);
}

// Compute FAVAR fitted values and residuals
std::pair&lt;Mat&lt;double&gt;, Mat&lt;double&gt;&gt; favar_fitted_resid_(
    const Mat&lt;double&gt;&amp; y, const Mat&lt;double&gt;&amp; F, const Mat&lt;double&gt;&amp; beta,
    int p_y, int p_f, bool include_const = false) {
  
  int T = y.n_rows;
  int max_p = std::max(p_y, p_f);
  
  // Reconstruct regressor matrix
  Mat&lt;double&gt; y_dep = y.rows(max_p, T - 1);
  Mat&lt;double&gt; X;
  
  if (p_y &gt; 0) {
    Mat&lt;double&gt; y_lag = create_lags_(y, p_y);
    if (p_y &lt; max_p) {
      y_lag = y_lag.rows(max_p - p_y, y_lag.n_rows - 1);
    }
    
    Mat&lt;double&gt; F_regressors;
    
    if (p_f &gt; 0) {
      Mat&lt;double&gt; F_lag = create_lags_(F, p_f);
      if (p_f &lt; max_p) {
        F_lag = F_lag.rows(max_p - p_f, F_lag.n_rows - 1);
      }
      F_regressors = F_lag;
    }
    
    X = join_horiz(y_lag, F_regressors);
  } else {
    Mat&lt;double&gt; F_regressors;
    
    if (p_f &gt; 0) {
      Mat&lt;double&gt; F_lag = create_lags_(F, p_f);
      if (p_f &lt; max_p) {
        F_lag = F_lag.rows(max_p - p_f, F_lag.n_rows - 1);
      }
      F_regressors = F_lag;
    }
    
    X = F_regressors;
  }
  
  if (include_const) {
    Mat&lt;double&gt; ones(X.n_rows, 1, fill::ones);
    X = join_horiz(ones, X);
  }
  
  // Compute fitted values and residuals
  Mat&lt;double&gt; y_fitted = X * beta;
  Mat&lt;double&gt; residuals = y_dep - y_fitted;
  
  return std::make_pair(y_fitted, residuals);
}

// FAVAR forecasting with lagged factors only
Mat&lt;double&gt; favar_forecast_(const Mat&lt;double&gt;&amp; y, const Mat&lt;double&gt;&amp; F,
                           const Mat&lt;double&gt;&amp; beta_y, const Mat&lt;double&gt;&amp; Phi_f,
                           int p_y, int p_f, int h, bool include_const = false) {
  
  int T = y.n_rows;
  int K = y.n_cols;
  int n_factors = F.n_cols;
  
  // Initialize forecasts
  Mat&lt;double&gt; y_forecast(h, K);
  Mat&lt;double&gt; F_forecast(h, n_factors);
  
  // Step 1: Forecast factors using factor VAR
  Mat&lt;double&gt; F_init = F.rows(T - p_f, T - 1);
  Mat&lt;double&gt; F_current = vectorise(F_init.t()).t();
  
  for (int i = 0; i &lt; h; ++i) {
    Mat&lt;double&gt; X_f;
    if (include_const) {
      Mat&lt;double&gt; ones(1, 1, fill::ones);
      X_f = join_horiz(ones, F_current);
    } else {
      X_f = F_current;
    }
    
    Mat&lt;double&gt; F_pred = X_f * Phi_f;
    F_forecast.row(i) = F_pred;
    
    // Update state for next iteration
    if (i &lt; h - 1 &amp;&amp; p_f &gt; 1) {
      F_current = join_horiz(F_pred, F_current.cols(0, n_factors * (p_f - 1) - 1));
    } else if (p_f == 1) {
      F_current = F_pred;
    }
  }
  
  // Step 2: Forecast y using forecasted factors (lagged factors only)
  Mat&lt;double&gt; y_init = y.rows(T - std::max(p_y, 1), T - 1);
  Mat&lt;double&gt; y_current = (p_y &gt; 0) ? vectorise(y_init.t()).t() : Mat&lt;double&gt;();
  
  // Extend F with forecasts for easier indexing
  Mat&lt;double&gt; F_extended = join_vert(F, F_forecast);
  
  for (int i = 0; i &lt; h; ++i) {
    Mat&lt;double&gt; X_y;
    
    // Add y lags if p_y &gt; 0
    if (p_y &gt; 0) {
      X_y = y_current;
    }
    
    // Add lagged factors: F_{T+i-1}, ..., F_{T+i-p_f} (no contemporaneous factor)
    Mat&lt;double&gt; F_current_forecast;
    if (p_f &gt; 0) {
      for (int lag = 1; lag &lt;= p_f; ++lag) {
        if (T + i - lag &gt;= 0) {
          Mat&lt;double&gt; F_lag_t = F_extended.row(T + i - lag);
          if (lag == 1) {
            F_current_forecast = F_lag_t;
          } else {
            F_current_forecast = join_horiz(F_current_forecast, F_lag_t);
          }
        }
      }
    }
    
    // Combine y lags and factors
    if (p_y &gt; 0) {
      X_y = join_horiz(X_y, F_current_forecast);
    } else {
      X_y = F_current_forecast;
    }
    
    // Add constant if needed
    if (include_const) {
      Mat&lt;double&gt; ones(1, 1, fill::ones);
      X_y = join_horiz(ones, X_y);
    }
    
    Mat&lt;double&gt; y_pred = X_y * beta_y;
    y_forecast.row(i) = y_pred;
    
    // Update y_current for next iteration
    if (p_y &gt; 1 &amp;&amp; i &lt; h - 1) {
      y_current = join_horiz(y_pred, y_current.cols(0, K * (p_y - 1) - 1));
    } else if (p_y == 1) {
      y_current = y_pred;
    }
  }
  
  return y_forecast;
}

/* roxygen
@title Factor-Augmented VAR (FA-VAR) Model
@description Estimates a FA-VAR model using PCA for factor extraction.
@param y Time series vector (T x 1)
@param n_lags Number of lags of y to include in X for factor extraction
@param n_factors Number of latent factors to extract (r &lt; n_lags + 1)
@param p_y VAR lag order for y dynamics
@param p_f VAR lag order for factor dynamics
@param include_const Include constant term in VARs
@param forecast_h Forecast horizon (0 for no forecast)
@export
*/
[[cpp4r::register]] list favar_model(const doubles_matrix&lt;&gt;&amp; y, int n_lags,
                                     int n_factors, int p_y = 1, int p_f = 1,
                                     bool include_const = false, int forecast_h = 0) {
  
  Mat&lt;double&gt; Y = as_Mat(y);
  int T = Y.n_rows;
  int K = Y.n_cols;
  
  if (K != 1) {
    throw std::runtime_error("FA-VAR requires univariate y (single column)");
  }
  
  if (T &lt;= n_lags + std::max(p_y, p_f)) {
    throw std::runtime_error("Insufficient observations for lags");
  }
  
  // Step 1: Create X matrix [y_t, y_{t-1}, ..., y_{t-n_lags}]
  Mat&lt;double&gt; X_lags = create_lags_(Y, n_lags);
  Mat&lt;double&gt; Y_contemp = Y.rows(n_lags, T - 1);
  Mat&lt;double&gt; X = join_horiz(Y_contemp, X_lags);
  
  int N = X.n_cols;  // n_lags + 1
  
  if (n_factors &gt;= N) {
    throw std::runtime_error("Number of factors must be less than number of variables in X");
  }
  
  // Step 2: Extract factors from X using PCA
  auto factor_result = favar_extract_factors_(X, n_factors);
  Mat&lt;double&gt; F = factor_result.first;
  Mat&lt;double&gt; Lambda = factor_result.second;
  
  // Step 3: Estimate factor VAR
  Mat&lt;double&gt; Phi = favar_factor_var_(F, p_f, include_const);
  
  // Step 4: Estimate augmented VAR (y on its lags + lagged factors only)
  // Need to align y with F (both start at observation n_lags)
  Mat&lt;double&gt; Y_aligned = Y.rows(n_lags, T - 1);
  
  auto var_result = favar_augmented_var_(Y_aligned, F, p_y, p_f, include_const);
  Mat&lt;double&gt; beta = var_result.first;
  Mat&lt;double&gt; C = var_result.second;
  
  // Step 5: Compute fitted values and residuals
  auto fitted_resid = favar_fitted_resid_(Y_aligned, F, beta, p_y, p_f, include_const);
  Mat&lt;double&gt; y_fitted = fitted_resid.first;
  Mat&lt;double&gt; residuals = fitted_resid.second;
  
  // Compute residual covariance
  Mat&lt;double&gt; Sigma = (residuals.t() * residuals) / (residuals.n_rows - beta.n_rows);
  
  // Compute factor residuals
  auto factor_fitted_resid = var_fitted_resid_(F, Phi, p_f, include_const);
  Mat&lt;double&gt; F_residuals = factor_fitted_resid.second;
  Mat&lt;double&gt; Omega = (F_residuals.t() * F_residuals) / (F_residuals.n_rows - Phi.n_rows);
  
  // Compute AIC
  int n_params = beta.n_rows * K;
  double aic = aic_metric(residuals, n_params);
  
  // Prepare results list
  writable::list result;
  
  result.push_back({"coefficients"_nm = as_doubles_matrix(beta)});
  result.push_back({"factor_coefficients"_nm = as_doubles_matrix(Phi)});
  result.push_back({"factor_loadings"_nm = as_doubles_matrix(Lambda)});
  result.push_back({"factors"_nm = as_doubles_matrix(F)});
  result.push_back({"fitted_values"_nm = as_doubles_matrix(y_fitted)});

  result.push_back({"residuals"_nm = as_doubles_matrix(residuals)});
  result.push_back({"factor_residuals"_nm = as_doubles_matrix(F_residuals)});
  result.push_back({"sigma"_nm = as_doubles_matrix(Sigma)});
  result.push_back({"omega"_nm = as_doubles_matrix(Omega)});
  result.push_back({"n_factors"_nm = cpp4r::as_sexp(n_factors)});

  result.push_back({"n_lags"_nm = cpp4r::as_sexp(n_lags)});
  result.push_back({"lag_order_y"_nm = cpp4r::as_sexp(p_y)});
  result.push_back({"lag_order_f"_nm = cpp4r::as_sexp(p_f)});
  result.push_back({"n_obs"_nm = cpp4r::as_sexp(y_fitted.n_rows)});
  result.push_back({"include_const"_nm = cpp4r::as_sexp(include_const)});

  // Compute RMSFE and MAE using helper functions
  // Need to align Y_aligned with fitted values (both start after max_p lags)
  int max_p = std::max(p_y, p_f);
  Mat&lt;double&gt; Y_actual = Y_aligned.rows(max_p, Y_aligned.n_rows - 1);
  
  // result.push_back({"observed_values"_nm = as_doubles_matrix(Y_actual)});
  result.push_back({"rmsfe"_nm = cpp4r::as_sexp(rmsfe(Y_actual, y_fitted))});
  result.push_back({"mae"_nm = cpp4r::as_sexp(mae(Y_actual, y_fitted))});
  result.push_back({"aic"_nm = cpp4r::as_sexp(aic)});
  
  // Add forecasts if requested
  if (forecast_h &gt; 0) {
    Mat&lt;double&gt; forecasts = favar_forecast_(Y_aligned, F, beta, Phi, p_y, p_f, forecast_h, include_const);
    result.push_back({"forecasts"_nm = as_doubles_matrix(forecasts)});
    result.push_back({"forecast_horizon"_nm = cpp4r::as_sexp(forecast_h)});
  }
  
  return result;
}</code></pre>
</div>
</div>
</section>
<section id="dfm-model" class="level2">
<h2 class="anchored" data-anchor-id="dfm-model">DFM model</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb47"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">readLines</span>(<span class="st">"../ecod025ps1/src/03-dfm.h"</span>), <span class="at">sep =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>/* Dynamic Factor Model (DFM) with Kalman Smoothing */

// Standardize data: mean 0 and common variance
std::tuple&lt;Mat&lt;double&gt;, rowvec, double&gt; dfm_standardize_(const Mat&lt;double&gt;&amp; X) {
  int T = X.n_rows;
  int N = X.n_cols;
  
  rowvec means = mean(X, 0);
  Mat&lt;double&gt; X_centered = X.each_row() - means;
  
  double total_var = accu(square(X_centered)) / (T * N);
  double common_sd = sqrt(total_var);
  
  Mat&lt;double&gt; X_std = X_centered / common_sd;
  
  return std::make_tuple(X_std, means, common_sd);
}

// Unstandardize data back to original scale
Mat&lt;double&gt; dfm_unstandardize_(const Mat&lt;double&gt;&amp; X_std, const rowvec&amp; means, double common_sd) {
  Mat&lt;double&gt; X_unstd = X_std * common_sd;
  X_unstd.each_row() += means;
  return X_unstd;
}

// PCA initialization for factors and loadings
std::pair&lt;Mat&lt;double&gt;, Mat&lt;double&gt;&gt; dfm_pca_init_(const Mat&lt;double&gt;&amp; X, int n_factors) {
  Mat&lt;double&gt; U, V;
  vec s;
  
  bool svd_ok = svd_econ(U, s, V, X.t());
  if (!svd_ok) {
    throw std::runtime_error("SVD decomposition failed in PCA initialization");
  }
  
  Mat&lt;double&gt; Lambda = U.cols(0, n_factors-1);
  Mat&lt;double&gt; F = X * Lambda;
  
  // Normalize factors to have unit variance
  rowvec F_var = var(F, 0, 0);
  for (int j = 0; j &lt; n_factors; ++j) {
    double var_j = F_var(j);
    if (var_j &gt; 1e-10) {
      double sd_j = sqrt(var_j);
      F.col(j) /= sd_j;
      Lambda.col(j) *= sd_j;
    }
  }
  
  return std::make_pair(F, Lambda);
}

// Kalman Filter and Smoother for DFM
struct KalmanOutput {
  Mat&lt;double&gt; F_smooth;     // Smoothed factors (T x state_dim)
  Cube&lt;double&gt; P_smooth;    // Smoothed covariances (state_dim x state_dim x T)
  Cube&lt;double&gt; PPm_smooth;  // Lag-one smoothed covariances for EM
  double loglik;
};

KalmanOutput dfm_kalman_smoother_(const Mat&lt;double&gt;&amp; X, const Mat&lt;double&gt;&amp; Lambda,
                                  const Mat&lt;double&gt;&amp; A, const Mat&lt;double&gt;&amp; Q,
                                  const Mat&lt;double&gt;&amp; R, int n_factors, int p) {
  int T = X.n_rows;
  int N = X.n_cols;
  int state_dim = (p &gt; 0) ? n_factors * p : n_factors;

  // Storage for filter outputs
  Mat&lt;double&gt; F_pred(T, state_dim);
  Mat&lt;double&gt; F_filt(T, state_dim);
  Cube&lt;double&gt; P_pred(state_dim, state_dim, T);
  Cube&lt;double&gt; P_filt(state_dim, state_dim, T);
  
  // Observation matrix H
  Mat&lt;double&gt; H = zeros&lt;Mat&lt;double&gt;&gt;(N, state_dim);
  H.submat(0, 0, N-1, n_factors-1) = Lambda;
  
  // Initial conditions
  vec F0 = zeros&lt;vec&gt;(state_dim);
  Mat&lt;double&gt; P0 = eye&lt;Mat&lt;double&gt;&gt;(state_dim, state_dim) * 10.0;
  
  double loglik = 0.0;
  double log_2pi = log(2 * datum::pi);
  
  // Forward pass (Kalman filter)
  for (int t = 0; t &lt; T; ++t) {
    // Prediction
    if (t == 0) {
      F_pred.row(t) = F0.t();
      P_pred.slice(t) = P0;
    } else {
      F_pred.row(t) = (A * F_filt.row(t-1).t()).t();
      P_pred.slice(t) = A * P_filt.slice(t-1) * A.t() + Q;
      // Ensure symmetry
      P_pred.slice(t) = 0.5 * (P_pred.slice(t) + P_pred.slice(t).t());
    }
    
    // Update
    vec y_t = X.row(t).t();
    vec y_pred = H * F_pred.row(t).t();
    vec innov = y_t - y_pred;
    
    Mat&lt;double&gt; S = H * P_pred.slice(t) * H.t() + R;
    S = 0.5 * (S + S.t()); // Ensure symmetry
    
    // Add regularization to avoid singularity
    S += eye&lt;Mat&lt;double&gt;&gt;(N, N) * 1e-8;
    
    // Compute Kalman gain: K = P * H' * inv(S)
    Mat&lt;double&gt; K = P_pred.slice(t) * H.t() * inv_sympd(S);
    
    F_filt.row(t) = F_pred.row(t) + (K * innov).t();
    P_filt.slice(t) = (eye&lt;Mat&lt;double&gt;&gt;(state_dim, state_dim) - K * H) * P_pred.slice(t);
    P_filt.slice(t) = 0.5 * (P_filt.slice(t) + P_filt.slice(t).t());
    
    // Log-likelihood
    double detS = det(S);
    if (detS &gt; 1e-10) {
      vec S_inv_innov;
      bool solve_ok = solve(S_inv_innov, S, innov);
      if (solve_ok) {
        double mahal = dot(innov, S_inv_innov);
        loglik -= 0.5 * (N * log_2pi + log(detS) + mahal);
      }
    }
  }
  
  // Backward pass (Smoother)
  Mat&lt;double&gt; F_smooth(T, state_dim);
  Cube&lt;double&gt; P_smooth(state_dim, state_dim, T);
  Cube&lt;double&gt; PPm_smooth(state_dim, state_dim, T);
  
  // Initialize with filtered values at T
  F_smooth.row(T-1) = F_filt.row(T-1);
  P_smooth.slice(T-1) = P_filt.slice(T-1);
  
  // Backward recursion
  for (int t = T-2; t &gt;= 0; --t) {
    Mat&lt;double&gt; J = P_filt.slice(t) * A.t() * inv(P_pred.slice(t+1));
    
    F_smooth.row(t) = F_filt.row(t) + 
                      (J * (F_smooth.row(t+1) - F_pred.row(t+1)).t()).t();
    
    P_smooth.slice(t) = P_filt.slice(t) + 
                        J * (P_smooth.slice(t+1) - P_pred.slice(t+1)) * J.t();
    P_smooth.slice(t) = 0.5 * (P_smooth.slice(t) + P_smooth.slice(t).t());
    
    // Lag-one covariance for EM (Cov(F_t+1, F_t | Y))
    if (t == T-2) {
      Mat&lt;double&gt; K_T = P_filt.slice(T-1) * H.t() * 
                        inv(H * P_pred.slice(T-1) * H.t() + R);
      PPm_smooth.slice(t+1) = (eye&lt;Mat&lt;double&gt;&gt;(state_dim, state_dim) - K_T * H) * 
                              A * P_filt.slice(t);
    } else {
      Mat&lt;double&gt; J_next = P_filt.slice(t+1) * A.t() * inv(P_pred.slice(t+2));
      PPm_smooth.slice(t+1) = P_filt.slice(t+1) * J.t() + 
                              J_next * (PPm_smooth.slice(t+2) - A * P_filt.slice(t+1)) * J.t();
    }
  }
  
  // First lag-one covariance
  if (T &gt; 1) {
    Mat&lt;double&gt; J0 = P0 * A.t() * inv(P_pred.slice(0));
    PPm_smooth.slice(0) = P_filt.slice(0) * J0.t() + 
                          (P_filt.slice(0) * A.t() * inv(P_pred.slice(1))) * 
                          (PPm_smooth.slice(1) - A * P_filt.slice(0)) * J0.t();
  }
  
  KalmanOutput out;
  out.F_smooth = F_smooth;  // Keep full state vector for EM algorithm
  out.P_smooth = P_smooth;
  out.PPm_smooth = PPm_smooth;
  out.loglik = loglik;
  
  return out;
}

// EM algorithm for DFM
struct DFMParams {
  Mat&lt;double&gt; Lambda;
  Mat&lt;double&gt; A;
  Mat&lt;double&gt; Q;
  Mat&lt;double&gt; R;
};

DFMParams dfm_em_algorithm_(const Mat&lt;double&gt;&amp; X, int n_factors, int p, 
                            int max_iter = 100, double tol = 1e-6) {
  int T = X.n_rows;
  int N = X.n_cols;
  int state_dim = (p &gt; 0) ? n_factors * p : n_factors;
  
  // Initialize with PCA
  auto pca_init = dfm_pca_init_(X, n_factors);
  Mat&lt;double&gt; F = pca_init.first;
  Mat&lt;double&gt; Lambda = pca_init.second;
  
  // Initialize dynamics
  Mat&lt;double&gt; A, Q;
  if (p &gt; 0) {
    Mat&lt;double&gt; A_var = var_estimate_(as_doubles_matrix(F), p, false);
    A = var_companion_(A_var, p, n_factors, false);
    
    // Scale down the persistence to allow more variation in forecasts
    // This prevents over-smoothing and allows factors to respond more to recent data
    A.submat(0, 0, n_factors-1, n_factors-1) *= 0.75;
    
    auto fitted_resid = var_fitted_resid_(F, A_var, p, false);
    Mat&lt;double&gt; eta = fitted_resid.second;
    
    Q = zeros&lt;Mat&lt;double&gt;&gt;(state_dim, state_dim);
    Mat&lt;double&gt; Q_init = cov(eta);
    // Increase factor innovation variance to capture more variation
    Q_init *= 1.5;
    Q.submat(0, 0, n_factors-1, n_factors-1) = Q_init;
  } else {
    // Lower persistence, higher variance for static case
    A = eye&lt;Mat&lt;double&gt;&gt;(n_factors, n_factors) * 0.7;
    Q = eye&lt;Mat&lt;double&gt;&gt;(n_factors, n_factors) * 0.2;
  }
  
  // Initialize R
  Mat&lt;double&gt; X_fitted = F * Lambda.t();
  Mat&lt;double&gt; residuals = X - X_fitted;
  vec R_diag = var(residuals, 0, 0).t();
  
  // Ensure R is positive definite with minimum variance
  for (uword i = 0; i &lt; R_diag.n_elem; ++i) {
    if (R_diag(i) &lt; 5e-6) {
      R_diag(i) = 5e-6;
    }
  }
  Mat&lt;double&gt; R = diagmat(R_diag);
  
  double prev_loglik = -datum::inf;
  
  // EM iterations
  for (int iter = 0; iter &lt; max_iter; ++iter) {
    // E-step: Run Kalman smoother
    KalmanOutput ks = dfm_kalman_smoother_(X, Lambda, A, Q, R, n_factors, p);
    
    // Check convergence
    if (iter &gt; 0 &amp;&amp; std::abs(ks.loglik - prev_loglik) / std::abs(prev_loglik) &lt; tol) {
      break;
    }
    prev_loglik = ks.loglik;
    
    // M-step: Update parameters
    // Sufficient statistics
    Mat&lt;double&gt; delta = zeros&lt;Mat&lt;double&gt;&gt;(N, n_factors);
    Mat&lt;double&gt; gamma = zeros&lt;Mat&lt;double&gt;&gt;(n_factors, n_factors);
    Mat&lt;double&gt; beta = zeros&lt;Mat&lt;double&gt;&gt;(n_factors, n_factors);
    Mat&lt;double&gt; gamma1 = zeros&lt;Mat&lt;double&gt;&gt;(n_factors, n_factors);
    
    // Extract actual factors for EM updates
    Mat&lt;double&gt; F_ks = ks.F_smooth.cols(0, n_factors-1);
    
    for (int t = 0; t &lt; T; ++t) {
      rowvec f_t = F_ks.row(t);
      Mat&lt;double&gt; P_t = ks.P_smooth.slice(t).submat(0, 0, n_factors-1, n_factors-1);
      
      delta += X.row(t).t() * f_t;
      gamma += f_t.t() * f_t + P_t;
      
      if (t &gt; 0) {
        rowvec f_tm1 = F_ks.row(t-1);
        Mat&lt;double&gt; PPm_t = ks.PPm_smooth.slice(t).submat(0, 0, n_factors-1, n_factors-1);
        beta += f_t.t() * f_tm1 + PPm_t;
        gamma1 += f_tm1.t() * f_tm1 + 
                  ks.P_smooth.slice(t-1).submat(0, 0, n_factors-1, n_factors-1);
      }
    }
    
    // Update Lambda
    // Lambda is N x n_factors, we want Lambda = delta * inv(gamma)
    // where delta is N x n_factors and gamma is n_factors x n_factors
    Lambda = delta * inv(gamma);
    
    // Update R
    Mat&lt;double&gt; X_pred = F_ks * Lambda.t();
    Mat&lt;double&gt; resid = X - X_pred;
    vec R_diag = sum(square(resid), 0).t() / T;
    
    // Add trace term for measurement error variance
    for (int i = 0; i &lt; N; ++i) {
      for (int j = 0; j &lt; n_factors; ++j) {
        double trace_term = Lambda(i, j) * Lambda(i, j) * 
                           (gamma(j, j) / T - 
                            as_scalar(F_ks.col(j).t() * F_ks.col(j)) / T);
        R_diag(i) += trace_term;
      }
      // Ensure positive definite with minimum variance
      if (R_diag(i) &lt; 5e-6) {
        R_diag(i) = 5e-6;
      }
    }
    R = diagmat(R_diag);
    
    // Update A and Q (only for dynamic model)
    if (p &gt; 0) {
      // Update A (only top-left block for companion form)
      Mat&lt;double&gt; A_new = beta * inv(gamma1);
      
      // Apply dampening to prevent too much persistence
      A_new *= 0.85;
      
      A.submat(0, 0, n_factors-1, n_factors-1) = A_new;
      
      // Update Q (only top-left block)
      Mat&lt;double&gt; Q_new = (gamma - beta * A_new.t() - A_new * beta.t() + 
                          A_new * gamma1 * A_new.t()) / T;
      Q_new = 0.5 * (Q_new + Q_new.t());
      
      // Inflate Q slightly to capture more variation
      Q_new *= 1.2;
      
      Q.submat(0, 0, n_factors-1, n_factors-1) = Q_new;
    }
  }
  
  DFMParams params;
  params.Lambda = Lambda;
  params.A = A;
  params.Q = Q;
  params.R = R;
  
  return params;
}

// DFM forecasting
Mat&lt;double&gt; dfm_forecast_(const Mat&lt;double&gt;&amp; F_last, const Mat&lt;double&gt;&amp; Lambda,
                         const Mat&lt;double&gt;&amp; A, int n_factors, int p, int h) {
  int N = Lambda.n_rows;
  int state_dim = (p &gt; 0) ? n_factors * p : n_factors;
  
  Mat&lt;double&gt; F_forecast(h, n_factors);
  Mat&lt;double&gt; X_forecast(h, N);
  
  // Initialize state vector
  vec state = zeros&lt;vec&gt;(state_dim);
  if (p &gt; 0) {
    // Fill companion form state
    int max_lags = std::min(p, static_cast&lt;int&gt;(F_last.n_rows));
    for (int i = 0; i &lt; max_lags; ++i) {
      state.subvec(i * n_factors, (i + 1) * n_factors - 1) = 
        F_last.row(F_last.n_rows - 1 - i).t();
    }
  } else {
    state = F_last.row(F_last.n_rows - 1).t();
  }
  
  // Generate forecasts
  for (int i = 0; i &lt; h; ++i) {
    state = A * state;
    F_forecast.row(i) = state.subvec(0, n_factors - 1).t();
    X_forecast.row(i) = (Lambda * F_forecast.row(i).t()).t();
  }
  
  return X_forecast;
}

/* roxygen
@title Dynamic Factor Model (DFM)
@description Estimates a DFM using EM algorithm with Kalman smoothing
@param x Matrix of observed variables (T x N)
@param n_factors Number of latent factors
@param p VAR lag order for factor dynamics
@param max_iter Maximum EM iterations
@param tol Convergence tolerance
@param forecast_h Forecast horizon
@export
*/
[[cpp4r::register]] list dfm_model(const doubles_matrix&lt;&gt;&amp; x, int n_factors, 
                                   int p = 1, int max_iter = 100, 
                                   double tol = 1e-6, int forecast_h = 0) {
  Mat&lt;double&gt; X_raw = as_Mat(x);
  int T = X_raw.n_rows;
  int N = X_raw.n_cols;
  
  if (T &lt;= p) {
    throw std::runtime_error("Sample size must be greater than lag order p");
  }
  
  if (n_factors &gt;= N) {
    throw std::runtime_error("Number of factors must be less than number of variables");
  }

  // Standardize data
  auto standardize_result = dfm_standardize_(X_raw);
  Mat&lt;double&gt; X = std::get&lt;0&gt;(standardize_result);
  rowvec means = std::get&lt;1&gt;(standardize_result);
  double common_sd = std::get&lt;2&gt;(standardize_result);
  
  // Estimate DFM parameters
  DFMParams params = dfm_em_algorithm_(X, n_factors, p, max_iter, tol);
  
  // Final smoothing pass
  KalmanOutput final_ks = dfm_kalman_smoother_(X, params.Lambda, params.A, 
                                               params.Q, params.R, n_factors, p);
  
  // Extract actual factors (first n_factors columns)
  Mat&lt;double&gt; F_smooth = final_ks.F_smooth.cols(0, n_factors-1);
  
  // Compute fitted values
  Mat&lt;double&gt; X_fitted_std = F_smooth * params.Lambda.t();
  Mat&lt;double&gt; X_fitted = dfm_unstandardize_(X_fitted_std, means, common_sd);
  Mat&lt;double&gt; residuals = X_raw - X_fitted;
  
  // Information criteria
  int n_params = N * n_factors + n_factors * n_factors * p + 
                 n_factors * (n_factors + 1) / 2 + N;
  double aic = -2 * final_ks.loglik + 2 * n_params;
  double bic = -2 * final_ks.loglik + n_params * log(T);
  
  // Prepare results
  writable::list result;
  
  result.push_back({"factors"_nm = as_doubles_matrix(F_smooth)});
  result.push_back({"loadings"_nm = as_doubles_matrix(params.Lambda)});
  result.push_back({"transition"_nm = as_doubles_matrix(params.A)});
  result.push_back({"factor_cov"_nm = as_doubles_matrix(params.Q)});
  result.push_back({"idiosync_cov"_nm = as_doubles_matrix(params.R)});
  result.push_back({"fitted_values"_nm = as_doubles_matrix(X_fitted)});
  result.push_back({"residuals"_nm = as_doubles_matrix(residuals)});
  result.push_back({"loglik"_nm = cpp4r::as_sexp(final_ks.loglik)});
  result.push_back({"aic"_nm = cpp4r::as_sexp(aic)});
  result.push_back({"bic"_nm = cpp4r::as_sexp(bic)});
  result.push_back({"n_factors"_nm = cpp4r::as_sexp(n_factors)});
  result.push_back({"lag_order"_nm = cpp4r::as_sexp(p)});
  result.push_back({"n_variables"_nm = cpp4r::as_sexp(N)});
  result.push_back({"n_obs"_nm = cpp4r::as_sexp(T)});
  
  // Metrics
  result.push_back({"rmsfe"_nm = cpp4r::as_sexp(rmsfe(X_raw.col(0), X_fitted.col(0)))});
  result.push_back({"mae"_nm = cpp4r::as_sexp(mae(X_raw.col(0), X_fitted.col(0)))});
  
  // Forecasts
  if (forecast_h &gt; 0) {
    Mat&lt;double&gt; forecasts_std = dfm_forecast_(F_smooth, params.Lambda, 
                                              params.A, n_factors, p, forecast_h);
    Mat&lt;double&gt; forecasts = dfm_unstandardize_(forecasts_std, means, common_sd);
    result.push_back({"forecasts"_nm = as_doubles_matrix(forecasts)});
    result.push_back({"forecast_horizon"_nm = cpp4r::as_sexp(forecast_h)});
  }
  
  return result;
}</code></pre>
</div>
</div>
</section>
<section id="bayesian-var-model" class="level2">
<h2 class="anchored" data-anchor-id="bayesian-var-model">Bayesian VAR model</h2>
<div class="cell">
<div class="sourceCode cell-code" id="cb49"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="fu">readLines</span>(<span class="st">"minnesota-litterman-var.stan"</span>), <span class="at">sep =</span> <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>// Bayesian VAR model with Minnesota prior for forecasting
data {
  int&lt;lower=1&gt; T;           // Number of time periods
  int&lt;lower=1&gt; K;           // Number of variables (3: CPI, GDP deflator, GDP growth)
  int&lt;lower=1&gt; p;           // Number of lags
  int&lt;lower=1&gt; h;           // Forecast horizon
  matrix[T, K] Y;           // Observed data
  
  // Minnesota prior hyperparameters
  real&lt;lower=0&gt; lambda;     // Overall tightness
  real&lt;lower=0&gt; tau;        // Relative tightness of own lags
  real&lt;lower=0&gt; epsilon;    // Small constant for numerical stability
}

transformed data {
  int T_eff = T - p;        // Effective sample size
  matrix[T_eff, K*p] X;    // Lagged variables matrix
  matrix[T_eff, K] Y_eff;  // Dependent variables
  
  // Construct lagged matrix
  for (t in 1:T_eff) {
    Y_eff[t] = Y[t + p];
    for (lag in 1:p) {
      for (k in 1:K) {
        X[t, (lag-1)*K + k] = Y[t + p - lag, k];
      }
    }
  }
}

parameters {
  matrix[K*p, K] B;         // VAR coefficients
  vector[K] c;              // Intercepts
  cholesky_factor_corr[K] L_Omega;  // Cholesky factor of correlation matrix
  vector&lt;lower=0&gt;[K] sigma;         // Standard deviations
}

transformed parameters {
  matrix[K, K] Sigma;      // Covariance matrix
  matrix[K, K] L_Sigma;    // Cholesky factor of Sigma
  L_Sigma = diag_pre_multiply(sigma, L_Omega);
  Sigma = L_Sigma * L_Sigma';
}

model {
  matrix[T_eff, K] mu;
  
  // Priors for error structure (put these FIRST to establish sigma values)
  sigma ~ normal(1, 1);  // More informative prior centered at 1
  L_Omega ~ lkj_corr_cholesky(2.0);
  
  // Minnesota prior on VAR coefficients (now sigma is well-defined)
  for (k in 1:K) {
    c[k] ~ normal(0, 10);  // Weakly informative prior on intercepts
    
    for (j in 1:K) {
      for (lag in 1:p) {
        int idx = (lag-1)*K + j;
        real prior_mean = (k == j &amp;&amp; lag == 1) ? 0.8 : 0.0;  // AR(1) coefficient = 0.8 for own first lag
        real prior_sd;
        
        if (k == j) {
          // Own lags: simple shrinkage
          prior_sd = lambda / pow(lag, 2);
        } else {
          // Cross lags: add epsilon to prevent division by zero
          prior_sd = lambda * tau / (pow(lag, 2) * (sigma[j] + epsilon));
        }
        
        B[idx, k] ~ normal(prior_mean, prior_sd);
      }
    }
  }
  
  // Likelihood
  mu = X * B;
  for (i in 1:K) {
    mu[, i] = mu[, i] + c[i];
  }
  for (t in 1:T_eff) {
    Y_eff[t] ~ multi_normal_cholesky(to_vector(mu[t]), L_Sigma);
  }
}

generated quantities {
  matrix[h, K] Y_forecast;           // Forecasts
  matrix[h, K] Y_forecast_mean;      // Mean forecasts
  matrix[T_eff, K] fitted;           // Fitted values
  matrix[T_eff, K] residuals;        // Residuals
  array[T_eff] real log_lik;         // Log likelihood for LOO
  
  // Compute fitted values and residuals
  fitted = X * B;
  for (i in 1:K) {
    fitted[, i] = fitted[, i] + c[i];
  }
  residuals = Y_eff - fitted;
  
  // Compute log likelihood
  for (t in 1:T_eff) {
    log_lik[t] = multi_normal_lpdf(Y_eff[t] | fitted[t], Sigma);
  }
  
  // Generate forecasts
  {
    matrix[p, K] Y_last;  // Last p observations
    matrix[h + p, K] Y_extended;  // Extended series for forecasting
    
    // Initialize with last p observations
    for (i in 1:p) {
      Y_last[i] = Y[T - p + i];
      Y_extended[i] = Y_last[i];
    }
    
    // Generate h-step ahead forecasts
    for (horizon in 1:h) {
      vector[K*p] x_forecast;
      
      // Construct lagged variables for forecasting
      for (lag in 1:p) {
        for (k in 1:K) {
          if (horizon - lag &lt;= 0) {
            // Use actual data
            x_forecast[(lag-1)*K + k] = Y_last[p + horizon - lag, k];
          } else {
            // Use previous forecasts
            x_forecast[(lag-1)*K + k] = Y_extended[p + horizon - lag, k];
          }
        }
      }
      
      // Mean forecast
      Y_forecast_mean[horizon] = (B' * x_forecast + c)';
      
      // Forecast with uncertainty
      Y_forecast[horizon] = multi_normal_cholesky_rng(
        B' * x_forecast + c, 
        L_Sigma
      )';
      
      // Store for next iteration
      Y_extended[p + horizon] = Y_forecast[horizon];
    }
  }
}</code></pre>
</div>
</div>

</section>
</section>

<div id="quarto-appendix" class="default"><section class="quarto-appendix-contents" role="doc-bibliography" id="quarto-bibliography"><h2 class="anchored quarto-appendix-heading">References</h2><div id="refs" class="references csl-bib-body hanging-indent" data-entry-spacing="0" role="list">
<div id="ref-hansen22" class="csl-entry" role="listitem">
Hansen, Bruce E. 2022. <em>Econometrics</em>. Princeton, New Jersey: Princeton University Press.
</div>
<div id="ref-sanderson24" class="csl-entry" role="listitem">
Sanderson, Conrad. 2024. <span>“Armadillo: <span>C</span>++ Library for Linear Algebra &amp; Scientific Computing.”</span> <a href="https://arma.sourceforge.net/speed.html">https://arma.sourceforge.net/speed.html</a>.
</div>
<div id="ref-sanderson16" class="csl-entry" role="listitem">
Sanderson, Conrad, and Ryan Curtin. 2016. <span>“Armadillo: A Template-Based <span>C</span>++ Library for Linear Algebra.”</span> <em>Journal of Open Source Software</em> 1 (2): 26. <a href="https://doi.org/10.21105/joss.00026">https://doi.org/10.21105/joss.00026</a>.
</div>
</div></section></div></main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
  window.document.addEventListener("DOMContentLoaded", function (event) {
    const icon = "";
    const anchorJS = new window.AnchorJS();
    anchorJS.options = {
      placement: 'right',
      icon: icon
    };
    anchorJS.add('.anchored');
    const isCodeAnnotation = (el) => {
      for (const clz of el.classList) {
        if (clz.startsWith('code-annotation-')) {                     
          return true;
        }
      }
      return false;
    }
    const onCopySuccess = function(e) {
      // button target
      const button = e.trigger;
      // don't keep focus
      button.blur();
      // flash "checked"
      button.classList.add('code-copy-button-checked');
      var currentTitle = button.getAttribute("title");
      button.setAttribute("title", "Copied!");
      let tooltip;
      if (window.bootstrap) {
        button.setAttribute("data-bs-toggle", "tooltip");
        button.setAttribute("data-bs-placement", "left");
        button.setAttribute("data-bs-title", "Copied!");
        tooltip = new bootstrap.Tooltip(button, 
          { trigger: "manual", 
            customClass: "code-copy-button-tooltip",
            offset: [0, -8]});
        tooltip.show();    
      }
      setTimeout(function() {
        if (tooltip) {
          tooltip.hide();
          button.removeAttribute("data-bs-title");
          button.removeAttribute("data-bs-toggle");
          button.removeAttribute("data-bs-placement");
        }
        button.setAttribute("title", currentTitle);
        button.classList.remove('code-copy-button-checked');
      }, 1000);
      // clear code selection
      e.clearSelection();
    }
    const getTextToCopy = function(trigger) {
        const codeEl = trigger.previousElementSibling.cloneNode(true);
        for (const childEl of codeEl.children) {
          if (isCodeAnnotation(childEl)) {
            childEl.remove();
          }
        }
        return codeEl.innerText;
    }
    const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
      text: getTextToCopy
    });
    clipboard.on('success', onCopySuccess);
    if (window.document.getElementById('quarto-embedded-source-code-modal')) {
      const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
        text: getTextToCopy,
        container: window.document.getElementById('quarto-embedded-source-code-modal')
      });
      clipboardModal.on('success', onCopySuccess);
    }
      var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
      var mailtoRegex = new RegExp(/^mailto:/);
        var filterRegex = new RegExp('/' + window.location.host + '/');
      var isInternal = (href) => {
          return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
      }
      // Inspect non-navigation links and adorn them if external
     var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
      for (var i=0; i<links.length; i++) {
        const link = links[i];
        if (!isInternal(link.href)) {
          // undo the damage that might have been done by quarto-nav.js in the case of
          // links that we want to consider external
          if (link.dataset.originalHref !== undefined) {
            link.href = link.dataset.originalHref;
          }
        }
      }
    function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
      const config = {
        allowHTML: true,
        maxWidth: 500,
        delay: 100,
        arrow: false,
        appendTo: function(el) {
            return el.parentElement;
        },
        interactive: true,
        interactiveBorder: 10,
        theme: 'quarto',
        placement: 'bottom-start',
      };
      if (contentFn) {
        config.content = contentFn;
      }
      if (onTriggerFn) {
        config.onTrigger = onTriggerFn;
      }
      if (onUntriggerFn) {
        config.onUntrigger = onUntriggerFn;
      }
      window.tippy(el, config); 
    }
    const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
    for (var i=0; i<noterefs.length; i++) {
      const ref = noterefs[i];
      tippyHover(ref, function() {
        // use id or data attribute instead here
        let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
        try { href = new URL(href).hash; } catch {}
        const id = href.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note) {
          return note.innerHTML;
        } else {
          return "";
        }
      });
    }
    const xrefs = window.document.querySelectorAll('a.quarto-xref');
    const processXRef = (id, note) => {
      // Strip column container classes
      const stripColumnClz = (el) => {
        el.classList.remove("page-full", "page-columns");
        if (el.children) {
          for (const child of el.children) {
            stripColumnClz(child);
          }
        }
      }
      stripColumnClz(note)
      if (id === null || id.startsWith('sec-')) {
        // Special case sections, only their first couple elements
        const container = document.createElement("div");
        if (note.children && note.children.length > 2) {
          container.appendChild(note.children[0].cloneNode(true));
          for (let i = 1; i < note.children.length; i++) {
            const child = note.children[i];
            if (child.tagName === "P" && child.innerText === "") {
              continue;
            } else {
              container.appendChild(child.cloneNode(true));
              break;
            }
          }
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(container);
          }
          return container.innerHTML
        } else {
          if (window.Quarto?.typesetMath) {
            window.Quarto.typesetMath(note);
          }
          return note.innerHTML;
        }
      } else {
        // Remove any anchor links if they are present
        const anchorLink = note.querySelector('a.anchorjs-link');
        if (anchorLink) {
          anchorLink.remove();
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        if (note.classList.contains("callout")) {
          return note.outerHTML;
        } else {
          return note.innerHTML;
        }
      }
    }
    for (var i=0; i<xrefs.length; i++) {
      const xref = xrefs[i];
      tippyHover(xref, undefined, function(instance) {
        instance.disable();
        let url = xref.getAttribute('href');
        let hash = undefined; 
        if (url.startsWith('#')) {
          hash = url;
        } else {
          try { hash = new URL(url).hash; } catch {}
        }
        if (hash) {
          const id = hash.replace(/^#\/?/, "");
          const note = window.document.getElementById(id);
          if (note !== null) {
            try {
              const html = processXRef(id, note.cloneNode(true));
              instance.setContent(html);
            } finally {
              instance.enable();
              instance.show();
            }
          } else {
            // See if we can fetch this
            fetch(url.split('#')[0])
            .then(res => res.text())
            .then(html => {
              const parser = new DOMParser();
              const htmlDoc = parser.parseFromString(html, "text/html");
              const note = htmlDoc.getElementById(id);
              if (note !== null) {
                const html = processXRef(id, note);
                instance.setContent(html);
              } 
            }).finally(() => {
              instance.enable();
              instance.show();
            });
          }
        } else {
          // See if we can fetch a full url (with no hash to target)
          // This is a special case and we should probably do some content thinning / targeting
          fetch(url)
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.querySelector('main.content');
            if (note !== null) {
              // This should only happen for chapter cross references
              // (since there is no id in the URL)
              // remove the first header
              if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
                note.children[0].remove();
              }
              const html = processXRef(null, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      }, function(instance) {
      });
    }
        let selectedAnnoteEl;
        const selectorForAnnotation = ( cell, annotation) => {
          let cellAttr = 'data-code-cell="' + cell + '"';
          let lineAttr = 'data-code-annotation="' +  annotation + '"';
          const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
          return selector;
        }
        const selectCodeLines = (annoteEl) => {
          const doc = window.document;
          const targetCell = annoteEl.getAttribute("data-target-cell");
          const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
          const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
          const lines = annoteSpan.getAttribute("data-code-lines").split(",");
          const lineIds = lines.map((line) => {
            return targetCell + "-" + line;
          })
          let top = null;
          let height = null;
          let parent = null;
          if (lineIds.length > 0) {
              //compute the position of the single el (top and bottom and make a div)
              const el = window.document.getElementById(lineIds[0]);
              top = el.offsetTop;
              height = el.offsetHeight;
              parent = el.parentElement.parentElement;
            if (lineIds.length > 1) {
              const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
              const bottom = lastEl.offsetTop + lastEl.offsetHeight;
              height = bottom - top;
            }
            if (top !== null && height !== null && parent !== null) {
              // cook up a div (if necessary) and position it 
              let div = window.document.getElementById("code-annotation-line-highlight");
              if (div === null) {
                div = window.document.createElement("div");
                div.setAttribute("id", "code-annotation-line-highlight");
                div.style.position = 'absolute';
                parent.appendChild(div);
              }
              div.style.top = top - 2 + "px";
              div.style.height = height + 4 + "px";
              div.style.left = 0;
              let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
              if (gutterDiv === null) {
                gutterDiv = window.document.createElement("div");
                gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
                gutterDiv.style.position = 'absolute';
                const codeCell = window.document.getElementById(targetCell);
                const gutter = codeCell.querySelector('.code-annotation-gutter');
                gutter.appendChild(gutterDiv);
              }
              gutterDiv.style.top = top - 2 + "px";
              gutterDiv.style.height = height + 4 + "px";
            }
            selectedAnnoteEl = annoteEl;
          }
        };
        const unselectCodeLines = () => {
          const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
          elementsIds.forEach((elId) => {
            const div = window.document.getElementById(elId);
            if (div) {
              div.remove();
            }
          });
          selectedAnnoteEl = undefined;
        };
          // Handle positioning of the toggle
      window.addEventListener(
        "resize",
        throttle(() => {
          elRect = undefined;
          if (selectedAnnoteEl) {
            selectCodeLines(selectedAnnoteEl);
          }
        }, 10)
      );
      function throttle(fn, ms) {
      let throttle = false;
      let timer;
        return (...args) => {
          if(!throttle) { // first call gets through
              fn.apply(this, args);
              throttle = true;
          } else { // all the others get throttled
              if(timer) clearTimeout(timer); // cancel #2
              timer = setTimeout(() => {
                fn.apply(this, args);
                timer = throttle = false;
              }, ms);
          }
        };
      }
        // Attach click handler to the DT
        const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
        for (const annoteDlNode of annoteDls) {
          annoteDlNode.addEventListener('click', (event) => {
            const clickedEl = event.target;
            if (clickedEl !== selectedAnnoteEl) {
              unselectCodeLines();
              const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
              if (activeEl) {
                activeEl.classList.remove('code-annotation-active');
              }
              selectCodeLines(clickedEl);
              clickedEl.classList.add('code-annotation-active');
            } else {
              // Unselect the line
              unselectCodeLines();
              clickedEl.classList.remove('code-annotation-active');
            }
          });
        }
    const findCites = (el) => {
      const parentEl = el.parentElement;
      if (parentEl) {
        const cites = parentEl.dataset.cites;
        if (cites) {
          return {
            el,
            cites: cites.split(' ')
          };
        } else {
          return findCites(el.parentElement)
        }
      } else {
        return undefined;
      }
    };
    var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
    for (var i=0; i<bibliorefs.length; i++) {
      const ref = bibliorefs[i];
      const citeInfo = findCites(ref);
      if (citeInfo) {
        tippyHover(citeInfo.el, function() {
          var popup = window.document.createElement('div');
          citeInfo.cites.forEach(function(cite) {
            var citeDiv = window.document.createElement('div');
            citeDiv.classList.add('hanging-indent');
            citeDiv.classList.add('csl-entry');
            var biblioDiv = window.document.getElementById('ref-' + cite);
            if (biblioDiv) {
              citeDiv.innerHTML = biblioDiv.innerHTML;
            }
            popup.appendChild(citeDiv);
          });
          return popup.innerHTML;
        });
      }
    }
  });
  </script>
</div> <!-- /content -->




</body></html>